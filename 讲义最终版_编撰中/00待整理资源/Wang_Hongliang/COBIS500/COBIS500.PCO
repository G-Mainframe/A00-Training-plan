000010******************************************************************
000020*         ＜海輝軟件(大連)＞                                     *
000030*      1. プログラム名  : 契約手形債権明細移行処理               *
000040*      2. プログラムID  : COBIS500                               *
000050*      3. 処理概要      : SUMMITファクタリングＤＢより、契約手形 *
000060*                         債権明細テーブルを作成する。           *
000070*      4. 作成者        : 王洪亮                                 *
000080*      5. 作成日        : 2005.4.4                               *
000090******************************************************************
000100*                                                                 
000110******************************************************************
000120*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000130******************************************************************
000140 IDENTIFICATION                       DIVISION.                   
000150*                                                                 
000160 PROGRAM-ID.                          COBIS500.                   
000170******************************************************************
000180*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000190******************************************************************
000200 ENVIRONMENT                          DIVISION.                   
000210******************************************************************
000220*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000230******************************************************************
000240 DATA                                 DIVISION.                   
000250******************************************************************
000260*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000270******************************************************************
000280  WORKING-STORAGE                     SECTION.                    
000290*----------------------------------------------------------------*
000300*    ホスト変数定義エリア                                        *
000310*----------------------------------------------------------------*
000320     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000330*--< ＯＲＡＣＬＥ共通変数 >                                       
000340     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000350*                                                                 
000360*--< ＯＲＡＣＬＥ  ＳＱＬ実行情報 >                               
000370     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000380*                                                                 
000390*--< 移行後_債権展開 >                                            
000400     EXEC  SQL  INCLUDE  LTRFCT.CBL            END-EXEC.          
000410*--< 変換テーブル >                                               
000420     EXEC  SQL  INCLUDE  IKOTBL001.CBL         END-EXEC.          
000430*--< 移行後_債権 >                                                
000440     EXEC  SQL  INCLUDE  LTRFCK.CBL            END-EXEC.          
000450*--< 変則払ＤＢ>                                                  
000460     EXEC  SQL  INCLUDE  D415UTM.CBL           END-EXEC.          
000470*                                                                 
000480     EXEC  SQL  END  DECLARE          SECTION  END-EXEC.          
000490*                                                                 
000500*----------------------------------------------------------------*
000510*    ＷＯＲＫエリア                                              *
000520*----------------------------------------------------------------*
000530 01  ＷＯＲＫ−エリア.                                            
000540*--< エラー判定用 >                                               
000550     03  Ｗ−エラーコード             PIC S9(04).                 
000560*                                                                 
000570*--< フラグアリア >                                               
000580     03  フラグアリア.                                            
000590         05  Ｗ−終了−フラグ         PIC  X(01).                 
000600         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
000610*                                                                 
000620*--< 件数エリア >                                                 
000630     03  件数エリア.                                              
000640         05  Ｗ−入力−件数１           PIC  9(09).               
000650         05  Ｗ−入力−件数２           PIC  9(09).               
000660         05  Ｗ−出力−件数             PIC  9(09).               
000670*                                                                 
000680*--< 共通情報 >                                                   
000690 01  Ｗ−共通情報.                                                
000700     03  Ｗ−システム日付.                                        
000710         05  Ｗ−世紀                 PIC  X(02) VALUE  "20".     
000720         05  Ｗ−年月日               PIC  X(06).                 
000730     03  Ｗ−システム時刻             PIC  X(08).                 
000740     03  Ｗ−担当者                   PIC  X(08) VALUE "IKOPG   ".
000750*                                                                 
000760*----------------------------------------------------------------*
000770*    サブルーチン名                                              *
000780*----------------------------------------------------------------*
000790 01  CALL-AREA.                                                   
000800*--< 共通ログサブルーチン >                                       
000810     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
000820     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
000830*                                                                 
000840*----------------------------------------------------------------*
000850*    ＣＯＰＹ領域                                                *
000860*----------------------------------------------------------------*
000870*--< 共通ログ用パラメータ >                                       
000880 01  IF-CHOCO001.                                                 
000890     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
000900*                                                                 
000910*----------------------------------------------------------------*
000920*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
000930*----------------------------------------------------------------*
000940 01  PARA-AREA.                                                   
000950     COPY CPBCO001.                                               
000960******************************************************************
000970*    定数用データ定義エリア                                      *
000980******************************************************************
000990 CONSTANT                             SECTION.                    
001000 01  定数領域.                                                    
001010     03  定数−プログラムＩＤ         PIC  X(08) VALUE "COBIS500".
001020     03  定数−プログラム名           PIC  X(80)                  
001030                                    VALUE  "契約手形債権明細ＤＢ".
001040     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001050     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001060     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001070     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001080******************************************************************
001090*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001100******************************************************************
001110 PROCEDURE                            DIVISION.                   
001120*                                                                 
001130     PERFORM  初期処理.                                           
001140*                                                                 
001150     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001160*                                                                 
001170     PERFORM  終了処理.                                           
001180*                                                                 
001190     STOP     RUN.                                                
001200*                                                                 
001210******************************************************************
001220*    初期処理                                                    *
001230******************************************************************
001240 初期処理                             SECTION.                    
001250 初期処理−ＳＴＡＲＴ.                                            
001260*                                                                 
001270*----------------------------------------------------------------*
001280*    開始メッセージ出力処理                                      *
001290*----------------------------------------------------------------*
001300     INITIALIZE                       IF-CHOCO001.                
001310     MOVE  "3"                        TO  共１−イベント種別.     
001320     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001330     MOVE  "0"                        TO  共１−復帰コード.       
001340     MOVE  "START"                    TO  共１−処理識別.         
001350     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001360     CALL  CLOCO001                USING  IF-CHOCO001.            
001370*                                                                 
001380*----------------------------------------------------------------*
001390*    作業領域の初期値処理                                        *
001400*----------------------------------------------------------------*
001410     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001420     INITIALIZE                           ＷＯＲＫ−エリア.       
001430*                                                                 
001440*--< ＣＰＵ日付を取得 >                                           
001450     ACCEPT  Ｗ−年月日               FROM  DATE.                 
001460*                                                                 
001470*--< ＣＰＵ時刻を取得 >                                           
001480     ACCEPT  Ｗ−システム時刻         FROM  TIME.                 
001490*                                                                 
001500*--< ＯＲＡＣＬＥ接続 >                                           
001510     PERFORM   ＯＲＡＣＬＥ接続.                                  
001520*                                                                 
001530*--< 結合テーブルカーソル定義 >                                   
001540     PERFORM  結合テーブルカーソル定義.                           
001550*                                                                 
001560*--< 結合テーブルカーソル読込(１件目) >                           
001570     PERFORM  結合テーブルカーソル読込.                           
001580*                                                                 
001590 初期処理−ＥＸＩＴ.                                              
001600     EXIT.                                                        
001610******************************************************************
001620*    ＯＲＡＣＬＥ接続                                            *
001630******************************************************************
001640 ＯＲＡＣＬＥ接続                     SECTION.                    
001650 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
001660*                                                                 
001670*--< ＩＮＩファイル読込サブルーチン呼び出し >                     
001680     CALL  COBCO001                USING  PARA-AREA.              
001690*                                                                 
001700     MOVE  PARA-DBSTRING              TO  DB-STRING.              
001710     MOVE  PARA-USERNAME              TO  USERNAME.               
001720     MOVE  PARA-PASSWORD              TO  PASSWD.                 
001730*                                                                 
001740*----------------------------------------------------------------*
001750*    開始接続                                                    *
001760*----------------------------------------------------------------*
001770     IF  DB-STRING  =  SPACE                                      
001780        EXEC  SQL                                                 
001790           CONNECT  :USERNAME  IDENTIFIED  BY  :PASSWD            
001800        END-EXEC                                                  
001810     ELSE                                                         
001820        EXEC  SQL                                                 
001830           CONNECT  :USERNAME  IDENTIFIED  BY  :PASSWD            
001840             USING  :DB-STRING                                    
001850        END-EXEC                                                  
001860     END-IF.                                                      
001870*                                                                 
001880*----------------------------------------------------------------*
001890*    接続状態判定                                                *
001900*----------------------------------------------------------------*
001910     EVALUATE  SQLCODE                                            
001920        WHEN  定数−ＳＱＬＯＫ                                    
001930*--<       接続正常 >                                             
001940           CONTINUE                                               
001950        WHEN  OTHER                                               
001960*--<       接続エラー >                                           
001970           MOVE     -10               TO  Ｗ−エラーコード        
001980           PERFORM  エラー処理                                    
001990     END-EVALUATE.                                                
002000*                                                                 
002010 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002020     EXIT.                                                        
002030******************************************************************
002040*        結合テーブルカーソル定義                                *
002050******************************************************************
002060 結合テーブルカーソル定義             SECTION.                    
002070 結合テーブルカーソル定義−ＳＴＡＲＴ.                            
002080*                                                                 
002090*----------------------------------------------------------------*
002100*    カーソルＯＰＥＮ処理                                        *
002110*----------------------------------------------------------------*
002120     EXEC SQL                                                     
002130        DECLARE CUR1  CURSOR FOR                                  
002140           SELECT  LTRFCT.契約番号                                
002141                  ,NVL(LTRFCK.ユーザーコード,RPAD('0',8,'0'))     
002142                  ,NVL(LTRFCK.額面金額,0)                         
002143                  ,NVL(LTRFCK.期日,RPAD('0',7,'0'))               
002170                  ,LTRFCT.利息期日                                
002180                  ,LTRFCT.期間日数                                
002190                  ,LTRFCT.割引率                                  
002200                  ,LTRFCT.割引料                                  
002210                  ,LTRFCT.受取手数料                              
002220                  ,LTRFCT.受取手数料消費税等額                    
002230                  ,LTRFCT.買取金額                                
002231                  ,NVL(LTRFCK.社内金利,0)                         
002232                  ,NVL(LTRFCK.粗利益,0)                           
002260                  ,LTRFCT.手形番号                                
002270                  ,LTRFCT.手形種類                                
002280                  ,LTRFCT.取引銀行コード                          
002300                  ,NVL(LTRFCK.請求先コード,RPAD('0',8,'0'))       
002310                  ,LTRFCT.期限前決裁日                            
002320             FROM  LTRFCK                                         
002330                  ,LTRFCT                                         
002340            WHERE  LTRFCT.契約番号  =  LTRFCK.契約番号 ( + )      
002350     END-EXEC.                                                    
002360*                                                                 
002370*----------------------------------------------------------------*
002380*    カーソルＯＰＥＮ処理                                        *
002390*----------------------------------------------------------------*
002400     EXEC  SQL                                                    
002410        OPEN  CUR1                                                
002420     END-EXEC.                                                    
002430*                                                                 
002440*----------------------------------------------------------------*
002450*    カーソルＯＰＥＮ確認                                        *
002460*----------------------------------------------------------------*
002470     EVALUATE  SQLCODE                                            
002480        WHEN  定数−ＳＱＬＯＫ                                    
002490*--<       正常 >                                                 
002500           CONTINUE                                               
002510        WHEN  OTHER                                               
002520*--<       カーソルＯＰＥＮエラー >                               
002530           MOVE -20                   TO  Ｗ−エラーコード        
002540           PERFORM  エラー処理                                    
002550     END-EVALUATE.                                                
002560*                                                                 
002570 結合テーブルカーソル定義−ＥＸＩＴ.                              
002580     EXIT.                                                        
002590******************************************************************
002600*    結合テーブルカーソル読込                                    *
002610******************************************************************
002620 結合テーブルカーソル読込             SECTION.                    
002630 結合テーブルカーソル読込−ＳＴＡＲＴ.                            
002640*                                                                 
002650*--< 結合テーブルカーソル読込 >                                   
002660     EXEC SQL                                                     
002670         FETCH  CUR1                                              
002680          INTO  :ＬＴＲＦＣＴ−契約番号                           
002681               ,:ＬＴＲＦＣＫ−ユーザーコード                     
002690               ,:ＬＴＲＦＣＫ−額面金額                           
002700               ,:ＬＴＲＦＣＫ−期日                               
002710               ,:ＬＴＲＦＣＴ−利息期日                           
002720               ,:ＬＴＲＦＣＴ−期間日数                           
002730               ,:ＬＴＲＦＣＴ−割引率                             
002740               ,:ＬＴＲＦＣＴ−割引料                             
002750               ,:ＬＴＲＦＣＴ−受取手数料                         
002760               ,:ＬＴＲＦＣＴ−受取手数料消費税等額               
002770               ,:ＬＴＲＦＣＴ−買取金額                           
002780               ,:ＬＴＲＦＣＫ−社内金利                           
002790               ,:ＬＴＲＦＣＫ−粗利益                             
002800               ,:ＬＴＲＦＣＴ−手形番号                           
002810               ,:ＬＴＲＦＣＴ−手形種類                           
002820               ,:ＬＴＲＦＣＴ−取引銀行コード                     
002830               ,:ＬＴＲＦＣＫ−請求先コード                       
002840               ,:ＬＴＲＦＣＴ−期限前決裁日                       
002850     END-EXEC.                                                    
002860*                                                                 
002870*----------------------------------------------------------------*
002880*    結合テーブルカーソル読込を確認                              *
002890*----------------------------------------------------------------*
002900     EVALUATE   SQLCODE                                           
002910        WHEN   定数−ＳＱＬＯＫ                                   
002920*--<       正常 >                                                 
002930           COMPUTE  Ｗ−入力−件数１  =  Ｗ−入力−件数１  +  1   
002940           COMPUTE  Ｗ−入力−件数２  =  Ｗ−入力−件数２  +  1   
002950        WHEN   定数−ＳＱＬＥＮＤ                                 
002960*--<       読込終了 >                                             
002970           MOVE  "Y"                  TO  Ｗ−終了−フラグ        
002980        WHEN   OTHER                                              
002990*--<       読込エラー >                                           
003000           MOVE     -30               TO  Ｗ−エラーコード        
003010           PERFORM  エラー処理                                    
003020     END-EVALUATE.                                                
003030*                                                                 
003040 結合テーブルカーソル読込−ＥＸＩＴ.                              
003050     EXIT.                                                        
003060******************************************************************
003070*    主処理                                                      *
003080******************************************************************
003090 主処理                               SECTION.                    
003100 主処理−ＳＴＡＲＴ.                                              
003110*                                                                 
003120     PERFORM  編集出力処理.                                       
003130*                                                                 
003140     PERFORM  出力処理                                            
003150*--< 結合テーブルカーソル読込（２件目以降） >                     
003160     PERFORM  結合テーブルカーソル読込.                           
003170*                                                                 
003180 主処理−ＥＸＩＴ.                                                
003190     EXIT.                                                        
003200******************************************************************
003210*    項目抽出処理１                                              *
003220******************************************************************
003230 項目抽出処理１                         SECTION.                  
003240 項目抽出処理−ＳＴＡＲＴ.                                        
003241                                                                  
003242     MOVE  SPACE                      TO                          
003243                                      ＩＫＯ００１−新取引先コード
003244     MOVE  SPACE                      TO  ＩＫＯ００１−枝番      
003250*                                                                 
003260*----------------------------------------------------------------*
003270*    新取引先コード読込                                          *
003280*----------------------------------------------------------------*
003290      EXEC SQL                                                    
003300         SELECT   新取引先コード                                  
003310         INTO    :ＩＫＯ００１−新取引先コード                    
003320         FROM    IKOTBL001                                        
003340        WHERE    IKOTBL001.取引先コード =                         
003360                                    :ＬＴＲＦＣＫ−ユーザーコード 
003370          AND    IKOTBL001.目的ＣＤ = '2'                         
003380      END-EXEC.                                                   
003390*----------------------------------------------------------------*
003400*   新取引先コード検索を確認                                     *
003410*----------------------------------------------------------------*
003420     EVALUATE   SQLCODE                                           
003430        WHEN   定数−ＳＱＬＯＫ                                   
003440*--< 正常の時 >                                                   
003450           CONTINUE                                               
003460        WHEN   OTHER                                              
003470*--< 存在しない >                                                 
003480           MOVE     SPACE             TO                          
003490                                      ＩＫＯ００１−新取引先コード
003520     END-EVALUATE.                                                
003530*----------------------------------------------------------------*
003540*    枝番読込                                                    *
003550*----------------------------------------------------------------*
003560      EXEC SQL                                                    
003570         SELECT  枝番                                             
003580         INTO   :ＩＫＯ００１−枝番                               
003590         FROM   IKOTBL001                                         
003610        WHERE   IKOTBL001.取引先コード =                          
003630                                     :ＬＴＲＦＣＫ−ユーザーコード
003640          AND   IKOTBL001.目的ＣＤ = '2'                          
003650      END-EXEC.                                                   
003660*----------------------------------------------------------------*
003670*   枝番検索を確認                                               *
003680*----------------------------------------------------------------*
003690     EVALUATE   SQLCODE                                           
003700        WHEN   定数−ＳＱＬＯＫ                                   
003710*--< 正常の時 >                                                   
003720           CONTINUE                                               
003730        WHEN   OTHER                                              
003740*--< 存在しない >                                                 
003750           MOVE     SPACE             TO  ＩＫＯ００１−枝番      
003780     END-EVALUATE.                                                
003790  項目抽出処理１−ＥＸＩＴ.                                       
003800     EXIT.                                                        
003810******************************************************************
003820*    項目抽出処理２                                              *
003830******************************************************************
003840 項目抽出処理２                         SECTION.                  
003850 項目抽出処理−ＳＴＡＲＴ.                                        
003851                                                                  
003852     MOVE  SPACE                      TO                          
003853                                      ＩＫＯ００１−新取引先コード
003854     MOVE  SPACE                      TO  ＩＫＯ００１−枝番      
003855                                                                  
003860*----------------------------------------------------------------*
003870*    新取引先コード読込                                          *
003880*----------------------------------------------------------------*
003890      EXEC SQL                                                    
003900         SELECT  新取引先コード                                   
003910         INTO    :ＩＫＯ００１−新取引先コード                    
003920         FROM    IKOTBL001                                        
003930         WHERE   IKOTBL001.取引先コード =                         
003950                                       :ＬＴＲＦＣＫ−請求先コード
003970          AND    IKOTBL001.目的ＣＤ = '3'                         
003980      END-EXEC.                                                   
003990*----------------------------------------------------------------*
004000*    新取引先コード検索を確認                                    *
004010*----------------------------------------------------------------*
004020     EVALUATE   SQLCODE                                           
004030        WHEN   定数−ＳＱＬＯＫ                                   
004040*--< 正常の時 >                                                   
004050           CONTINUE                                               
004060        WHEN   OTHER                                              
004070*--< 存在しない >                                                 
004080           MOVE     SPACE             TO                          
004090                                      ＩＫＯ００１−新取引先コード
004100     END-EVALUATE.                                                
004130*----------------------------------------------------------------*
004140*    枝番読込                                                    *
004150*----------------------------------------------------------------*
004160      EXEC SQL                                                    
004170         SELECT  枝番                                             
004180         INTO    :ＩＫＯ００１−枝番                              
004190         FROM    IKOTBL001                                        
004200        WHERE    IKOTBL001.取引先コード =                         
004220                                       :ＬＴＲＦＣＫ−請求先コード
004240          AND    IKOTBL001.目的ＣＤ = '3'                         
004250      END-EXEC.                                                   
004260*----------------------------------------------------------------*
004270*     枝番検索を確認                                             *
004280*----------------------------------------------------------------*
004290     EVALUATE   SQLCODE                                           
004300        WHEN   定数−ＳＱＬＯＫ                                   
004310*--< 正常の時 >                                                   
004320           CONTINUE                                               
004330        WHEN   OTHER                                              
004340*--< 存在しない >                                                 
004350           MOVE     SPACE             TO   ＩＫＯ００１−枝番     
004380     END-EVALUATE.                                                
004390 項目抽出処理２−ＥＸＩＴ.                                        
004400     EXIT.                                                        
004410******************************************************************
004420*     編集出力処理                                               *
004430******************************************************************
004440 編集出力処理                         SECTION.                    
004450 編集出力処理−ＳＴＡＲＴ.                                        
004460*----------------------------------------------------------------*
004470*       初期化処理                                               *
004480*----------------------------------------------------------------*
004490        MOVE  SPACE                   TO  契約手形債権明細        
004500        INITIALIZE                        契約手形債権明細        
004510*                                                                 
004520*----------------------------------------------------------------*
004530*       項目編集処理                                             *
004540*----------------------------------------------------------------*
004550*--<    No.01 >                                                   
004560        MOVE  ＬＴＲＦＣＴ−契約番号  TO  Ｄ４１５−契約番号.     
004570*                                                                 
004580*--<    No.02 >                                                   
004590        MOVE  Ｗ−出力−件数          TO  Ｄ４１５−明細番号.     
004600*                                                                 
004610        PERFORM  項目抽出処理１.                                  
004620*--<    No.03 >                                                   
004630        MOVE  ＩＫＯ００１−新取引先コード                        
004640                                      TO  Ｄ４１５−取引先コード. 
004650*                                                                 
004660*--<    No.04 >                                                   
004670        MOVE  ＩＫＯ００１−枝番      TO  Ｄ４１５−契約先コード. 
004680*                                                                 
004690*--<    No.05 >                                                   
004700        MOVE  ＬＴＲＦＣＫ−額面金額  TO  Ｄ４１５−額面金額.     
004710*                                                                 
004720*--<    No.06 >                                                   
004730        MOVE  ＬＴＲＦＣＫ−期日      TO  Ｄ４１５−手形期日.     
004740*                                                                 
004750*--<    No.07 >                                                   
004760        MOVE  ＬＴＲＦＣＴ−利息期日  TO  Ｄ４１５−利息期日.     
004770*                                                                 
004780*--<    No.08 >                                                   
004790        MOVE  ＬＴＲＦＣＴ−期間日数  TO  Ｄ４１５−日数.         
004800*                                                                 
004810*--<    No.09 >                                                   
004820        MOVE  ＬＴＲＦＣＴ−割引率    TO  Ｄ４１５−割引率.       
004830*                                                                 
004840*--<    No.10 >                                                   
004850        MOVE  ＬＴＲＦＣＴ−割引料    TO  Ｄ４１５−割引料.       
004860*                                                                 
004870*--<    No.11 >                                                   
004880        MOVE  ＬＴＲＦＣＴ−受取手数料                            
004890                                      TO  Ｄ４１５−取立手数料等. 
004900*                                                                 
004910*--<    No.12 >                                                   
004920        MOVE  ＬＴＲＦＣＴ−受取手数料消費税等額                  
004930                                      TO                          
004940                                   Ｄ４１５−取立手数料等消費税額.
004950*                                                                 
004960*--<    No.13 >                                                   
004970        MOVE  ＬＴＲＦＣＴ−買取金額  TO  Ｄ４１５−買取代金額.   
004980*                                                                 
004990*--<    No.14 >                                                   
005000        MOVE  ZERO                    TO  Ｄ４１５−社内金利区分. 
005010*                                                                 
005020*--<    No.15 >                                                   
005030        MOVE  ＬＴＲＦＣＫ−社内金利  TO  Ｄ４１５−社内金利.     
005040*                                                                 
005050*--<    No.16 >                                                   
005060        MOVE  ZERO                    TO  Ｄ４１５−実質年率.     
005070*                                                                 
005080*--<    No.17 >                                                   
005090        MOVE  ＬＴＲＦＣＫ−粗利益    TO  Ｄ４１５−粗利.         
005100*                                                                 
005110*--<    No.18 >                                                   
005120        MOVE  ＬＴＲＦＣＴ−手形番号  TO  Ｄ４１５−手形番号.     
005130*                                                                 
005140*--<    No.19 >                                                   
005150        MOVE  ＬＴＲＦＣＴ−手形種類  TO  Ｄ４１５−手形種類.     
005160*                                                                 
005170*--<    No.20 >                                                   
005180        MOVE  ＬＴＲＦＣＴ−取引銀行コード(1:4)                   
005190                                      TO Ｄ４１５−支払銀行コード.
005210*--<    No.21 >                                                   
005220        MOVE  ＬＴＲＦＣＴ−取引銀行コード(5:3)                   
005230                                      TO Ｄ４１５−支払支店コード.
005250*                                                                 
005260        PERFORM  項目抽出処理２.                                  
005270*--<    No.22 >                                                   
005280        MOVE  ＩＫＯ００１−新取引先コード                        
005290                                      TO                          
005300                                       Ｄ４１５−請求取引先コード.
005310*                                                                 
005320*--<    No.23 >                                                   
005330        MOVE  ＩＫＯ００１−枝番      TO  Ｄ４１５−請求先コード. 
005340*                                                                 
005350*--<    No.24 >                                                   
005360        MOVE  ＬＴＲＦＣＫ−社内金利  TO                          
005370                                         Ｄ４１５−社内金利−一般.
005380*                                                                 
005390*--<    No.25 >                                                   
005400        MOVE  ＬＴＲＦＣＫ−粗利益    TO  Ｄ４１５−粗利−一般.   
005410*                                                                 
005420*--<    No.26 >                                                   
005430        MOVE  ZERO                    TO  Ｄ４１５−流動化先.     
005440*                                                                 
005450*--<    No.27 >                                                   
005460        MOVE  ZERO                    TO                          
005470                                       Ｄ４１５−債権流動化先区分.
005480*                                                                 
005490*--<    No.28 >                                                   
005500        MOVE  ＬＴＲＦＣＴ−期限前決裁日                          
005510                                      TO  Ｄ４１５−期限前決裁日. 
005520*                                                                 
005530*--<    No.29 >                                                   
005540        MOVE  Ｗ−システム日付        TO  Ｄ４１５−更新年月日.   
005550*                                                                 
005560*--<    No.30 >                                                   
005570        MOVE  Ｗ−システム時刻        TO  Ｄ４１５−更新時間.     
005580*                                                                 
005590*--<    No.31 >                                                   
005600        MOVE  Ｗ−担当者              TO  Ｄ４１５−更新者.       
005610*                                                                 
005620*--<    No.32 >                                                   
005630        MOVE  Ｗ−担当者              TO                          
005640                                      Ｄ４１５−入力担当者コード. 
005650*                                                                 
005660*--<    No.33 >                                                   
005670        MOVE  Ｗ−システム日付        TO  Ｄ４１５−登録年月日.   
005680*                                                                 
005690*--<    No.34 >                                                   
005700        MOVE  Ｗ−システム時刻        TO  Ｄ４１５−登録時間.     
005710*                                                                 
005720*--<    No.35 >                                                   
005730        MOVE  Ｗ−担当者              TO  Ｄ４１５−登録担当者.   
005740*                                                                 
005750 編集出力処理−ＥＸＩＴ.                                          
005760     EXIT.                                                        
005770******************************************************************
005780*    出力処理                                                    *
005790******************************************************************
005800 出力処理                             SECTION.                    
005810 出力処理−ＳＴＡＲＴ.                                            
005820*                                                                 
005830       EXEC  SQL                                                  
005840         INSERT  INTO  D415UTM_TBL                                
005850           ( 契約番号                                             
005860            ,明細番号                                             
005870            ,取引先コード                                         
005880            ,契約先コード                                         
005890            ,額面金額                                             
005900            ,手形期日                                             
005910            ,利息期日                                             
005920            ,日数                                                 
005930            ,割引率                                               
005940            ,割引料                                               
005950            ,取立手数料等                                         
005960            ,取立手数料等消費税額                                 
005970            ,買取代金額                                           
005980            ,社内金利区分                                         
005990            ,社内金利                                             
006000            ,実質年率                                             
006010            ,粗利                                                 
006020            ,手形番号                                             
006030            ,手形種類                                             
006040            ,支払銀行コード                                       
006050            ,支払支店コード                                       
006060            ,請求取引先コード                                     
006070            ,請求先コード                                         
006080            ,社内金利_一般                                        
006090            ,粗利_一般                                            
006091            ,期限前決裁日                                         
006100            ,流動化先                                             
006110            ,債権流動化先区分                                     
006130            ,更新年月日                                           
006140            ,更新時間                                             
006150            ,更新者                                               
006160            ,入力担当者コード                                     
006170            ,登録年月日                                           
006180            ,登録時間                                             
006190            ,登録担当者)                                          
006200       VALUES                                                     
006210           ( :Ｄ４１５−契約番号                                  
006220            ,:Ｄ４１５−明細番号                                  
006230            ,:Ｄ４１５−取引先コード                              
006240            ,:Ｄ４１５−契約先コード                              
006250            ,:Ｄ４１５−額面金額                                  
006260            ,:Ｄ４１５−手形期日                                  
006270            ,:Ｄ４１５−利息期日                                  
006280            ,:Ｄ４１５−日数                                      
006290            ,:Ｄ４１５−割引率                                    
006300            ,:Ｄ４１５−割引料                                    
006310            ,:Ｄ４１５−取立手数料等                              
006320            ,:Ｄ４１５−取立手数料等消費税額                      
006330            ,:Ｄ４１５−買取代金額                                
006340            ,:Ｄ４１５−社内金利区分                              
006350            ,:Ｄ４１５−社内金利                                  
006360            ,:Ｄ４１５−実質年率                                  
006370            ,:Ｄ４１５−粗利                                      
006380            ,:Ｄ４１５−手形番号                                  
006390            ,:Ｄ４１５−手形種類                                  
006400            ,:Ｄ４１５−支払銀行コード                            
006410            ,:Ｄ４１５−支払支店コード                            
006420            ,:Ｄ４１５−請求取引先コード                          
006430            ,:Ｄ４１５−請求先コード                              
006440            ,:Ｄ４１５−社内金利−一般                            
006450            ,:Ｄ４１５−粗利−一般                                
006451            ,:Ｄ４１５−期限前決裁日                              
006460            ,:Ｄ４１５−流動化先                                  
006470            ,:Ｄ４１５−債権流動化先区分                          
006490            ,:Ｄ４１５−更新年月日                                
006500            ,:Ｄ４１５−更新時間                                  
006510            ,:Ｄ４１５−更新者                                    
006520            ,:Ｄ４１５−入力担当者コード                          
006530            ,:Ｄ４１５−登録年月日                                
006540            ,:Ｄ４１５−登録時間                                  
006550            ,:Ｄ４１５−登録担当者)                               
006560                                                                  
006570     END-EXEC.                                                    
006580*                                                                 
006590*----------------------------------------------------------------*
006600*    追加処理を確認                                              *
006610*----------------------------------------------------------------*
006620     EVALUATE  SQLCODE                                            
006630        WHEN   定数−ＳＱＬＯＫ                                   
006640*--<       追加成功 >                                             
006650           COMPUTE  Ｗ−出力−件数  =  Ｗ−出力−件数  +  1       
006660        WHEN   OTHER                                              
006670*--<       追加処理エラー >                                       
006680           MOVE     -50               TO  Ｗ−エラーコード        
006690           PERFORM  エラー処理                                    
006700     END-EVALUATE.                                                
006710*                                                                 
006720 出力処理−ＥＸＩＴ.                                              
006730     EXIT.                                                        
006740******************************************************************
006750*    終了処理                                                    *
006760******************************************************************
006770 終了処理                             SECTION.                    
006780 終了処理−ＳＴＡＲＴ.                                            
006790*                                                                 
006800     PERFORM  ＤＢクローズ処理.                                   
006810*                                                                 
006820     PERFORM  ＤＢコミット処理.                                   
006830*                                                                 
006840     PERFORM  終了メッセージ出力.                                 
006850*                                                                 
006860*--< プログラム正常終了 >                                         
006870     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
006880*                                                                 
006890 終了処理−ＥＸＩＴ.                                              
006900     EXIT.                                                        
006910******************************************************************
006920*    終了メッセージ出力                                          *
006930******************************************************************
006940 終了メッセージ出力                   SECTION.                    
006950 終了メッセージ出力−ＳＴＡＲＴ.                                  
006960*                                                                 
006970*----------------------------------------------------------------*
006980*    件数メッセージ出力処理                                      *
006990*----------------------------------------------------------------*
007000     INITIALIZE                       IF-CHOCO001.                
007010     MOVE  "3"                        TO  共１−イベント種別.     
007020     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007030     MOVE  "0"                        TO  共１−復帰コード.       
007040     MOVE  "LTRFCT"                   TO  共１−処理テーブルＩＤ. 
007050     MOVE  "COUNT"                    TO  共１−処理識別.         
007060     MOVE  Ｗ−入力−件数１           TO  共１−データ内容.       
007070     MOVE  "SUMMITﾌｧｸﾀﾘﾝｸﾞ手形債権読込件数"                       
007080                                      TO  共１−その他メッセージ. 
007090     CALL  CLOCO001                USING  IF-CHOCO001.            
007100*                                                                 
007110     INITIALIZE                       IF-CHOCO001.                 
007120     MOVE  "3"                        TO  共１−イベント種別.     
007130     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007140     MOVE  "0"                        TO  共１−復帰コード.       
007150     MOVE  "LTRFCK"                   TO  共１−処理テーブルＩＤ. 
007160     MOVE  "COUNT"                    TO  共１−処理識別.         
007170     MOVE  Ｗ−入力−件数２           TO  共１−データ内容.       
007180     MOVE  "SUMMITﾌｧｸﾀﾘﾝｸﾞ基本情報読込件数"                       
007190                                      TO  共１−その他メッセージ. 
007200     CALL  CLOCO001                USING  IF-CHOCO001.            
007210*                                                                 
007220     INITIALIZE                       IF-CHOCO001.                
007230     MOVE  "3"                        TO  共１−イベント種別.     
007240     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007250     MOVE  "0"                        TO  共１−復帰コード.       
007260     MOVE  "D415UTM"                  TO  共１−処理テーブルＩＤ. 
007270     MOVE  "COUNT"                    TO  共１−処理識別.         
007280     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
007290     MOVE  "契約手形債権明細登録件数"                             
007300                                      TO  共１−その他メッセージ. 
007310     CALL  CLOCO001                USING  IF-CHOCO001.            
007320*                                                                 
007330*----------------------------------------------------------------*
007340*    終了メッセージ出力                                          *
007350*----------------------------------------------------------------*
007360     INITIALIZE                       IF-CHOCO001.                
007370     MOVE  "3"                        TO  共１−イベント種別.     
007380     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007390     MOVE  "0"                        TO  共１−復帰コード.       
007400     MOVE  "END"                      TO  共１−処理識別.         
007410     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
007420     CALL  CLOCO001                USING  IF-CHOCO001.            
007430*                                                                 
007440 終了メッセージ出力−ＥＸＩＴ.                                    
007450     EXIT.                                                        
007460******************************************************************
007470*    ＤＢクローズ                                                *
007480******************************************************************
007490 ＤＢクローズ処理                     SECTION.                    
007500 ＤＢクローズ処理−ＳＴＡＲＴ.                                    
007510*                                                                 
007520*--< カーソル クローズ >                                          
007530     EXEC SQL                                                     
007540        CLOSE  CUR1                                               
007550     END-EXEC.                                                    
007560*                                                                 
007570 ＤＢクローズ処理−ＥＸＩＴ.                                      
007580     EXIT.                                                        
007590******************************************************************
007600*    ＤＢコミット処理                                            *
007610******************************************************************
007620 ＤＢコミット処理                     SECTION.                    
007630 ＤＢコミット処理−ＳＴＡＲＴ.                                    
007640*                                                                 
007650     EXEC  SQL                                                    
007660        COMMIT  WORK  RELEASE                                     
007670     END-EXEC.                                                    
007680*                                                                 
007690     INITIALIZE                       IF-CHOCO001.                
007700     MOVE  "3"                        TO  共１−イベント種別.     
007710     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007720     MOVE  "0"                        TO  共１−復帰コード.       
007730     MOVE  "COMMIT"                   TO  共１−処理識別.         
007740     MOVE  "コミット実施"             TO  共１−その他メッセージ. 
007750     CALL  CLOCO001                USING  IF-CHOCO001.            
007760*                                                                 
007770 ＤＢコミット処理−ＥＸＩＴ.                                      
007780     EXIT.                                                        
007790******************************************************************
007800*    ＤＢロールバック処理                                        *
007810******************************************************************
007820 ＤＢロールバック処理                 SECTION.                    
007830 ＤＢロールバック処理−ＳＴＡＲＴ.                                
007840*                                                                 
007850     EXEC  SQL                                                    
007860        ROLLBACK WORK  RELEASE                                    
007870     END-EXEC.                                                    
007880*                                                                 
007890     INITIALIZE                       IF-CHOCO001.                
007900     MOVE  "1"                        TO  共１−イベント種別.     
007910     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007920     MOVE  "9"                        TO  共１−復帰コード.       
007930     MOVE  "ROLLBACK"                 TO  共１−処理識別.         
007940     MOVE  "ロールバック実施"         TO  共１−その他メッセージ. 
007950     CALL  CLOCO001                USING  IF-CHOCO001.            
007960*                                                                 
007970 ＤＢロールバック処理−ＥＸＩＴ.                                  
007980     EXIT.                                                        
007990******************************************************************
008000*    エラー処理                                                  *
008010******************************************************************
008020 エラー処理                       SECTION.                        
008030 エラー処理−ＳＴＡＲＴ.                                          
008040*                                                                 
008050     MOVE  "Y"                        TO Ｗ−異常終了−フラグ.    
008060     INITIALIZE                           IF-CHOCO001.            
008070*                                                                 
008080     EVALUATE  Ｗ−エラーコード                                   
008090        WHEN  -10                                                 
008100*--<       ＯＲＡＣＬＥ接続失敗 >                                 
008110           MOVE  "1"                  TO  共１−イベント種別      
008120           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008130           MOVE  "9"                  TO  共１−復帰コード        
008140           MOVE  "CONNECT"            TO  共１−処理識別          
008150           MOVE  SQLCODE              TO  共１−データ内容        
008160           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008170           CALL  CLOCO001          USING  IF-CHOCO001             
008180*                                                                 
008190        WHEN  -20                                                 
008200*--<       結合テーブルカーソルオープン失敗 >                     
008210           MOVE  "1"                  TO  共１−イベント種別      
008220           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008230           MOVE  "9"                  TO  共１−復帰コード        
008240           MOVE  "LTRFCT"             TO  共１−処理テーブルＩＤ  
008250           MOVE  "OPEN"               TO  共１−処理識別          
008260           MOVE  SQLCODE              TO  共１−データ内容        
008270           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008280           CALL  CLOCO001          USING  IF-CHOCO001             
008290*                                                                 
008300        WHEN  -30                                                 
008310*--<       結合テーブル読込失敗 >                                 
008320           MOVE  "1"                  TO  共１−イベント種別      
008330           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008340           MOVE  "9"                  TO  共１−復帰コード        
008350           MOVE  "LTRFCT"             TO  共１−処理テーブルＩＤ  
008360           MOVE  "FETCH"              TO  共１−処理識別          
008370           MOVE  SQLCODE              TO  共１−データ内容        
008380           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008390           CALL  CLOCO001          USING  IF-CHOCO001             
008400*                                                                 
008410        WHEN  -40                                                 
008420*--<      項目抽出処理エラー >                                    
008430           MOVE  "2"                  TO  共１−イベント種別      
008440           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008450           MOVE  "9"                  TO  共１−復帰コード        
008460           MOVE  "IKOTBL001"          TO  共１−処理テーブルＩＤ  
008470           MOVE  "SELECT"             TO  共１−処理識別          
008480           MOVE  SQLCODE              TO  共１−データ内容        
008490           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008500           CALL  CLOCO001          USING  IF-CHOCO001             
008510           MOVE  "N"                  TO  Ｗ−異常終了−フラグ      
008520        WHEN  -50                                                 
008530*--<       契約手形債権明細ＤＢ追加失敗 >                         
008540           MOVE  "1"                  TO  共１−イベント種別      
008550           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008560           MOVE  "9"                  TO  共１−復帰コード        
008570           MOVE  "D415UTM"            TO  共１−処理テーブルＩＤ  
008580           MOVE  "INSERT"             TO  共１−処理識別          
008590           MOVE  SQLCODE              TO  共１−データ内容        
008600           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008610           CALL  CLOCO001          USING  IF-CHOCO001             
008620*                                                                 
008630        WHEN  OTHER                                               
008640           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
008650     END-EVALUATE.                                                
008660*                                                                 
008670     IF Ｗ−異常終了−フラグ  =  "Y"                              
008680        PERFORM  ＤＢロールバック処理                             
008690*                                                                 
008700        PERFORM  終了メッセージ出力                               
008710*                                                                 
008720*--<    プログラム異常終了のリターンコード >                      
008730        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
008740*                                                                 
008750        EXIT  PROGRAM                                             
008760     END-IF.                                                      
008770*                                                                 
008780 エラー処理−ＥＸＩＴ.                                            
008790     EXIT.                                                        
008800******************************************************************
008810*                  END OF PROGRAM                                *
008820******************************************************************
