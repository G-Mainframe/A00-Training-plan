000010******************************************************************
000020*         ＜海輝軟件(大連)＞                                     *
000030*      1. プログラム名  : 前受金受払残高ファイル作成             *
000040*      2. プログラムID  : AAASED25                               *
000050*      3. 処理概要      : 前受情報ＤＢをメインに、マスタと表     *
000060*                         結合して読込み、前受金受払残高中間     *
000070*                         ファイルを作成する。                   *
000080*                                                                *
000090*      4. 作成者        : 王軍                                   *
000100*      5. 作成日        : 2005.03.26                             *
000110******************************************************************
000120*                                                                 
000130******************************************************************
000140*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000150******************************************************************
000160 IDENTIFICATION                       DIVISION.                   
000170*                                                                 
000180 PROGRAM-ID.                          AAASED25.                   
000190******************************************************************
000200*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000210******************************************************************
000220 ENVIRONMENT                          DIVISION.                   
000230******************************************************************
000240*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000250******************************************************************
000260 INPUT-OUTPUT                         SECTION.                    
000270*                                                                 
000280 FILE-CONTROL.                                                    
000290     SELECT    出力ファイル           ASSIGN    TO     U11        
000300     FILE      STATUS     IS          Ｗ−状態                    
000310     ORGANIZATION         IS          LINE      SEQUENTIAL.       
000320*                                                                 
000330******************************************************************
000340*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000350******************************************************************
000360 DATA                                 DIVISION.                   
000370******************************************************************
000380*    ＦＩＬＥ                      ＳＥＣＴＩＯＮ                *
000390******************************************************************
000400 FILE                                 SECTION.                    
000410*----------------------------------------------------------------*
000420*    出力ファイル                                                *
000430*----------------------------------------------------------------*
000440 FD  出力ファイル                                                 
000450     LABEL     RECORD     IS          STANDARD                    
000460     BLOCK     CONTAINS   0           RECORDS.                    
000470*                                                                 
000480 01  出力−レコード.                                              
000490     COPY  CPSCE50  REPLACING  ==()==  BY  ==出力−==.            
000500*                                                                 
000510******************************************************************
000520*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000530******************************************************************
000540  WORKING-STORAGE                     SECTION.                    
000550*----------------------------------------------------------------*
000560*    ホスト変数定義エリア                                        *
000570*----------------------------------------------------------------*
000580     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000590*                                                                 
000600 01  ＷＳ−名称１                     PIC  X(60).                 
000610 01  ＷＳ−名称２                     PIC  X(60).                 
000620 01  ＷＳ−業務管理ＩＤ               PIC  X(08) VALUE "GYMKNRRC".
000630 01  ＷＳ−前受金受払残高表対象フラグ PIC  X(01) VALUE "1".       
000640 01  ＷＳ−コードＮＯ１               PIC  X(12) VALUE "038".     
000650 01  ＷＳ−コードＮＯ２               PIC  X(12) VALUE "005".     
000660 01  ＷＳ−レコード区分               PIC  X(01) VALUE "1".       
000670*                                                                 
000680*--< ＯＲＡＣＬＥ共通変数 >                                       
000690     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000700*                                                                 
000710*--< ＯＲＡＣＬＥ  ＳＱＬ実行情報 >                               
000720     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000730*                                                                 
000740*--< 前受情報ＤＢ >                                               
000750     EXEC  SQL  INCLUDE  M40MAB.CBL            END-EXEC.          
000760*                                                                 
000770*--< 業務管理テーブル >                                           
000780     EXEC  SQL  INCLUDE  D70GYM.CBL            END-EXEC.          
000790*                                                                 
000800*--< 取引先マスタ>                                                
000810     EXEC  SQL  INCLUDE  D01TRS.CBL            END-EXEC.          
000820*                                                                 
000830*--< 請求先マスタ>                                                
000840     EXEC  SQL  INCLUDE  D02SQS.CBL            END-EXEC.          
000850*                                                                 
000860*--< 項目名称マスタ>                                              
000870     EXEC  SQL  INCLUDE  D19MSY.CBL            END-EXEC.          
000880*                                                                 
000890*--< 債権情報（一般）ＤＢ>                                        
000900     EXEC  SQL  INCLUDE  M01SAJ.CBL            END-EXEC.          
000910*                                                                 
000920     EXEC  SQL  END  DECLARE          SECTION  END-EXEC.          
000930*----------------------------------------------------------------*
000940*    ＷＯＲＫエリア                                              *
000950*----------------------------------------------------------------*
000960 01  ＷＯＲＫ−エリア.                                            
000970*                                                                 
000980*--< ファイル状態 >                                               
000990     03  Ｗ−状態エリア.                                          
001000         05  Ｗ−状態                 PIC  X(02).                 
001010*--< エラー判定用 >                                               
001020     03  Ｗ−エラーコード             PIC S9(04).                 
001030*                                                                 
001040*--< フラグアリア >                                               
001050     03  フラグアリア.                                            
001060         05  Ｗ−終了−フラグ         PIC  X(01).                 
001070         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
001080*                                                                 
001090*--< 件数エリア >                                                 
001100     03  件数エリア.                                              
001110         05  Ｗ−入力−件数           PIC  9(09).                 
001120         05  Ｗ−出力−件数           PIC  9(09).                 
001130*                                                                 
001140*----------------------------------------------------------------*
001150*    サブルーチン名                                              *
001160*----------------------------------------------------------------*
001170 01  CALL-AREA.                                                   
001180*--< 共通ログサブルーチン >                                       
001190     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
001200     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
001210*                                                                 
001220*----------------------------------------------------------------*
001230*    ＣＯＰＹ領域                                                *
001240*----------------------------------------------------------------*
001250*--< 共通ログ用パラメータ >                                       
001260 01  IF-CHOCO001.                                                 
001270     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
001280*                                                                 
001290*----------------------------------------------------------------*
001300*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001310*----------------------------------------------------------------*
001320 01  PARA-AREA.                                                   
001330     COPY CPBCO001.                                               
001340******************************************************************
001350*    定数用データ定義エリア                                      *
001360******************************************************************
001370 CONSTANT                             SECTION.                    
001380 01  定数領域.                                                    
001390     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
001400     03  定数−プログラム名           PIC  X(80) VALUE            
001410                                     "前受金受払残高ファイル作成".
001420     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001430     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001440     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001450     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001460******************************************************************
001470*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001480******************************************************************
001490 PROCEDURE                            DIVISION.                   
001500*                                                                 
001510     PERFORM  初期処理.                                           
001520*                                                                 
001530     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001540*                                                                 
001550     PERFORM  終了処理.                                           
001560*                                                                 
001570     STOP     RUN.                                                
001580*                                                                 
001590******************************************************************
001600*    初期処理                                                    *
001610******************************************************************
001620 初期処理                             SECTION.                    
001630 初期処理−ＳＴＡＲＴ.                                            
001640*                                                                 
001650*----------------------------------------------------------------*
001660*    開始メッセージ出力処理                                      *
001670*----------------------------------------------------------------*
001680     INITIALIZE                       IF-CHOCO001.                
001690     MOVE  "3"                        TO  共１−イベント種別.     
001700     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001710     MOVE  "0"                        TO  共１−復帰コード.       
001720     MOVE  "START"                    TO  共１−処理識別.         
001730     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001740     CALL  CLOCO001                USING  IF-CHOCO001.            
001750*                                                                 
001760*----------------------------------------------------------------*
001770*    作業領域の初期値処理                                        *
001780*----------------------------------------------------------------*
001790     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001800     INITIALIZE                           ＷＯＲＫ−エリア.       
001810*----------------------------------------------------------------*
001820*    ＯＲＡＣＬＥ接続                                            *
001830*----------------------------------------------------------------*
001840     PERFORM  ＯＲＡＣＬＥ接続.                                   
001850*----------------------------------------------------------------*
001860*    業務管理テーブル読込                                        *
001870*----------------------------------------------------------------*
001880     PERFORM  業務管理テーブル読込.                               
001890*----------------------------------------------------------------*
001900*    結合テーブルカーソル定義                                    *
001910*----------------------------------------------------------------*
001920     PERFORM  結合テーブルカーソル定義.                           
001930*----------------------------------------------------------------*
001940*    ファイルオープン                                            *
001950*----------------------------------------------------------------*
001960     PERFORM  ファイルオープン.                                   
001970*----------------------------------------------------------------*
001980*    結合テーブルカーソル読込                                    *
001990*----------------------------------------------------------------*
002000     PERFORM  結合テーブルカーソル読込.                           
002010*                                                                 
002020 初期処理−ＥＸＩＴ.                                              
002030     EXIT.                                                        
002040******************************************************************
002050*    ＯＲＡＣＬＥ接続                                            *
002060******************************************************************
002070 ＯＲＡＣＬＥ接続                     SECTION.                    
002080 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
002090*                                                                 
002100*--< ＤＢ接続用情報を取得処理 >                                   
002110     CALL  COBCO001                USING  PARA-AREA.              
002120*                                                                 
002130     MOVE  PARA-DBSTRING              TO  DB-STRING.              
002140     MOVE  PARA-USERNAME              TO  USERNAME.               
002150     MOVE  PARA-PASSWORD              TO  PASSWD.                 
002160*                                                                 
002170*----------------------------------------------------------------*
002180*    開始接続                                                    *
002190*----------------------------------------------------------------*
002200     IF    DB-STRING  =  SPACE                                    
002210        EXEC SQL                                                  
002220           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002230        END-EXEC                                                  
002240     ELSE                                                         
002250        EXEC SQL                                                  
002260           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002270             USING  :DB-STRING                                    
002280        END-EXEC                                                  
002290     END-IF.                                                      
002300*                                                                 
002310*----------------------------------------------------------------*
002320*    接続確認                                                    *
002330*----------------------------------------------------------------*
002340     EVALUATE  SQLCODE                                            
002350        WHEN   定数−ＳＱＬＯＫ                                   
002360           CONTINUE                                               
002370        WHEN   OTHER                                              
002380*--<       接続エラー >                                           
002390           MOVE     -1                TO  Ｗ−エラーコード        
002400           PERFORM  エラー処理                                    
002410     END-EVALUATE.                                                
002420*                                                                 
002430 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002440     EXIT.                                                        
002450******************************************************************
002460*    業務管理テーブル読込                                        *
002470******************************************************************
002480 業務管理テーブル読込                 SECTION.                    
002490 業務管理テーブル読込−ＳＴＡＲＴ.                                
002500*                                                                 
002510*----------------------------------------------------------------*
002520*    業務管理テーブル読込                                        *
002530*----------------------------------------------------------------*
002540     EXEC SQL                                                     
002550        SELECT  バッチ用業務年月                                  
002560          INTO :Ｄ７０−バッチ用業務年月                          
002570          FROM  D70GYM_TBL                                        
002580         WHERE  業務管理ＩＤ = :ＷＳ−業務管理ＩＤ                
002590     END-EXEC.                                                    
002600*----------------------------------------------------------------*
002610*    業務管理テーブル検索を確認                                  *
002620*----------------------------------------------------------------*
002630     EVALUATE   SQLCODE                                           
002640        WHEN   定数−ＳＱＬＯＫ                                   
002650*--<       正常の時 >                                             
002660           CONTINUE                                               
002670           DISPLAY "業務年月 = " Ｄ７０−バッチ用業務年月         
002680        WHEN   OTHER                                              
002690*--<       存在しない >                                           
002700           MOVE     -2                TO  Ｗ−エラーコード        
002710           PERFORM  エラー処理                                    
002720     END-EVALUATE.                                                
002730*                                                                 
002740 業務管理テーブル読込−ＥＸＩＴ.                                  
002750     EXIT.                                                        
002760******************************************************************
002770*    結合テーブルカーソル定義                                    *
002780******************************************************************
002790 結合テーブルカーソル定義             SECTION.                    
002800 結合テーブルカーソル定義−ＳＴＡＲＴ.                            
002810*                                                                 
002820*----------------------------------------------------------------*
002830*    カーソル定義処理                                            *
002840*----------------------------------------------------------------*
002850     EXEC SQL                                                     
002860        DECLARE CUR1  CURSOR FOR                                  
002870           SELECT  M40MAB_TBL.レコード区分                        
002880                  ,M40MAB_TBL.経理用主契約区分                    
002890                  ,M40MAB_TBL.顧客区分                            
002900                  ,NVL(D01TRS_TBL.名寄せコード,RPAD(' ',40,' '))  
002910                  ,M40MAB_TBL.請求先取引先コード                  
002920                  ,M40MAB_TBL.請求先コード                        
002930                  ,M40MAB_TBL.契約番号                            
002940                  ,M40MAB_TBL.契約種類                            
002950                  ,M40MAB_TBL.担当部課コード                      
002960                  ,M40MAB_TBL.再リース回数                        
002970                  ,M40MAB_TBL.充当開始年月                        
002980                  ,M40MAB_TBL.充当月数                            
002990                  ,M40MAB_TBL.前払回収方法                        
003000                  ,M40MAB_TBL.入金日                              
003010                  ,M40MAB_TBL.入金区分                            
003020                  ,NVL(D01TRS_TBL.取引先名称,RPAD(' ',80,' '))    
003030                  ,NVL(D02SQS_TBL.請求先名称,RPAD(' ',80,' '))    
003040                  ,M40MAB_TBL.前月末残高                          
003050                  ,M40MAB_TBL.当月回収額                          
003060                  ,M40MAB_TBL.当月消化額                          
003070                  ,M40MAB_TBL.当月末残高                          
003080                  ,M40MAB_TBL.協調区分                            
003090                  ,M40MAB_TBL.前月末残高他社                      
003100                  ,M40MAB_TBL.当月回収額他社                      
003110                  ,M40MAB_TBL.当月消化額他社                      
003120                  ,M40MAB_TBL.当月他社解約分料金                  
003130                  ,M40MAB_TBL.当月他社解約分消費税                
003140                  ,M40MAB_TBL.当月末残高他社                      
003150             FROM  M40MAB_TBL                                     
003160                  ,D01TRS_TBL                                     
003170                  ,D02SQS_TBL                                     
003180            WHERE  M40MAB_TBL.前受金受払残高表対象フラグ  =       
003190                                 :ＷＳ−前受金受払残高表対象フラグ
003200              AND  M40MAB_TBL.請求先取引先コード =                
003210                                    D01TRS_TBL.取引先コード ( + ) 
003220              AND  M40MAB_TBL.請求先取引先コード =                
003230                                    D02SQS_TBL.取引先コード ( + ) 
003240              AND  M40MAB_TBL.請求先コード       =                
003250                                    D02SQS_TBL.請求先コード ( + ) 
003260         ORDER BY  M40MAB_TBL.レコード区分                        
003270                  ,M40MAB_TBL.契約番号                            
003280     END-EXEC.                                                    
003290*                                                                 
003300*----------------------------------------------------------------*
003310*    カーソルＯＰＥＮ処理                                        *
003320*----------------------------------------------------------------*
003330     EXEC  SQL                                                    
003340        OPEN  CUR1                                                
003350     END-EXEC.                                                    
003360*                                                                 
003370*----------------------------------------------------------------*
003380*    カーソルＯＰＥＮ確認                                        *
003390*----------------------------------------------------------------*
003400     EVALUATE  SQLCODE                                            
003410        WHEN  定数−ＳＱＬＯＫ                                    
003420*--<       正常 >                                                 
003430           CONTINUE                                               
003440        WHEN  OTHER                                               
003450*--<       カーソルＯＰＥＮエラー >                               
003460           MOVE     -3                TO  Ｗ−エラーコード        
003470           PERFORM  エラー処理                                    
003480     END-EVALUATE.                                                
003490*                                                                 
003500 結合テーブルカーソル定義−ＥＸＩＴ.                              
003510     EXIT.                                                        
003520******************************************************************
003530*    ファイルオープン                                            *
003540******************************************************************
003550 ファイルオープン                     SECTION.                    
003560 ファイルオープン−ＳＴＡＲＴ.                                    
003570*                                                                 
003580*----------------------------------------------------------------*
003590*    前受金受払残高中間ファイルのオープン                        *
003600*----------------------------------------------------------------*
003610     OPEN  OUTPUT   出力ファイル.                                 
003620*                                                                 
003630*--< ファイルオープンの状態判定 >                                 
003640     EVALUATE  Ｗ−状態                                           
003650        WHEN  ZERO                                                
003660           CONTINUE                                               
003670        WHEN  OTHER                                               
003680*--<       ファイルオープンエラー >                               
003690           MOVE     -4                TO  Ｗ−エラーコード        
003700           PERFORM  エラー処理                                    
003710     END-EVALUATE.                                                
003720*                                                                 
003730 ファイルオープン−ＥＸＩＴ.                                      
003740     EXIT.                                                        
003750******************************************************************
003760*    結合テーブルカーソル読込                                    *
003770******************************************************************
003780 結合テーブルカーソル読込             SECTION.                    
003790 結合テーブルカーソル読込−ＳＴＡＲＴ.                            
003800*                                                                 
003810*--< 結合テーブルカーソル読込 >                                   
003820     EXEC SQL                                                     
003830         FETCH   CUR1                                             
003840          INTO   :Ｍ４０−レコード区分                            
003850                ,:Ｍ４０−経理用主契約区分                        
003860                ,:Ｍ４０−顧客区分                                
003870                ,:Ｄ０１−名寄せコード                            
003880                ,:Ｍ４０−請求先取引先コード                      
003890                ,:Ｍ４０−請求先コード                            
003900                ,:Ｍ４０−契約番号                                
003910                ,:Ｍ４０−契約種類                                
003920                ,:Ｍ４０−担当部課コード                          
003930                ,:Ｍ４０−再リース回数                            
003940                ,:Ｍ４０−充当開始年月                            
003950                ,:Ｍ４０−充当月数                                
003960                ,:Ｍ４０−前払回収方法                            
003970                ,:Ｍ４０−入金日                                  
003980                ,:Ｍ４０−入金区分                                
003990                ,:Ｄ０１−取引先名称                              
004000                ,:Ｄ０２−請求先名称                              
004010                ,:Ｍ４０−前月末残高                              
004020                ,:Ｍ４０−当月回収額                              
004030                ,:Ｍ４０−当月消化額                              
004040                ,:Ｍ４０−当月末残高                              
004050                ,:Ｍ４０−協調区分                                
004060                ,:Ｍ４０−前月末残高他社                          
004070                ,:Ｍ４０−当月回収額他社                          
004080                ,:Ｍ４０−当月消化額他社                          
004090                ,:Ｍ４０−当月他社解約分料金                      
004100                ,:Ｍ４０−当月他社解約分消費税                    
004110                ,:Ｍ４０−当月末残高他社                          
004120     END-EXEC.                                                    
004130*                                                                 
004140*----------------------------------------------------------------*
004150*    結合テーブルカーソル読込を確認                              *
004160*----------------------------------------------------------------*
004170     EVALUATE   SQLCODE                                           
004180        WHEN   定数−ＳＱＬＯＫ                                   
004190*--<       正常 >                                                 
004200           COMPUTE  Ｗ−入力−件数  =  Ｗ−入力−件数  +  1       
004210        WHEN   定数−ＳＱＬＥＮＤ                                 
004220*--<       読込終了 >                                             
004230           MOVE  "Y"                  TO  Ｗ−終了−フラグ        
004240        WHEN   OTHER                                              
004250*--<       読込エラー >                                           
004260           MOVE     -5                TO  Ｗ−エラーコード        
004270           PERFORM  エラー処理                                    
004280     END-EVALUATE.                                                
004290*                                                                 
004300 結合テーブルカーソル読込−ＥＸＩＴ.                              
004310     EXIT.                                                        
004320******************************************************************
004330*    主処理                                                      *
004340******************************************************************
004350 主処理                               SECTION.                    
004360 主処理−ＳＴＡＲＴ.                                              
004370*----------------------------------------------------------------*
004380*    項目名称マスタより項目の抽出処理                            *
004390*----------------------------------------------------------------*
004400     PERFORM  項目名称マスタ抽出処理.                             
004410*----------------------------------------------------------------*
004420*    債権情報（一般）ＤＢより項目の抽出処理                      *
004430*----------------------------------------------------------------*
004440     PERFORM  債権情報ＤＢ抽出処理.                               
004450*----------------------------------------------------------------*
004460*    前受金受払残高中間ファイル出力判定処理                      *
004470*----------------------------------------------------------------*
004480     IF  Ｍ０１−担保区分  NOT = "1"                              
004490*--<    前受金受払残高中間ファイル項目編集、出力処理>             
004500        PERFORM  前受金受払残高中間ファイル編集出力               
004510     END-IF.                                                      
004520*----------------------------------------------------------------*
004530*    結合テーブルカーソル読込（２件目以降）                      *
004540*----------------------------------------------------------------*
004550     PERFORM  結合テーブルカーソル読込.                           
004560*                                                                 
004570 主処理−ＥＸＩＴ.                                                
004580     EXIT.                                                        
004590******************************************************************
004600*    項目名称マスタより項目の抽出処理                            *
004610******************************************************************
004620 項目名称マスタ抽出処理               SECTION.                    
004630 項目名称マスタ抽出処理−ＳＴＡＲＴ.                              
004640*                                                                 
004650*項目名称マスタより主契約区分名称の抽出処理                       
004660*----------------------------------------------------------------*
004670*    項目名称マスタ読込                                          *
004680*----------------------------------------------------------------*
004690     EXEC SQL                                                     
004700        SELECT  名称                                              
004710          INTO :ＷＳ−名称１                                      
004720          FROM  D19MSY_TBL                                        
004730         WHERE  コードＮＯ = :ＷＳ−コードＮＯ１                  
004740           AND  SUBSTR(コード,1,1) = :Ｍ４０−経理用主契約区分    
004750     END-EXEC.                                                    
004760*----------------------------------------------------------------*
004770*    項目名称マスタ検索を確認                                    *
004780*----------------------------------------------------------------*
004790     EVALUATE   SQLCODE                                           
004800        WHEN   定数−ＳＱＬＯＫ                                   
004810*--<       正常の時 >                                             
004820           CONTINUE                                               
004830        WHEN   OTHER                                              
004840*--<       存在しない >                                           
004850           MOVE     SPACE             TO  ＷＳ−名称１            
004860           MOVE     -6                TO  Ｗ−エラーコード        
004870           PERFORM  エラー処理                                    
004880     END-EVALUATE.                                                
004890*                                                                 
004900*項目名称マスタより顧客区分名称の抽出処理                         
004910*----------------------------------------------------------------*
004920*    項目名称マスタ読込                                          *
004930*----------------------------------------------------------------*
004940     EXEC SQL                                                     
004950        SELECT  名称                                              
004960          INTO :ＷＳ−名称２                                      
004970          FROM  D19MSY_TBL                                        
004980         WHERE  コードＮＯ = :ＷＳ−コードＮＯ２                  
004990           AND  SUBSTR(コード,1,2) = :Ｍ４０−顧客区分            
005000     END-EXEC.                                                    
005010*----------------------------------------------------------------*
005020*    項目名称マスタ検索を確認                                    *
005030*----------------------------------------------------------------*
005040     EVALUATE   SQLCODE                                           
005050        WHEN   定数−ＳＱＬＯＫ                                   
005060*--<       正常の時 >                                             
005070           CONTINUE                                               
005080        WHEN   OTHER                                              
005090*--<       存在しない >                                           
005100           MOVE     SPACE             TO  ＷＳ−名称２            
005110           MOVE     -6                TO  Ｗ−エラーコード        
005120           PERFORM  エラー処理                                    
005130     END-EVALUATE.                                                
005140*                                                                 
005150 項目名称マスタ抽出処理−ＥＸＩＴ.                                
005160     EXIT.                                                        
005170******************************************************************
005180*    債権情報（一般）ＤＢより項目の抽出処理                      *
005190******************************************************************
005200 債権情報ＤＢ抽出処理                 SECTION.                    
005210 債権情報ＤＢ抽出処理−ＳＴＡＲＴ.                                
005220*                                                                 
005230*----------------------------------------------------------------*
005240*    債権情報ＤＢ読込                                            *
005250*----------------------------------------------------------------*
005260     EXEC SQL                                                     
005270        SELECT  状態フラグ                                        
005280               ,債権契約件名                                      
005290               ,担保区分                                          
005300          INTO :Ｍ０１−状態フラグ                                
005310              ,:Ｍ０１−債権契約件名                              
005320              ,:Ｍ０１−担保区分                                  
005330          FROM  M01SAJ_TBL                                        
005340         WHERE  レコード区分 = :ＷＳ−レコード区分                
005350           AND  契約番号     = :Ｍ４０−契約番号                  
005360           AND  再リース回数 = :Ｍ４０−再リース回数              
005370           AND  契約種類     = :Ｍ４０−契約種類                  
005380     END-EXEC.                                                    
005390*----------------------------------------------------------------*
005400*    債権情報ＤＢ検索を確認                                      *
005410*----------------------------------------------------------------*
005420     EVALUATE   SQLCODE                                           
005430        WHEN   定数−ＳＱＬＯＫ                                   
005440*--<       正常の時 >                                             
005450           CONTINUE                                               
005460        WHEN   OTHER                                              
005470*--<       存在しない >                                           
005480           MOVE     ZERO              TO  Ｍ０１−状態フラグ      
005490           MOVE     SPACE             TO  Ｍ０１−債権契約件名    
005500           MOVE     ZERO              TO  Ｍ０１−担保区分        
005510           MOVE     -7                TO  Ｗ−エラーコード        
005520           PERFORM  エラー処理                                    
005530     END-EVALUATE.                                                
005540*                                                                 
005550 債権情報ＤＢ抽出処理−ＥＸＩＴ.                                  
005560     EXIT.                                                        
005570******************************************************************
005580*    前受金受払残高中間ファイル項目編集、出力処理                *
005590******************************************************************
005600 前受金受払残高中間ファイル編集出力   SECTION.                    
005610 前受金受払残高中間ファイル編集出力−ＳＴＡＲＴ.                  
005620*                                                                 
005630*--< 出力レコードの初期化処理 >                                   
005640     MOVE  SPACE                      TO  出力−レコード.         
005650     INITIALIZE                           出力−レコード.         
005660*--< 自社分個別の編集 >                                           
005670     PERFORM  自社分編集.                                         
005680*--< 自社分出力判定 >                                             
005690     IF      出力−前月末残高  NOT  =  0                          
005700         OR  出力−当月入金額  NOT  =  0                          
005710         OR  出力−当月消化額  NOT  =  0                          
005720         OR  出力−当月末残高  NOT  =  0                          
005730         PERFORM  前受金受払残高中間ファイル出力処理              
005740     END-IF.                                                      
005750*--< 他社分個別の編集 >                                           
005760     IF  Ｍ４０−協調区分 = "2"                                   
005770        PERFORM  他社分編集出力                                   
005780     END-IF.                                                      
005790*                                                                 
005800 前受金受払残高中間ファイル編集出力−ＥＸＩＴ.                    
005810     EXIT.                                                        
005820******************************************************************
005830*    自社分編集                                                  *
005840******************************************************************
005850 自社分編集                             SECTION.                  
005860 自社分編集−ＳＴＡＲＴ.                                          
005870*                                                                 
005880*--< No.1 >                                                       
005890     IF  Ｍ０１−状態フラグ < "3"                                 
005900        MOVE  "3"                     TO  出力−自他社区分        
005910     ELSE                                                         
005920        MOVE  "1"                     TO  出力−自他社区分        
005930     END-IF.                                                      
005940*--< No.2 >                                                       
005950     MOVE  Ｍ４０−レコード区分       TO  出力−前受区分.         
005960*--< No.3 >                                                       
005970     MOVE  Ｍ４０−経理用主契約区分   TO  出力−主契約区分.       
005980*--< No.4 >                                                       
005990     MOVE  Ｍ４０−顧客区分           TO  出力−連結区分.         
006000*--< No.5 >                                                       
006010     MOVE  Ｄ０１−名寄せコード       TO  出力−名寄せコード.     
006020*--< No.6 >                                                       
006030     MOVE  Ｍ４０−請求先取引先コード TO  出力−取引先コード.     
006040*--< No.7 >                                                       
006050     MOVE  Ｍ４０−請求先コード       TO  出力−請求先コード.     
006060*--< No.8 >                                                       
006070     MOVE  Ｍ４０−契約番号           TO  出力−契約番号.         
006080*--< No.9 >                                                       
006090     MOVE  Ｍ４０−契約種類           TO  出力−契約種類.         
006100*--< No.10 >                                                      
006110     MOVE  Ｄ７０−バッチ用業務年月   TO  出力−業務年月.         
006120*--< No.11 >                                                      
006130     MOVE  Ｍ４０−担当部課コード     TO  出力−担当部課コード.   
006140*--< No.12 >                                                      
006150     MOVE  Ｍ０１−債権契約件名       TO  出力−契約件名.         
006160*--< No.13 >                                                      
006170     MOVE  Ｍ４０−再リース回数       TO  出力−再リース回数.     
006180*--< No.14 >                                                      
006190     MOVE  Ｍ４０−充当開始年月       TO  出力−充当開始年月.     
006200*--< No.15 >                                                      
006210     MOVE  Ｍ４０−充当月数           TO  出力−充当月数.         
006220*--< No.16 >                                                      
006230     MOVE  Ｍ４０−前払回収方法       TO  出力−前払回収方法.     
006240*--< No.17 >                                                      
006250     MOVE  Ｍ４０−入金日             TO  出力−入金日.           
006260*--< No.18 >                                                      
006270     MOVE  Ｍ４０−入金区分           TO  出力−入金区分.         
006280*--< No.19 >                                                      
006290     MOVE  Ｄ０１−取引先名称         TO  出力−取引先名称.       
006300*--< No.20 >                                                      
006310     MOVE  Ｄ０２−請求先名称         TO  出力−請求先名称.       
006320*--< No.21 >                                                      
006330     MOVE  ＷＳ−名称１               TO  出力−主契約区分名称.   
006340*--< No.22 >                                                      
006350     MOVE  ＷＳ−名称２               TO  出力−連結区分名称.     
006360*--< No.23 >                                                      
006370     MOVE  Ｍ４０−前月末残高         TO  出力−前月末残高.       
006380*--< No.24 >                                                      
006390     MOVE  Ｍ４０−当月回収額         TO  出力−当月入金額.       
006400*--< No.25 >                                                      
006410     MOVE  Ｍ４０−当月消化額         TO  出力−当月消化額.       
006420*--< No.26 >                                                      
006430     MOVE  Ｍ４０−当月末残高         TO  出力−当月末残高.       
006440*                                                                 
006450 自社分編集−ＥＸＩＴ.                                            
006460     EXIT.                                                        
006470******************************************************************
006480*    他社分個別部分の編集出力                                    *
006490******************************************************************
006500 他社分編集出力                       SECTION.                    
006510 他社分編集出力−ＳＴＡＲＴ.                                      
006520*                                                                 
006530*--< 他社分編集 >                                                 
006540*--< No.1 >                                                       
006550     IF  Ｍ０１−状態フラグ < "3"                                 
006560        MOVE  "4"                     TO  出力−自他社区分        
006570     ELSE                                                         
006580        MOVE  "2"                     TO  出力−自他社区分        
006590     END-IF.                                                      
006600*--< No.23 >                                                      
006610     MOVE  Ｍ４０−前月末残高他社     TO  出力−前月末残高.       
006620*--< No.24 >                                                      
006630     MOVE  Ｍ４０−当月回収額他社     TO  出力−当月入金額.       
006640*--< No.25 >                                                      
006650     COMPUTE  出力−当月消化額  =  Ｍ４０−当月消化額他社         
006660                                +  Ｍ４０−当月他社解約分料金     
006670                                +  Ｍ４０−当月他社解約分消費税.  
006680*--< No.26 >                                                      
006690     COMPUTE  出力−当月末残高  =  Ｍ４０−当月末残高他社         
006700                                -  Ｍ４０−当月他社解約分料金     
006710                                -  Ｍ４０−当月他社解約分消費税.  
006720*--< 他社分出力判定 >                                             
006730     IF      出力−前月末残高  NOT  =  0                          
006740         OR  出力−当月入金額  NOT  =  0                          
006750         OR  出力−当月消化額  NOT  =  0                          
006760         OR  出力−当月末残高  NOT  =  0                          
006770         PERFORM  前受金受払残高中間ファイル出力処理              
006780     END-IF.                                                      
006790*                                                                 
006800 他社分編集出力−ＥＸＩＴ.                                        
006810     EXIT.                                                        
006820******************************************************************
006830*    前受金受払残高中間ファイル出力処理                          *
006840******************************************************************
006850 前受金受払残高中間ファイル出力処理   SECTION.                    
006860 前受金受払残高中間ファイル出力処理−ＳＴＡＲＴ.                  
006870*                                                                 
006880     WRITE  出力−レコード.                                       
006890*                                                                 
006900*--< 前受金受払残高中間ファイル出力の状態判定 >                   
006910     EVALUATE  Ｗ−状態                                           
006920        WHEN  ZERO                                                
006930*--<       前受金受払残高中間ファイル出力件数の加算 >             
006940           COMPUTE  Ｗ−出力−件数 =  Ｗ−出力−件数 + 1          
006950        WHEN  OTHER                                               
006960*--<       ファイル出力エラー >                                   
006970           MOVE     -8                TO  Ｗ−エラーコード        
006980           PERFORM  エラー処理                                    
006990     END-EVALUATE.                                                
007000*                                                                 
007010 前受金受払残高中間ファイル出力処理−ＥＸＩＴ.                    
007020     EXIT.                                                        
007030******************************************************************
007040*    終了処理                                                    *
007050******************************************************************
007060 終了処理                             SECTION.                    
007070 終了処理−ＳＴＡＲＴ.                                            
007080*                                                                 
007090*----------------------------------------------------------------*
007100*    ＤＢクローズ                                                *
007110*----------------------------------------------------------------*
007120     EXEC SQL                                                     
007130        CLOSE  CUR1                                               
007140     END-EXEC.                                                    
007150*----------------------------------------------------------------*
007160*    ファイルクローズ                                            *
007170*----------------------------------------------------------------*
007180     CLOSE  出力ファイル.                                         
007190*----------------------------------------------------------------*
007200*    件数メッセージ出力                                          *
007210*----------------------------------------------------------------*
007220     PERFORM  件数メッセージ出力処理.                             
007230*----------------------------------------------------------------*
007240*    終了メッセージ出力                                          *
007250*----------------------------------------------------------------*
007260     PERFORM  終了メッセージ出力.                                 
007270*--< プログラム正常終了 >                                         
007280     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
007290*                                                                 
007300 終了処理−ＥＸＩＴ.                                              
007310     EXIT.                                                        
007320******************************************************************
007330*    終了メッセージ出力処理                                      *
007340******************************************************************
007350 終了メッセージ出力                   SECTION.                    
007360 終了メッセージ出力−ＳＴＡＲＴ.                                  
007370*                                                                 
007380     INITIALIZE                       IF-CHOCO001.                
007390     MOVE  "3"                        TO  共１−イベント種別.     
007400     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007410     MOVE  "0"                        TO  共１−復帰コード.       
007420     MOVE  "END"                      TO  共１−処理識別.         
007430     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
007440     CALL  CLOCO001                USING  IF-CHOCO001.            
007450*                                                                 
007460 終了メッセージ出力−ＥＸＩＴ.                                    
007470     EXIT.                                                        
007480******************************************************************
007490*    件数メッセージ出力処理                                      *
007500******************************************************************
007510 件数メッセージ出力処理               SECTION.                    
007520 件数メッセージ出力処理−ＳＴＡＲＴ.                              
007530*                                                                 
007540     INITIALIZE                       IF-CHOCO001.                
007550     MOVE  "3"                        TO  共１−イベント種別.     
007560     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007570     MOVE  "0"                        TO  共１−復帰コード.       
007580     MOVE  "M40MAB"                   TO  共１−処理テーブルＩＤ. 
007590     MOVE  "COUNT"                    TO  共１−処理識別.         
007600     MOVE  Ｗ−入力−件数             TO  共１−データ内容.       
007610     MOVE  "前受情報ＤＢ入力件数"     TO  共１−その他メッセージ. 
007620     CALL  CLOCO001                USING  IF-CHOCO001.            
007630*                                                                 
007640     INITIALIZE                       IF-CHOCO001.                
007650     MOVE  "3"                        TO  共１−イベント種別.     
007660     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007670     MOVE  "0"                        TO  共１−復帰コード.       
007680     MOVE  "SFHSED25"                 TO  共１−処理テーブルＩＤ. 
007690     MOVE  "COUNT"                    TO  共１−処理識別.         
007700     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
007710     MOVE  "前受金受払残高中間ファイル出力件数"                   
007720                                      TO  共１−その他メッセージ. 
007730     CALL  CLOCO001                USING  IF-CHOCO001.            
007740*                                                                 
007750 件数メッセージ出力処理−ＥＸＩＴ.                                
007760     EXIT.                                                        
007770******************************************************************
007780*    エラー処理                                                  *
007790******************************************************************
007800 エラー処理                           SECTION.                    
007810 エラー処理−ＳＴＡＲＴ.                                          
007820*                                                                 
007830     MOVE     "Y"                     TO  Ｗ−異常終了−フラグ    
007840     INITIALIZE                           IF-CHOCO001.            
007850*                                                                 
007860     EVALUATE  Ｗ−エラーコード                                   
007870        WHEN  -1                                                  
007880*--<       ＯＲＡＣＬＥ接続失敗 >                                 
007890           MOVE  "1"                  TO  共１−イベント種別      
007900           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
007910           MOVE  "9"                  TO  共１−復帰コード        
007920           MOVE  "CONNECT"            TO  共１−処理識別          
007930           MOVE  SQLCODE              TO  共１−データ内容        
007940           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007950           CALL  CLOCO001          USING  IF-CHOCO001             
007960*                                                                 
007970        WHEN  -2                                                  
007980*--<       業務管理テーブル検索エラー >                           
007990           MOVE  "1"                  TO  共１−イベント種別      
008000           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008010           MOVE  "9"                  TO  共１−復帰コード        
008020           MOVE  "D70GYM"             TO  共１−処理テーブルＩＤ  
008030           MOVE  "SELECT"             TO  共１−処理識別          
008040           MOVE  SQLCODE              TO  共１−データ内容        
008050           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008060           CALL  CLOCO001          USING  IF-CHOCO001             
008070*                                                                 
008080        WHEN  -3                                                  
008090*--<       結合テーブルカーソルオープン失敗 >                     
008100           MOVE  "1"                  TO  共１−イベント種別      
008110           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008120           MOVE  "9"                  TO  共１−復帰コード        
008130           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
008140           MOVE  "OPEN"               TO  共１−処理識別          
008150           MOVE  SQLCODE              TO  共１−データ内容        
008160           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008170           CALL  CLOCO001          USING  IF-CHOCO001             
008180*                                                                 
008190        WHEN  -4                                                  
008200*--<       前受金受払残高中間ファイルオープンエラー >             
008210           MOVE  "1"                  TO  共１−イベント種別      
008220           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008230           MOVE  "9"                  TO  共１−復帰コード        
008240           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
008250           MOVE  "OPEN"               TO  共１−処理識別          
008260           MOVE  Ｗ−状態             TO  共１−データ内容        
008270           MOVE  "前受金受払残高中間ファイルオープンエラー"       
008280                                      TO  共１−その他メッセージ  
008290           CALL  CLOCO001          USING  IF-CHOCO001             
008300*                                                                 
008310        WHEN  -5                                                  
008320*--<       結合テーブル読込失敗 >                                 
008330           MOVE  "1"                  TO  共１−イベント種別      
008340           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008350           MOVE  "9"                  TO  共１−復帰コード        
008360           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
008370           MOVE  "FETCH"              TO  共１−処理識別          
008380           MOVE  SQLCODE              TO  共１−データ内容        
008390           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008400           CALL  CLOCO001          USING  IF-CHOCO001             
008410*                                                                 
008420        WHEN  -6                                                  
008430*--<       項目名称マスタオープンエラー >                         
008440           MOVE  "2"                  TO  共１−イベント種別      
008450           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008460           MOVE  "9"                  TO  共１−復帰コード        
008470           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
008480           MOVE  "SELECT"             TO  共１−処理識別          
008490           MOVE  SQLCODE              TO  共１−データ内容        
008500           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008510           CALL  CLOCO001          USING  IF-CHOCO001             
008520           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
008530*                                                                 
008540        WHEN  -7                                                  
008550*--<       債権情報（一般）ＤＢオープンエラー >                   
008560           MOVE  "2"                  TO  共１−イベント種別      
008570           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008580           MOVE  "9"                  TO  共１−復帰コード        
008590           MOVE  "M01SAJ"             TO  共１−処理テーブルＩＤ  
008600           MOVE  "SELECT"             TO  共１−処理識別          
008610           MOVE  SQLCODE              TO  共１−データ内容        
008620           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008630           CALL  CLOCO001          USING  IF-CHOCO001             
008640           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
008650*                                                                 
008660        WHEN  -8                                                  
008670*--<       前受金受払残高中間ファイル出力エラー >                 
008680           MOVE  "1"                  TO  共１−イベント種別      
008690           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008700           MOVE  "9"                  TO  共１−復帰コード        
008710           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
008720           MOVE  "WRITE"              TO  共１−処理識別          
008730           MOVE  Ｗ−状態             TO  共１−データ内容        
008740           MOVE  "前受金受払残高中間ファイル出力エラー "          
008750                                      TO  共１−その他メッセージ  
008760           CALL  CLOCO001          USING  IF-CHOCO001             
008770*                                                                 
008780        WHEN  OTHER                                               
008790           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
008800*                                                                 
008810     END-EVALUATE.                                                
008820*                                                                 
008830     IF Ｗ−異常終了−フラグ  =  "Y"                              
008840*--<    件数メッセージ出力処理 >                                  
008850        PERFORM  件数メッセージ出力処理                           
008860*--<    終了メッセージ出力 >                                      
008870        PERFORM  終了メッセージ出力                               
008880*--<    プログラム異常終了のリターンコード >                      
008890        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
008900*                                                                 
008910        EXIT  PROGRAM                                             
008920     END-IF.                                                      
008930*                                                                 
008940 エラー処理−ＥＸＩＴ.                                            
008950     EXIT.                                                        
008960******************************************************************
008970*                  END OF PROGRAM                                *
008980******************************************************************
