000010******************************************************************
000020*         ＜海輝軟件(大連)＞                                     *
000030*      1. プログラム名  : 前受金受払残高ファイル作成		
000040*                                        　                     *
000050*      2. プログラムID  : AAASED25                               *
000060*      3. 処理概要      : 前受情報ＤＢをメインに、マスタと表    　 *
000070*                          結合して読込 前受金受払残高中間      　 *
000080*                         ファイルを 作成する*                   *
000090*      4. 作成者        : 高守軍                              　  *
000100*      5. 作成日        : 2005.03.28                         　  *
000110******************************************************************
000120*                                                                 
000130******************************************************************
000140*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000150******************************************************************
000160 IDENTIFICATION                       DIVISION.                   
000170*                                                                 
000180 PROGRAM-ID.                          AAASED25.                   
000190******************************************************************
000200*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000210******************************************************************
000220 ENVIRONMENT                          DIVISION.                   
000230******************************************************************
000240*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000250******************************************************************
000260 INPUT-OUTPUT                         SECTION.                    
000270*                                                                 
000280 FILE-CONTROL.                                                    
000290     SELECT    出力ファイル            ASSIGN    TO     U11       
000300     FILE      STATUS     IS          Ｗ−状態                    
000310     ORGANIZATION         IS          LINE      SEQUENTIAL. 
000320******************************************************************
000330*    ＤＡＴＡ                 ＤＩＶＩＳＩＯＮ                    *
000340******************************************************************
000350 DATA                                 DIVISION.                   
000360******************************************************************
000370*    ＦＩＬＥ                 ＳＥＣＴＩＯＮ                      *
000380******************************************************************
000390 FILE                                 SECTION.                    
000400* ---------------------------------------------------------------*
000410*    出力ファイル                       
000420* ---------------------------------------------------------------*
000430 FD  出力ファイル                                                 
000440     LABEL     RECORD     IS          STANDARD                    
000450     BLOCK     CONTAINS   0           RECORDS.                                                                                  
000460 01  出力−レコード.                                              
000470     COPY  CPSCE50  REPLACING  ==()==  BY  ==出力−==.            
000480*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000490******************************************************************
000500  WORKING-STORAGE                     SECTION.                    
000510* ---------------------------------------------------------------*
000520*    ホスト変数定義エリア                                        *
000530* ---------------------------------------------------------------*
000540     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000550* --< 項目名称マスタの名称 >                                       
000560 01 項目名称マスタの名称.                                         
000570    03 ＷＳ−名称１               PIC  X(60).                     
000580    03 ＷＳ−名称２               PIC  X(60). 
000590* --< 業務管理テーブルの業務管理ＩＤ >   
000600 01 ＷＳ−業務管理ＩＤ                 PIC X(08)  VALUE 'GYMKNRRC'. 
000610 
000620* --< 項目名称マスタのコードＮＯ１ >           
000630 01 ＷＳ−コードＮＯ１                 PIC X(08)  VALUE '038'. 
000640
000650* --< 項目名称マスタのコードＮＯ２ >                
000660 01 ＷＳ−コードＮＯ２                 PIC X(08)  VALUE '005'.
000670
000680* --< 債権情報のレコード区分 >                 
000690 01 ＷＳ−レコード区分                 PIC X(1)   VALUE '1'.   
000700        
000710* --< ＯＲＡＣＬＥ共通変数 >                                       
000720     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000730                             
000740* --< ＯＲＡＣＬＥ  ＳＱＬ実行情報 >                               
000750     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000760                                                                 
000770* --< 前受情報ＤＢ >                                               
000780     EXEC  SQL  INCLUDE  M40MAB.CBL            END-EXEC.          
000790                                                                 
000800* --< 業務管理テーブル >                                           
000810     EXEC  SQL  INCLUDE  D70GYM.CBL            END-EXEC.          
000820                                                                 
000830* --< 取引先マスタ>                                                
000840     EXEC  SQL  INCLUDE  D01TRS.CBL            END-EXEC.          
000850                                                                
000860* --< 請求先マスタ >                                               
000870     EXEC  SQL  INCLUDE  D02SQS.CBL            END-EXEC.  
000880  
000890* --< 項目名称マスタ >                                             
000900     EXEC  SQL  INCLUDE  D19MSY.CBL            END-EXEC.  
000910  
000920* --< 債権情報（一般）ＤＢ >                                       
000930     EXEC  SQL  INCLUDE  M01SAJ.CBL            END-EXEC.          
000940*                                                                 
000950     EXEC  SQL  END  DECLARE          SECTION  END-EXEC.          
000960                                                                 
000970* ---------------------------------------------------------------*
000980*    ＷＯＲＫエリア                                              *
000990* ---------------------------------------------------------------*
001000 01  ＷＯＲＫ−エリア.                                            
001010* --< エラー判定用 >                                               
001020     03  Ｗ−エラーコード             PIC S9(04).                 
001030                                                                 
001040* --< フラグアリア >                                               
001050     03  フラグアリア.                                            
001060         05  Ｗ−終了−フラグ         PIC  X(01).                 
001070         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
001080* --< ファイル状態 >                                               
001090     03  Ｗ−状態エリア.                                          
001100         05  Ｗ−状態                 PIC  X(02).
001110                                                                 
001120* --< 件数エリア >                                                 
001130     03  件数エリア.                                              
001140         05  Ｗ−入力−件数           PIC  9(09).                 
001150         05  Ｗ−出力−件数           PIC  9(09).                 
001160* --< 共通情報 >                                                   
001170 01  Ｗ−共通情報.                                                
001180     03  Ｗ−システム日付.                                        
001190         05  Ｗ−世紀                 PIC  X(02) VALUE  "20".     
001200         05  Ｗ−年月日               PIC  X(06).                 
001210     03  Ｗ−システム時刻             PIC  X(08).                 
001220     03  Ｗ−担当者                   PIC  X(08) VALUE "IKOPG   ".
001230                                                                 
001240* ---------------------------------------------------------------*
001250*    サブルーチン名                                              *
001260* ---------------------------------------------------------------*
001270 01  CALL-AREA.                                                   
001280* --< 共通ログサブルーチン >                                       
001290     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
001300     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
001310                                                           
001320* ---------------------------------------------------------------*
001330*    ＣＯＰＹ領域                                                *
001340* ---------------------------------------------------------------*
001350* --< 共通ログ用パラメータ >                                       
001360 01  IF-CHOCO001.                                                 
001370     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
001380                                                                 
001390* ---------------------------------------------------------------*
001400*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001410* ---------------------------------------------------------------*
001420 01  PARA-AREA.                                                   
001430     COPY CPBCO001.                                               
001440******************************************************************
001450*    定数用データ定義エリア                                      *
001460******************************************************************
001470 CONSTANT                             SECTION.                    
001480 01  定数領域.                                                    
001490     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
001500     03  定数−プログラム名           PIC  X(80)                  
001510                               VALUE "前受金受払残高ファイル作成".
001520     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001530     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001540     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001550     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001560******************************************************************
001570*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001580******************************************************************
001590 PROCEDURE                            DIVISION.                   
001600                                                                 
001610     PERFORM  初期処理.                                           
001620                                                                 
001630     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001640                                                                
001650     PERFORM  終了処理.                                           
001660                                                                
001670     STOP     RUN.                                                
001680                                                                
001690******************************************************************
001700*    初期処理                                                    *
001710******************************************************************
001720 初期処理                             SECTION.                    
001730 初期処理−ＳＴＡＲＴ.                                            
001740                                                                 
001750* ---------------------------------------------------------------*
001760*    開始メッセージ出力処理                                      *
001770* ---------------------------------------------------------------*
001780     INITIALIZE                       IF-CHOCO001.                
001790     MOVE  "3"                        TO  共１−イベント種別.     
001800     MOVE  定数−プログラムＩＤ        TO  共１−ソースＩＤ.       
001810     MOVE  "0"                        TO  共１−復帰コード.       
001820     MOVE  "START"                    TO  共１−処理識別.         
001830     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001840     CALL  CLOCO001                USING  IF-CHOCO001.            
001850                                                                 
001860* ---------------------------------------------------------------*
001870*    作業領域の初期値処理                                        *
001880* ---------------------------------------------------------------*
001890     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001900     INITIALIZE                           ＷＯＲＫ−エリア.  
001910                                                                 
001920* --< ＣＰＵ日付を取得 >                                           
001930     ACCEPT  Ｗ−年月日                  FROM  DATE.                                                                                 
001940* --< ＣＰＵ時刻を取得 >                                           
001950     ACCEPT  Ｗ−システム時刻            FROM  TIME.                      
001960* --< ＯＲＡＣＬＥ接続 >                                           
001970     PERFORM   ＯＲＡＣＬＥ接続.                                                                                                   
001980* --< 業務管理テーブル読込  >                                      
001990     PERFORM  業務管理テーブル読込.                               
002000* --< 結合テーブルカーソル宣言 >                                   
002010     PERFORM  結合テーブルカーソル定義.                                                                                           
002020* --< ファイルオープン >                                           
002030     PERFORM  ファイルオープン.                                                                                                   
002040* --< 結合テーブルカーソル読込(１件目) >                           
002050     PERFORM  結合テーブルカーソル読込.                                                                                           
002060 初期処理−ＥＸＩＴ.                                              
002070     EXIT.                                                        
002080******************************************************************
002090*    ＯＲＡＣＬＥ接続                                            *
002100******************************************************************
002110 ＯＲＡＣＬＥ接続                     SECTION.                    
002120 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                                                                                    
002130* --< ＤＢ接続用情報を取得処理 >                                   
002140     CALL  COBCO001                    USING  PARA-AREA.                                                                               
002150     MOVE  PARA-DBSTRING               TO  DB-STRING.              
002160     MOVE  PARA-USERNAME               TO  USERNAME.               
002170     MOVE  PARA-PASSWORD               TO  PASSWD.                                                                                  
002180* ---------------------------------------------------------------*
002190*    開始接続                                                    *
002200* ---------------------------------------------------------------*
002210     IF    DB-STRING  =  SPACE                                    
002220        EXEC SQL                                                  
002230             CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002240        END-EXEC                                                  
002250     ELSE                                                         
002260        EXEC SQL                                                  
002270             CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002280             USING  :DB-STRING                                    
002290        END-EXEC                                                  
002300     END-IF.                                                                                                                       
002310* ---------------------------------------------------------------*
002320*    接続確認                                                    *
002330* ---------------------------------------------------------------*
002340     EVALUATE  SQLCODE                                            
002350        WHEN   定数−ＳＱＬＯＫ                                   
002360             CONTINUE                                               
002370        WHEN   OTHER                                              
002380* --<   接続エラー >                                           
002390           MOVE     -10               TO  Ｗ−エラーコード        
002400           PERFORM  エラー判定処理                                
002410     END-EVALUATE.                                                                                                                 
002420 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002430     EXIT.                                                        
002440******************************************************************
002450*        業務管理テーブル読込                                    *
002460******************************************************************
002470 業務管理テーブル読込                     SECTION.                
002480 業務管理テーブル読込−ＳＴＡＲＴ.                                                                                                
002490* ---------------------------------------------------------------*
002500*    業務管理テーブル読込処理                                    *
002510* ---------------------------------------------------------------*
002520     EXEC SQL                                                     
002530           SELECT  バッチ用業務年月                               
002540             INTO  :Ｄ７０−バッチ用業務年月                       
002550             FROM  D70GYM_TBL                                     
002560            WHERE  業務管理ＩＤ = :ＷＳ−業務管理ＩＤ                      
002570     END-EXEC.                                                    
002580                                                                  
002590* ---------------------------------------------------------------*
002600*    業務管理テーブル読込処理ＯＰＥＮ確認                        *
002610* ---------------------------------------------------------------*
002620     EVALUATE  SQLCODE                                            
002630        WHEN  定数−ＳＱＬＯＫ                                    
002640* --<       正常 >                                                 
002650           CONTINUE                                               
002660        WHEN  OTHER                                               
002670* --<       カーソルＯＰＥＮエラー >                               
002680           MOVE -20                   TO  Ｗ−エラーコード        
002690           PERFORM  エラー判定処理                                
002700     END-EVALUATE.                                                
002710                                                          
002720 業務管理テーブル読込−ＥＸＩＴ.                                  
002730     EXIT.                                                        
002740******************************************************************
002750*        結合テーブルカーソル定義                                *
002760******************************************************************
002770 結合テーブルカーソル定義             SECTION.                    
002780 結合テーブルカーソル定義−ＳＴＡＲＴ.                                                                                            
002790* ---------------------------------------------------------------*
002800*    カーソル宣言                                        *
002810* ---------------------------------------------------------------*
002820     EXEC SQL                                                     
002830        DECLARE CUR1  CURSOR FOR                                  
002840           SELECT  M40MAB_TBL.レコード区分                        
002850                  ,M40MAB_TBL.経理用主契約区分                    
002860			,M40MAB_TBL.顧客区分                            
002870			,NVL(D01TRS_TBL.名寄せコード,' ')                       
002880			,M40MAB_TBL.請求先取引先コード                  
002890			,M40MAB_TBL.請求先コード                        
002900			,M40MAB_TBL.契約番号                            
002910			,M40MAB_TBL.契約種類                            
002920			,M40MAB_TBL.担当部課コード                      
002930			,M40MAB_TBL.再リース回数                        
002940			,M40MAB_TBL.充当開始年月                        
002950			,M40MAB_TBL.充当月数                            
002960			,M40MAB_TBL.前払回収方法                        
002970			,M40MAB_TBL.入金日                              
002980			,M40MAB_TBL.入金区分                            
002990			,NVL(D01TRS_TBL.取引先名称,RPAD(' ',80,' '))                          
003000			,NVL(D02SQS_TBL.請求先名称,RPAD(' ',80,' '))                          
003010			,M40MAB_TBL.前月末残高                          
003020			,M40MAB_TBL.当月回収額                          
003030			,M40MAB_TBL.当月消化額                          
003040			,M40MAB_TBL.当月末残高
003050                  ,M40MAB_TBL.協調区分 
003060                  ,M40MAB_TBL.前月末残高他社                      
003070                  ,M40MAB_TBL.当月回収額他社                         
003080                  ,M40MAB_TBL.当月消化額他社                      
003090                  ,M40MAB_TBL.当月他社解約分料金                  
003100                  ,M40MAB_TBL.当月他社解約分消費税                
003110                  ,M40MAB_TBL.当月末残高他社                      
003120                                              
003130             FROM  M40MAB_TBL                                     
003140                  ,D01TRS_TBL                                     
003150                  ,D02SQS_TBL                                     
003160            WHERE  M40MAB_TBL.前受金受払残高表対象フラグ  =  '1'  
003170              AND  M40MAB_TBL.請求先取引先コード  =               
003180                                    D01TRS_TBL.取引先コード (+)         
003190              AND  M40MAB_TBL.請求先取引先コード  =               
003200                                    D02SQS_TBL.取引先コード (+)         
003210              AND  M40MAB_TBL.請求先コード        =               
003220                                    D02SQS_TBL.請求先コード  (+)        
003230         ORDER BY  M40MAB_TBL.レコード区分                        
003240                  ,M40MAB_TBL.契約番号                            
003250                                                                  
003260     END-EXEC.                                                    
003270* ---------------------------------------------------------------*
003280*    結合テーブルカーソルオープン                                       *
003290* ---------------------------------------------------------------*
003300     EXEC  SQL                                                    
003310        OPEN  CUR1                                                
003320     END-EXEC.                                                                                                                    
003330* ---------------------------------------------------------------*
003340*    結合テーブルカーソルオープンを確認                                       *
003350* ---------------------------------------------------------------*
003360     EVALUATE  SQLCODE                                            
003370        WHEN  定数−ＳＱＬＯＫ                                    
003380* --<       正常 >                                                 
003390           CONTINUE                                               
003400        WHEN  OTHER                                               
003410* --<       カーソルＯＰＥＮエラー >                               
003420           MOVE -30                    TO  Ｗ−エラーコード        
003430           PERFORM  エラー判定処理                                
003440     END-EVALUATE.                                                                                                                
003450 結合テーブルカーソル定義−ＥＸＩＴ.                              
003460     EXIT.                                                                                                                         
003470******************************************************************
003480*    ファイルオープン                                            *
003490******************************************************************
003500 ファイルオープン                        SECTION.                    
003510 ファイルオープン−ＳＴＡＲＴ.                                    
003520* ---------------------------------------------------------------*
003530*    前受金受払残高中間ファイルのオープン                                                     *
003540* ---------------------------------------------------------------*
003550     OPEN  OUTPUT   出力ファイル.                                                                                                 
003560* --< ファイルオープンの状態判定 >                                 
003570     EVALUATE  Ｗ−状態                                           
003580        WHEN  ZERO                                                
003590            CONTINUE                                               
003600        WHEN  OTHER                                               
003610* --<       ファイルオープンエラー >                               
003620            MOVE     -40                TO  Ｗ−エラーコード       
003630           PERFORM  エラー判定処理                                
003640     END-EVALUATE.                                                                                                                
003650 ファイルオープン−ＥＸＩＴ.                                      
003660     EXIT.                                                        
003670                                                                  
003680******************************************************************
003690*    結合テーブルカーソル読込                                    *
003700******************************************************************
003710 結合テーブルカーソル読込             SECTION.                    
003720 結合テーブルカーソル読込−ＳＴＡＲＴ.                                                                                            
003730* --< 結合テーブルカーソル読込 >                                   
003740     EXEC SQL                                                     
003750         FETCH  CUR1                                              
003760          INTO                              
003770                :Ｍ４０−レコード区分                             
003780               ,:Ｍ４０−経理用主契約区分                         
003790		     ,:Ｍ４０−顧客区分                                 
003800		     ,:Ｄ０１−名寄せコード                             
003810		     ,:Ｍ４０−請求先取引先コード                       
003820		     ,:Ｍ４０−請求先コード                             
003830		     ,:Ｍ４０−契約番号                                 
003840		     ,:Ｍ４０−契約種類                                 
003850		     ,:Ｍ４０−担当部課コード                           
003860		     ,:Ｍ４０−再リース回数                             
003870		     ,:Ｍ４０−充当開始年月                             
003880		     ,:Ｍ４０−充当月数                                 
003890		     ,:Ｍ４０−前払回収方法                             
003900		     ,:Ｍ４０−入金日                                   
003910		     ,:Ｍ４０−入金区分                                 
003920		     ,:Ｄ０１−取引先名称                               
003930		     ,:Ｄ０２−請求先名称                               
003940		     ,:Ｍ４０−前月末残高                               
003950		     ,:Ｍ４０−当月回収額                               
003960		     ,:Ｍ４０−当月消化額                               
003970		     ,:Ｍ４０−当月末残高
003980               ,:Ｍ４０−協調区分 
0039900              ,:Ｍ４０−前月末残高他社                          
004000               ,:Ｍ４０−当月回収額他社                              
004010               ,:Ｍ４０−当月消化額他社                           
004020               ,:Ｍ４０−当月他社解約分料金                       
004030               ,:Ｍ４０−当月他社解約分消費税                     
004040               ,:Ｍ４０−当月末残高他社                           
004050                                              
004060                                                                  
004070     END-EXEC.                                                                                                                    
004080* ------------------------------------------------------------ --*
004090*    結合テーブルカーソル読込を確認                              *
004100* ---------------------------------------------------------------*
004110     EVALUATE   SQLCODE                                           
004120        WHEN   定数−ＳＱＬＯＫ                                   
004130* --<       正常 >                                                                                                                 
004140            COMPUTE  Ｗ−入力−件数  =  Ｗ−入力−件数  +  1       
004150        WHEN   定数−ＳＱＬＥＮＤ                                 
004160* --<       読込終了 >                                             
004170            MOVE  "Y"                  TO  Ｗ−終了−フラグ        
004180        WHEN   OTHER                                              
004190* --<       読込エラー >                                           
004200            MOVE     -50               TO  Ｗ−エラーコード        
004210            PERFORM  エラー判定処理                                
004220     END-EVALUATE.                                                                                                               
004230 結合テーブルカーソル読込−ＥＸＩＴ.                              
004240     EXIT.                                                        
004250******************************************************************
004260*    主処理                                                      *
004270******************************************************************
004280 主処理                               SECTION.                    
004290 主処理−ＳＴＡＲＴ.                                              
004300                                                          
004310     PERFORM  項目名称抽出処理.                                                                                                   
004320     PERFORM  債権情報抽出処理.                                                                                                
004330	   PERFORM  出力判定処理.                                   
004340* --< 結合テーブルカーソル読込（２件目以降） >                     
004350     PERFORM  結合テーブルカーソル読込.                           
004360                                                                                                
004370 主処理−ＥＸＩＴ.                                                
004380     EXIT.                                                        
004390******************************************************************
004400*     項目名称マスタより項目の抽出処理                           *
004410******************************************************************
004420 項目名称抽出処理                      SECTION.                   
004430 項目名称抽出処理−ＳＴＡＲＴ.                                                                                                    
004440* ---------------------------------------------------------------*
004450*    項目名称マスタより主契約区分名称の抽出処理                  *
004460* ---------------------------------------------------------------*
004470     INITIALIZE                       項目名称マスタの名称.       
004480     EXEC SQL                                                     
004490         SELECT  名称                                           
004500           INTO  :ＷＳ−名称１                                  
004510           FROM  D19MSY_TBL                                                                                  
004520          WHERE  コードＮＯ  =  :ＷＳ−コードＮＯ１                
004530            AND  SUBSTR (コード,1,1)  =  :Ｍ４０−経理用主契約区分                     
004540     END-EXEC.                                                    
004550                                                                  
004560* ---------------------------------------------------------------*
004570*     項目名称マスタより主契約区分名称の抽出確認                 *
004580* ---------------------------------------------------------------*
004590     EVALUATE  SQLCODE                                            
004600         WHEN  定数−ＳＱＬＯＫ                                    
004610* --< 正常 >                                                  
004620             CONTINUE                                               
004630         WHEN    OTHER                                               
004640* --< 存在しない >                               
004650             MOVE -60                   TO  Ｗ−エラーコード        
004660             PERFORM  エラー判定処理                                
004670     END-EVALUATE.                                                
004680* ---------------------------------------------------------------*
004690*    項目名称マスタより顧客区分名称の抽出処理                                             *
004700* ---------------------------------------------------------------*
004710     INITIALIZE                       項目名称マスタの名称.       
004720     EXEC SQL                                                     
004730           SELECT  名称                                           
004740             INTO  :ＷＳ−名称２                                  
004750             FROM  D19MSY_TBL                                                                                            
004760            WHERE  コードＮＯ  =  :ＷＳ−コードＮＯ２                
004770              AND  SUBSTR (コード,1,2) =              
004780		          :Ｍ４０−顧客区分                           
004790     END-EXEC.                                                    
004800                                                                  
004810* ---------------------------------------------------------------*
004820*     項目名称マスタより顧客区分名称の抽出確認                   *
004830* ---------------------------------------------------------------*
004840     EVALUATE  SQLCODE                                            
004850        WHEN  定数−ＳＱＬＯＫ                                    
004860* --< 正常 >                                                 
004870            CONTINUE                                               
004880        WHEN  OTHER                                               
004890* --< カーソルＯＰＥＮエラー >                               
004900            MOVE -70                   TO  Ｗ−エラーコード        
004910            PERFORM  エラー判定処理                                
004920     END-EVALUATE.                                                
004930*                                                                 
004940 項目名称抽出処理−ＥＸＩＴ.                                      
004950     EXIT.                                                        
004960******************************************************************
004970*     債権情報（一般）ＤＢより項目の抽出処理                     *
004980******************************************************************
004990 債権情報抽出処理                     SECTION.                    
005000 債権情報抽出処理−ＳＴＡＲＴ.                                    
005010*                                                                 
005020* ---------------------------------------------------------------*
005030*    債権情報抽出処理の抽出処理                                  *
005040* ---------------------------------------------------------------*
005050            
005060     EXEC SQL                                                     
005070           SELECT  M01SAJ_TBL.状態フラグ                          
005080                  ,M01SAJ_TBL.債権契約件名                        
005090			,M01SAJ_TBL.担保区分                            
005100             INTO  :Ｍ０１−状態フラグ                            
005110		        ,:Ｍ０１−債権契約件名                          
005120			,:Ｍ０１−担保区分                              
005130             FROM  M01SAJ_TBL                                     
005140                                                        
005150            WHERE  レコード区分  =     :ＷＳ−レコード区分               
005160              AND  契約番号      =     :Ｍ４０−契約番号    
005170	            AND  再リース回数  =     :Ｍ４０−再リース回数                     
005180	            AND  契約種類      =     :Ｍ４０−契約種類    
005190     END-EXEC.                                                    
005200                                                                  
005210* ---------------------------------------------------------------*
005220*     債権情報抽出処理の抽出確認                                 *
005230* ---------------------------------------------------------------*
005240     EVALUATE  SQLCODE                                            
005250        WHEN  定数−ＳＱＬＯＫ                                    
005260* --< 正常 >                                                 
005270            CONTINUE                                               
005280        WHEN  OTHER                                               
005290* --< カーソルＯＰＥＮエラー >                               
005300            MOVE -80                   TO  Ｗ−エラーコード        
005310            PERFORM  エラー判定処理                                
005320     END-EVALUATE.                                                
005330 債権情報抽出処理−ＥＸＩＴ.                                      
005340     EXIT.                                                        
005350******************************************************************
005360*    前受金受払残高中間ファイル出力判定処理                      *
005370******************************************************************
005380 出力判定処理                     SECTION.                    
005390 出力判定処理−ＳＴＡＲＴ.                                    
005400     IF Ｍ０１−担保区分  NOT = '1'                                                                                                
005410        PERFORM  自社分出力処理                                   
005420               IF  Ｍ４０−協調区分 =  '2'                              
005430                   PERFORM  他社分出力処理                                
005440               END-IF                                                  
005470     END-IF.                                                      
005480 出力判定処理−ＥＸＩＴ.                                      
005490     EXIT.                                                        
005500******************************************************************
005510*    自社分出力処理                                              *
005520******************************************************************
005530 自社分出力処理                         SECTION.                    
005540 自社分出力処理−ＳＴＡＲＴ.  
005550*----------------------------------------------------------------*
005560*        出力−レコード 初期化処理                               *
005570*----------------------------------------------------------------*
005580        MOVE  SPACE                TO  出力−レコード.            
005590        INITIALIZE                     出力−レコード.            
005600*                                                                                                     
005610*                                                                 
005620      IF   Ｍ０１−状態フラグ  <  '3'                               
005630	       MOVE  "3"                     TO   出力−自他社区分       
005640      ELSE                                                        
005650         MOVE  "1"                     TO   出力−自他社区分.      
005660* --< 共通編集処理 >                                               
005670      PERFORM   共通編集処理.                                     
005680*                                                                 
005690      MOVE     Ｍ４０−前月末残高       TO   出力−前月末残高.      
005700      MOVE     Ｍ４０−当月回収額       TO   出力−当月入金額.      
005710      MOVE     Ｍ４０−当月消化額       TO   出力−当月消化額.      
005720      MOVE     Ｍ４０−当月末残高       TO   出力−当月末残高.      
005730* ---------------------------------------------------------------*
005740*     前受金受払残高中間ファイル出力処理                     *
005750* ---------------------------------------------------------------*
005760      PERFORM   受払残高中間ファイル出力.                             
005770 自社分出力処理−ＥＸＩＴ.                                        
005780     EXIT.                                                        
005790******************************************************************
005800*    他社分出力処理                                              *
005810******************************************************************
005820 他社分出力処理                       SECTION.                    
005830 他社分出力処理−ＳＴＡＲＴ.                                                                                                      
005840     IF   Ｍ０１−状態フラグ  <  '3'                               
005850         MOVE  "4"  TO   出力−自他社区分                          
005860     ELSE                                                         
005870         MOVE  "2"  TO   出力−自他社区分.                         
005880                                                                  
005890* --< 共通編集処理 >                                               
005900     PERFORM   共通編集処理.                                                                                                      
005910     MOVE     Ｍ４０−前月末残高       TO   出力−前月末残高.      
005920     MOVE     Ｍ４０−当月回収額       TO   出力−当月入金額.      
005930     COMPUTE  出力−当月消化額  =  Ｍ４０−当月消化額他社       
005940                                  +  Ｍ４０−当月他社解約分料金   
005950                                  +  Ｍ４０−当月他社解約分消費税.                                                                
005960     COMPUTE  出力−当月末残高  =  Ｍ４０−当月末残高他社       
005970                                  -  Ｍ４０−当月他社解約分料金   
005980                                  -  Ｍ４０−当月他社解約分消費税.
005990* ---------------------------------------------------------------*
006000*     前受金受払残高中間ファイル出力処理                     *
006010* ---------------------------------------------------------------*
006020     PERFORM   受払残高中間ファイル出力.                              
006030                                                                  
006040 他社分出力処理−ＥＸＩＴ.                                        
006050     EXIT.                                                        
006060
006070******************************************************************
006080*   前受金受払残高中間ファイル出力処理                       *
006090******************************************************************
006100 受払残高中間ファイル出力                 SECTION.                    
006110 受払残高中間ファイル出力−ＳＴＡＲＴ.                                                                                       
006120     IF  出力−前月末残高       NOT =   0                                 
006130         OR  出力−当月入金額  NOT =  0                              
006140         OR  出力−当月消化額  NOT =  0                              
006150         OR  出力−当月末残高  NOT =  0                              
006160         WRITE  出力−レコード.                                                                                                    
006170* --< 出力の状態判定 >                                         
006180     EVALUATE  Ｗ−状態                                           
006190        WHEN  ZERO                                                
006200* --< 出力件数の加算 >                                    
006210            COMPUTE  Ｗ−出力−件数 =  Ｗ−出力−件数 + 1          
006220        WHEN  OTHER                                               
006230* --< ファイル出力エラー >                                   
006240           MOVE     -90               TO  Ｗ−エラーコード        
006250           PERFORM  エラー判定処理                                
006260     END-EVALUATE.                                                                                                                 
006270 受払残高中間ファイル出力−ＥＸＩＴ.                                  
006280     EXIT.                                                        
006290******************************************************************
006300*    共通編集処理                                                *
006310******************************************************************
006320 共通編集処理                           SECTION.                  
006330 共通編集処理−ＳＴＡＲＴ.                                        
006340                                                                
006350     MOVE  Ｍ４０−レコード区分       TO   出力−前受区分.        
006360	   MOVE  Ｍ４０−経理用主契約区分   TO   出力−主契約区分.      
006370	   MOVE  Ｍ４０−顧客区分           TO   出力−連結区分.        
006380	   MOVE  Ｄ０１−名寄せコード       TO   出力−名寄せコード.    
006390	   MOVE  Ｍ４０−請求先取引先コード TO   出力−取引先コード.    
006400	   MOVE  Ｍ４０−請求先コード       TO   出力−請求先コード.    
006410	   MOVE  Ｍ４０−契約番号           TO   出力−契約番号.        
006420     MOVE  Ｍ４０−契約種類           TO   出力−契約種類.        
006430     MOVE  Ｄ７０−バッチ用業務年月   TO   出力−業務年月.        
006440     MOVE  Ｍ４０−担当部課コード     TO   出力−担当部課コード.  
006450     MOVE  Ｍ０１−債権契約件名       TO   出力−契約件名.        
006460     MOVE  Ｍ４０−再リース回数       TO   出力−再リース回数.    
006470     MOVE  Ｍ４０−充当開始年月       TO   出力−充当開始年月.    
006480     MOVE  Ｍ４０−充当月数           TO   出力−充当月数.        
006490     MOVE  Ｍ４０−前払回収方法       TO   出力−前払回収方法.    
006500     MOVE  Ｍ４０−入金日             TO   出力−入金日.          
006510     MOVE  Ｍ４０−入金区分           TO   出力−入金区分.        
006520     MOVE  Ｄ０１−取引先名称         TO   出力−取引先名称.      
006530     MOVE  Ｄ０２−請求先名称         TO   出力−請求先名称.      
006540     MOVE  ＷＳ−名称１               TO   出力−主契約区分名称.  
006550     MOVE  ＷＳ−名称２               TO   出力−連結区分名称.    
006560                                                                 
006570 共通編集処理−ＥＸＩＴ.                                            
006580     EXIT.                                                        
006590******************************************************************
006600*    終了処理                                                    *
006610******************************************************************
006620 終了処理                             SECTION.                    
006630 終了処理−ＳＴＡＲＴ.                                            
006640*                                                                 
006650     PERFORM  ＤＢクローズ処理.                                   
006660*                                                                 
006670     PERFORM  ファイルクローズ処理.                               
006680*                                                                 
006690     PERFORM  件数メッセージ出力.                                 
006700*                                                                 
006710     PERFORM  終了メッセージ出力.                                 
006720*                                                                 
006730* --< プログラム正常終了 >                                         
006740     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
006750*                                                                 
006760 終了処理−ＥＸＩＴ.                                              
006770     EXIT.                                                        
006780******************************************************************
006790*    ＤＢクローズ                                                *
006800******************************************************************
006810 ＤＢクローズ処理                     SECTION.                    
006820 ＤＢクローズ処理−ＳＴＡＲＴ.                                                                                                     
006830* --< カーソル クローズ >                                          
006840     EXEC SQL                                                     
006850         CLOSE  CUR1                                               
006860     END-EXEC.                                                                                                                    
006870 ＤＢクローズ処理−ＥＸＩＴ.                                      
006880     EXIT.                                                        
006890******************************************************************
006900*    ファイルクローズ                                            *
006910******************************************************************
006920 ファイルクローズ処理                 SECTION.                    
006930 ファイルクローズ処理−ＳＴＡＲＴ.                                
006940                                                                
006950     CLOSE  出力ファイル.                                         
006960                                                          
006970 ファイルクローズ処理−ＥＸＩＴ.                                  
006980     EXIT.                                                                                                                        
006990******************************************************************
007000*     件数メッセージ出力処理                                     *
007010******************************************************************
007020 件数メッセージ出力                   SECTION.                    
007030 件数メッセージ出力−ＳＴＡＲＴ.                                  
007040* ---------------------------------------------------------------*
007050*    件数メッセージ出力処理                                      *
007060* ---------------------------------------------------------------*
007070     INITIALIZE                       IF-CHOCO001.                
007080     MOVE  "3"                        TO  共１−イベント種別.     
007090     MOVE  定数−プログラムＩＤ        TO  共１−ソースＩＤ.       
007100     MOVE  "0"                        TO  共１−復帰コード.       
007110     MOVE  "M40MAB_TBL"               TO  共１−処理テーブルＩＤ. 
007120     MOVE  "COUNT"                    TO  共１−処理識別.         
007130     MOVE  Ｗ−入力−件数              TO  共１−データ内容.       
007140     MOVE  " 前受情報テーブル（入力）"                            
007150                                      TO  共１−その他メッセージ. 
007160     CALL  CLOCO001                   USING  IF-CHOCO001.        
007170                                                          
007180     INITIALIZE                       IF-CHOCO001.                
007190     MOVE  "3"                        TO  共１−イベント種別.     
007200     MOVE  定数−プログラムＩＤ        TO  共１−ソースＩＤ.       
007210     MOVE  "0"                        TO  共１−復帰コード.       
007220     MOVE  "SFHSED25.U11"             TO  共１−処理テーブルＩＤ. 
007230     MOVE  "COUNT"                    TO  共１−処理識別.         
007240     MOVE  Ｗ−出力−件数              TO  共１−データ内容.       
007250     MOVE  "前受金受払残高ファイル"    TO  共１−その他メッセージ. 
007260     CALL  CLOCO001                   USING  IF-CHOCO001.         
007270 件数メッセージ出力−ＥＸＩＴ.                                    
007280     EXIT.                                                                                                                        
007290******************************************************************
007300*    終了メッセージ出力                                          *
007310******************************************************************
007320 終了メッセージ出力                   SECTION.                    
007330 終了メッセージ出力−ＳＴＡＲＴ.                                                                                                                                         
007340* ---------------------------------------------------------------*
007350*    終了メッセージ出力                                          *
007360* ---------------------------------------------------------------*
007370     INITIALIZE                       IF-CHOCO001.                
007380     MOVE  "3"                        TO  共１−イベント種別.     
007390     MOVE  定数−プログラムＩＤ        TO  共１−ソースＩＤ.       
007400     MOVE  ZERO                       TO  共１−復帰コード.       
007410     MOVE  "END"                      TO  共１−処理識別.         
007420     MOVE  定数−プログラム名          TO  共１−その他メッセージ. 
007430     CALL  CLOCO001                   USING  IF-CHOCO001.                                                                         
007440 終了メッセージ出力−ＥＸＩＴ.                                    
007450     EXIT.                                                        
007460******************************************************************
007470*    エラー処理                                                  *
007480******************************************************************
007490 エラー判定処理                       SECTION.                    
007500 エラー判定処理−ＳＴＡＲＴ.                                                                                                      
007510     MOVE  "Y"                        TO Ｗ−異常終了−フラグ.    
007520     INITIALIZE                           IF-CHOCO001.            
007530*                                                                 
007540     EVALUATE  Ｗ−エラーコード                                   
007550        WHEN  -10                                                 
007560* --<       ＯＲＡＣＬＥ接続失敗 >                                 
007570           MOVE  "1"                  TO  共１−イベント種別      
007580           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
007590           MOVE  "9"                  TO  共１−復帰コード        
007600           MOVE  "CONNECT"            TO  共１−処理識別          
007610           MOVE  SQLCODE              TO  共１−データ内容        
007620           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007630           CALL  CLOCO001             USING  IF-CHOCO001          
007640                                                          
007650        WHEN  -20                                                 
007660* --<       業務管理テーブル読込処理失敗 >                         
007670           MOVE  "1"                  TO  共１−イベント種別      
007680           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
007690           MOVE  "9"                  TO  共１−復帰コード        
007700           MOVE  "D70GYM_TBL"         TO  共１−処理テーブルＩＤ  
007710           MOVE  "SELECT"             TO  共１−処理識別          
007720           MOVE  SQLCODE              TO  共１−データ内容        
007730           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007740           CALL  CLOCO001             USING  IF-CHOCO001          
007750                                                                
007760        WHEN  -30                                                 
007770* --<      結合テーブルカーソル定義処理失敗 >                      
007780           MOVE  "1"                  TO  共１−イベント種別      
007790           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
007800           MOVE  "9"                  TO  共１−復帰コード        
007810           MOVE  "M40MAB_TBL"         TO  共１−処理テーブルＩＤ  
007820           MOVE  "SELECT"             TO  共１−処理識別          
007830           MOVE  SQLCODE              TO  共１−データ内容        
007840           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007850           CALL  CLOCO001             USING  IF-CHOCO001          
007860                                                                
007870        WHEN  -40                                                 
007880* --<       ファイルオープン失敗 >                                 
007890           MOVE  "1"                  TO  共１−イベント種別      
007900           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
007910           MOVE  "9"                  TO  共１−復帰コード        
007920           MOVE  "SFHSED25.U11"       TO  共１−処理テーブルＩＤ  
007930           MOVE  "OPEN"               TO  共１−処理識別          
007940           MOVE  Ｗ−状態             TO  共１−データ内容        
007950           CALL  CLOCO001             USING  IF-CHOCO001          
007960                                                                
007970           WHEN  -50                                              
007980* --<       結合テーブルカーソル読込失敗 >                         
007990           MOVE  "1"                  TO  共１−イベント種別      
008000           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008010           MOVE  "9"                  TO  共１−復帰コード        
008020           MOVE  "M40MAB_TBL"         TO  共１−処理テーブルＩＤ  
008030           MOVE  "FETCH"              TO  共１−処理識別          
008040           MOVE  SQLCODE              TO  共１−データ内容        
008050           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008060           CALL  CLOCO001             USING  IF-CHOCO001          
008070                                                                
008080           WHEN  -60                                              
008090* --< 項目名称マスタより主契約区分名称の抽出確認失敗>              
008100           MOVE  "1"                  TO  共１−イベント種別      
008110           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008120           MOVE  "9"                  TO  共１−復帰コード        
008130           MOVE  "D19MSY_TBL"         TO  共１−処理テーブルＩＤ  
008140           MOVE  "SELECT"             TO  共１−処理識別          
008150           MOVE  SQLCODE              TO  共１−データ内容        
008160           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008170           CALL  CLOCO001             USING  IF-CHOCO001          
008180                                                                 
008190           WHEN  -70                                              
008200* --<      項目名称マスタより顧客区分名称の抽出失敗 >              
008210           MOVE  "1"                  TO  共１−イベント種別      
008220           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008230           MOVE  "9"                  TO  共１−復帰コード        
008240           MOVE  "D19MSY_TBL"         TO  共１−処理テーブルＩＤ  
008250           MOVE  "SELECT"             TO  共１−処理識別          
008260           MOVE  SQLCODE              TO  共１−データ内容        
008270           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008280           CALL  CLOCO001             USING  IF-CHOCO001          
008290                                                                 
008300           WHEN  -80                                              
008310* --<         債権情報抽出処理の抽出確認 失敗 >                    
008320           MOVE  "1"                  TO  共１−イベント種別      
008330           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008340           MOVE  "9"                  TO  共１−復帰コード        
008350           MOVE  "M01SAJ_TBL"         TO  共１−処理テーブルＩＤ  
008360           MOVE  "SELECT"             TO  共１−処理識別          
008370           MOVE  SQLCODE              TO  共１−データ内容        
008380           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008390           CALL  CLOCO001             USING  IF-CHOCO001          
008400                                                                
008410           WHEN  -90                                              
008420* --<         共通前受金受払残高中間ファイル出力処理失敗 >         
008430           MOVE  "1"                  TO  共１−イベント種別      
008440           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008450           MOVE  "9"                  TO  共１−復帰コード        
008460           MOVE  "SFHSED25.U11"       TO  共１−処理テーブルＩＤ  
008470           MOVE  "WRITE"              TO  共１−処理識別          
008480           MOVE  SQLCODE              TO  共１−データ内容        
008490           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008500           CALL  CLOCO001             USING  IF-CHOCO001          
008510        WHEN  OTHER                                               
008520           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
008530     END-EVALUATE.                                                
008540                                                                 
008550     IF Ｗ−異常終了−フラグ  =  "Y"
008560                                                          
008570        PERFORM  終了メッセージ出力                                                         
008580                                                                                                      
008590* --<    プログラム異常終了のリターンコード >                      
008600        MOVE  定数−異常状態          TO  PROGRAM-STATUS                                                                           
008610        EXIT  PROGRAM                                             
008620     END-IF.                                                                                                                       
008630 エラー処理−ＥＸＩＴ.                                            
008640     EXIT.                                                                               
008850******************************************************************
008860*                  END OF PROGRAM                                *
008870******************************************************************                                

