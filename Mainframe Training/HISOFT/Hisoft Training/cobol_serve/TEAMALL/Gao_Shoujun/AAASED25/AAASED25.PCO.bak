000010******************************************************************
000020*         ＜海輝軟件(大連)＞                                     *
000030*      1. プログラム名  : 前受金受払残高ファイル作成	       *
000040*                                        　                      *
000050*      2. プログラムID  : AAASED25                               *
000060*      3. 処理概要      : 前受情報ＤＢをメインに、マスタと表     *
000070*                          結合して読込 前受金受払残高中間       *
000080*                         ファイルを 作成する*                   *
000090*      4. 作成者        : 高守軍                              　 *
000100*      5. 作成日        : 2005.03.28                         　  *
000110******************************************************************
000120*                                                                 
000130******************************************************************
000140*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000150******************************************************************
000160 IDENTIFICATION                       DIVISION.                   
000170*                                                                 
000180 PROGRAM-ID.                          AAASED25.                   
000190******************************************************************
000200*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000210******************************************************************
000220 ENVIRONMENT                          DIVISION.                   
000230******************************************************************
000240*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000250******************************************************************
000260 INPUT-OUTPUT                         SECTION.                    
000270*                                                                 
000280 FILE-CONTROL.                                                    
000290     SELECT    出力ファイル            ASSIGN    TO     U11       
000300     FILE      STATUS     IS          Ｗ−状態                    
000310     ORGANIZATION         IS          LINE      SEQUENTIAL. 
000320******************************************************************
000330*    ＤＡＴＡ                 ＤＩＶＩＳＩＯＮ                   *
000340******************************************************************
000350 DATA                                 DIVISION.                   
000360******************************************************************
000370*    ＦＩＬＥ                 ＳＥＣＴＩＯＮ                     *
000380******************************************************************
000390 FILE                                 SECTION.                    
000400* ---------------------------------------------------------------*
000410*    出力ファイル                       
000420* ---------------------------------------------------------------*
000430 FD  出力ファイル                                                 
000440     LABEL     RECORD     IS          STANDARD                    
000450     BLOCK     CONTAINS   0           RECORDS.                                                                                  
000460 01  出力−レコード.                                              
000470     COPY  CPSCE50  REPLACING  ==()==  BY  ==出力−==.            
000480*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000490******************************************************************
000500  WORKING-STORAGE                     SECTION.                    
000510* ---------------------------------------------------------------*
000520*    ホスト変数定義エリア                                        *
000530* ---------------------------------------------------------------*
000540     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000550* --< 項目名称マスタの名称 >                                       
000560 01 項目名称マスタの名称.                                         
000570    03 ＷＳ−名称１                   PIC  X(60).                     
000580    03 ＷＳ−名称２                   PIC  X(60). 
000590* --< 業務管理テーブルの業務管理ＩＤ >   
000600 01 ＷＳ−業務管理ＩＤ                PIC X(08)  VALUE 'GYMKNRRC'. 
000610 
000620* --< 項目名称マスタのコードＮＯ１ >           
000630 01 ＷＳ−コードＮＯ１      PIC X(08)  VALUE '038'. 
000640
000650* --< 項目名称マスタのコードＮＯ２ >                
000660 01 ＷＳ−コードＮＯ２                PIC X(08)  VALUE '005'.
000670
000680* --< 債権情報のレコード区分 >                 
000690 01 ＷＳ−レコード区分                PIC X(01)  VALUE '1'.   
000700        
000710* --< ＯＲＡＣＬＥ共通変数 >                                       
000720     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000730                             
000740* --< ＯＲＡＣＬＥ  ＳＱＬ実行情報 >                               
000750     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000760                                                                 
000770* --< 前受情報ＤＢ >                                               
000780     EXEC  SQL  INCLUDE  M40MAB.CBL            END-EXEC.          
000790                                                                 
000800* --< 業務管理テーブル >                                           
000810     EXEC  SQL  INCLUDE  D70GYM.CBL            END-EXEC.          
000820                                                                 
000830* --< 取引先マスタ>                                                
000840     EXEC  SQL  INCLUDE  D01TRS.CBL            END-EXEC.          
000850                                                                
000860* --< 請求先マスタ >                                               
000870     EXEC  SQL  INCLUDE  D02SQS.CBL            END-EXEC.  
000880  
000890* --< 項目名称マスタ >                                             
000900     EXEC  SQL  INCLUDE  D19MSY.CBL            END-EXEC.  
000910  
000920* --< 債権情報（一般）ＤＢ >                                       
000930     EXEC  SQL  INCLUDE  M01SAJ.CBL            END-EXEC.          
000940*                                                                 
000950     EXEC  SQL  END  DECLARE          SECTION  END-EXEC.          
000960                                                                 
000970* ---------------------------------------------------------------*
000980*    ＷＯＲＫエリア                                              *
000990* ---------------------------------------------------------------*
001000 01  ＷＯＲＫ−エリア.                                            
001010* --< エラー判定用 >                                               
001020     03  Ｗ−エラーコード             PIC S9(04).                 
001030                                                                 
001040* --< フラグアリア >                                               
001050     03  フラグアリア.                                            
001060         05  Ｗ−終了−フラグ         PIC  X(01).                 
001070         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
001080* --< ファイル状態 >                                               
001090     03  Ｗ−状態エリア.                                          
001100         05  Ｗ−状態                 PIC  X(02).
001110                                                                 
001120* --< 件数エリア >                                                 
001130     03  件数エリア.                                              
001140         05  Ｗ−入力−件数           PIC  9(09).                 
001150         05  Ｗ−出力−件数           PIC  9(09).                 
001160                                                          
001170* ---------------------------------------------------------------*
001180*    サブルーチン名                                              *
001190* ---------------------------------------------------------------*
001200 01  CALL-AREA.                                                   
001210* --< 共通ログサブルーチン >                                       
001220     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
001230     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
001240                                                           
001250* ---------------------------------------------------------------*
001260*    ＣＯＰＹ領域                                                *
001270* ---------------------------------------------------------------*
001280* --< 共通ログ用パラメータ >                                       
001290 01  IF-CHOCO001.                                                 
001300     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
001310                                                                 
001320* ---------------------------------------------------------------*
001330*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001340* ---------------------------------------------------------------*
001350 01  PARA-AREA.                                                   
001360     COPY CPBCO001.                                               
001370******************************************************************
001380*    定数用データ定義エリア                                      *
001390******************************************************************
001400 CONSTANT                             SECTION.                    
001410 01  定数領域.                                                    
001420     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
001430     03  定数−プログラム名           PIC  X(80)                  
001440                               VALUE "前受金受払残高ファイル作成".
001450     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001460     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001470     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001480     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001490******************************************************************
001500*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001510******************************************************************
001520 PROCEDURE                            DIVISION.                   
001530                                                                 
001540     PERFORM  初期処理.                                           
001550                                                                 
001560     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001570                                                                
001580     PERFORM  終了処理.                                           
001590                                                                
001600     STOP     RUN.                                                
001610                                                                
001620******************************************************************
001630*    初期処理                                                    *
001640******************************************************************
001650 初期処理                             SECTION.                    
001660 初期処理−ＳＴＡＲＴ.                                            
001670                                                                 
001680* ---------------------------------------------------------------*
001690*    開始メッセージ出力処理                                      *
001700* ---------------------------------------------------------------*
001710     INITIALIZE                       IF-CHOCO001.                
001720     MOVE  "3"                        TO  共１−イベント種別.     
001730     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001740     MOVE  "0"                        TO  共１−復帰コード.       
001750     MOVE  "START"                    TO  共１−処理識別.         
001760     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001770     CALL  CLOCO001                USING  IF-CHOCO001.            
001780                                                                 
001790* ---------------------------------------------------------------*
001800*    作業領域の初期値処理                                        *
001810* ---------------------------------------------------------------*
001820     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001830     INITIALIZE                           ＷＯＲＫ−エリア.  
001840                  
001850* --< ＯＲＡＣＬＥ接続 >                                           
001860     PERFORM   ＯＲＡＣＬＥ接続.                                                                                                   
001870* --< 業務管理テーブル読込  >                                      
001880     PERFORM  業務管理テーブル読込.                               
001890* --< 結合テーブルカーソル宣言 >                                   
001900     PERFORM  結合テーブルカーソル定義.                                                                                           
001910* --< ファイルオープン >                                           
001920     PERFORM  ファイルオープン.                                                                                                   
001930* --< 結合テーブルカーソル読込(１件目) >                           
001940     PERFORM  結合テーブルカーソル読込.                                                                                           
001950 初期処理−ＥＸＩＴ.                                              
001960     EXIT.                                                        
001970******************************************************************
001980*    ＯＲＡＣＬＥ接続                                            *
001990******************************************************************
002000 ＯＲＡＣＬＥ接続                     SECTION.                    
002010 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                                                                                    
002020* --< ＤＢ接続用情報を取得処理 >                                   
002030     CALL  COBCO001                    USING  PARA-AREA.                                                                               
002040     MOVE  PARA-DBSTRING               TO  DB-STRING.              
002050     MOVE  PARA-USERNAME               TO  USERNAME.               
002060     MOVE  PARA-PASSWORD               TO  PASSWD.                                                                                  
002070* ---------------------------------------------------------------*
002080*    開始接続                                                    *
002090* ---------------------------------------------------------------*
002100     IF    DB-STRING  =  SPACE                                    
002110        EXEC SQL                                                  
002120             CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002130        END-EXEC                                                  
002140     ELSE                                                         
002150        EXEC SQL                                                  
002160             CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002170             USING  :DB-STRING                                    
002180        END-EXEC                                                  
002190     END-IF.                                                                                                                       
002200* ---------------------------------------------------------------*
002210*    接続確認                                                    *
002220* ---------------------------------------------------------------*
002230     EVALUATE  SQLCODE                                            
002240        WHEN   定数−ＳＱＬＯＫ                                   
002250             CONTINUE                                               
002260        WHEN   OTHER                                              
002270* --<   接続エラー >                                           
002280           MOVE     -10               TO  Ｗ−エラーコード        
002290           PERFORM  エラー判定処理                                
002300     END-EVALUATE.                                                                                                                 
002310 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002320     EXIT.                                                        
002330******************************************************************
002340*        業務管理テーブル読込                                    *
002350******************************************************************
002360 業務管理テーブル読込                     SECTION.                
002370 業務管理テーブル読込−ＳＴＡＲＴ.                                                                                                
002380* ---------------------------------------------------------------*
002390*    業務管理テーブル読込処理                                    *
002400* ---------------------------------------------------------------*
002410     EXEC SQL                                                     
002420           SELECT  バッチ用業務年月                               
002430             INTO  :Ｄ７０−バッチ用業務年月                       
002440             FROM  D70GYM_TBL                                     
002450            WHERE  業務管理ＩＤ = :ＷＳ−業務管理ＩＤ                      
002460     END-EXEC.                                                    
002470                                                                  
002480* ---------------------------------------------------------------*
002490*    業務管理テーブル読込処理ＯＰＥＮ確認                        *
002500* ---------------------------------------------------------------*
002510     EVALUATE  SQLCODE                                            
002520        WHEN  定数−ＳＱＬＯＫ                                    
002530* --<   正常 >                                                 
002540           CONTINUE                                               
002550        WHEN  OTHER                                               
002560* --<   業務管理テーブル読込失敗 >                               
002570           MOVE -20                   TO  Ｗ−エラーコード        
002580           PERFORM  エラー判定処理                                
002590     END-EVALUATE.                                                
002600                                                          
002610 業務管理テーブル読込−ＥＸＩＴ.                                  
002620     EXIT.                                                        
002630******************************************************************
002640*        結合テーブルカーソル定義                                *
002650******************************************************************
002660 結合テーブルカーソル定義             SECTION.                    
002670 結合テーブルカーソル定義−ＳＴＡＲＴ.                                                                                            
002680* ---------------------------------------------------------------*
002690*    カーソル宣言                                        *
002700* ---------------------------------------------------------------*
002710     EXEC SQL                                                     
002720        DECLARE CUR1  CURSOR FOR                                  
002730           SELECT  M40MAB_TBL.レコード区分                        
002740                  ,M40MAB_TBL.経理用主契約区分                    
002750			,M40MAB_TBL.顧客区分                            
002760			,NVL(D01TRS_TBL.名寄せコード,RPAD(' ',40,' '))                       
002770			,M40MAB_TBL.請求先取引先コード                  
002780			,M40MAB_TBL.請求先コード                        
002790			,M40MAB_TBL.契約番号                            
002800			,M40MAB_TBL.契約種類                            
002810			,M40MAB_TBL.担当部課コード                      
002820			,M40MAB_TBL.再リース回数                        
002830			,M40MAB_TBL.充当開始年月                        
002840			,M40MAB_TBL.充当月数                            
002850			,M40MAB_TBL.前払回収方法                        
002860			,M40MAB_TBL.入金日                              
002870			,M40MAB_TBL.入金区分                            
002880			,NVL(D01TRS_TBL.取引先名称,RPAD(' ',80,' '))                          
002890			,NVL(D02SQS_TBL.請求先名称,RPAD(' ',80,' '))                          
002900			,M40MAB_TBL.前月末残高                          
002910			,M40MAB_TBL.当月回収額                          
002920			,M40MAB_TBL.当月消化額                          
002930			,M40MAB_TBL.当月末残高
002940                  ,M40MAB_TBL.協調区分 
002950                  ,M40MAB_TBL.前月末残高他社                      
002960                  ,M40MAB_TBL.当月回収額他社                         
002970                  ,M40MAB_TBL.当月消化額他社                      
002980                  ,M40MAB_TBL.当月他社解約分料金                  
002990                  ,M40MAB_TBL.当月他社解約分消費税                
003000                  ,M40MAB_TBL.当月末残高他社                      
003010                                              
003020             FROM  M40MAB_TBL                                     
003030                  ,D01TRS_TBL                                     
003040                  ,D02SQS_TBL                                     
003050            WHERE  M40MAB_TBL.前受金受払残高表対象フラグ  =  '1'  
003060              AND  M40MAB_TBL.請求先取引先コード  =               
003070                                    D01TRS_TBL.取引先コード (+)         
003080              AND  M40MAB_TBL.請求先取引先コード  =               
003090                                    D02SQS_TBL.取引先コード (+)         
003100              AND  M40MAB_TBL.請求先コード        =               
003110                                    D02SQS_TBL.請求先コード  (+)        
003120         ORDER BY  M40MAB_TBL.レコード区分                        
003130                  ,M40MAB_TBL.契約番号                            
003140                                                                  
003150     END-EXEC.                                                    
003160* ---------------------------------------------------------------*
003170*    結合テーブルカーソルオープン                                       *
003180* ---------------------------------------------------------------*
003190     EXEC  SQL                                                    
003200        OPEN  CUR1                                                
003210     END-EXEC.                                                                                                                    
003220* ---------------------------------------------------------------*
003230*    結合テーブルカーソルオープンを確認                                       *
003240* ---------------------------------------------------------------*
003250     EVALUATE  SQLCODE                                            
003260        WHEN  定数−ＳＱＬＯＫ                                    
003270* --<       正常 >                                                 
003280           CONTINUE                                               
003290        WHEN  OTHER                                               
003300* --<       カーソルＯＰＥＮエラー >                               
003310           MOVE -30                    TO  Ｗ−エラーコード        
003320           PERFORM  エラー判定処理                                
003330     END-EVALUATE.                                                                                                                
003340 結合テーブルカーソル定義−ＥＸＩＴ.                              
003350     EXIT.                                                                                                                         
003360******************************************************************
003370*    ファイルオープン                                            *
003380******************************************************************
003390 ファイルオープン                        SECTION.                    
003400 ファイルオープン−ＳＴＡＲＴ.                                    
003410* ---------------------------------------------------------------*
003420*    前受金受払残高中間ファイルのオープン                                                     *
003430* ---------------------------------------------------------------*
003440     OPEN  OUTPUT   出力ファイル.                                                                                                 
003450* --< ファイルオープンの状態判定 >                                 
003460     EVALUATE  Ｗ−状態                                           
003470        WHEN  ZERO                                                
003480            CONTINUE                                               
003490        WHEN  OTHER                                               
003500* --<   前受金受払残高中間ファイルオープンエラー >                              
003510            MOVE     -40                TO  Ｗ−エラーコード       
003520           PERFORM  エラー判定処理                                
003530     END-EVALUATE.                                                                                                                
003540 ファイルオープン−ＥＸＩＴ.                                      
003550     EXIT.                                                        
003560                                                                  
003570******************************************************************
003580*    結合テーブルカーソル読込                                    *
003590******************************************************************
003600 結合テーブルカーソル読込             SECTION.                    
003610 結合テーブルカーソル読込−ＳＴＡＲＴ.                                                                                            
003620* --< 結合テーブルカーソル読込 >                                   
003630     EXEC SQL                                                     
003640         FETCH  CUR1                                              
003650          INTO                              
003660                :Ｍ４０−レコード区分                             
003670               ,:Ｍ４０−経理用主契約区分                         
003680		     ,:Ｍ４０−顧客区分                                 
003690		     ,:Ｄ０１−名寄せコード                             
003700		     ,:Ｍ４０−請求先取引先コード                       
003710		     ,:Ｍ４０−請求先コード                             
003720		     ,:Ｍ４０−契約番号                                 
003730		     ,:Ｍ４０−契約種類                                 
003740		     ,:Ｍ４０−担当部課コード                           
003750		     ,:Ｍ４０−再リース回数                             
003760		     ,:Ｍ４０−充当開始年月                             
003770		     ,:Ｍ４０−充当月数                                 
003780		     ,:Ｍ４０−前払回収方法                             
003790		     ,:Ｍ４０−入金日                                   
003800		     ,:Ｍ４０−入金区分                                 
003810		     ,:Ｄ０１−取引先名称                               
003820		     ,:Ｄ０２−請求先名称                               
003830		     ,:Ｍ４０−前月末残高                               
003840		     ,:Ｍ４０−当月回収額                               
003850		     ,:Ｍ４０−当月消化額                               
003860		     ,:Ｍ４０−当月末残高
003870               ,:Ｍ４０−協調区分 
0038800              ,:Ｍ４０−前月末残高他社                          
003890               ,:Ｍ４０−当月回収額他社                              
003900               ,:Ｍ４０−当月消化額他社                           
003910               ,:Ｍ４０−当月他社解約分料金                       
003920               ,:Ｍ４０−当月他社解約分消費税                     
003930               ,:Ｍ４０−当月末残高他社                           
003940                                              
003950                                                                  
003960     END-EXEC.                                                                                                                    
003970* ------------------------------------------------------------ --*
003980*    結合テーブルカーソル読込を確認                              *
003990* ---------------------------------------------------------------*
004000     EVALUATE   SQLCODE                                           
004010        WHEN   定数−ＳＱＬＯＫ                                   
004020* --<       正常 >                                                                                                                 
004030            COMPUTE  Ｗ−入力−件数  =  Ｗ−入力−件数  +  1       
004040        WHEN   定数−ＳＱＬＥＮＤ                                 
004050* --<       読込終了 >                                             
004060            MOVE  "Y"                  TO  Ｗ−終了−フラグ        
004070        WHEN   OTHER                                              
004080* --<       読込エラー >                                           
004090            MOVE     -50               TO  Ｗ−エラーコード        
004100            PERFORM  エラー判定処理                                
004110     END-EVALUATE.                                                                                                               
004120 結合テーブルカーソル読込−ＥＸＩＴ.                              
004130     EXIT.                                                        
004140******************************************************************
004150*    主処理                                                      *
004160******************************************************************
004170 主処理                               SECTION.                    
004180 主処理−ＳＴＡＲＴ.                                              
004190                                                          
004200     PERFORM  項目名称抽出処理.                                                                                                   
004210     PERFORM  債権情報抽出処理.                                                                                                
004220	   PERFORM  出力判定処理.                                   
004230* --< 結合テーブルカーソル読込（２件目以降） >                     
004240     PERFORM  結合テーブルカーソル読込.                           
004250                                                                                                
004260 主処理−ＥＸＩＴ.                                                
004270     EXIT.                                                        
004280******************************************************************
004290*     項目名称マスタより項目の抽出処理                           *
004300******************************************************************
004310 項目名称抽出処理                      SECTION.                   
004320 項目名称抽出処理−ＳＴＡＲＴ.                                                                                                    
004330* ---------------------------------------------------------------*
004340*    項目名称マスタより主契約区分名称の抽出処理                  *
004350* ---------------------------------------------------------------*
004360     INITIALIZE                       項目名称マスタの名称.       
004370     EXEC SQL                                                     
004380         SELECT  名称                                           
004390           INTO  :ＷＳ−名称１                                  
004400           FROM  D19MSY_TBL                                                                                  
004410          WHERE  コードＮＯ  =  :ＷＳ−コードＮＯ１                
004420            AND  SUBSTR (コード,1,1)  =  :Ｍ４０−経理用主契約区分                     
004430     END-EXEC.                                                    
004440                                                                  
004450* ---------------------------------------------------------------*
004460*     項目名称マスタより主契約区分名称の抽出確認                 *
004470* ---------------------------------------------------------------*
004480     EVALUATE  SQLCODE                                            
004490         WHEN  定数−ＳＱＬＯＫ                                    
004500* --< 正常 >                                                  
004510             CONTINUE                                               
004520         WHEN    OTHER                                               
004530* --< 存在しない >                               
004540             MOVE -60                   TO  Ｗ−エラーコード        
004550             PERFORM  エラー判定処理                                
004560     END-EVALUATE.                                                
004570* ---------------------------------------------------------------*
004580*    項目名称マスタより顧客区分名称の抽出処理                                             *
004590* ---------------------------------------------------------------*
004600            
004610     EXEC SQL                                                     
004620           SELECT  名称                                           
004630             INTO  :ＷＳ−名称２                                  
004640             FROM  D19MSY_TBL                                                                                            
004650            WHERE  コードＮＯ  =  :ＷＳ−コードＮＯ２                
004660              AND  SUBSTR (コード,1,2) =              
004670		          :Ｍ４０−顧客区分                           
004680     END-EXEC.                                                    
004690                                                                  
004700* ---------------------------------------------------------------*
004710*     項目名称マスタより顧客区分名称の抽出確認                   *
004720* ---------------------------------------------------------------*
004730     EVALUATE  SQLCODE                                            
004740        WHEN  定数−ＳＱＬＯＫ                                    
004750* --< 正常 >                                                 
004760            CONTINUE                                               
004770        WHEN  OTHER                                               
004780* --< カーソルＯＰＥＮエラー >                               
004790            MOVE -70                   TO  Ｗ−エラーコード        
004800            PERFORM  エラー判定処理                                
004810     END-EVALUATE.                                                
004820*                                                                 
004830 項目名称抽出処理−ＥＸＩＴ.                                      
004840     EXIT.                                                        
004850******************************************************************
004860*     債権情報（一般）ＤＢより項目の抽出処理                     *
004870******************************************************************
004880 債権情報抽出処理                     SECTION.                    
004890 債権情報抽出処理−ＳＴＡＲＴ.                                    
004900*                                                                 
004910* ---------------------------------------------------------------*
004920*    債権情報抽出処理の抽出処理                                  *
004930* ---------------------------------------------------------------*
004940     INITIALIZE               Ｍ０１−状態フラグ   
004950			            Ｍ０１−債権契約件名
004960			            Ｍ０１−担保区分    .
004970
004980	   MOVE  SPACE          TO  Ｍ０１−状態フラグ  
004990				    Ｍ０１−債権契約件名
005000				    Ｍ０１−担保区分    
005010     EXEC SQL                                                     
005020           SELECT  M01SAJ_TBL.状態フラグ                          
005030                  ,M01SAJ_TBL.債権契約件名                        
005040			,M01SAJ_TBL.担保区分                            
005050             INTO  :Ｍ０１−状態フラグ                            
005060		        ,:Ｍ０１−債権契約件名                          
005070			,:Ｍ０１−担保区分                              
005080             FROM  M01SAJ_TBL                                     
005090                                                        
005100            WHERE  レコード区分  =     :ＷＳ−レコード区分               
005110              AND  契約番号      =     :Ｍ４０−契約番号    
005120	            AND  再リース回数  =     :Ｍ４０−再リース回数                     
005130	            AND  契約種類      =     :Ｍ４０−契約種類    
005140     END-EXEC.                                                    
005150                                                                  
005160* ---------------------------------------------------------------*
005170*     債権情報抽出処理の抽出確認                                 *
005180* ---------------------------------------------------------------*
005190     EVALUATE  SQLCODE                                            
005200        WHEN  定数−ＳＱＬＯＫ                                    
005210* --< 正常 >                                                 
005220            CONTINUE                                               
005230        WHEN  OTHER                                               
005240* --< カーソルＯＰＥＮエラー >                               
005250            MOVE -80                   TO  Ｗ−エラーコード        
005260            PERFORM  エラー判定処理                                
005270     END-EVALUATE.                                                
005280 債権情報抽出処理−ＥＸＩＴ.                                      
005290     EXIT.                                                        
005300******************************************************************
005310*    前受金受払残高中間ファイル出力判定処理                      *
005320******************************************************************
005330 出力判定処理                     SECTION.                    
005340 出力判定処理−ＳＴＡＲＴ.                                    
005350     IF Ｍ０１−担保区分  NOT = '1'                                                                                                
005360        PERFORM  自社分出力処理                                   
005370               IF  Ｍ４０−協調区分 =  '2'                              
005380                   PERFORM  他社分出力処理                                
005390               END-IF                                                      
005400     END-IF.                                                      
005410 出力判定処理−ＥＸＩＴ.                                      
005420     EXIT.                                                        
005430******************************************************************
005440*    自社分出力処理                                              *
005450******************************************************************
005460 自社分出力処理                         SECTION.                    
005470 自社分出力処理−ＳＴＡＲＴ.                                                                                                       
005480*                                                                 
005490      IF   Ｍ０１−状態フラグ  <  '3'                               
005500	       MOVE  '3'                     TO   出力−自他社区分       
005510      ELSE                                                        
005520         MOVE  '1'                     TO   出力−自他社区分.      
005530* --< 共通編集処理 >                                               
005540      PERFORM   共通編集処理.                                     
005550*                                                                 
005560      MOVE     Ｍ４０−前月末残高       TO   出力−前月末残高.      
005570      MOVE     Ｍ４０−当月回収額       TO   出力−当月入金額.      
005580      MOVE     Ｍ４０−当月消化額       TO   出力−当月消化額.      
005590      MOVE     Ｍ４０−当月末残高       TO   出力−当月末残高.      
005600* ---------------------------------------------------------------*
005610*     前受金受払残高中間ファイル出力処理                     *
005620* ---------------------------------------------------------------*
005630      PERFORM   受払残高中間ファイル出力.                             
005640 自社分出力処理−ＥＸＩＴ.                                        
005650     EXIT.                                                        
005660******************************************************************
005670*    他社分出力処理                                              *
005680******************************************************************
005690 他社分出力処理                       SECTION.                    
005700 他社分出力処理−ＳＴＡＲＴ.                                                                                                      
005710     IF   Ｍ０１−状態フラグ  <  '3'                               
005720         MOVE  '4'  TO   出力−自他社区分                          
005730     ELSE                                                         
005740         MOVE  '2'  TO   出力−自他社区分.                         
005750                                                                  
005760* --< 共通編集処理 >                                               
005770     PERFORM   共通編集処理.                                                                                                      
005780     MOVE     Ｍ４０−前月末残高       TO   出力−前月末残高.      
005790     MOVE     Ｍ４０−当月回収額       TO   出力−当月入金額.      
005800     COMPUTE  出力−当月消化額  =  Ｍ４０−当月消化額他社       
005810                                  +  Ｍ４０−当月他社解約分料金   
005820                                  +  Ｍ４０−当月他社解約分消費税.                                                                
005830     COMPUTE  出力−当月末残高  =  Ｍ４０−当月末残高他社       
005840                                  -  Ｍ４０−当月他社解約分料金   
005850                                  -  Ｍ４０−当月他社解約分消費税.
005860* ---------------------------------------------------------------*
005870*     前受金受払残高中間ファイル出力処理                         *
005880* ---------------------------------------------------------------*
005890     PERFORM   受払残高中間ファイル出力.                              
005900                                                                  
005910 他社分出力処理−ＥＸＩＴ.                                        
005920     EXIT.                                                        
005930
005940******************************************************************
005950*   前受金受払残高中間ファイル出力処理                           *
005960******************************************************************
005970 受払残高中間ファイル出力                 SECTION.                    
005980 受払残高中間ファイル出力−ＳＴＡＲＴ. 
005990
006000* --< 出力−レコード 初期化処理 >                                       
006010     MOVE  SPACE                TO  出力−レコード.            
006020     INITIALIZE                     出力−レコード.
006030
006040* --< 出力処理判定 >                                                                                           
006050     IF  出力−前月末残高      NOT =  ZERO                                 
006060         OR  出力−当月入金額  NOT =  ZERO                              
006070         OR  出力−当月消化額  NOT =  ZERO                              
006080         OR  出力−当月末残高  NOT =  ZERO                           
006090         WRITE  出力−レコード.                                                                                                    
006100* --< 出力の状態判定 >                                         
006110     EVALUATE  Ｗ−状態                                           
006120        WHEN  ZERO                                                
006130* --< 出力件数の加算 >                                    
006140            COMPUTE  Ｗ−出力−件数 =  Ｗ−出力−件数 + 1          
006150        WHEN  OTHER                                               
006160* --< ファイル出力エラー >                                   
006170           MOVE     -90               TO  Ｗ−エラーコード        
006180           PERFORM  エラー判定処理                                
006190     END-EVALUATE.                                                                                                                 
006200 受払残高中間ファイル出力−ＥＸＩＴ.                                  
006210     EXIT.                                                        
006220******************************************************************
006230*    共通編集処理                                                *
006240******************************************************************
006250 共通編集処理                           SECTION.                  
006260 共通編集処理−ＳＴＡＲＴ.                                        
006270* --< No.2 >                                                                
006280     MOVE  Ｍ４０−レコード区分       TO   出力−前受区分.
006290* --< No.3 >        
006300	   MOVE  Ｍ４０−経理用主契約区分   TO   出力−主契約区分.      
006310* --< No.4 >
006320	   MOVE  Ｍ４０−顧客区分           TO   出力−連結区分.        
006330* --< No.5 >
006340	   MOVE  Ｄ０１−名寄せコード       TO   出力−名寄せコード.    
006350* --< No.6 >
006360	   MOVE  Ｍ４０−請求先取引先コード TO   出力−取引先コード.    
006370* --< No.7 >
006380	   MOVE  Ｍ４０−請求先コード       TO   出力−請求先コード.    
006390* --< No.8 >
006400	   MOVE  Ｍ４０−契約番号           TO   出力−契約番号.        
006410* --< No.9 >
006420     MOVE  Ｍ４０−契約種類           TO   出力−契約種類.        
006430* --< No.10 >
006440     MOVE  Ｄ７０−バッチ用業務年月   TO   出力−業務年月.        
006450* --< No.11 >
006460     MOVE  Ｍ４０−担当部課コード     TO   出力−担当部課コード.  
006470* --< No.12 >
006480     MOVE  Ｍ０１−債権契約件名       TO   出力−契約件名.        
006490* --< No.13 >
006500     MOVE  Ｍ４０−再リース回数       TO   出力−再リース回数.    
006510* --< No.14 >
006520     MOVE  Ｍ４０−充当開始年月       TO   出力−充当開始年月.    
006530* --< No.15 >
006540     MOVE  Ｍ４０−充当月数           TO   出力−充当月数.        
006550* --< No.16 >
006560     MOVE  Ｍ４０−前払回収方法       TO   出力−前払回収方法.    
006570* --< No.17 >
006580     MOVE  Ｍ４０−入金日             TO   出力−入金日.          
006590* --< No.18 >
006600     MOVE  Ｍ４０−入金区分           TO   出力−入金区分.        
006610* --< No.19 >
006620     MOVE  Ｄ０１−取引先名称         TO   出力−取引先名称.      
006630* --< No.20 >
006640     MOVE  Ｄ０２−請求先名称         TO   出力−請求先名称.      
006650* --< No.21 >
006660     MOVE  ＷＳ−名称１               TO   出力−主契約区分名称.  
006670* --< No.22 >
006680     MOVE  ＷＳ−名称２               TO   出力−連結区分名称.    
006690                                                                 
006700 共通編集処理−ＥＸＩＴ.                                            
006710     EXIT.                                                        
006720******************************************************************
006730*    終了処理                                                    *
006740******************************************************************
006750 終了処理                             SECTION.                    
006760 終了処理−ＳＴＡＲＴ.                                            
006770*                                                                 
006780     PERFORM  ＤＢクローズ処理.                                   
006790*                                                                 
006800     PERFORM  ファイルクローズ処理.                               
006810*                                                                 
006820     PERFORM  件数メッセージ出力.                                 
006830*                                                                 
006840     PERFORM  終了メッセージ出力.                                 
006850*                                                                 
006860* --< プログラム正常終了 >                                         
006870     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
006880*                                                                 
006890 終了処理−ＥＸＩＴ.                                              
006900     EXIT.                                                        
006910******************************************************************
006920*    ＤＢクローズ                                                *
006930******************************************************************
006940 ＤＢクローズ処理                     SECTION.                    
006950 ＤＢクローズ処理−ＳＴＡＲＴ.                                                                                                     
006960* --< カーソル クローズ >                                          
006970     EXEC SQL                                                     
006980         CLOSE  CUR1                                               
006990     END-EXEC.                                                                                                                    
007000 ＤＢクローズ処理−ＥＸＩＴ.                                      
007010     EXIT.                                                        
007020******************************************************************
007030*    ファイルクローズ                                            *
007040******************************************************************
007050 ファイルクローズ処理                 SECTION.                    
007060 ファイルクローズ処理−ＳＴＡＲＴ.                                
007070                                                                
007080     CLOSE  出力ファイル.                                         
007090                                                          
007100 ファイルクローズ処理−ＥＸＩＴ.                                  
007110     EXIT.                                                                                                                        
007120******************************************************************
007130*     件数メッセージ出力処理                                     *
007140******************************************************************
007150 件数メッセージ出力                   SECTION.                    
007160 件数メッセージ出力−ＳＴＡＲＴ.                                  
007170* ---------------------------------------------------------------*
007180*    件数メッセージ出力処理                                      *
007190* ---------------------------------------------------------------*
007200     INITIALIZE                       IF-CHOCO001.                
007210     MOVE  "3"                        TO  共１−イベント種別.     
007220     MOVE  定数−プログラムＩＤ        TO  共１−ソースＩＤ.       
007230     MOVE  "0"                        TO  共１−復帰コード.       
007240     MOVE  "M40MAB_TBL"               TO  共１−処理テーブルＩＤ. 
007250     MOVE  "COUNT"                    TO  共１−処理識別.         
007260     MOVE  Ｗ−入力−件数              TO  共１−データ内容.       
007270     MOVE  " 前受情報テーブル（入力）"                            
007280                                      TO  共１−その他メッセージ. 
007290     CALL  CLOCO001                   USING  IF-CHOCO001.        
007300                                                          
007310     INITIALIZE                       IF-CHOCO001.                
007320     MOVE  "3"                        TO  共１−イベント種別.     
007330     MOVE  定数−プログラムＩＤ        TO  共１−ソースＩＤ.       
007340     MOVE  "0"                        TO  共１−復帰コード.       
007350     MOVE  "SFHSED25.U11"             TO  共１−処理テーブルＩＤ. 
007360     MOVE  "COUNT"                    TO  共１−処理識別.         
007370     MOVE  Ｗ−出力−件数              TO  共１−データ内容.       
007380     MOVE  "前受金受払残高ファイル"    TO  共１−その他メッセージ. 
007390     CALL  CLOCO001                   USING  IF-CHOCO001.         
007400 件数メッセージ出力−ＥＸＩＴ.                                    
007410     EXIT.                                                                                                                        
007420******************************************************************
007430*    終了メッセージ出力                                          *
007440******************************************************************
007450 終了メッセージ出力                   SECTION.                    
007460 終了メッセージ出力−ＳＴＡＲＴ.                                                                                                                                                  
007470* ---------------------------------------------------------------*
007480*    終了メッセージ出力                                          *
007490* ---------------------------------------------------------------*
007500     INITIALIZE                       IF-CHOCO001.                
007510     MOVE  "3"                        TO  共１−イベント種別.     
007520     MOVE  定数−プログラムＩＤ        TO  共１−ソースＩＤ.       
007530     MOVE  ZERO                       TO  共１−復帰コード.       
007540     MOVE  "END"                      TO  共１−処理識別.         
007550     MOVE  定数−プログラム名          TO  共１−その他メッセージ. 
007560     CALL  CLOCO001                   USING  IF-CHOCO001.   
007570                                                                                              
007580 終了メッセージ出力−ＥＸＩＴ.                                    
007590     EXIT.                                                        
007600******************************************************************
007610*    エラー処理                                                  *
007620******************************************************************
007630 エラー判定処理                       SECTION.                    
007640 エラー判定処理−ＳＴＡＲＴ.                                                                                                      
007650     MOVE  "Y"                        TO Ｗ−異常終了−フラグ.    
007660     INITIALIZE                           IF-CHOCO001.            
007670*                                                                 
007680     EVALUATE  Ｗ−エラーコード                                   
007690        WHEN  -10                                                 
007700* --<       ＯＲＡＣＬＥ接続失敗 >                                 
007710           MOVE  "1"                  TO  共１−イベント種別      
007720           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
007730           MOVE  "9"                  TO  共１−復帰コード        
007740           MOVE  "CONNECT"            TO  共１−処理識別          
007750           MOVE  SQLCODE              TO  共１−データ内容        
007760           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007770           CALL  CLOCO001             USING  IF-CHOCO001          
007780                                                          
007790        WHEN  -20                                                 
007800* --<       業務管理テーブル読込処理失敗 >                         
007810           MOVE  "1"                  TO  共１−イベント種別      
007820           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
007830           MOVE  "9"                  TO  共１−復帰コード        
007840           MOVE  "D70GYM"             TO  共１−処理テーブルＩＤ  
007850           MOVE  "SELECT"             TO  共１−処理識別          
007860           MOVE  SQLCODE              TO  共１−データ内容        
007870           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007880           CALL  CLOCO001             USING  IF-CHOCO001          
007890                                                                
007900        WHEN  -30                                                 
007910* --<      結合テーブルカーソル定義処理失敗 >                      
007920           MOVE  "1"                  TO  共１−イベント種別      
007930           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
007940           MOVE  "9"                  TO  共１−復帰コード        
007950           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
007960           MOVE  "SELECT"             TO  共１−処理識別          
007970           MOVE  SQLCODE              TO  共１−データ内容        
007980           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007990           CALL  CLOCO001             USING  IF-CHOCO001         
008000                                                                
008010        WHEN  -40                                                 
008020* --<      前受金受払残高中間ファイルオープンエラー >                                 
008030           MOVE  "1"                  TO  共１−イベント種別      
008040           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008050           MOVE  "9"                  TO  共１−復帰コード        
008060           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
008070           MOVE  "OPEN"               TO  共１−処理識別          
008080           MOVE  Ｗ−状態             TO  共１−データ内容        
008090           CALL  CLOCO001             USING  IF-CHOCO001          
008100                                                                
008110           WHEN  -50                                              
008120* --<      結合テーブルカーソル読込失敗 >                         
008130           MOVE  "1"                  TO  共１−イベント種別      
008140           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008150           MOVE  "9"                  TO  共１−復帰コード        
008160           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
008170           MOVE  "FETCH"              TO  共１−処理識別          
008180           MOVE  SQLCODE              TO  共１−データ内容        
008190           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008200           CALL  CLOCO001             USING  IF-CHOCO001          
008210                                                                
008220           WHEN  -60                                              
008230* --<     項目名称マスタより主契約区分名称の抽出確認失敗>              
008240           MOVE  "2"                  TO  共１−イベント種別      
008250           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008260           MOVE  "9"                  TO  共１−復帰コード        
008270           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
008280           MOVE  "SELECT"             TO  共１−処理識別          
008290           MOVE  SQLCODE              TO  共１−データ内容        
008300           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008310           CALL  CLOCO001             USING  IF-CHOCO001 
008320           MOVE  "N"                  TO  Ｗ−異常終了−フラグ         
008330                                                                 
008340           WHEN  -70                                              
008350* --<      項目名称マスタより顧客区分名称の抽出失敗 >              
008360           MOVE  "2"                  TO  共１−イベント種別      
008370           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008380           MOVE  "9"                  TO  共１−復帰コード        
008390           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
008400           MOVE  "SELECT"             TO  共１−処理識別          
008410           MOVE  SQLCODE              TO  共１−データ内容        
008420           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008430           CALL  CLOCO001             USING  IF-CHOCO001
008440           MOVE  "N"                  TO  Ｗ−異常終了−フラグ          
008450                                                                 
008460           WHEN  -80                                              
008470* --<      債権情報抽出処理の抽出確認 失敗 >                    
008480           MOVE  "2"                  TO  共１−イベント種別      
008490           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008500           MOVE  "9"                  TO  共１−復帰コード        
008510           MOVE  "M01SAJ"             TO  共１−処理テーブルＩＤ  
008520           MOVE  "SELECT"             TO  共１−処理識別          
008530           MOVE  SQLCODE              TO  共１−データ内容        
008540           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008550           CALL  CLOCO001             USING  IF-CHOCO001
008560           MOVE  "N"                  TO  Ｗ−異常終了−フラグ          
008570                                                                
008580           WHEN  -90                                              
008590* --<      共通前受金受払残高中間ファイル出力処理失敗 >         
008600           MOVE  "1"                  TO  共１−イベント種別      
008610           MOVE  定数−プログラムＩＤ  TO  共１−ソースＩＤ        
008620           MOVE  "9"                  TO  共１−復帰コード        
008630           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
008640           MOVE  "WRITE"              TO  共１−処理識別          
008650           MOVE  SQLCODE              TO  共１−データ内容        
008660           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008670           CALL  CLOCO001             USING  IF-CHOCO001 
008680         
008690        WHEN  OTHER                                               
008700           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
008710     END-EVALUATE.                                                
008720                                                                 
008730     IF Ｗ−異常終了−フラグ  =  "Y"
008740        PERFORM       件数メッセージ出力                                                   
008750        PERFORM       終了メッセージ出力                                                                                                                            
008760* --<    プログラム異常終了のリターンコード >                      
008770        MOVE  定数−異常状態          TO  PROGRAM-STATUS                                                                           
008780        EXIT  PROGRAM                                             
008790     END-IF.                                                                                                                       
008800 エラー処理−ＥＸＩＴ.                                            
008810     EXIT.                                                                               
008820******************************************************************
008830*                  END OF PROGRAM                                *
008840****************************************************************** 
