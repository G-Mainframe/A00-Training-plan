000010******************************************************************
000020*         ＜海輝軟件(大連)＞                                     *
000030*      1. プログラム名  : 前受金受払残高ファイル作成             *
000040*      2. プログラムID  : AAASED25(抽出)                         *
000050*      3. 処理概要      : 経理締処理（帳票作成）                 *
000060*                       （リース前受関連帳票抽出）               *
000070*                                                                *
000080*      4. 作成者        : 趙遠方                                 *
000090*      5. 作成日        : 2005.03.                               *
000100******************************************************************
000110*                                                                 
000120******************************************************************
000130*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000140******************************************************************
000150 IDENTIFICATION                       DIVISION.                   
000160*                                                                 
000170 PROGRAM-ID.                          AAASED25.                   
000180******************************************************************
000190*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000200******************************************************************
000210 ENVIRONMENT                          DIVISION.                   
000211******************************************************************
000212*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000213******************************************************************
000214 INPUT-OUTPUT                         SECTION.                    
000215*                                                                 
000216 FILE-CONTROL.                                                    
000217     SELECT    出力ファイル           ASSIGN    TO     U11        
000218     FILE      STATUS     IS          Ｗ−状態                    
000219     ORGANIZATION         IS          LINE      SEQUENTIAL.       
000220                                                                  
000221******************************************************************
000230*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000240******************************************************************
000250 DATA                                 DIVISION.                   
000252******************************************************************
000253*    ＦＩＬＥ                      ＳＥＣＴＩＯＮ                *
000254******************************************************************
000255 FILE                                 SECTION.                    
000256*----------------------------------------------------------------*
000257*    出力ファイル                                                *
000258*----------------------------------------------------------------*
000259 FD  出力ファイル                                                 
000260     LABEL     RECORD     IS          STANDARD                    
000261     BLOCK     CONTAINS   0           RECORDS.                    
000262*                                                                 
000263 01  出力−レコード.                                              
000264     COPY      CPSCE50    REPLACING  ==()==  BY  ==出力−==.      
000265*                                                                 
000267******************************************************************
000270*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000280******************************************************************
000290  WORKING-STORAGE                     SECTION.                    
000300*----------------------------------------------------------------*
000310*    ホスト変数定義エリア                                        *
000320*----------------------------------------------------------------*
000330     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000340*                                                                 
000341 01  ＷＳ−名称１                     PIC  X(60).                 
000342 01  ＷＳ−名称２                     PIC  X(60).                 
000343*                                                                 
000350*--< ＯＲＡＣＬＥ共通変数 >                                       
000360     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000370*                                                                 
000380*--< ＯＲＡＣＬＥ  ＳＱＬ実行情報 >                               
000390     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000400*                                                                 
000410*--< 前受情報ＤＢ >                                               
000420     EXEC  SQL  INCLUDE  M40MAB.CBL            END-EXEC.          
000430*                                                                 
000440*--< 業務管理テーブル >                                           
000450     EXEC  SQL  INCLUDE  D70GYM.CBL            END-EXEC.          
000460*                                                                 
000470*--< 取引先マスタ>                                                
000480     EXEC  SQL  INCLUDE  D01TRS.CBL            END-EXEC.          
000481*                                                                 
000482*--< 請求先マスタ >                                               
000483     EXEC  SQL  INCLUDE  D02SQS.CBL            END-EXEC.          
000484*                                                                 
000485*--< 項目名称マスタ >                                             
000486     EXEC  SQL  INCLUDE  D19MSY.CBL            END-EXEC.          
000487*                                                                 
000488*--< 債権情報（一般）ＤＢ>                                        
000489     EXEC  SQL  INCLUDE  M01SAJ.CBL            END-EXEC.          
000491*                                                                 
000500     EXEC  SQL  END  DECLARE          SECTION  END-EXEC.          
000510*                                                                 
000520*----------------------------------------------------------------*
000530*    ＷＯＲＫエリア                                              *
000540*----------------------------------------------------------------*
000550 01  ＷＯＲＫ−エリア.                                            
000560*--< エラー判定用 >                                               
000570     03  Ｗ−エラーコード             PIC S9(04).
           03  Ｗ−状態                     PIC X(01).
000580*                                                                 
000590*--< フラグアリア >                                               
000600     03  フラグアリア.                                            
000610         05  Ｗ−終了−フラグ         PIC  X(01).                 
000620         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
000630*                                                                 
000640*--< 件数エリア >                                                 
000650     03  件数エリア.                                              
000660         05  Ｗ−入力−件数           PIC  9(09).                 
000670         05  Ｗ−出力−件数           PIC  9(09).                 
000810*                                                                 
000820*--< 共通情報 >                                                   
000830 01  Ｗ−共通情報.                                                
000840     03  Ｗ−システム日付.                                        
000850         05  Ｗ−世紀                 PIC  X(02) VALUE  "20".     
000860         05  Ｗ−年月日               PIC  X(06).                 
000870     03  Ｗ−システム時刻             PIC  X(08).                 
000880     03  Ｗ−担当者                   PIC  X(08) VALUE "IKOPG   ".
000890*                                                                 
000900*----------------------------------------------------------------*
000910*    サブルーチン名                                              *
000920*----------------------------------------------------------------*
000930 01  CALL-AREA.                                                   
000940*--< 共通ログサブルーチン >                                       
000950     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
000960     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
000970*                                                                 
000980*----------------------------------------------------------------*
000990*    ＣＯＰＹ領域                                                *
001000*----------------------------------------------------------------*
001010*--< 共通ログ用パラメータ >                                       
001020 01  IF-CHOCO001.                                                 
001030     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
001040*                                                                 
001050*----------------------------------------------------------------*
001060*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001070*----------------------------------------------------------------*
001080 01  PARA-AREA.                                                   
001090     COPY CPBCO001.                                               
001100******************************************************************
001110*    定数用データ定義エリア                                      *
001120******************************************************************
001130 CONSTANT                             SECTION.                    
001140 01  定数領域.                                                    
001150     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
001160     03  定数−プログラム名           PIC  X(80)                  
001170                                      VALUE 
001171                                    "前受金受払残高ファイル作成". 
001180     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001190     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001200     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001210     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001221******************************************************************
001222*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001223******************************************************************
001224 PROCEDURE                            DIVISION.                   
001225*                                                                 
001226     PERFORM  初期処理.                                           
001227*                                                                 
001228     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001229*                                                                 
001230     PERFORM  終了処理.                                           
001231*                                                                 
001232     STOP     RUN.                                                
001233*                                                                 
001234******************************************************************
001235*    初期処理                                                    *
001236******************************************************************
001237 初期処理                             SECTION.                    
001238 初期処理−ＳＴＡＲＴ.                                            
001239*                                                                 
001240*----------------------------------------------------------------*
001241*    開始メッセージ出力処理                                      *
001242*----------------------------------------------------------------*
001243     INITIALIZE                       IF-CHOCO001.                
001244     MOVE  "3"                        TO  共１−イベント種別.     
001245     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001246     MOVE  "0"                        TO  共１−復帰コード.       
001247     MOVE  "START"                    TO  共１−処理識別.         
001248     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001249     CALL  CLOCO001                USING  IF-CHOCO001.            
001250*                                                                 
001251*----------------------------------------------------------------*
001252*    作業領域の初期値処理                                        *
001253*----------------------------------------------------------------*
001254     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001255     INITIALIZE                           ＷＯＲＫ−エリア.       
001258*                                                                 
001259*--< ＣＰＵ日付を取得 >                                           
001260     ACCEPT  Ｗ−年月日               FROM  DATE.                 
001261*                                                                 
001262*--< ＣＰＵ時刻を取得 >                                           
001263     ACCEPT  Ｗ−システム時刻         FROM  TIME.                 
001264*                                                                 
001265*--< ＯＲＡＣＬＥ接続 >                                           
001266     PERFORM  ＯＲＡＣＬＥ接続.                                   
001267*                                                                 
001269*--<  業務管理テーブル読込 >                                      
001270     PERFORM   業務管理テーブル読込.                              
001271*                                                                 
001272*--< 結合テーブルカーソル定義 >                                   
001273     PERFORM  結合テーブルカーソル定義.                           
001274*                                                                 
001275*--<前受金受払残高中間フアイルオーフン >                          
001276     PERFORM  フアイルオーフン.                                   
001277*                                                                 
001278*--< 結合テーブルカーソル読込(１件目) >                           
001279     PERFORM  結合テーブルカーソル読込.                           
001280*                                                                 
001281 初期処理−ＥＸＩＴ.                                              
001282     EXIT.                                                        
001283******************************************************************
001284*    ＯＲＡＣＬＥ接続                                            *
001285******************************************************************
001286 ＯＲＡＣＬＥ接続                     SECTION.                    
001287 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
001288*                                                                 
001289*--< ＤＢ接続用情報を取得処理 >                                   
001290     CALL  COBCO001                USING  PARA-AREA.              
001291*                                                                 
001292     MOVE  PARA-DBSTRING              TO  DB-STRING.              
001293     MOVE  PARA-USERNAME              TO  USERNAME.               
001294     MOVE  PARA-PASSWORD              TO  PASSWD.                 
001295*                                                                 
001296*----------------------------------------------------------------*
001297*    開始接続                                                    *
001298*----------------------------------------------------------------*
001299     IF    DB-STRING  =  SPACE                                    
001300        EXEC SQL                                                  
001301           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
001302        END-EXEC                                                  
001303     ELSE                                                         
001304        EXEC SQL                                                  
001305           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
001306             USING  :DB-STRING                                    
001307        END-EXEC                                                  
001308     END-IF.                                                      
001309*                                                                 
001310*----------------------------------------------------------------*
001311*    接続確認                                                    *
001312*----------------------------------------------------------------*
001313     EVALUATE  SQLCODE                                            
001314        WHEN   定数−ＳＱＬＯＫ                                   
001315           CONTINUE                                               
001316        WHEN   OTHER                                              
001317*--<       接続エラー >                                           
001318           MOVE     -10               TO  Ｗ−エラーコード        
001319           PERFORM  エラー判定処理                                
001320     END-EVALUATE.                                                
001321*                                                                 
001322 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
001323     EXIT.                                                        
001324******************************************************************
001325*        業務管理テーブル読込				       *
001326******************************************************************
001327 業務管理テーブル読込             SECTION.                        
001328 業務管理テーブル読込−ＳＴＡＲＴ.                                
001329     EXEC  SQL                                                    
001330           SELECT  バッチ用業務年月                               
001331             INTO  :Ｄ７０−バッチ用業務年月                      
001332             FROM  D70GYM_TBL                                     
001333            WHERE  業務管理ＩＤ = 'GYMKNRRC'                      
001334     END-EXEC.                                                    
001335*----------------------------------------------------------------*
001336*   業務管理テーブル読込確認                                     *
001337*----------------------------------------------------------------*
001338*                                                                 
001339        EVALUATE  SQLCODE                                         
001340        WHEN  定数−ＳＱＬＯＫ                                    
001341*--<       正常 >                                                 
001342           CONTINUE                                               
001343        WHEN  OTHER                                               
001344*--<       ＯＰＥＮエラー >                                       
001345           MOVE -20                   TO  Ｗ−エラーコード        
001346           PERFORM  エラー判定処理                                
001347     END-EVALUATE.                                                
001348*                                                                 
001349 業務管理テーブル読込−ＥＸＩＴ.                                 
001350     EXIT.                                                        
001364******************************************************************
001365*        結合テーブルカーソル定義                                *
001366******************************************************************
001367 結合テーブルカーソル定義             SECTION.                    
001368 結合テーブルカーソル定義−ＳＴＡＲＴ.                            
001369*                                                                 
001370*----------------------------------------------------------------*
001371*    カーソルＯＰＥＮ処理                                        *
001372*----------------------------------------------------------------*
001373     EXEC SQL                                                     
001374        DECLARE CUR1  CURSOR FOR                                  
001375           SELECT  M40MAB_TBL.レコード区分                        
001376                  ,M40MAB_TBL.経理用主契約区分                    
001377                  ,M40MAB_TBL.顧客区分                            
001378                  ,D01TRS_TBL.名寄せコード                        
001379                  ,M40MAB_TBL.請求先取引先コード                  
001380                  ,M40MAB_TBL.請求先コード                        
001381                  ,M40MAB_TBL.契約番号                            
001382                  ,M40MAB_TBL.契約種類                            
001383                  ,M40MAB_TBL.担当部課コード                      
001384                  ,M40MAB_TBL.再リース回数                        
001385                  ,M40MAB_TBL.充当開始年月                        
001386                  ,M40MAB_TBL.充当月数                            
001387                  ,M40MAB_TBL.前払回収方法                        
001388                  ,M40MAB_TBL.入金日                              
001389                  ,M40MAB_TBL.入金区分                            
001390                  ,D01TRS_TBL.取引先名称                          
001391                  ,D02SQS_TBL.請求先名称                          
001392                  ,M40MAB_TBL.前月末残高                          
001393                  ,M40MAB_TBL.当月回収額                          
001394                  ,M40MAB_TBL.当月消化額                          
001395                  ,M40MAB_TBL.当月末残高                          
001396                  ,M40MAB_TBL.協調区分                            
001397                  ,M40MAB_TBL.前月末残高他社                      
001398                  ,M40MAB_TBL.当月回収額他社                      
001399                  ,M40MAB_TBL.当月消化額他社                      
001400                  ,M40MAB_TBL.当月他社解約分料金                  
001401                  ,M40MAB_TBL.当月他社解約分消費税                
001402                  ,M40MAB_TBL.当月末残高他社                                              
001403             FROM  M40MAB_TBL                                     
001404                  ,D02SQS_TBL                                     
001405                  ,D01TRS_TBL                                     
001406            WHERE  M40MAB_TBL.前受金受払残高表対象フラグ =  '1'   
001407              AND  M40MAB_TBL.請求先取引先コード =                
001408                                      D01TRS_TBL.取引先コード (+) 
001409              AND  M40MAB_TBL.請求先取引先コード =                
001410                                      D02SQS_TBL.取引先コード (+) 
001411              AND  M40MAB_TBL.請求先コード       =                
001412                                      D02SQS_TBL.請求先コード (+) 
001413         ORDER BY  M40MAB_TBL.レコード区分                        
001414                  ,M40MAB_TBL.契約番号                            
001415     END-EXEC.                                                    
001416*----------------------------------------------------------------*
001417*    カーソルＯＰＥＮ                                            *
001418*----------------------------------------------------------------*
001419     EXEC  SQL                                                    
001420        OPEN  CUR1                                                
001421     END-EXEC.                                                    
001422*                                                                 
001423*----------------------------------------------------------------*
001424*    カーソルＯＰＥＮ確認                                        *
001425*----------------------------------------------------------------*
001426     EVALUATE  SQLCODE                                            
001427        WHEN  定数−ＳＱＬＯＫ                                    
001428*--<       正常 >                                                 
001429           CONTINUE                                               
001430        WHEN  OTHER                                               
001431*--<       カーソルＯＰＥＮエラー >                               
001432           MOVE -30                   TO  Ｗ−エラーコード        
001433           PERFORM  エラー判定処理                                
001434     END-EVALUATE.                                                
001435*                                                                 
001436 結合テーブルカーソル定義−ＥＸＩＴ.                              
001437     EXIT.                                                        
001438******************************************************************
001439*    前受金受払残高中間フアイルオーフン                          *
001440******************************************************************
001441 フアイルオーフン                     SECTION.                    
001442 フアイルオーフン−ＳＴＡＲＴ.                                    
001443*                                                                 
001444*--< フアイルオーフ >                                             
001445     OPEN  OUTPUT  出力ファイル.                                   
001446*----------------------------------------------------------------*
001447*    フアイルオーフ 確認                                         *
001448*----------------------------------------------------------------*
001449     EVALUATE  SQLCODE                                            
001450        WHEN  定数−ＳＱＬＯＫ                                    
001451*--<       正常 >                                                 
001452           CONTINUE                                               
001453                                                                  
001454        WHEN  OTHER                                               
001455*--<       フアイルオーフエラー >                                 
001456           MOVE -40                   TO  Ｗ−エラーコード        
001457           PERFORM  エラー判定処理                                
001458     END-EVALUATE.                                                
001459*                                                                 
001460 フアイルオーフ−ＥＸＩＴ.                                        
001461     EXIT.                                                        
001462******************************************************************
001463*    結合テーブルカーソル読込                                    *
001464******************************************************************
001465 結合テーブルカーソル読込             SECTION.                    
001466 結合テーブルカーソル読込−ＳＴＡＲＴ.                            
001467*                                                                 
001468*--< 結合テーブルカーソル読込 >                                   
001469     EXEC SQL                                                     
001470         FETCH  CUR1                                              
001471          INTO  :Ｍ４０−レコード区分                             
001472               ,:Ｍ４０−経理用主契約区分                         
001473               ,:Ｍ４０−顧客区分                                 
001474               ,:Ｄ０１−名寄せコード                             
001475               ,:Ｍ４０−請求先取引先コード                       
001476               ,:Ｍ４０−請求先コード                             
001477               ,:Ｍ４０−契約番号                                 
001478               ,:Ｍ４０−契約種類                                 
001479               ,:Ｄ７０−バッチ用業務年月                         
001480               ,:Ｍ４０−担当部課コード                           
001481               ,:Ｍ４０−再リース回数                             
001482               ,:Ｍ４０−充当開始年月                             
001483               ,:Ｍ４０−充当月数                                 
001484               ,:Ｍ４０−前払回収方法                             
001485               ,:Ｍ４０−入金日                                   
001486               ,:Ｍ４０−入金区分                                 
001487               ,:Ｄ０１−取引先名称                               
001488               ,:Ｄ０２−請求先名称                               
001489               ,:Ｍ４０−前月末残高                               
001490               ,:Ｍ４０−当月回収額                               
001491               ,:Ｍ４０−当月消化額                               
001492               ,:Ｍ４０−当月末残高                               
001493     END-EXEC.                                                    
001494*                                                                 
001495*----------------------------------------------------------------*
001496*   結合テーブルカーソル読込を確認                               *
001497*----------------------------------------------------------------*
001498     EVALUATE  SQLCODE                                            
001499        WHEN  定数−ＳＱＬＯＫ                                    
001500*--<       正常 >                                                 
001501           CONTINUE                                               
001502*--<       読込終了 >                                             
001503        WHEN  定数−ＳＱＬＥＮＤ                                  
001504           MOVE "Y"                   TO  Ｗ−終了−フラグ        
001505        WHEN  OTHER                                               
001506*--<       カーソルＯＰＥＮエラー >                               
001507           MOVE -50                   TO  Ｗ−エラーコード        
001508           PERFORM  エラー判定処理                                
001509     END-EVALUATE.                                                
001510*                                                                 
001511 結合テーブルカーソル読込−ＥＸＩＴ.                              
001512     EXIT.                                                        
001513*                                                                 
001514******************************************************************
001515*    主処理                                                      *
001516******************************************************************
001517 主処理                               SECTION.                    
001518 主処理−ＳＴＡＲＴ.                                              
001519*                                                                 
001520*--<項目名称マスタより項目の抽出処理 >                            
001521     PERFORM  項目名称抽出処理                                    
001522*                                                                 
001523*--<債権情報（一般）ＤＢより項目の抽出処理 >                      
001524     PERFORM  債権情報抽出処理					
001525*                                                                 
001526*--<前受金受払残高中間ファイル出力判定処理  > 			
001527     IF   Ｍ０１−担保区分  NOT = "1"                             
001528        PERFORM  前受金編集出力                                   
001529     END-IF.                                                      
001530*--< 結合テーブルカーソル読込（２件目以降） >                     
001531     PERFORM  結合テーブルカーソル読込.                           
001532*                                                                 
001533     IF  Ｗ−終了−フラグ  =  "Y"                                 
001534*--<    入力データ終わる時最後出力処理 >                          
001535        PERFORM 前受金出力処理                                    
001536     END-IF.                                                      
001537*                                                                 
001538 主処理−ＥＸＩＴ.                                                
001539     EXIT.                                                        
001540******************************************************************
001541*     項目名称マスタより項目の抽出処理                           *
001542******************************************************************
001543 項目名称抽出処理                    SECTION.                     
001544 項目名称抽出処理−ＳＴＡＲＴ.                                    
001545*----------------------------------------------------------------*
001546*       項目名称マスタより主契約区分名称の抽出処理	       *
001547*----------------------------------------------------------------*
001548     EXEC  SQL                                                    
001549           SELECT  名称                                           
001550             INTO  ＷＳ−名称１                                   
001551             FROM  D19MSY_TBL                                     
001552            WHERE  コードＮＯ = '038'                             
001553              AND  SUBSTR(コードＮＯ,1,1) =                       
001554                                      : Ｍ４０−経理用主契約区分  
001555     END-EXEC.                                                    
001556*                                                                 
001557*----------------------------------------------------------------*
001558*  項目名称マスタより主契約区分名称の抽出 ＯＰＥＮ確認           *
001559*----------------------------------------------------------------*
001560     EVALUATE   SQLCODE                                           
001561        WHEN   定数−ＳＱＬＯＫ                                   
001562*--<       正常の時 >                                             
001563           CONTINUE                                               
001564        WHEN   OTHER                                              
001565*--<       存在しない >                                           
001566           MOVE     SPACE             TO  ＷＳ−名称１            
001567           MOVE     -60               TO  Ｗ−エラーコード        
001568           PERFORM  エラー判定処理                                
001569     END-EVALUATE.                                                
001570                                                                  
001571*----------------------------------------------------------------*
001572*       項目名称マスタより顧客区分名称の抽出処理		       *
001573*----------------------------------------------------------------*
001574     EXEC  SQL                                                    
001575           SELECT  名称                                           
001576             INTO  ＷＳ−名称２                                   
001577             FROM  D19MSY_TBL                                     
001578            WHERE  コードＮＯ = '005'                             
001579              AND  SUBSTR(コードＮＯ,1,2) =                       
001580                                      :Ｍ４０−顧客区分           
001581     END-EXEC.                                                    
001582*----------------------------------------------------------------*
001583*   項目名称マスタより顧客区分名称の抽出処理確認                 *
001584*----------------------------------------------------------------*
001585      EVALUATE   SQLCODE                                          
001586        WHEN   定数−ＳＱＬＯＫ                                   
001587*--<       正常の時 >                                             
001588           CONTINUE                                               
001589        WHEN   OTHER                                              
001590*--<       存在しない >                                           
001591           MOVE     SPACE             TO  ＷＳ−名称２            
001592           MOVE     -60               TO  Ｗ−エラーコード        
001593           PERFORM  エラー判定処理                                
001594     END-EVALUATE.                                                
001595*                                                                 
001596 項目名称抽出処理−ＥＸＩＴ.                                      
001597     EXIT.                                                        
001598******************************************************************
001599*     債権情報（一般）ＤＢより項目の抽出処理	               *
001600******************************************************************
001601 債権情報抽出処理                     SECTION.                    
001602 債権情報抽出処理−ＳＴＡＲＴ.                                    
001603     EXEC  SQL                                                    
001604           SELECT  M01SAJ_TBL.状態フラグ                          
001605                  ,M01SAJ_TBL.債権契約件名                        
001606                  ,M01SAJ_TBL.担保区分                            
001607             INTO :Ｍ０１−状態フラグ                             
001608                 ,:Ｍ０１−債権契約件名                           
001609                 ,:Ｍ０１−担保区分                               
001610             FROM  M01SAJ_TBL                                     
001611            WHERE  レコード区分 = '1'                             
001612              AND  契約番号 = :Ｍ４０−契約番号                   
001613              AND  再リース回数 = :Ｍ４０−再リース回数           
001614              AND  契約種類 = :Ｍ４０−契約種類                   
001615      END-EXEC.                                                    
001616*----------------------------------------------------------------*
001617*   債権情報（一般）ＤＢより項目の抽出処理確認                   *
001618*----------------------------------------------------------------*
001621     EVALUATE   SQLCODE                                              
001622        WHEN   定数−ＳＱＬＯＫ                                   
001623*--<       正常の時 >                                             
001624           CONTINUE                                               
001625        WHEN   OTHER                                              
001626*--<       存在しない >                                           
001627           MOVE     SPACE             TO  Ｍ０１−状態フラグ      
001628           MOVE     SPACE             TO  Ｍ０１−債権契約件名    
001629           MOVE     SPACE             TO  Ｍ０１−担保区分        
001630           MOVE     -70               TO  Ｗ−エラーコード        
001631           PERFORM  エラー判定処理                                
001632     END-EVALUATE.                                                
001633*                                                                 
001634 債権情報抽出処理−ＥＸＩＴ.                                      
001635     EXIT.                                                        
001636******************************************************************
001637*     前受金受払残高中間ファイル編集出力処理		       *
001638******************************************************************
001639 前受金編集出力                       SECTION.                    
001640 前受金編集出力−ＳＴＡＲＴ.                                      
001641*--<出力−レコード 初期化処理 >                                   
001642*                                                                 
001644     MOVE  SPACE                      TO  出力−レコード            
001645     INITIALIZE                           出力−レコード          
001646*                                                                 
001650*--< 自社分個別の編集 >                                           
001651     PERFORM  自社分編集.                                      
001652*                                                                 
001655*--< 自社分出力判定 >                                             
001656     IF      出力−前月末残高  NOT  =  0                       
001657         OR   出力−当月入金額  NOT  =  0                       
001658         OR   出力−当月消化額  NOT  =  0                       
001659         OR   出力−当月末残高  NOT  =  0                       
001660         PERFORM  前受金出力処理.                               
001663*                                                                 
001664*--< 他社分個別の編集 >                                           
001665*                                                                 
001666     IF  Ｍ４０−協調区分 = "2"                                
001667         PERFORM  他社分編集出力.                               
001668 前受金受払残高中間ファイル編集出力−ＥＸＩＴ.                   
001669     EXIT.                                                     
001670*                                                                 
001673******************************************************************
001674*        自社分編集		                               *
001675******************************************************************
001676*                                                                 
001677 自社分編集                           SECTION.                    
001678 自社分編集−ＳＴＡＲＴ.                                          
001679*--<    No.01 >                                                   
001680        IF  Ｍ０１−状態フラグ < 3                                
001681              MOVE   3                TO  出力−自他社区分        
001682        ELSE                                                      
001683              MOVE   1                TO  出力−自他社区分        
001684        END-IF.                                                   
001685*                                                                 
001686*--<    No.02 >                                                   
001687        MOVE  Ｍ４０−レコード区分    TO  出力−前受区分.         
001688*                                                                 
001696*--<    No.03 >                                                   
001697        MOVE  Ｍ４０−経理用主契約区分                            
001698                                      TO  出力−主契約区分.       
001699*                                                                 
001700*--<    No.04 >                                                   
001701        MOVE  Ｍ４０−顧客区分        TO  出力−連結区分.         
001702*                                                                 
001703*--<    No.05 >                                                   
001704        MOVE  Ｄ０１−名寄せコード    TO  出力−名寄せコード.     
001705*                                                                 
001706*--<    No.06 >                                                   
001707        MOVE  Ｍ４０−請求先取引先コード                          
001708                                      TO  出力−取引先コード.     
001709*                                                                 
001710*--<    No.07 >                                                   
001711        MOVE  Ｍ４０−請求先コード    TO  出力−請求先コード.     
001712*                                                                 
001713*--<    No.08 >                                                   
001714        MOVE  Ｍ４０−契約番号        TO  出力−契約番号.         
001715*                                                                 
001716*--<    No.09 >                                                   
001717        MOVE  Ｍ４０−契約種類        TO  出力−契約種類.         
001718*                                                                 
001719*--<    No.10 >                                                   
001720        MOVE  Ｄ７０−バッチ用業務年月                            
001721                                      TO  出力−業務年月.         
001722*                                                                 
001723*--<    No.11 >                                                   
001724        MOVE  Ｍ４０−担当部課コード  TO  出力−担当部課コード.   
001725*                                                                 
001726*--<    No.12 >                                                   
001727        MOVE  Ｍ０１−債権契約件名    TO  出力−契約件名.         
001728*                                                                 
001729*--<    No.13 >                                                   
001730        MOVE  Ｍ４０−再リース回数    TO  出力−再リース回数.     
001731*                                                                 
001732*--<    No.14 >                                                   
001733        MOVE  Ｍ４０−充当開始年月    TO  出力−充当開始年月.     
001734*                                                                 
001735*--<    No.15 >                                                   
001736        MOVE  Ｍ４０−充当月数        TO  出力−充当月数.         
001737*                                                                 
001738*--<    No.16 >                                                   
001739        MOVE  Ｍ４０−前払回収方法    TO  出力−前払回収方法.     
001740*                                                                 
001741*--<    No.17 >                                                   
001742        MOVE  Ｍ４０−入金日          TO  出力−入金日.           
001743*                                                                 
001744*--<    No.18 >                                                   
001745        MOVE  Ｍ４０−入金区分        TO  出力−入金区分.         
001746*                                                                 
001747*--<    No.19 >                                                   
001748        MOVE  Ｄ０１−取引先名称      TO  出力−取引先名称.       
001749*                                                                 
001750*--<    No.20 >                                                   
001751        MOVE  Ｄ０２−請求先名称      TO  出力−請求先名称.       
001752*                                                                 
001753*--<    No.21 >                                                   
001754        MOVE  ＷＳ−名称１            TO  出力−主契約区分名称.   
001755*                                                                 
001756*--<    No.22 >                                                   
001757        MOVE  ＷＳ−名称２            TO  出力−連結区分名称.     
001758*                                                                 
001759*--<    No.23 >                                                   
001760        MOVE  Ｍ４０−前月末残高      TO  出力−前月末残高.       
001761*                                                                 
001762*--<    No.24 >                                                   
001763        MOVE  Ｍ４０−当月回収額      TO  出力−当月入金額.       
001764*                                                                 
001766*--<    No.25 >                                                   
001767        MOVE  Ｍ４０−当月消化額      TO  出力−当月消化額.       
001768*                                                                 
001769*--<    No.26 >                                                   
001770        MOVE  Ｍ４０−当月末残高      TO  出力−当月末残高.       
001774                                                                  
001775 自社分編集−ＥＸＩＴ.                                            
001776     EXIT.                                                        
001777******************************************************************
001778*    他社分個別部分の編集出力                                    *
001779******************************************************************
001780 他社分編集出力                       SECTION.                    
001781 他社分編集出力−ＳＴＡＲＴ.                                      
001782*                                                                 
001783*--<    No.01 >                                                   
001784        IF   Ｍ０１−状態フラグ < 3                               
001785            MOVE  4                   TO  出力−自他社区分        
001786        ELSE                                                      
001787            MOVE  2                   TO  出力−自他社区分        
001788        END-IF.                                                   
001789*--<    No.23 >                                                   
001790        MOVE  Ｍ４０−前月末残高他社  TO  出力−前月末残高.       
001791*                                                                 
001792*--<    No.24 >                                                   
001793        MOVE  Ｍ４０−当月回収額他社  TO  出力−当月入金額.       
001794*                                                                 
001795*--<    No.25 >                                                   
001796        COMPUTE  出力−当月消化額 =  Ｍ４０−当月消化額他社       
001797                                  +  Ｍ４０−当月他社解約分料金   
001798                                  +  Ｍ４０−当月他社解約分消費税.
001799*--<    No.26 >                                                   
001800     COMPUTE  出力−当月末残高 =  Ｍ４０−当月末残高他社       
001801                               -  Ｍ４０−当月他社解約分料金   
001802                               -  Ｍ４０−当月他社解約分消費税.
001803*--< 他社分出力判定 >                                             
001804     IF      出力−前月末残高  NOT  =  0                       
001805            OR  出力−当月入金額  NOT  =  0                       
001806            OR  出力−当月消化額  NOT  =  0                       
001807            OR  出力−当月末残高  NOT  =  0                       
001808     PERFORM  前受金出力処理                                   
001809     END-IF.                                                   
001810*                                                                 
001811 他社分編集出力−ＥＸＩＴ.                                      
001812     EXIT.                                                     
001813******************************************************************
001814*            前受金出力処理                                      *
001815******************************************************************
001816 前受金出力処理                       SECTION.                    
001817 前受金出力処理−ＳＴＡＲＴ.                                      
001818     WRITE  出力−レコード.                                         
001872*----------------------------------------------------------------*
001873*    追加処理を確認                                              *
001874*----------------------------------------------------------------*
001875     EVALUATE  SQLCODE                                            
001876        WHEN   定数−ＳＱＬＯＫ                                   
001877*--<       追加成功 >                                             
001878           COMPUTE  Ｗ−出力−件数  =  Ｗ−出力−件数  +  1       
001879        WHEN   OTHER                                              
001880*--<       追加処理エラー >                                       
001881           MOVE     -80               TO  Ｗ−エラーコード        
001882           PERFORM  エラー判定処理                                
001883     END-EVALUATE.                                                
001884*                                                                 
001885 前受金出力処理−ＥＸＩＴ.                                        
001886     EXIT.                                                        
001887******************************************************************
001888*    終了処理                                                    *
001889******************************************************************
001890 終了処理                             SECTION.                    
001891 終了処理−ＳＴＡＲＴ.                                            
001892*--< ＤＢクローズ処理 >                                           
001893     PERFORM  ＤＢクローズ処理.                                   
001894*                                                                 
001895*--< ファイルクローズ    >                                        
001896       CLOSE  出力ファイル.                                       
001897*                                                                 
001898*--< 件数メッセージ出力 >                                         
001899     PERFORM  件数メッセージ出力.                                 
001900*                                                                 
001901*--< 終了メッセージ出力 >                                         
001902     PERFORM  終了メッセージ出力.                                 
001903*                                                                 
001904*--< プログラム正常終了 >                                         
001905     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
001906*                                                                 
001907 終了処理−ＥＸＩＴ.                                              
001908     EXIT.                                                        
001909******************************************************************
001910*    ＤＢクローズ                                                *
001911******************************************************************
001912 ＤＢクローズ処理                     SECTION.                    
001913 ＤＢクローズ処理−ＳＴＡＲＴ.                                    
001914*                                                                 
001915*--< カーソル クローズ >                                          
001916     EXEC SQL                                                     
001917        CLOSE  CUR1                                               
001918     END-EXEC.                                                    
001919*                                                                 
001920 ＤＢクローズ処理−ＥＸＩＴ.                                      
001921     EXIT.                                                        
001922******************************************************************
001923*   件数メッセージ出力                                           *
001924******************************************************************
001925 件数メッセージ出力                   SECTION.                    
001926 件数メッセージ出力−ＳＴＡＲＴ.                                  
001927*----------------------------------------------------------------*
001928*    件数メッセージ出力処理                                      *
001929*----------------------------------------------------------------*
001930     INITIALIZE                       IF-CHOCO001.                
001931     MOVE  "3"                        TO  共１−イベント種別.     
001932     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001933     MOVE  "0"                        TO  共１−復帰コード.       
001934     MOVE  "M40MAB"                   TO  共１−処理テーブルＩＤ. 
001935     MOVE  "COUNT"                    TO  共１−処理識別.         
001936     MOVE  Ｗ−入力−件数             TO  共１−データ内容.       
001937     MOVE  "前受情報ＤＢ"             TO  共１−その他メッセージ. 
001938     CALL  CLOCO001                USING  IF-CHOCO001.            
001939*                                                                 
001940     INITIALIZE                       IF-CHOCO001.                
001941     MOVE  "3"                        TO  共１−イベント種別.     
001942     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001943     MOVE  "0"                        TO  共１−復帰コード.       
001944     MOVE  "SFHSED25"                 TO  共１−処理テーブルＩＤ. 
001945     MOVE  "COUNT"                    TO  共１−処理識別.         
001946     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
001947     MOVE  "前受金受払残高中間ファイル"                           
001948                                      TO  共１−その他メッセージ. 
001949     CALL  CLOCO001                USING  IF-CHOCO001.            
001950*                                                                 
001951 件数メッセージ出力−ＥＸＩＴ.                                     
001952     EXIT.                                                        
001953******************************************************************
001954*    終了メッセージ出力                                          *
001955******************************************************************
001956 終了メッセージ出力                   SECTION.                    
001957 終了メッセージ出力−ＳＴＡＲＴ.                                  
001980*----------------------------------------------------------------*
001981*    終了メッセージ出力                                          *
001982*----------------------------------------------------------------*
001983     INITIALIZE                       IF-CHOCO001.                
001984     MOVE  "3"                        TO  共１−イベント種別.     
001985     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001986     MOVE  "0"                        TO  共１−復帰コード.       
001987     MOVE  "END"                      TO  共１−処理識別.         
001988     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001989     CALL  CLOCO001                USING  IF-CHOCO001.            
001990*                                                                 
001991 終了メッセージ出力−ＥＸＩＴ.                                    
001992     EXIT.                                                        
002005*                                                                 
002046******************************************************************
002047*    エラー処理                                                  *
002048******************************************************************
002049 エラー判定処理                       SECTION.                    
002050 エラー判定処理−ＳＴＡＲＴ.                                      
002051*                                                                 
002052     MOVE  "Y"                        TO Ｗ−異常終了−フラグ.    
002053     INITIALIZE                           IF-CHOCO001.            
002054*                                                                 
002055     EVALUATE  Ｗ−エラーコード                                   
002056        WHEN  -10                                                 
002057*--<       ＯＲＡＣＬＥ接続失敗 >                                 
002058           MOVE  "1"                  TO  共１−イベント種別      
002059           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
002060           MOVE  "9"                  TO  共１−復帰コード        
002061           MOVE  "CONNECT"            TO  共１−処理識別          
002062           MOVE  SQLCODE              TO  共１−データ内容        
002063           MOVE  SQLERRMC             TO  共１−その他メッセージ  
002064           CALL  CLOCO001          USING  IF-CHOCO001             
002065*                                                                 
002066        WHEN  -20                                                 
002067*--<       業務管理テーブル読込失敗 >                             
002068           MOVE  "1"                  TO  共１−イベント種別      
002069           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
002070           MOVE  "9"                  TO  共１−復帰コード        
002071           MOVE  "D70GYM"             TO  共１−処理テーブルＩＤ  
002072           MOVE  "OPEN"               TO  共１−処理識別          
002073           MOVE  SQLCODE              TO  共１−データ内容        
002074           MOVE  SQLERRMC             TO  共１−その他メッセージ  
002075           CALL  CLOCO001          USING  IF-CHOCO001             
002076*                                                                 
002077        WHEN  -30                                                 
002078*--<       結合テーブルカーソルＯＰＥＮエラー  >                  
002079           MOVE  "1"                  TO  共１−イベント種別      
002080           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
002081           MOVE  "9"                  TO  共１−復帰コード        
002082           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
002083           MOVE  "OPEN"               TO  共１−処理識別          
002084           MOVE  SQLCODE              TO  共１−データ内容        
002085           MOVE  SQLERRMC             TO  共１−その他メッセージ  
002086           CALL  CLOCO001          USING  IF-CHOCO001             
002087*                                                                 
002088        WHEN  -40                                                 
002089*--<       前受金受払残高中間ファイルオープン確認>                
002090           MOVE  "1"                  TO  共１−イベント種別      
002091           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
002092           MOVE  "9"                  TO  共１−復帰コード        
002093           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
002094           MOVE  "OPEN"               TO  共１−処理識別          
002095           MOVE  SQLCODE              TO  共１−データ内容        
002096           MOVE  SQLERRMC             TO  共１−その他メッセージ  
002097           CALL  CLOCO001          USING  IF-CHOCO001             
002098        WHEN  -50                                                 
002099*--<       結合テーブルカーソル読込を確認 >                       
002100           MOVE  "1"                  TO  共１−イベント種別      
002101           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
002102           MOVE  "9"                  TO  共１−復帰コード        
002103           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
002104           MOVE  "FETCH"              TO  共１−処理識別          
002105           MOVE  SQLCODE              TO  共１−データ内容        
002106           MOVE  SQLERRMC             TO  共１−その他メッセージ  
002107           CALL  CLOCO001          USING  IF-CHOCO001             
002108        WHEN  -60                                                 
002109*--<      項目名称マスタの抽出処理確認 >                          
002110           MOVE  "1"                  TO  共１−イベント種別      
002111           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
002112           MOVE  "9"                  TO  共１−復帰コード        
002113           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
002114           MOVE  "OPEN"               TO  共１−処理識別          
002115           MOVE  SQLCODE              TO  共１−データ内容        
002116           MOVE  SQLERRMC             TO  共１−その他メッセージ  
002117           CALL  CLOCO001          USING  IF-CHOCO001             
002118         WHEN  -70                                                
002119*--<      債権情報（一般）ＤＢより項目の抽出処理確認 >            
002120           MOVE  "1"                  TO  共１−イベント種別      
002121           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
002122           MOVE  "9"                  TO  共１−復帰コード        
002123           MOVE  "M01SAJ"             TO  共１−処理テーブルＩＤ  
002124           MOVE  "OPEN"               TO  共１−処理識別          
002125           MOVE  SQLCODE              TO  共１−データ内容        
002126           MOVE  SQLERRMC             TO  共１−その他メッセージ  
002127           CALL  CLOCO001          USING  IF-CHOCO001             
002128         WHEN  -80                                                
002129*--<      前受金出力処理エラー >                                  
002130           MOVE  "1"                  TO  共１−イベント種別      
002131           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
002132           MOVE  "9"                  TO  共１−復帰コード        
002133           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
002134           MOVE  "WRITE"              TO  共１−処理識別          
002135           MOVE  SQLCODE              TO  共１−データ内容        
002136           MOVE  SQLERRMC             TO  共１−その他メッセージ  
002137           CALL  CLOCO001          USING  IF-CHOCO001             
002138*                                                                 
002139        WHEN  OTHER                                               
002140           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
002141     END-EVALUATE.                                                
002142*                                                                 
002143     IF Ｗ−異常終了−フラグ  =  "Y"                              
002144*        PERFORM  ＤＢロールバック処理                             
002145*                                                                 
002146        PERFORM  終了メッセージ出力                               
002147*                                                                 
002148*--<    プログラム異常終了のリターンコード >                      
002149        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
002150*                                                                 
002151        EXIT  PROGRAM                                             
002152     END-IF.                                                      
002153*                                                                 
002154 エラー判定処理−ＥＸＩＴ.                                        
002155     EXIT.                                                        
002176******************************************************************
002177*                  END OF PROGRAM                                *
002178******************************************************************
002179                                                                  
