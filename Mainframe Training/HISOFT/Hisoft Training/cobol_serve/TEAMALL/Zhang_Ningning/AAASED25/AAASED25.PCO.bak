000010******************************************************************
000020*      1. プログラム名  : 前受金受払残高ファイル作成             *
000030*      2. プログラムID  : AAASED25 		               *
000040*      3. 処理概要      : 前受情報ＤＢをメインに、マスタと表結合 *
000050*                         して読込み、前受金受払残高中間ファイル *
000060*                         を作成する			       *
000070*                                                                *
000080*      4. 作成者        :  張寧寧                                *
000090*      5. 作成日        :  2005.03.29                            *
000100******************************************************************
000110*                                                                 
000120******************************************************************
000130*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000140******************************************************************
000150 IDENTIFICATION                       DIVISION.                   
000160*                                                                 
000170 PROGRAM-ID.                          AAASED25.                   
000180******************************************************************
000190*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000200******************************************************************
000210 ENVIRONMENT                          DIVISION.                   
000220******************************************************************
000230*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000240******************************************************************
000250 INPUT-OUTPUT                         SECTION.                    
000260 FILE-CONTROL.                                                    
000270*                                                                 
000280     SELECT  出力ファイル  ASSIGN    TO   U11                     
000290     FILE STATUS    IS     Ｗ−状態                               
000300     ORGANIZATION   IS     LINE       SEQUENTIAL.                 
000310*                                                                 
000320******************************************************************
000330*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000340******************************************************************
000350 DATA                                 DIVISION.                   
000360******************************************************************
000370*    ＦＩＬＥ                      ＳＥＣＴＩＯＮ                *
000380******************************************************************
000390 FILE                                 SECTION.                    
000400*----------------------------------------------------------------*
000410*   前受金受払残高中間ファイル                                   *
000420*----------------------------------------------------------------*
000430 FD  出力ファイル                                                 
000440     LABEL  RECORD    IS              STANDARD                    
000450     BLOCK  CONTAINS  0               RECORDS.                    
000460*                                                                 
000470 01  出力−レコード.                                              
000480     COPY   CPSCE50  REPLACING      ==()==  BY  ==出力−==.       
000490*                                                                 
000500******************************************************************
000510*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000520******************************************************************
000530 WORKING-STORAGE                      SECTION.                    
000540*----------------------------------------------------------------*
000550*    ホスト変数定義エリア                                        *
000560*----------------------------------------------------------------*
000570     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000580 01  ＷＳ−業務管理ＩＤ               PIC  X(08) VALUE "GYMKNRRC".
000590 01  ＷＳ−名称１                     PIC  X(60).                 
000600 01  ＷＳ−名称２                     PIC  X(60).                 
000610 01  ＷＳ−コードＮＯ１               PIC  X(03) VALUE "038".     
000620 01  ＷＳ−コードＮＯ２               PIC  X(03) VALUE "005".     
000630 01  ＷＳ−レコード区分               PIC  X(01) VALUE "1".       
000640 01  ＷＳ−前受金受払残高表対象フラグ PIC  X(01) VALUE "1".       
000650*                                                                 
000660*--< ＯＲＡＣＬＥ共通変数 >                                       
000670     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000680*                                                                 
000690*--< 前受情報ＤＢ >                                               
000700     EXEC  SQL  INCLUDE  M40MAB.CBL            END-EXEC.          
000710*                                                                 
000720*--< 業務管理テーブル >                                           
000730     EXEC  SQL  INCLUDE  D70GYM.CBL            END-EXEC.          
000740*                                                                 
000750*--< 取引先マスタ >                                               
000760     EXEC  SQL  INCLUDE  D01TRS.CBL           END-EXEC.           
000770*                                                                 
000780*--< 請求先マスタ >                                               
000790     EXEC  SQL  INCLUDE  D02SQS.CBL           END-EXEC.           
000800*                                                                 
000810*--< 項目名称マスタ >                                             
000820     EXEC  SQL  INCLUDE  D19MSY.CBL           END-EXEC.           
000830*                                                                 
000840*--< 債権情報（一般）ＤＢ >                                       
000850     EXEC  SQL  INCLUDE  M01SAJ.CBL           END-EXEC.           
000860*                                                                 
000870*--< ＯＲＡＣＬＥ ＳＱＬ実行情報 (SQLCA) >                        
000880     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000890*                                                                 
000900     EXEC  SQL  END      DECLARE      SECTION  END-EXEC.          
000910*----------------------------------------------------------------*
000920*   作業領域定義                                                 *
000930*----------------------------------------------------------------*
000940 01  ＷＯＲＫ−エリア.                                            
000950*--< エラーコード >                                               
000960     03  Ｗ−エラーコード             PIC S9(04).                 
000970*                                                                 
000980*--< 出力ー判定用 >                                               
000990     03  Ｗ−出力判定                 PIC 9(01).                  
001000*                                                                 
001010*--< Ｗ−状態 >                                                   
001020     03  Ｗ−状態                     PIC  X(02).                 
001030*                                                                 
001040*--< 件数エリア >                                                 
001050     03  件数エリア.                                              
001060          05  Ｗ−入力−件数           PIC  9(09).                
001070          05  Ｗ−出力−件数           PIC  9(09).                
001080*                                                                 
001090*--< フラグアリア >                                               
001100     03  フラグ−エリア.                                          
001110         05  Ｗ−終了−フラグ         PIC  X(01).                 
001120         05  異常終了−フラグ         PIC  X(01).                 
001130*                                                                 
001140*----------------------------------------------------------------*
001150*    サブルーチン名                                              *
001160*----------------------------------------------------------------*
001170 01  CALL-AREA.                                                   
001180*--< 共通ログサブルーチン >                                       
001190     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
001200     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
001210*                                                                 
001220*----------------------------------------------------------------*
001230*    ＣＯＰＹ領域                                                *
001240*----------------------------------------------------------------*
001250*--< 共通ログ用パラメータ >                                       
001260 01  IF-CHOCO001.                                                 
001270     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
001280*                                                                 
001290*----------------------------------------------------------------*
001300*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001310*----------------------------------------------------------------*
001320 01  PARA-AREA.                                                   
001330     COPY CPBCO001.                                               
001340******************************************************************
001350*    定数用データ定義エリア                                      *
001360******************************************************************
001370 CONSTANT                             SECTION.                    
001380 01  定数領域.                                                    
001390     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
001400     03  定数−プログラム名           PIC  X(80)                  
001410                              VALUE  "前受金受払残高ファイル作成".
001420     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001430     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001440     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001450     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001460******************************************************************
001470*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001480******************************************************************
001490 PROCEDURE                            DIVISION.                   
001500*                                                                 
001510     PERFORM  初期処理.                                           
001520*                                                                 
001530     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001540*                                                                 
001550     PERFORM  終了処理.                                           
001560*                                                                 
001570     STOP     RUN.                                                
001580*                                                                 
001590******************************************************************
001600*    初期処理                                                    *
001610******************************************************************
001620 初期処理                             SECTION.                    
001630 初期処理−ＳＴＡＲＴ.                                            
001640*                                                                 
001650*----------------------------------------------------------------*
001660*    開始メッセージ出力処理                                      *
001670*----------------------------------------------------------------*
001680     INITIALIZE                       IF-CHOCO001.                
001690     MOVE  "3"                        TO  共１−イベント種別.     
001700     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001710     MOVE  "0"                        TO  共１−復帰コード.       
001720     MOVE  "START"                    TO  共１−処理識別.         
001730     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001740     CALL  CLOCO001                USING  IF-CHOCO001.            
001750*                                                                 
001760*----------------------------------------------------------------*
001770*    作業領域の初期値処理                                        *
001780*----------------------------------------------------------------*
001790     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001800     INITIALIZE                           ＷＯＲＫ−エリア.       
001810*                                                                 
001820*--< ＯＲＡＣＬＥ接続 >                                           
001830     PERFORM  ＯＲＡＣＬＥ接続.                                   
001840*                                                                 
001850*--< 業務管理テーブル読込 >                                       
001860     PERFORM  業務管理テーブル読込.                               
001870*                                                                 
001880*--< 結合テーブルカーソル宣言 >                                   
001890     PERFORM  結合テーブルカーソル宣言.                           
001900*                                                                 
001910*--< ファイルオープン >                                           
001920     PERFORM  ファイルオープン.                                   
001930*                                                                 
001940*--< 結合テール読込(１件目) >                                     
001950     PERFORM  結合テーブル読込.                                   
001960*                                                                 
001970 初期処理−ＥＸＩＴ.                                              
001980     EXIT.                                                        
001990*                                                                 
002000******************************************************************
002010*    主処理                                                      *
002020******************************************************************
002030 主処理                               SECTION.                    
002040 主処理−ＳＴＡＲＴ.                                              
002050*                                                                 
002060*--< 項目名称マスタより項目の抽出処理 >                           
002070     PERFORM  項目名称抽出処理.                                   
002080*                                                                 
002090*--< 債権情報ＤＢより項目の抽出処理 >                             
002100     PERFORM  債権情報ＤＢ抽出処理.                               
002110*                                                                 
002120*--< 前受金受払残高中間ﾌｧｲﾙ出力判定処理 >                         
002130     PERFORM  出力判定処理.                                       
002140*                                                                 
002150*--< 結合テーブﾙ読込（２件目以降） >                              
002160     PERFORM  結合テーブル読込.                                   
002170*                                                                 
002180 主処理−ＥＸＩＴ.                                                
002190     EXIT.                                                        
002200******************************************************************
002210*    終了処理                                                    *
002220******************************************************************
002230 終了処理                             SECTION.                    
002240 終了処理−ＳＴＡＲＴ.                                            
002250*                                                                 
002260     PERFORM  ＤＢクローズ処理.                                   
002270*                                                                 
002280     CLOSE  出力ファイル.                                         
002290*                                                                 
002300     PERFORM  終了メッセージ出力処理.                             
002310*                                                                 
002320*--< プログラム正常終了 >                                         
002330     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
002340*                                                                 
002350 終了処理−ＥＸＩＴ.                                              
002360     EXIT.                                                        
002370******************************************************************
002380*    ＯＲＡＣＬＥ接続                                            *
002390******************************************************************
002400 ＯＲＡＣＬＥ接続                     SECTION.                    
002410 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
002420*                                                                 
002430*--< ＤＢ接続用情報を取得処理 >                                   
002440     CALL  COBCO001                USING  PARA-AREA.              
002450*                                                                 
002460     MOVE  PARA-DBSTRING              TO  DB-STRING.              
002470     MOVE  PARA-USERNAME              TO  USERNAME.               
002480     MOVE  PARA-PASSWORD              TO  PASSWD.                 
002490*                                                                 
002500*----------------------------------------------------------------*
002510*    開始接続                                                    *
002520*----------------------------------------------------------------*
002530     IF  DB-STRING  =  SPACE                                      
002540        EXEC  SQL                                                 
002550           CONNECT  :USERNAME  IDENTIFIED  BY  :PASSWD            
002560        END-EXEC                                                  
002570     ELSE                                                         
002580        EXEC  SQL                                                 
002590           CONNECT  :USERNAME  IDENTIFIED  BY  :PASSWD            
002600             USING  :DB-STRING                                    
002610        END-EXEC                                                  
002620     END-IF.                                                      
002630*                                                                 
002640*----------------------------------------------------------------*
002650*    接続状態判定                                                *
002660*----------------------------------------------------------------*
002670     EVALUATE  SQLCODE                                            
002680        WHEN  定数−ＳＱＬＯＫ                                    
002690*--<       接続正常 >                                             
002700           CONTINUE                                               
002710        WHEN  OTHER                                               
002720*--<       接続エラー >                                           
002730           MOVE     -10               TO  Ｗ−エラーコード        
002740           PERFORM  エラー処理                                    
002750     END-EVALUATE.                                                
002760*                                                                 
002770 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002780     EXIT.                                                        
002790******************************************************************
002800*     業務管理テーブル読込                                       *
002810******************************************************************
002820  業務管理テーブル読込                     SECTION.               
002830  業務管理テーブル読込−ＳＴＡＲＴ.                               
002840      EXEC SQL                                                    
002850        SELECT  バッチ用業務年月                                  
002860          INTO :Ｄ７０−バッチ用業務年月                          
002870          FROM  D70GYM_TBL                                        
002880         WHERE  D70GYM_TBL.業務管理ＩＤ = :ＷＳ−業務管理ＩＤ     
002890      END-EXEC.                                                   
002900*                                                                 
002910*----------------------------------------------------------------*
002920*     業務管理テーブル読込確認                                   *
002930*----------------------------------------------------------------*
002940     EVALUATE  SQLCODE                                            
002950        WHEN  定数−ＳＱＬＯＫ                                    
002960*--<       正常 >                                                 
002970           CONTINUE                                               
002980        WHEN  OTHER                                               
002990*--<       読込エラー、プログラムが異常終了 >                     
003000           MOVE      -20              TO  Ｗ−エラーコード        
003010           PERFORM   エラー処理                                   
003020     END-EVALUATE.                                                
003030*                                                                 
003040  業務管理テーブル読込−ＥＸＩＴ.                                 
003050      EXIT.                                                       
003060******************************************************************
003070*        結合テーブルカーソル宣言                                *
003080******************************************************************
003090 結合テーブルカーソル宣言             SECTION.                    
003100 結合テーブルカーソル宣言−ＳＴＡＲＴ.                            
003110*                                                                 
003120*----------------------------------------------------------------*
003130*    カーソルＯＰＥＮ処理                                        *
003140*----------------------------------------------------------------*
003150     EXEC  SQL                                                    
003160        DECLARE CUR1  CURSOR FOR                                  
003170           SELECT   M40MAB_TBL.レコード区分                       
003180                   ,M40MAB_TBL.経理用主契約区分                   
003190                   ,M40MAB_TBL.顧客区分                           
003200                   ,NVL(D01TRS_TBL.名寄せコード,RPAD(' ',40,' ')) 
003210                   ,M40MAB_TBL.請求先取引先コード                 
003220                   ,M40MAB_TBL.請求先コード                       
003230                   ,M40MAB_TBL.契約番号                           
003240                   ,M40MAB_TBL.契約種類                           
003250                   ,M40MAB_TBL.担当部課コード                     
003260                   ,M40MAB_TBL.再リース回数                       
003270                   ,M40MAB_TBL.充当開始年月                       
003280                   ,M40MAB_TBL.充当月数                           
003290                   ,M40MAB_TBL.前払回収方法                       
003300                   ,M40MAB_TBL.入金日                             
003310			 ,M40MAB_TBL.入金区分                           
003320                   ,NVL(D01TRS_TBL.取引先名称,RPAD(' ',80,' '))   
003330                   ,NVL(D02SQS_TBL.請求先名称,RPAD(' ',80,' '))   
003340                   ,M40MAB_TBL.前月末残高                         
003350                   ,M40MAB_TBL.当月回収額                         
003360                   ,M40MAB_TBL.当月消化額                         
003370                   ,M40MAB_TBL.当月末残高                         
003380                   ,M40MAB_TBL.協調区分                           
003390                   ,M40MAB_TBL.前月末残高他社                     
003400                   ,M40MAB_TBL.当月回収額他社                     
003410                   ,M40MAB_TBL.当月消化額他社                     
003420                   ,M40MAB_TBL.当月他社解約分料金                 
003430                   ,M40MAB_TBL.当月他社解約分消費税               
003440                   ,M40MAB_TBL.当月末残高他社                     
003450             FROM  M40MAB_TBL                                     
003460                  ,D01TRS_TBL                                     
003470                  ,D02SQS_TBL                                     
003480            WHERE  M40MAB_TBL.前受金受払残高表対象フラグ =        
003490                                 :ＷＳ−前受金受払残高表対象フラグ
003500              AND  M40MAB_TBL.請求先取引先コード =                
003510                                     D01TRS_TBL.取引先コード ( + )
003520              AND  M40MAB_TBL.請求先取引先コード =                
003530                                    D02SQS_TBL.取引先コード( + )  
003540              AND  M40MAB_TBL.請求先コード =                      
003550                                    D02SQS_TBL.請求先コード( + )  
003560         ORDER BY  M40MAB_TBL.レコード区分                        
003570                  ,M40MAB_TBL.契約番号                            
003580     END-EXEC.                                                    
003590*                                                                 
003600*----------------------------------------------------------------*
003610*    カーソルＯＰＥＮ処理                                        *
003620*----------------------------------------------------------------*
003630     EXEC  SQL                                                    
003640        OPEN  CUR1                                                
003650     END-EXEC.                                                    
003660*                                                                 
003670*----------------------------------------------------------------*
003680*    カーソルＯＰＥＮ確認                                        *
003690*----------------------------------------------------------------*
003700     EVALUATE  SQLCODE                                            
003710        WHEN  定数−ＳＱＬＯＫ                                    
003720*--<       正常 >                                                 
003730           CONTINUE                                               
003740        WHEN  OTHER                                               
003750*--<       カーソルＯＰＥＮエラー >                               
003760           MOVE -30                   TO  Ｗ−エラーコード        
003770           PERFORM  エラー処理                                    
003780     END-EVALUATE.                                                
003790*                                                                 
003800 結合テーブルカーソル宣言−ＥＸＩＴ.                              
003810     EXIT.                                                        
003820******************************************************************
003830*    ファイルオープン                                            *
003840******************************************************************
003850 ファイルオープン             SECTION.                            
003860 ファイルオープン−ＳＴＡＲＴ.                                    
003870*                                                                 
003880     OPEN  OUTPUT  出力ファイル.                                  
003890*                                                                 
003900*----------------------------------------------------------------*
003910*    Ｗ−状態判定                                                *
003920*----------------------------------------------------------------*
003930     EVALUATE  Ｗ−状態                                           
003940        WHEN  ZERO                                                
003950           CONTINUE                                               
003960        WHEN  OTHER                                               
003970*--<       ファイルオープンエラー >                               
003980           MOVE     -2                TO  Ｗ−エラーコード        
003990           PERFORM  エラー処理                                    
004000     END-EVALUATE.                                                
004010*                                                                 
004020 ファイルオープン−ＥＸＩＴ.
004030******************************************************************
004040*    結合テーブル読込                                            *
004050******************************************************************
004060 結合テーブル読込             SECTION.                            
004070 結合テーブル読込−ＳＴＡＲＴ.                                    
004080*                                                                 
004090*--< 結合テーブル読込 >                                           
004100     EXEC SQL                                                     
004110         FETCH  CUR1                                              
004120            INTO                                                  
004130                :Ｍ４０−レコード区分                             
004140               ,:Ｍ４０−経理用主契約区分                         
004150               ,:Ｍ４０−顧客区分                                 
004160               ,:Ｄ０１−名寄せコード                             
004170               ,:Ｍ４０−請求先取引先コード                       
004180               ,:Ｍ４０−請求先コード                             
004190               ,:Ｍ４０−契約番号                                 
004200               ,:Ｍ４０−契約種類                                 
004210               ,:Ｍ４０−担当部課コード                           
004220               ,:Ｍ４０−再リース回数                             
004230               ,:Ｍ４０−充当開始年月                             
004240               ,:Ｍ４０−充当月数                                 
004250               ,:Ｍ４０−前払回収方法                             
004260               ,:Ｍ４０−入金日                                   
004270               ,:Ｍ４０−入金区分                                 
004280               ,:Ｄ０１−取引先名称                               
004290               ,:Ｄ０２−請求先名称                               
004300               ,:Ｍ４０−前月末残高                               
004310               ,:Ｍ４０−当月回収額                               
004320               ,:Ｍ４０−当月消化額                               
004330               ,:Ｍ４０−当月末残高                               
004340               ,:Ｍ４０−協調区分                                 
004350               ,:Ｍ４０−前月末残高他社                           
004360               ,:Ｍ４０−当月回収額他社                           
004370               ,:Ｍ４０−当月消化額他社                           
004380               ,:Ｍ４０−当月他社解約分料金                       
004390               ,:Ｍ４０−当月他社解約分消費税                     
004400               ,:Ｍ４０−当月末残高他社                           
004410     END-EXEC.                                                    
004420*                                                                 
004430*----------------------------------------------------------------*
004440*    結合テーブル読込を確認                                      *
004450*----------------------------------------------------------------*
004460     EVALUATE   SQLCODE                                           
004470        WHEN   定数−ＳＱＬＯＫ                                   
004480*--<       正常 >                                                 
004490           COMPUTE  Ｗ−入力−件数  =  Ｗ−入力−件数  +  1       
004500           CONTINUE                                               
004510           MOVE       0              TO  Ｗ−出力判定             
004520        WHEN   定数−ＳＱＬＥＮＤ                                 
004530*--<       読込終了 >                                             
004540           MOVE  "Y"                 TO  Ｗ−終了−フラグ         
004550        WHEN  OTHER                                               
004560*--<       結合テーブルオープン失敗プログラムが異常終了 >         
004570           MOVE     -40              TO  Ｗ−エラーコード         
004580           PERFORM  エラー処理                                    
004590     END-EVALUATE.                                                
004600*                                                                 
004610 結合テーブル読込−ＥＸＩＴ.                                      
004620     EXIT.                                                        
004630*                                                                 
004640******************************************************************
004650*     項目名称マスタより項目の抽出処理                           *
004660******************************************************************
004670 項目名称抽出処理                        SECTION.                 
004680 項目名称抽出処理−ＳＴＡＲＴ.                                    
004690*                                                                 
004700*--< 項目名称マスタより主契約区分名称の抽出処理 >                 
004710*                                                                 
004720     EXEC SQL                                                     
004730        SELECT  D19MSY_TBL. 名称                                  
004740          INTO  :ＷＳ−名称１                                     
004750          FROM  D19MSY_TBL                                        
004760         WHERE  D19MSY_TBL.コードＮＯ = :ＷＳ−コードＮＯ１       
004770           AND  SUBSTR(D19MSY_TBL.コード,1,1)                     
004780                                    =  :Ｍ４０−経理用主契約区分  
004790     END-EXEC.                                                    
004800*                                                                 
004810*----------------------------------------------------------------*
004820*     抽出処理を確認確認                                         *
004830*----------------------------------------------------------------*
004840     EVALUATE  SQLCODE                                            
004850        WHEN  定数−ＳＱＬＯＫ                                    
004860*--<       正常 >                                                 
004870           CONTINUE                                               
004880        WHEN  OTHER                                               
004890*--<       抽出エラー >                                           
004900           MOVE     SPACE             TO  ＷＳ−名称１            
004910           MOVE     -50               TO  Ｗ−エラーコード        
004920           PERFORM  エラー処理                                    
004930     END-EVALUATE.                                                
004940*                                                                 
004950*--< 項目名称マスタより顧客区分名称の抽出処理 >                   
004960*                                                                 
004970     EXEC SQL                                                     
004980        SELECT  D19MSY_TBL.名称                                   
004990          INTO :ＷＳ−名称２                                      
005000          FROM  D19MSY_TBL                                        
005010         WHERE  D19MSY_TBL.コードＮＯ = :ＷＳ−コードＮＯ２       
005020           AND  SUBSTR(D19MSY_TBL.コード,1,2)                     
005030                                    =  :Ｍ４０−顧客区分          
005040     END-EXEC.                                                    
005050*                                                                 
005060*----------------------------------------------------------------*
005070*     抽出処理を確認                                             *
005080*----------------------------------------------------------------*
005090     EVALUATE  SQLCODE                                            
005100        WHEN  定数−ＳＱＬＯＫ                                    
005110*--<       正常 >                                                 
005120           CONTINUE                                               
005130        WHEN  OTHER                                               
005140*--<       抽出エラー >                                           
005150           MOVE     SPACE              TO  ＷＳ−名称２           
005160           MOVE     -50                TO  Ｗ−エラーコード       
005170           PERFORM  エラー処理                                   
005180     END-EVALUATE.                                                
005190*                                                                 
005200  項目名称抽出処理−ＥＸＩＴ.                                     
005210      EXIT.                                                       
005220******************************************************************
005230*    債権情報ＤＢより項目の抽出処理                              *
005240******************************************************************
005250 債権情報ＤＢ抽出処理                  SECTION.                   
005260 債権情報ＤＢ抽出処理−ＳＴＡＲＴ.                                
005270*                                                                 
005280*--<  債権情報（一般）ＤＢ項目取得 >                              
005290     EXEC SQL                                                     
005300        SELECT  M01SAJ_TBL. 状態フラグ                            
005310               ,M01SAJ_TBL.債権契約件名                           
005320               ,M01SAJ_TBL.担保区分                               
005330          INTO  :Ｍ０１−状態フラグ                               
005340               ,:Ｍ０１−債権契約件名                             
005350               ,:Ｍ０１−担保区分                                 
005360          FROM  M01SAJ_TBL                                        
005370               ,M40MAB_TBL                                        
005380        WHERE   M01SAJ_TBL.レコード区分  = :ＷＳ−レコード区分    
005390          AND   M01SAJ_TBL.契約番号      = :Ｍ４０−契約番号      
005400          AND   M01SAJ_TBL.再リース回数  = :Ｍ４０−再リース回数  
005410          AND   M01SAJ_TBL.契約種類      = :Ｍ４０−契約種類      
005420     END-EXEC.                                                    
005430*                                                                 
005440*--< 抽出処理を確認 >                                             
005450     EVALUATE  SQLCODE                                            
005460        WHEN  定数−ＳＱＬＯＫ                                    
005470*--<       正常 >                                                 
005480           CONTINUE                                               
005490        WHEN  OTHER                                               
005500*--<       抽出エラー >                                           
005510           MOVE     SPACE             TO  Ｍ０１−状態フラグ      
005520           MOVE     SPACE             TO  Ｍ０１−債権契約件名    
005530           MOVE     SPACE             TO  Ｍ０１−担保区分        
005540           MOVE      -70              TO  Ｗ−エラーコード        
005550           PERFORM   エラー処理                                   
005560     END-EVALUATE.                                                
005570*                                                                 
005580  債権情報ＤＢ抽出処理−ＥＸＩＴ.                                 
005590      EXIT.                                                       
005600******************************************************************
005610*      前受金受払残高中間ﾌｧｲﾙ出力判定処理                        *
005620******************************************************************
005630 出力判定処理                      SECTION.                       
005640 出力判定処理−ＳＴＡＲＴ.                                        
005650*--< 出力条件判定 >                                               
005660     IF  Ｍ０１−担保区分  NOT =  "1"                             
005670        PERFORM  項目編集出力処理                                 
005680     END-IF.                                                      
005690*                                                                 
005700 出力判定処理−ＥＸＩＴ.                                          
005710     EXIT.                                                        
005720******************************************************************
005730*     項目編集出力処理                                           *
005740******************************************************************
005750 項目編集出力処理                    SECTION.                     
005760 項目編集出力処理−ＳＴＡＲＴ.                                    
005770*--<  初期化処理 >                                                
005780*     MOVE  SPACE                      TO  出力−レコード.        
005790*     INITIALIZE                           出力−レコード.        
005800*                                                                 
005810     PERFORM  編集処理自社分.                                     
005820*                                                                 
005830*--< 編集条件判定 >                                               
005840     IF  Ｍ４０−協調区分 = "2"                                   
005850        PERFORM   編集処理他社分                                  
005860     END-IF.                                                      
005870*                                                                 
005880 項目編集出力処理−ＥＸＩＴ.                                      
005890      EXIT.                                                       
005900*                                                                 
005910******************************************************************
005920*         編集処理自社分                               <2.4.1>   *
005930******************************************************************
005940 編集処理自社分               SECTION.                            
005950 編集処理自社分−ＳＴＡＲＴ.                                      
005960     MOVE  SPACE                      TO  出力−レコード.         
005970     INITIALIZE                           出力−レコード.         
005980                                                                  
005990*--<    No.01 >                                                   
006000     IF  Ｍ０１−状態フラグ < "3"                                 
006010        MOVE  "3"                     TO  出力−自他社区分        
006020     ELSE                                                         
006030        MOVE  "1"                     TO  出力−自他社区分        
006040     END-IF.                                                      
006050*                                                                 
006060*--< 共通出力処理 >                                               
006070     PERFORM  共通出力処理                                        
006080*                                                                 
006090*--<    No.23 >                                                   
006100        MOVE  Ｍ４０−前月末残高         TO  出力−前月末残高.    
006110*                                                                 
006120*--<    No.24 >                                                   
006130       MOVE  Ｍ４０−当月回収額         TO  出力−当月入金額.     
006140*                                                                 
006150*--<    No.25 >                                                   
006160       MOVE  Ｍ４０−当月消化額         TO  出力−当月消化額.     
006170*                                                                 
006180*--<    No.26 >                                                   
006190        MOVE  Ｍ４０−当月末残高         TO  出力−当月末残高.    
006200*-----------------------------------------------------------------
006210*     共通前受金受払残高中間ファイル出力処理                      
006220*-----------------------------------------------------------------
006230*                                                                 
006240     PERFORM  前受金受払残高中間ファイル出力処理.                 
006250 編集処理自社分−ＥＸＩＴ.                                        
006260     EXIT.                                                        
006270******************************************************************
006280*    編集処理他社分                                      <2.4.2> *
006290******************************************************************
006300 編集処理他社分               SECTION.                            
006310 編集処理他社分−ＳＴＡＲＴ.                                      
006320     MOVE  SPACE                      TO  出力−レコード.         
006330     INITIALIZE                           出力−レコード.         
006340*                                                                 
006350*--<  No.01 >                                                     
006360      IF  Ｍ０１−状態フラグ < "3"                                
006370         MOVE  "4"                    TO  出力−自他社区分        
006380      ELSE                                                        
006390         MOVE  "2"                    TO  出力−自他社区分        
006400      END-IF.                                                     
006410*                                                                 
006420*--<  共通出力処理 >                                              
006430      PERFORM  共通出力処理                                       
006440*                                                                 
006450*--<  No.23 >                                                     
006460      MOVE  Ｍ４０−前月末残高他社    TO  出力−前月末残高        
006470*                                                                 
006480*--<  No.24 >                                                     
006490      MOVE  Ｍ４０−当月回収額他社    TO  出力−当月入金額 .      
006500*                                                                 
006510*--<  No.25 >                                                     
006520      COMPUTE   出力−当月消化額             =                    
006530                Ｍ４０−当月消化額他社       +                    
006540                Ｍ４０−当月他社解約分料金   +	                
006550                Ｍ４０−当月他社解約分消費税.                     
006560*                                                                 
006570*--< No.26 >                                                      
006580     COMPUTE    出力−当月末残高             =                    
006590                Ｍ４０−当月消化額他社       -                    
006600                Ｍ４０−当月他社解約分料金   -                    
006610                Ｍ４０−当月他社解約分消費税.                     
006620*                                                                 
006630*----------------------------------------------------------------*
006640*    共通前受金受払残高中間ファイル出力処理                      *
006650*----------------------------------------------------------------*
006660*                                                                 
006670     PERFORM   前受金受払残高中間ファイル出力処理.                
006680 編集処理他社分−ＥＸＩＴ.                                        
006690     EXIT.                                                        
006700******************************************************************
006710*    共通出力処理                                                *
006720******************************************************************
006730 共通出力処理               SECTION.                              
006740 共通出力処理−ＳＴＡＲＴ.                                        
006750*                                                                 
006760*--<  No.02 >                                                     
006770      MOVE  Ｍ４０−レコード区分     TO  出力−前受区分.          
006780*                                                                 
006790*--<  No.03 >                                                     
006800      MOVE  Ｍ４０−経理用主契約区分 TO  出力−主契約区分.        
006810*                                                                 
006820*--<  No.04 >                                                     
006830      MOVE  Ｍ４０−顧客区分         TO  出力−連結区分.          
006840*                                                                 
006850*--<  No.05 >                                                     
006860      MOVE  Ｄ０１−名寄せコード     TO  出力−名寄せコード.      
006870*                                                                 
006880*--<  No.06 >                                                     
006890      MOVE  Ｍ４０−請求先取引先コード  TO  出力−取引先コード.   
006900*                                                                 
006910*--<  No.07 >                                                     
006920      MOVE  Ｍ４０−請求先コード        TO  出力−請求先コード.   
006930*                                                                 
006940*--<  No.08 >                                                     
006950      MOVE  Ｍ４０−契約番号      TO  出力−契約番号.             
006960*                                                                 
006970*--<  No.09 >                                                     
006980      MOVE  Ｍ４０−契約種類        TO  出力−契約種類.           
006990*                                                                 
007000*--<  No.10 >                                                     
007010      MOVE  Ｄ７０−業務年月    TO  出力−業務年月.               
007020*                                                                 
007030*--<  No.11 >                                                     
007040      MOVE  Ｍ４０−担当部課コード  TO  出力−担当部課コード.     
007050*                                                                 
007060*--<  No.12 >                                                     
007070      MOVE  Ｍ０１−債権契約件名       TO  出力−契約件名.        
007080*                                                                 
007090*--<  No.13 >                                                     
007100      MOVE  Ｍ４０−再リース回数      TO  出力−再リース回数.     
007110*                                                                 
007120*--<  No.14 >                                                     
007130      MOVE  Ｍ４０−充当開始年月      TO  出力−充当開始年月.     
007140*                                                                 
007150*--<  No.15 >                                                     
007160      MOVE  Ｍ４０−充当月数         TO  出力−充当月数 .         
007170*                                                                 
007180*--<  No.16 >                                                     
007190      MOVE  Ｍ４０−前払回収方法        TO  出力−前払回収方法.   
007200*                                                                 
007210*--<  No.17 >                                                     
007220      MOVE  Ｍ４０−入金日              TO  出力−入金日.         
007230*                                                                 
007240*--<  No.18 >                                                     
007250      MOVE  Ｍ４０−入金区分            TO  出力−入金区分 .      
007260*                                                                 
007270*--<  No.19 >                                                     
007280      MOVE  Ｄ０１−取引先名称          TO  出力−取引先名称.     
007290*--<  No.20 >                                                     
007300      MOVE  Ｄ０２−請求先名称          TO  出力−請求先名称 .    
007310*                                                                 
007320*--<  No.21 >                                                     
007330      MOVE  ＷＳ−名称１                TO  出力−主契約区分名称. 
007340*                                                                 
007350*--<  No.22 >                                                     
007360      MOVE  ＷＳ−名称２               TO  出力−連結区分名称.    
007370*                                                                 
007380 共通出力処理−ＥＸＩＴ.                                          
007390     EXIT.                                                        
007400******************************************************************
007410*    前受金受払残高中間ファイル出力処理                          *
007420******************************************************************
007430 前受金受払残高中間ファイル出力処理     SECTION.                   
007440 前受金受払残高中間ファイル出力処理−ＳＴＡＲＴ.                   
007450*                                                                 
007460*-----------------------------------------------------------------
007470*      項目編集処理                                               
007480*-----------------------------------------------------------------
007490*                                                                 
007500     IF     出力−前月末残高 = ZERO                               
007510       AND  出力−当月入金額 = ZERO                               
007520       AND  出力−当月消化額 = ZERO                               
007530	     AND  出力−当月末残高 = ZERO                               
007540       CONTINUE                                                   
007550     ELSE                                                         
007560        WRITE  出力−レコード                                     
007570*                                                                 
007580*--< ファイル出力の状態判定 >                                     
007590        EVALUATE Ｗ−状態                                         
007600           WHEN ZERO                                              
007610*--<          ファイル出力件数の加算>                             
007620              COMPUTE  Ｗ−出力−件数 =  Ｗ−出力−件数 + 1       
007630           WHEN OTHER                                             
007640*--<          ファイル出力エラー>                                 
007650              MOVE     -6             TO Ｗ−エラーコード         
007660              PERFORM  エラー処理                                 
007670        END-EVALUATE                                              
007680     END-IF.                                                      
007690 前受金受払残高中間ファイル出力処理−ＥＸＩＴ.                    
007700      EXIT.                                                       
007710******************************************************************
007720*  終了メッセージ出力処理                                        *
007730******************************************************************
007740  終了メッセージ出力処理              SECTION.                    
007750  終了メッセージ出力処理−ＳＴＡＲＴ.                            
007760*                                                                 
007770*----------------------------------------------------------------*
007780*    件数メッセージ出力処理                                      *
007790*----------------------------------------------------------------*
007800     INITIALIZE                       IF-CHOCO001.                
007810     MOVE  "3"                        TO  共１−イベント種別.     
007820     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007830     MOVE  "0"                        TO  共１−復帰コード.       
007840     MOVE  "M40MAB"                   TO  共１−処理テーブルＩＤ. 
007850     MOVE  "COUNT"                    TO  共１−処理識別.         
007860     MOVE  Ｗ−入力−件数             TO  共１−データ内容.       
007870     MOVE  "前受情報テーブル（入力）" TO  共１−その他メッセージ. 
007880     CALL  CLOCO001                USING  IF-CHOCO001.            
007890*                                                                 
007900     INITIALIZE                       IF-CHOCO001.                
007910     MOVE  "3"                        TO  共１−イベント種別.     
007920     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007930     MOVE  "0"                        TO  共１−復帰コード.       
007940     MOVE  "SFHSED25"                 TO  共１−処理テーブルＩＤ. 
007950     MOVE  "COUNT"                    TO  共１−処理識別.         
007960     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
007970     MOVE  "前受金受払残高ファイル"   TO  共１−その他メッセージ. 
007980     CALL  CLOCO001                USING  IF-CHOCO001.            
007990*                                                                 
008000*----------------------------------------------------------------*
008010*    終了メッセージ出力                                          *
008020*----------------------------------------------------------------*
008030*                                                                 
008040     INITIALIZE                       IF-CHOCO001.                
008050     MOVE  "3"                        TO  共１−イベント種別.     
008060     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
008070     MOVE  "0"                        TO  共１−復帰コード.       
008080     MOVE  "END"                      TO  共１−処理識別.         
008090     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
008100     CALL  CLOCO001                USING  IF-CHOCO001.            
008110*                                                                 
008120 終了メッセージ出力処理−ＥＸＩＴ.                                
008130     EXIT.                                                        
008140******************************************************************
008150*    ＤＢクローズ                                <4.1>           *
008160******************************************************************
008170  ＤＢクローズ処理                 SECTION.                       
008180  ＤＢクローズ処理−ＳＴＡＲＴ.                                   
008190**                                                                
008200*--< カーソル クローズ >                                          
008210     EXEC  SQL                                                    
008220         CLOSE  CUR1                                              
008230     END-EXEC.                                                    
008240  ＤＢクローズ処理−ＥＸＩＴ.                                     
008250     EXIT.                                                        
008260******************************************************************
008270*    エラー処理                                                  *
008280******************************************************************
008290 エラー処理                       SECTION.                        
008300 エラー処理−ＳＴＡＲＴ.                                          
008310*                                                                 
008320     MOVE  "Y"                        TO  異常終了−フラグ.       
008330     INITIALIZE                           IF-CHOCO001.            
008340*                                                                 
008350     EVALUATE  Ｗ−エラーコード                                   
008360        WHEN  -2                                               
008370*--<       ファイルオープンエラー >                               
008380           MOVE  "1"                  TO  共１−イベント種別      
008390           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008400           MOVE  "9"                  TO  共１−復帰コード        
008410           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
008420           MOVE  "OPEN"               TO  共１−処理識別          
008430           MOVE  Ｗ−状態             TO  共１−データ内容        
008440           MOVE  "ファイルオープン失敗"                           
008450                                      TO  共１−その他メッセージ  
008460           CALL  CLOCO001          USING  IF-CHOCO001             
008470*                                                                 
008480        WHEN  -6                                                  
008490*--<       ファイル出力エラー >                                   
008500           MOVE  "1"                  TO  共１−イベント種別      
008510           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008520           MOVE  "9"                  TO  共１−復帰コード        
008530           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
008540           MOVE  "WRITE"              TO  共１−処理識別          
008550           MOVE  Ｗ−状態             TO  共１−データ内容        
008560           MOVE  "ファイル出力失敗"   TO  共１−その他メッセージ  
008570           CALL  CLOCO001          USING  IF-CHOCO001             
008580*                                                                 
008590        WHEN  -10                                                 
008600*--<       ＯＲＡＣＬＥ接続失敗 >                                 
008610           MOVE  "1"                  TO  共１−イベント種別      
008620           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008630           MOVE  "9"                  TO  共１−復帰コード        
008640           MOVE  "CONNECT"            TO  共１−処理識別          
008650           MOVE  SQLCODE              TO  共１−データ内容        
008660           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008670           CALL  CLOCO001          USING  IF-CHOCO001             
008680*                                                                 
008690        WHEN  -20                                                 
008700*--<       業務管理テーブル読込失敗 >                             
008710           MOVE  "1"                  TO  共１−イベント種別      
008720           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008730           MOVE  "9"                  TO  共１−復帰コード        
008740           MOVE  "D70GYM"             TO  共１−処理テーブルＩＤ  
008750           MOVE  "SELECT"             TO  共１−処理識別          
008760           MOVE  SQLCODE              TO  共１−データ内容        
008770           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008780           CALL  CLOCO001          USING  IF-CHOCO001             
008790*                                                                 
008800        WHEN  -30                                                 
008810*--<       結合テーブルカーソルオープン失敗 >                     
008820           MOVE  "1"                  TO  共１−イベント種別      
008830           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008840           MOVE  "9"                  TO  共１−復帰コード        
008850           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
008860           MOVE  "OPEN"               TO  共１−処理識別          
008870           MOVE  SQLCODE              TO  共１−データ内容        
008880           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008890           CALL  CLOCO001          USING  IF-CHOCO001             
008900*                                                                 
008910        WHEN  -40                                                 
008920*--<       結合テーブルカーソルオープン失敗 >                     
008930           MOVE  "1"                  TO  共１−イベント種別      
008940           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008950           MOVE  "9"                  TO  共１−復帰コード        
008960           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
008970           MOVE  "FETCH"              TO  共１−処理識別          
008980           MOVE  SQLCODE              TO  共１−データ内容        
008990           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009000           CALL  CLOCO001          USING  IF-CHOCO001             
009010*                                                                 
009020        WHEN  -50                                                 
009030*--<       項目名称抽出処理失敗 >                                 
009040           MOVE  "2"                  TO  共１−イベント種別      
009050           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009060           MOVE  "9"                  TO  共１−復帰コード        
009070           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
009080           MOVE  "SELECT"             TO  共１−処理識別          
009090           MOVE  SQLCODE              TO  共１−データ内容        
009100           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009110           CALL  CLOCO001          USING  IF-CHOCO001             
009120           MOVE  "N"                  TO  異常終了−フラグ        
009130*                                                                 
009140        WHEN  -70                                                 
009150*--<       債権情報（一般）ＤＢより項目の抽出処理失敗 >           
009160           MOVE  "2"                  TO  共１−イベント種別      
009170           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009180           MOVE  "9"                  TO  共１−復帰コード        
009190           MOVE  "M01SAJ"             TO  共１−処理テーブルＩＤ  
009200           MOVE  "SELECT"             TO  共１−処理識別          
009210           MOVE  SQLCODE              TO  共１−データ内容        
009220           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009230           CALL  CLOCO001          USING  IF-CHOCO001             
009240           MOVE  "N"                  TO  異常終了−フラグ        
009250*                                                                 
009260        WHEN  OTHER                                               
009270           MOVE  "N"                  TO  異常終了−フラグ        
009280     END-EVALUATE.                                                
009290*                                                                 
009300     IF  異常終了−フラグ  =  "Y"                                 
009310        PERFORM  終了メッセージ出力処理                           
009320        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
009330        EXIT  PROGRAM                                             
009340     END-IF.                                                      
009350*                                                                 
009360 エラー処理−ＥＸＩＴ.                                            
009370      EXIT.                                                       
009380******************************************************************
009390*                  END OF PROGRAM                                *
009400******************************************************************
