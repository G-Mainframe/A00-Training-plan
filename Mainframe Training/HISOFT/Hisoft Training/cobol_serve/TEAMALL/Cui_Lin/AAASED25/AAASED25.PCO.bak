000010******************************************************************
000020*         ＜ＮＮＮＮＮ＞                                         *
000030*      1. プログラム名    ：前受金受払残高ファイル作成           *
000040*      2. プログラムID    ：AAASED25                             *
000050*      3. 処理概要        ：経理締処理（帳票作成）               *
000060*                           （リース前受関連帳票抽出）           *
000070*                                                                *
000080*      4. 作成者          ：cuilin                               *
000090*      5. 作成日          ：XXXX.XX.XX                           *
000100
000110******************************************************************
000120*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000130******************************************************************
000140 IDENTIFICATION                       DIVISION.                   
000150*                                                                 
000160 PROGRAM-ID.                            AAASED25.                   
000170
000180******************************************************************
000190*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000200******************************************************************
000210 ENVIRONMENT                          DIVISION.                   
000220******************************************************************
000230******************************************************************
000240*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000250******************************************************************
000260 INPUT-OUTPUT                         SECTION.                    
000270 FILE-CONTROL.                                                    
000280*                                                                 
000290     SELECT         出力ファイル  ASSIGN        TO   U11          
000300     FILE STATUS    IS     ファイル状態                           
000310     ORGANIZATION   IS     LINE       SEQUENTIAL.                 
000320*                                                                 
000330******************************************************************
000340*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000350******************************************************************
000360 DATA                                 DIVISION.                   
000370******************************************************************
000380*    ＦＩＬＥ                      ＳＥＣＴＩＯＮ                *
000390******************************************************************
000400 FILE                                 SECTION.                    
000410*----------------------------------------------------------------*
000420*  前受金受払残高中間ファイル                                    *
000430*----------------------------------------------------------------*
000440 FD  出力ファイル                                                 
000450     LABEL  RECORD    IS              STANDARD                    
000460     BLOCK  CONTAINS  0               RECORDS.                    
000470*                                                                 
000480 01  OUT-FILE.                                                    
000490     COPY   CPSCE50   REPLACING      ==()==  BY  ==出力−==.     
000500
000510******************************************************************
000520*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000530******************************************************************
000540 WORKING-STORAGE                     SECTION.                    
000550                                                  
000560               
000570*----------------------------------------------------------------*
000580*    ホスト変数定義エリア                                        *
000590*----------------------------------------------------------------*
000600     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000610*                                                                 
000620*--< ＯＲＡＣＬＥ共通変数 >                                       
000630     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000640*                                                                 
000650*--< ＯＲＡＣＬＥ  ＳＱＬ実行情報 >                               
000660     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000670*                                                                 
000680*--< 前受情報ＤＢ >                                               
000690     EXEC  SQL  INCLUDE  M40MAB.CBL           END-EXEC.           
000700*                                                                 
000710*--< 業務管理テーブル >                                           
000720     EXEC  SQL  INCLUDE  D70GYM.CBL            END-EXEC.          
000730*                                                                 
000740*--< 取引先マスタ>                                                
000750     EXEC  SQL  INCLUDE  D01TRS.CBL            END-EXEC.          
000760
000770*--< 請求先マスタ>                                                
000780     EXEC  SQL  INCLUDE  D02SQS.CBL            END-EXEC.          
000790
000800*--< 項目名称マスタ>                                              
000810     EXEC  SQL  INCLUDE  D19MSY.CBL            END-EXEC.          
000820
000830*--< 債権情報（一般）ＤＢ>                                       
000840     EXEC  SQL  INCLUDE  M01SAJ.CBL            END-EXEC.         
000850 01  ＷＳ−名称１         PIC  X(60).                  
000860 01  ＷＳ−名称２         PIC  X(60).                  
000870
000880 01  ＷＳ−業務管理ＩＤ   PIC  X(08)  VALUE 'GYMKNRRC'.
000890 01  ＷＳ−コードＮＯ１   PIC  X(03)  VALUE '038'.
000900 01  ＷＳ−コードＮＯ２   PIC  X(03)  VALUE '005'.
000910                                                                 
000920     EXEC  SQL  END  DECLARE          SECTION  END-EXEC.          
000930*
000940                                         
000950*----------------------------------------------------------------*
000960*    ＷＯＲＫエリア                                              *
000970*----------------------------------------------------------------*
000980 01  ＷＯＲＫ−エリア.                                            
000990*--< エラー判定用 >                                               
001000     03  Ｗ−エラーコード             PIC S9(04).                 
001010* 
001020*--< ファイル状態 >                                               
001030     03  ファイル状態                 PIC  X(02).  
001040                                                          
001050*--< フラグアリア >                                               
001060     03  フラグアリア.                                            
001070         05  Ｗ−終了−フラグ         PIC  X(01).                 
001080         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
001090*                                                                 
001100*--< 件数エリア >                                                 
001110     03  件数エリア.                                              
001120         05  Ｗ−入力−件数           PIC  9(09).                 
001130         05  Ｗ−出力−件数           PIC  9(09).                 
001140
001150*                                                                 
001160
001170*--< 共通情報 >                                                   
001180 01  Ｗ−共通情報.                                                
001190     03  Ｗ−システム日付.                                        
001200         05  Ｗ−世紀                 PIC  X(02) VALUE  "20".     
001210         05  Ｗ−年月日               PIC  X(06).                 
001220     03  Ｗ−システム時刻             PIC  X(08).                 
001230     03  Ｗ−担当者                   PIC  X(08) VALUE "IKOPG   ".
001240*                                                                 
001250*----------------------------------------------------------------*
001260*    サブルーチン名                                              *
001270*----------------------------------------------------------------*
001280 01  CALL-AREA.                                                   
001290*--< 共通ログサブルーチン >                                       
001300     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
001310     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
001320*                                                                 
001330*----------------------------------------------------------------*
001340*    ＣＯＰＹ領域                                                *
001350*----------------------------------------------------------------*
001360*--< 共通ログ用パラメータ >                                       
001370 01  IF-CHOCO001.                                                 
001380     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
001390*                                                                 
001400*----------------------------------------------------------------*
001410*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001420*----------------------------------------------------------------*
001430 01  PARA-AREA.                                                   
001440     COPY CPBCO001.                                               
001450******************************************************************
001460*    定数用データ定義エリア                                      *
001470******************************************************************
001480 CONSTANT                             SECTION.                    
001490 01  定数領域.                                                    
001500     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
001510     03  定数−プログラム名           PIC  X(80)                  
001520                                      VALUE  "変則払移行".        
001530     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001540     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001550     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001560     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001570******************************************************************
001580*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001590******************************************************************
001600 PROCEDURE                            DIVISION.                   
001610*                                                                 
001620     PERFORM  初期処理.                                           
001630*                                                                 
001640     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001650*                                                                 
001660     PERFORM  終了処理.                                           
001670*                                                                 
001680     STOP     RUN.                                                
001690*                                                                 
001700******************************************************************
001710*    初期処理                                                    *
001720******************************************************************
001730 初期処理                             SECTION.                    
001740 初期処理−ＳＴＡＲＴ.                                            
001750*                                                                 
001760*----------------------------------------------------------------*
001770*    開始メッセージ出力処理                                      *
001780*----------------------------------------------------------------*
001790     INITIALIZE                       IF-CHOCO001.                
001800     MOVE  "3"                        TO  共１−イベント種別.     
001810     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001820     MOVE  "0"                        TO  共１−復帰コード.       
001830     MOVE  "START"                    TO  共１−処理識別.         
001840     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001850     CALL  CLOCO001                USING  IF-CHOCO001.            
001860*                                                                 
001870*----------------------------------------------------------------*
001880*    作業領域の初期値処理                                        *
001890*----------------------------------------------------------------*
001900     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001910     INITIALIZE                           ＷＯＲＫ−エリア.       
001920
001930*--< ＯＲＡＣＬＥ接続 >                                           
001940     PERFORM   ＯＲＡＣＬＥ接続.                                  
001950*--<  業務管理テーブル読込  >                                                                  
001960     PERFORM 業務管理テーブル読込.                                                             
001970*--< 結合テーブルカーソル定義 >                                   
001980     PERFORM  結合テーブルカーソル定義.                           
001990*--<         ファイルオープン >
002000     PERFORM ファイルオープン.                                                               
002010*--< 結合テーブルカーソル読込(１件目) >                           
002020     PERFORM  結合テーブルカーソル読込.                           
002030*                                                                 
002040 初期処理−ＥＸＩＴ.                                              
002050     EXIT.                                                        
002060******************************************************************
002070*    ＯＲＡＣＬＥ接続                                            *
002080******************************************************************
002090 ＯＲＡＣＬＥ接続                     SECTION.                    
002100 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
002110*                                                                 
002120*--< ＤＢ接続用情報を取得処理 >                                   
002130     CALL  COBCO001                USING  PARA-AREA.              
002140*                                                                 
002150     MOVE  PARA-DBSTRING              TO  DB-STRING.              
002160     MOVE  PARA-USERNAME              TO  USERNAME.               
002170     MOVE  PARA-PASSWORD              TO  PASSWD.                 
002180*                                                                 
002190*----------------------------------------------------------------*
002200*    開始接続                                                    *
002210*----------------------------------------------------------------*
002220     IF    DB-STRING  =  SPACE                                    
002230        EXEC SQL                                                  
002240           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002250        END-EXEC                                                  
002260     ELSE                                                         
002270        EXEC SQL                                                  
002280           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002290             USING  :DB-STRING                                    
002300        END-EXEC                                                  
002310     END-IF.                                                      
002320*                                                                 
002330*----------------------------------------------------------------*
002340*    接続確認                                                    *
002350*----------------------------------------------------------------*
002360     EVALUATE  SQLCODE                                            
002370        WHEN   定数−ＳＱＬＯＫ                                   
002380           CONTINUE                                               
002390        WHEN   OTHER                                              
002400*--<       接続エラー >                                           
002410           MOVE     -10               TO  Ｗ−エラーコード        
002420           PERFORM  エラー判定処理                                
002430     END-EVALUATE.                                                
002440*                                                                 
002450 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002460     EXIT.                                                        
002470******************************************************************
002480*        結合テーブルカーソル定義                                *
002490******************************************************************
002500 結合テーブルカーソル定義             SECTION.                    
002510 結合テーブルカーソル定義−ＳＴＡＲＴ.                            
002520*                                                                 
002530*----------------------------------------------------------------*
002540*    カーソルＯＰＥＮ処理                                        *
002550*----------------------------------------------------------------*
002560     EXEC SQL                                                     
002570        DECLARE CUR1  CURSOR FOR                                  
002580           SELECT  M40MAB_TBL.協調区分                            
002590                  ,M40MAB_TBL.レコード区分   
002600                  ,M40MAB_TBL.経理用主契約区分   
002610                  ,M40MAB_TBL.顧客区分    
002620                  ,NVL(D01TRS_TBL.名寄せコード,RPAD(' ',40,' '))   
002630                  ,M40MAB_TBL.請求先取引先コード   
002640                  ,M40MAB_TBL.請求先コード   
002650                  ,M40MAB_TBL.契約番号    
002660                  ,M40MAB_TBL.契約種類    
002670                  ,M40MAB_TBL.担当部課コード   
002680                  ,M40MAB_TBL.再リース回数   
002690                  ,M40MAB_TBL.充当開始年月   
002700                  ,M40MAB_TBL.充当月数    
002710                  ,M40MAB_TBL.前払回収方法   
002720                  ,M40MAB_TBL.入金日    
002730                  ,M40MAB_TBL.入金区分    
002740                  ,NVL(D01TRS_TBL.取引先名称,RPAD(' ',80,' '))   
002750                  ,NVL(D02SQS_TBL.請求先名称,RPAD(' ',80,' '))   
002760                  ,M40MAB_TBL.前月末残高                          
002770                  ,M40MAB_TBL.当月回収額                          
002780                  ,M40MAB_TBL.当月消化額    
002790                  ,M40MAB_TBL.当月末残高
002800                  ,M40MAB_TBL.前月末残高他社
002810                  ,M40MAB_TBL.当月回収額他社
002820                  ,M40MAB_TBL.当月消化額他社
002830                  ,M40MAB_TBL.当月他社解約分料金
002840                  ,M40MAB_TBL.当月他社解約分消費税
002850                  ,M40MAB_TBL.当月末残高他社
002860             FROM  M40MAB_TBL                                     
002870                  ,D01TRS_TBL                                     
002880                  ,D02SQS_TBL                                     
002890            WHERE  M40MAB_TBL.前受金受払残高表対象フラグ  =  '1'  
002900              AND  M40MAB_TBL.請求先取引先コード                  
002910                              = D01TRS_TBL.取引先コード(+)           
002920              AND  M40MAB_TBL.請求先取引先コード                  
002930                              = D02SQS_TBL.取引先コード(+)           
002940              AND  M40MAB_TBL.請求先コード                        
002950                              = D02SQS_TBL.請求先コード(+)           
002960         ORDER BY  M40MAB_TBL.レコード区分                        
002970                  ,M40MAB_TBL.契約番号                            
002980     END-EXEC.                                                    
002990*                                                                 
003000
003010*----------------------------------------------------------------*
003020*    カーソルＯＰＥＮ処理                                        *
003030*----------------------------------------------------------------*
003040     EXEC  SQL                                                    
003050        OPEN  CUR1                                                
003060     END-EXEC.                                                    
003070*                                                                 
003080*----------------------------------------------------------------*
003090*    カーソルＯＰＥＮ確認                                        *
003100*----------------------------------------------------------------*
003110     EVALUATE  SQLCODE                                            
003120        WHEN  定数−ＳＱＬＯＫ                                    
003130*--<       正常 >                                                 
003140           CONTINUE                                               
003150        WHEN  OTHER                                               
003160*--<       カーソルＯＰＥＮエラー >                               
003170           MOVE -20                   TO  Ｗ−エラーコード        
003180           PERFORM  エラー判定処理                                
003190     END-EVALUATE.                                                
003200*                                                                 
003210 結合テーブルカーソル定義−ＥＸＩＴ.                              
003220     EXIT.                                                        
003230
003240******************************************************************
003250*    ファイルオープン                                            *
003260******************************************************************
003270 ファイルオープン                     SECTION.                    
003280 ファイルオープン−ＳＴＡＲＴ.                                    
003290*                                                                 
003300*--< ファイルオープン ＯＰＥＮ >                                  
003310     OPEN  OUTPUT  出力ファイル.                                  
003320*                                                                 
003330*--< ファイルオープン状態　判定 >                                   
003340     EVALUATE    ファイル状態                                   
003350        WHEN  ZERO                                                
003360*--<       ファイルオープン正常 >                                 
003370           CONTINUE                                               
003380        WHEN  OTHER                                               
003390*--<       ファイルオープンエラー >                               
003400           MOVE  SPACE                TO  Ｗ−異常終了−フラグ    
003410           MOVE  -40                  TO  Ｗ−エラーコード        
003420           PERFORM  エラー判定処理                                
003430     END-EVALUATE.                                                
003440*                                                                 
003450 ファイルオープン−ＥＸＩＴ.                                      
003460     EXIT.                                                        
003470*                                                                 
003480
003490******************************************************************
003500*    結合テーブルカーソル読込                                    *
003510******************************************************************
003520 結合テーブルカーソル読込             SECTION.                    
003530 結合テーブルカーソル読込−ＳＴＡＲＴ.                            
003540*                                                                 
003550*--< 結合テーブルカーソル読込 >                                   
003560     EXEC SQL                                                     
003570         FETCH  CUR1                                              
003580          INTO  :Ｍ４０−協調区分                                 
003590               ,:Ｍ４０−レコード区分                             
003600               ,:Ｍ４０−経理用主契約区分                         
003610               ,:Ｍ４０−顧客区分                                 
003620               ,:Ｄ０１−名寄せコード                             
003630               ,:Ｍ４０−請求先取引先コード                       
003640               ,:Ｍ４０−請求先コード                             
003650               ,:Ｍ４０−契約番号                                 
003660               ,:Ｍ４０−契約種類                                 
003670               ,:Ｍ４０−担当部課コード                           
003680               ,:Ｍ４０−再リース回数                             
003690               ,:Ｍ４０−充当開始年月                             
003700               ,:Ｍ４０−充当月数                                 
003710               ,:Ｍ４０−前払回収方法                             
003720               ,:Ｍ４０−入金日                                   
003730               ,:Ｍ４０−入金区分                                 
003740               ,:Ｄ０１−取引先名称                               
003750               ,:Ｄ０２−請求先名称                               
003760               ,:Ｍ４０−前月末残高                               
003770               ,:Ｍ４０−当月回収額                               
003780               ,:Ｍ４０−当月消化額                               
003790               ,:Ｍ４０−当月末残高                               
003800               ,:Ｍ４０−前月末残高他社                           
003810               ,:Ｍ４０−当月回収額他社                           
003820               ,:Ｍ４０−当月消化額他社                           
003830               ,:Ｍ４０−当月他社解約分料金                       
003840               ,:Ｍ４０−当月他社解約分消費税                     
003850               ,:Ｍ４０−当月末残高他社                           
003860                                                                  
003870     END-EXEC.                                                    
003880*                                                                 
003890*----------------------------------------------------------------*
003900*    結合テーブルカーソル読込を確認                              *
003910*----------------------------------------------------------------*
003920     EVALUATE   SQLCODE                                           
003930        WHEN  定数−ＳＱＬＯＫ                                    
003940*--<       正常 >                                                 
003950*--<  入力−件数>                                                 
003960           COMPUTE  Ｗ−入力−件数  =  Ｗ−入力−件数  +  1       
003970        WHEN   定数−ＳＱＬＥＮＤ                                 
003980*--<       読込終了 >                                             
003990           MOVE  "Y"                  TO  Ｗ−終了−フラグ        
004000        WHEN   OTHER                                              
004010*--<       読込エラー >                                           
004020           MOVE     -30               TO  Ｗ−エラーコード        
004030           PERFORM  エラー判定処理                                
004040     END-EVALUATE.                                                
004050                                                                  
004060                                                         
004070                                                                  

004780     PERFORM 項目名称マスタより項目の抽出処理.                                                            
004790* 
           PERFORM 債権情報ＤＢより項目の抽出処理.                                                                
004800 結合テーブルカーソル読込−ＥＸＩＴ.                              
004810     EXIT.                                                        


004820******************************************************************
004830*    項目名称マスタより項目の抽出処理                            *
004840******************************************************************                                                                  
004490
004850 項目名称マスタより項目の抽出処理            SECTION.                    
004860 項目名称マスタより項目の抽出処理−ＳＴＡＲＴ.                                              
004870*    
004080*--< 項目名称マスタより項目の抽出処理 >                           
004090     EXEC SQL                                                     
004100           SELECT  名称   
004110             INTO  :ＷＳ−名称１        
004120             FROM  D19MSY_TBL                                     
004130            WHERE  D19MSY_TBL.コードＮＯ = :ＷＳ−コードＮＯ１                  
004140              AND  SUBSTR(D19MSY_TBL.コード,1,1) = 
004150                                    :Ｍ４０−経理用主契約区分 
004160     END-EXEC.                                                    
004170                                                                  
004180*--<       SQLCODE判定処理 >                                      
004190     EVALUATE  SQLCODE                                            
004200        WHEN  定数−ＳＱＬＯＫ                                    
004210*--<       正常 >                                                 
004220           CONTINUE                                               
004230        WHEN  OTHER                                               
004240*--<       ＴＡＢＬＥ  ＳＥＬＥＣＴ  エラー >                     
004250           MOVE -60                   TO  Ｗ−エラーコード        
004260           PERFORM  エラー判定処理                                
004270     END-EVALUATE.                                                
004280                                                                  
004290     EXEC SQL                                                     
004300           SELECT  D19MSY_TBL.名称 INTO  :ＷＳ−名称２     
004310             FROM  D19MSY_TBL   
004320                                
004330            WHERE  D19MSY_TBL.コードＮＯ  =  :ＷＳ−コードＮＯ２                
004340              AND  SUBSTR(D19MSY_TBL.コード,1,2)    =  
004350                                           :Ｍ４０−顧客区分     
004360     END-EXEC.                                                    
004370                                                                  
004380*--<       SQLCODE判定処理 >                                      
004390     EVALUATE  SQLCODE                                            
004400        WHEN  定数−ＳＱＬＯＫ                                    
004410*--<       正常 >                                                 
004420           CONTINUE                                               
004430        WHEN  OTHER                                               
004440*--<       ＴＡＢＬＥ  ＳＥＬＥＣＴ  エラー >                     
004450           MOVE -60              TO  Ｗ−エラーコード        
004460           PERFORM  エラー判定処理                                
004470     END-EVALUATE.                                                
004770                                                               
       項目名称マスタより項目の抽出処理−ＥＸＩＴ.                                                
005080     EXIT.               
004820******************************************************************
004830*    債権情報（一般）ＤＢより項目の抽出処理                      *
004840******************************************************************                                                                  
004490
004850 債権情報ＤＢより項目の抽出処理            SECTION.                    
004860 債権情報ＤＢより項目の抽出処理−ＳＴＡＲＴ.                                              
004870*    
      *--< 債権情報（一般）ＤＢより項目の抽出処理 >                     
004500     EXEC SQL                                                     
004510           SELECT  M01SAJ_TBL.状態フラグ                          
004520                  ,M01SAJ_TBL.債権契約件名                        
004530                  ,M01SAJ_TBL.担保区分                            
004540             INTO :Ｍ０１−状態フラグ                             
004550                  ,:Ｍ０１−債権契約件名                           
004560                  ,:Ｍ０１−担保区分        
004570             FROM  M01SAJ_TBL                                     
004580            WHERE  M01SAJ_TBL.レコード区分 =  '1'                 
004590              AND  M01SAJ_TBL.契約番号                            
004600                              =  :Ｍ４０−契約番号                 
004610              AND  M01SAJ_TBL.再リース回数                        
004620                              =  :Ｍ４０−再リース回数             
004630              AND  M01SAJ_TBL.契約種類                            
004640                              =  :Ｍ４０−契約種類                 
004650     END-EXEC.                                                    
004660                                                                  
004670*--<       SQLCODE判定処理 >                                      
004680     EVALUATE  SQLCODE                                            
004690        WHEN  定数−ＳＱＬＯＫ                                    
004700*--<       正常 >                                                 
004710           CONTINUE                                               
004720        WHEN  OTHER                                               
004730*--<       ＴＡＢＬＥ  ＳＥＬＥＣＴ  エラー >                     
004740           MOVE -70                   TO  Ｗ−エラーコード        
004750           PERFORM  エラー判定処理                                
004760     END-EVALUATE.                                                
004770                                                               
       債権情報ＤＢより項目の抽出処理−ＥＸＩＴ.                                                
005080     EXIT.               

004820******************************************************************
004830*    主処理                                                      *
004840******************************************************************
004850 主処理                               SECTION.                    
004860 主処理−ＳＴＡＲＴ.                                              
004870*    
004880*--<     前受金出力処理 >                                         
004890     IF  Ｍ４０−前月末残高  =  ZERO      AND                       
004900         Ｍ４０−当月回収額  =  ZERO      AND                       
004910         Ｍ４０−当月消化額  =  ZERO      AND                       
004920         Ｍ４０−当月末残高  =  ZERO                                
004930        CONTINUE                                                  
004940     ELSE                                                         
004950                                                     
004960         PERFORM  編集出力処理１                                      
004970         PERFORM  出力処理                                           
004980       IF Ｍ０１−担保区分  NOT = '1' AND  Ｍ４０−協調区分 = '2'  
004990         PERFORM  編集出力処理２                                     
005000         PERFORM  出力処理                                          
005010       END-IF  
005020     END-IF.                                                    
005030*--< 結合テーブルカーソル読込（２件目以降） >                     
005040     PERFORM  結合テーブルカーソル読込.                           
005050*                                                                 
005060*                                                                 
005070 主処理−ＥＸＩＴ.                                                
005080     EXIT.                                                        
005090******************************************************************
005100*     編集出力処理１                                             *
005110******************************************************************
005120 編集出力処理１                         SECTION.                  
005130 編集出力処理１−ＳＴＡＲＴ.                                      
005140*                                                                 
005150*----------------------------------------------------------------*
005160*       初期化処理                                               *
005170*----------------------------------------------------------------*
005180*        MOVE  SPACE                   TO  変則払                  
005190*        INITIALIZE                        変則払                  
005200*                                                                 
005210*----------------------------------------------------------------*
005220*       項目編集処理                                             *
005230*----------------------------------------------------------------*
005240                                                                  
005250      IF  Ｍ０１−担保区分  NOT =  '1'                            
005260        IF  Ｍ０１−状態フラグ < '3'                              
005270*--<    No.01 >                                                   
005280            MOVE  3  TO  出力−自他社区分                         
005290        ELSE                                                      
005300            MOVE  1  TO  出力−自他社区分                         
005310*       END-IF                                                    
005320*--<    No.02>                                                    
005330        MOVE  Ｍ４０−レコード区分       TO  出力−前受区分       
005340                                                                  
005350*--<    No.03>                                                    
005360        MOVE  Ｍ４０−経理用主契約区分   TO  出力−主契約区分     
005370*                                                                 
005380*--<    No.04>                                                    
005390        MOVE  Ｍ４０−顧客区分           TO  出力−連結区分       
005400*                                                                 
005410*--<    No.05>                                                    
005420        MOVE  Ｄ０１−名寄せコード       TO  出力−名寄せコード   
005430*                                                                 
005440*--<    No.06>                                                    
005450        MOVE  Ｍ４０−請求先取引先コード TO  出力−取引先コード   
005460*                                                                 
005470*--<    No.07>                                                    
005480        MOVE  Ｍ４０−請求先コード     TO   出力−請求先コード    
005490*                                                                 
005500*--<    No.08>                                                    
005510        MOVE  Ｍ４０−契約番号         TO   出力−契約番号        
005520*                                                                 
005530*--<    No.09>                                                    
005540        MOVE  Ｍ４０−契約種類         TO   出力−契約種類        
005550*                                                                 
005560*--<    No.10>                                                    
005570        MOVE  Ｄ７０−バッチ用業務年月  TO   出力−業務年月       
005580*--<    No.11>                                                    
005590        MOVE  Ｍ４０−担当部課コード  TO   出力−担当部課コード   
005600*--<    No.12>                                                    
005610        MOVE  Ｍ０１−債権契約件名    TO   出力−契約件名         
005620*--<    No.13>                                                    
005630        MOVE  Ｍ４０−再リース回数    TO   出力−再リース回数     
005640*--<    No.14>                                                    
005650        MOVE  Ｍ４０−充当開始年月    TO   出力−充当開始年月     
005660*--<    No.15>                                                    
005670        MOVE  Ｍ４０−充当月数        TO   出力−充当月数         
005680*--<    No.16>                                                    
005690        MOVE  Ｍ４０−前払回収方法    TO   出力−前払回収方法     
005700*--<    No.17>                                                    
005710        MOVE  Ｍ４０−入金日          TO   出力−入金日           
005720*--<    No.18>                                                    
005730        MOVE  Ｍ４０−入金区分        TO   出力−入金区分         
005740*--<    No.19>                                                    
005750        MOVE  Ｄ０１−取引先名称      TO   出力−取引先名称       
005760*--<    No.20>                                                    
005770        MOVE  Ｄ０２−請求先名称      TO   出力−請求先名称       
005780*--<    No.21>                                                    
005790        MOVE  ＷＳ−名称１            TO   出力−主契約区分名称   
005800*--<    No.22>                                                    
005810        MOVE  ＷＳ−名称２           TO   出力−連結区分名称     
005820*--<    No.23>                                                    
005830        MOVE  Ｍ４０−前月末残高      TO   出力−前月末残高       
005840*--<    No.24>                                                    
005850        MOVE  Ｍ４０−当月回収額      TO   出力−当月入金額       
005860*--<    No.25>                                                    
005870        MOVE  Ｍ４０−当月消化額      TO   出力−当月消化額       
005880*--<    No.26>                                                    
005890        MOVE  Ｍ４０−当月末残高      TO   出力−当月末残高       
005900                                                                  
005910     END-IF.                                                      
005920                                                                  
005930 編集出力処理１−ＥＸＩＴ.                                        
005940     EXIT.                                                        
005950                                                                  
005960                                                                  
005970******************************************************************
005980*     編集出力処理２                                             *
005990******************************************************************
006000 編集出力処理２                         SECTION.                  
006010 編集出力処理２−ＳＴＡＲＴ.                                      
006020*                                                                 
006030*----------------------------------------------------------------*
006040*       初期化処理                                               *
006050*----------------------------------------------------------------*
006060*        MOVE  SPACE                   TO  変則払                  
006070*        INITIALIZE                        変則払                  
006080*                                                                 
006090*----------------------------------------------------------------*
006100*       項目編集処理                                             *
006110*----------------------------------------------------------------*
006120                                                                  
006130      IF  Ｍ０１−担保区分  NOT =  '1'                            
006140        IF  Ｍ４０−協調区分 = '2'                                
006150          IF  Ｍ０１−状態フラグ < '3'                            
006160*--<      No.01 >                                                 
006170              MOVE  4  TO  出力−自他社区分                       
006180          ELSE                                                    
006190              MOVE  2  TO  出力−自他社区分                       
006200*         END-IF                                                  
006210*                                                                 
006220*--<      No.02>                                                  
006230          MOVE  Ｍ４０−レコード区分       TO  出力−前受区分     
006240                                                                  
006250*--<      No.03>                                                  
006260          MOVE  Ｍ４０−経理用主契約区分   TO  出力−主契約区分   
006270*                                                                 
006280*--<      No.04>                                                  
006290          MOVE  Ｍ４０−顧客区分           TO  出力−連結区分     
006300*                                                                 
006310*--<      No.05>                                                  
006320          MOVE  Ｄ０１−名寄せコード       TO  出力−名寄せコード 
006330*                                                                 
006340*--<      No.06>                                                  
006350          MOVE  Ｍ４０−請求先取引先コード TO  出力−取引先コード 
006360*                                                                 
006370*--<      No.07>                                                  
006380          MOVE  Ｍ４０−請求先コード     TO   出力−請求先コード  
006390*                                                                 
006400*--<      No.08>                                                  
006410          MOVE  Ｍ４０−契約番号         TO   出力−契約番号      
006420*                                                                 
006430*--<      No.09>                                                  
006440          MOVE  Ｍ４０−契約種類         TO   出力−契約種類      
006450*                                                                 
006460*--<      No.10>                                                  
006470          MOVE  Ｄ７０−バッチ用業務年月  TO   出力−業務年月     
006480*--<      No.11>                                                  
006490          MOVE  Ｍ４０−担当部課コード  TO   出力−担当部課コード 
006500*--<      No.12>                                                  
006510          MOVE  Ｍ０１−債権契約件名    TO   出力−契約件名       
006520*--<      No.13>                                                  
006530          MOVE  Ｍ４０−再リース回数    TO   出力−再リース回数   
006540*--<      No.14>                                                  
006550          MOVE  Ｍ４０−充当開始年月    TO   出力−充当開始年月   
006560*--<      No.15>                                                  
006570          MOVE  Ｍ４０−充当月数        TO   出力−充当月数       
006580*--<      No.16>                                                  
006590          MOVE  Ｍ４０−前払回収方法    TO   出力−前払回収方法   
006600*--<      No.17>                                                  
006610          MOVE  Ｍ４０−入金日          TO   出力−入金日         
006620*--<      No.18>                                                  
006630          MOVE  Ｍ４０−入金区分        TO   出力−入金区分       
006640*--<      No.19>                                                  
006650          MOVE  Ｄ０１−取引先名称      TO   出力−取引先名称     
006660*--<      No.20>                                                  
006670          MOVE  Ｄ０２−請求先名称      TO   出力−請求先名称     
006680*--<      No.21>                                                  
006690          MOVE  ＷＳ−名称１            TO   出力−主契約区分名称 
006700*--<      No.22>                                                  
006710          MOVE  ＷＳ−名称２            TO   出力−連結区分名称   
006720*--<      No.23>                                                  
006730          MOVE  Ｍ４０−前月末残高他社    TO   出力−前月末残高 
006740*--<      No.24>                                                  
006750          MOVE  Ｍ４０−当月回収額他社    TO   出力−当月入金額 
006760*--<      No.25>                                                  
006770                                                                  
006780          COMPUTE  出力−当月消化額 =  Ｍ４０−当月消化額他社    
006790                                     + Ｍ４０−当月他社解約分料金
006800                                     + Ｍ４０−当月他社解約分消費税
006810*--<      No.26>                                                  
006820          COMPUTE  出力−当月末残高 =  Ｍ４０−当月末残高他社    
006830                                     + Ｍ４０−当月他社解約分料金
006840                                     + Ｍ４０−当月他社解約分消費税
006850       END-IF                                                    
006860     END-IF.                                                      
006870                                                                  
006880 編集出力処理２−ＥＸＩＴ.                                        
006890     EXIT.                                                        
006900                                                                  
006910******************************************************************
006920*    出力処理                                                    *
006930******************************************************************
006940 出力処理                             SECTION.                    
006950 出力処理−ＳＴＡＲＴ.                                            
006960*                                                                 
006970     WRITE OUT-FILE.    
006980*----------------------------------------------------------------*
006990*    追加処理を確認                                              *
007000*----------------------------------------------------------------*                                          
007010     EVALUATE  ファイル状態                                
007020        WHEN  ZERO                                             
007030*                                                              
007040*--<       追加成功 >                                             
007050     COMPUTE  Ｗ−出力−件数  =  Ｗ−出力−件数  +  1 
007060        WHEN  OTHER                                            
007070*                                                              
007080*--<       ファイル出力エラー >                                
007090           MOVE  SPACE             TO  Ｗ−異常終了−フラグ    
007100           MOVE  -50               TO  Ｗ−エラーコード        
007110           PERFORM  エラー判定処理                             
007120     END-EVALUATE.                                                                                                        
007130*                                                                 
007140 出力処理−ＥＸＩＴ.                                              
007150     EXIT.                                                        
007160
007170
007180******************************************************************
007190*    業務管理テーブル読込                                   *
007200******************************************************************
007210 業務管理テーブル読込                     SECTION.                
007220 業務管理テーブル読込−ＳＴＡＲＴ.                   
007230*                                                                 
007240     EXEC SQL                                                     
007250     SELECT  バッチ用業務年月  INTO  :Ｄ７０−バッチ用業務年月    
007260       FROM  D70GYM_TBL                                           
007270      WHERE  業務管理ＩＤ = :ＷＳ−業務管理ＩＤ
007280     END-EXEC.                                                    
007290
007300     EVALUATE  SQLCODE                                            
007310        WHEN  定数−ＳＱＬＯＫ                                    
007320*--<       正常 >                                                 
007330           CONTINUE                                               
007340        WHEN  OTHER                                               
007350*--<       ＴＡＢＬＥ  ＳＥＬＥＣＴ  エラー >                     
007360           MOVE -80                   TO  Ｗ−エラーコード        
007370           PERFORM  エラー判定処理                                
007380     END-EVALUATE.                                                
007390
007400
007410 業務管理テーブル読込−ＥＸＩＴ.                                              
007420     EXIT.                                                        
007430
007440
007450******************************************************************
007460*    終了処理                                                    *
007470******************************************************************
007480 終了処理                             SECTION.                    
007490 終了処理−ＳＴＡＲＴ.                                            
007500*                                                                 
007510     PERFORM  ＤＢクローズ処理.                                   
007520*                             
007530     PERFORM  ファイルクローズ処理.
007540     
007550     PERFORM  件数メッセージ出力.   
007560                                                     
007570     PERFORM  終了メッセージ出力.                                 
007580*                                                                 
007590*--< プログラム正常終了 >                                         
007600     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
007610*                                                                 
007620 終了処理−ＥＸＩＴ.                                              
007630     EXIT.                                                        
007640
007650******************************************************************
007660*    件数メッセージ出力                                          *
007670******************************************************************
007680 件数メッセージ出力                   SECTION.                    
007690 件数メッセージ出力−ＳＴＡＲＴ.                                  
007700*                                                                 
007710*----------------------------------------------------------------*
007720*    件数メッセージ出力処理                                      *
007730*----------------------------------------------------------------*
007740     INITIALIZE                       IF-CHOCO001.                
007750     MOVE  "3"                        TO  共１−イベント種別.     
007760     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007770     MOVE  "0"                        TO  共１−復帰コード.       
007780     MOVE  "M40MAB"                   TO  共１−処理テーブルＩＤ. 
007790     MOVE  "COUNT"                    TO  共１−処理識別.         
007800     MOVE  Ｗ−入力−件数             TO  共１−データ内容.       
007810     MOVE  "レベルアップ債権展開入力件数"                         
007820                                      TO  共１−その他メッセージ. 
007830     CALL  CLOCO001                USING  IF-CHOCO001.            
007840*                                                                 
007850     INITIALIZE                       IF-CHOCO001.                
007860     MOVE  "3"                        TO  共１−イベント種別.     
007870     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007880     MOVE  "0"                        TO  共１−復帰コード.       
007890     MOVE  "SFHSED25"                 TO  共１−処理テーブルＩＤ. 
007900     MOVE  "COUNT"                    TO  共１−処理識別.         
007910     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
007920     MOVE  "変則払DB出力件数"         TO  共１−その他メッセージ. 
007930     CALL  CLOCO001                USING  IF-CHOCO001.            
007940*                                                                 
007950 件数メッセージ出力−ＥＸＩＴ.                                    
007960     EXIT.                                                        
007970******************************************************************
007980*    終了メッセージ出力                                          *
007990******************************************************************
008000 終了メッセージ出力                   SECTION.                    
008010 終了メッセージ出力−ＳＴＡＲＴ.                                  
008020*                                                                 
008030*----------------------------------------------------------------*
008040*    終了メッセージ出力                                          *
008050*----------------------------------------------------------------*
008060     INITIALIZE                       IF-CHOCO001.                
008070     MOVE  "3"                        TO  共１−イベント種別.     
008080     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
008090     MOVE  "0"                        TO  共１−復帰コード.       
008100     MOVE  "END"                      TO  共１−処理識別.         
008110     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
008120     CALL  CLOCO001                USING  IF-CHOCO001.            
008130*                                                                 
008140 終了メッセージ出力−ＥＸＩＴ.                                    
008150     EXIT.                                                        
008160******************************************************************
008170*    ＤＢクローズ                                                *
008180******************************************************************
008190 ＤＢクローズ処理                     SECTION.                    
008200 ＤＢクローズ処理−ＳＴＡＲＴ.                                    
008210*                                                                 
008220*--< カーソル クローズ >                                          
008230     EXEC SQL                                                     
008240        CLOSE  CUR1                                               
008250     END-EXEC.                                                    
008260*                     
008270 ＤＢクローズ処理−ＥＸＩＴ.                                   
008280     EXIT.                                                        
008290
008300******************************************************************
008310*    ファイルクローズ処理                                            *
008320******************************************************************
008330 ファイルクローズ処理                  SECTION.                    
008340 ファイルクローズ処理−ＳＴＡＲＴ.                                    
008350                                                                 
008360*--<       ファイルクローズ > 
008370     CLOSE 出力ファイル.                                                                                
008380*                     
008270 ファイルクローズ処理−ＥＸＩＴ.                                   
008280     EXIT.                               
008410******************************************************************
008420*    エラー処理                                                  *
008430******************************************************************
008440 エラー判定処理                       SECTION.                    
008450 エラー判定処理−ＳＴＡＲＴ.                                      
008460*                                                                 
008470     MOVE  "Y"                        TO Ｗ−異常終了−フラグ.    
008480     INITIALIZE                           IF-CHOCO001.            
008490*                                                                 
008500     EVALUATE  Ｗ−エラーコード                                   
008510        WHEN  -10                                                 
008520*--<       ＯＲＡＣＬＥ接続失敗 >                                 
008530           MOVE  "1"                  TO  共１−イベント種別      
008540           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008550           MOVE  "9"                  TO  共１−復帰コード        
008560           MOVE  "CONNECT"            TO  共１−処理識別          
008570           MOVE  SQLCODE              TO  共１−データ内容        
008580           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008590           CALL  CLOCO001          USING  IF-CHOCO001             
008600*                                                                 
008610        WHEN  -20                                                 
008620*--<       結合テーブルカーソルオープン失敗 >                     
008630           MOVE  "1"                  TO  共１−イベント種別      
008640           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008650           MOVE  "9"                  TO  共１−復帰コード        
008660           MOVE  "D32SAK"             TO  共１−処理テーブルＩＤ  
008670           MOVE  "OPEN"               TO  共１−処理識別          
008680           MOVE  SQLCODE              TO  共１−データ内容        
008690           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008700           CALL  CLOCO001          USING  IF-CHOCO001             
008710*                                                                 
008720        WHEN  -30                                                 
008730*--<       結合テーブル読込失敗 >                                 
008740           MOVE  "1"                  TO  共１−イベント種別      
008750           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008760           MOVE  "9"                  TO  共１−復帰コード        
008770           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
008780           MOVE  "FETCH"              TO  共１−処理識別          
008790           MOVE  SQLCODE              TO  共１−データ内容        
008800           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008810           CALL  CLOCO001          USING  IF-CHOCO001             
008820*                                                                 
008830        WHEN  -40                                                 
008840*--<       ファイル状態OPEN失敗 >                                   
008850           MOVE  "1"                  TO  共１−イベント種別      
008860           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008870           MOVE  "9"                  TO  共１−復帰コード        
008880*          MOVE  "D34HNS"             TO  共１−処理テーブルＩＤ  
008890           MOVE  "OPEN"               TO  共１−処理識別          
008900*          MOVE  SQLCODE              TO  共１−データ内容        
008910           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008920           CALL  CLOCO001          USING  IF-CHOCO001             
008930*                                                                 
008940        WHEN  -50                                                 
008950*--<       ファイル状態WRITE失敗 >                                   
008960           MOVE  "1"                  TO  共１−イベント種別      
008970           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008980           MOVE  "9"                  TO  共１−復帰コード        
008990*          MOVE  "D34HNS"             TO  共１−処理テーブルＩＤ  
009000           MOVE  "WRITE"              TO  共１−処理識別          
009010*          MOVE  SQLCODE              TO  共１−データ内容        
009020           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009030           CALL  CLOCO001          USING  IF-CHOCO001             
009040
009050        WHEN  -60                                                 
009060*--<       結合テーブル 項目名称マスタより項目の抽出処理失敗 >                                   
009070           MOVE  "1"                  TO  共１−イベント種別      
009080           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009090           MOVE  "9"                  TO  共１−復帰コード        
009100           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
009110           MOVE  "SELECT"             TO  共１−処理識別          
009120           MOVE  SQLCODE              TO  共１−データ内容        
009130           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009140           CALL  CLOCO001          USING  IF-CHOCO001             
009150
009160        WHEN  -70                                                 
009170*--<       結合テーブル 債権情報ＤＢより項目の抽出処理失敗 >                                   
009180           MOVE  "1"                  TO  共１−イベント種別      
009190           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009200           MOVE  "9"                  TO  共１−復帰コード        
009210           MOVE  "M01SAJ"             TO  共１−処理テーブルＩＤ  
009220           MOVE  "SELECT"             TO  共１−処理識別          
009230           MOVE  SQLCODE              TO  共１−データ内容        
009240           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009250           CALL  CLOCO001          USING  IF-CHOCO001             
009260
009270        WHEN  -80                                                 
009280*--<       業務管理テーブル読込処理失敗 >                                   
009290           MOVE  "1"                  TO  共１−イベント種別      
009300           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009310           MOVE  "9"                  TO  共１−復帰コード        
009320           MOVE  "D70GYM"             TO  共１−処理テーブルＩＤ  
009330           MOVE  "SELECT"             TO  共１−処理識別          
009340           MOVE  SQLCODE              TO  共１−データ内容        
009350           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009360           CALL  CLOCO001          USING  IF-CHOCO001             
009370
009380        WHEN  OTHER                                               
009390           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
009400     END-EVALUATE.                                                
009410*                                                                 
009420     IF Ｗ−異常終了−フラグ  =  "Y"                              
009430        PERFORM  ＤＢクローズ処理                                   
009440*                                
009450        PERFORM  ファイルクローズ処理
009460     
009470        PERFORM  件数メッセージ出力   
009480                                                     
009490        PERFORM  終了メッセージ出力                                 
009500*                                                                 
009510*--<    プログラム異常終了のリターンコード >                      
009520        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
009530*                                                                 
009540        EXIT  PROGRAM                                             
009550     END-IF.                                                      
009560*                                                                 
009570 エラー処理−ＥＸＩＴ.                                            
009580     EXIT.                                                        
009590******************************************************************
009600*                  END OF PROGRAM                                *
009610******************************************************************
