000010******************************************************************
000020*         ＜海輝軟件(大連)＞                                     *
000030*      1. プログラム名  : 汎用請求テーブル　　　                 *
000040*      2. プログラムID  : COBIS460                               *
000050*      3. 処理概要      : SUMMIT.請求明細情報全件処理にて、      *
000060*                                                                *
000070*      4. 作成者        : 李貫宇                                 *
000080*      5. 作成日        : 2004.10.10                             *
000090******************************************************************
000100*                                                                 
000110******************************************************************
000120*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000130******************************************************************
000140 IDENTIFICATION                       DIVISION.                   
000150*                                                                 
000160 PROGRAM-ID.                          COBIS460.                   
000170******************************************************************
000180*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000190******************************************************************
000200 ENVIRONMENT                          DIVISION.                   
000210******************************************************************
000220*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000230******************************************************************
000240 DATA                                 DIVISION.                   
000250******************************************************************
000260*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000270******************************************************************
000280  WORKING-STORAGE                     SECTION.                    
000290*----------------------------------------------------------------*
000300*    ホスト変数定義エリア                                        *
000310*----------------------------------------------------------------*
000320     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.
000330*                                                                 
000340*--< ＯＲＡＣＬＥ共通変数 >                                       
000350     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000360*                                                                 
000370*--< ＯＲＡＣＬＥ  ＳＱＬ実行情報 >                               
000380     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000390*                                                                 
000400*--< SUMMIT請求明細 >                                            
000410     EXEC  SQL  INCLUDE 　LTRSKM.CBL           END-EXEC.          
000420*                                                                 
000430*--<移行後_契約内容>                                                
000440     EXEC  SQL  INCLUDE  D31KYK.CBL            END-EXEC.          
000450*                                                                 
000460*--< 移行後_受取口座マスタ>                                                  
000470     EXEC  SQL  INCLUDE  D05GKO.CBL            END-EXEC.          
000480*
000490*--< 汎用請求ＤＢ>                                                  
000500     EXEC  SQL  INCLUDE  D40HSQ.CBL            END-EXEC.          
000510*
000520*--< 共通>                                                  
000530     EXEC  SQL  INCLUDE  IKOTBL001.CBL         END-EXEC.          
000540*
000550*--< 共通>                                                  
000560     EXEC  SQL  INCLUDE  IKOTBL002.CBL         END-EXEC.
000570*
000580*--< 共通>                                                  
000590     EXEC  SQL  INCLUDE  IKOTBL005.CBL         END-EXEC.
000600
000610*          
000620     EXEC  SQL  END  DECLARE          SECTION  END-EXEC.          
000630*                                                                 
000640*----------------------------------------------------------------*
000650*    ＷＯＲＫエリア                                              *
000660*----------------------------------------------------------------*
000670 01  ＷＯＲＫ−エリア.
000680   03  ＷＳ−連番                       PIC S9(006) .
000690   03  ＷＳ−請求年月日.                              
000700     05  ＷＳ−請求発行日−世紀         PIC  X(02).                
000710     05  ＷＳ−請求発行日−年月日       PIC  X(06).                                      
000720   03  ＷＳ−請求金額                   PIC S9(013).
000730   03  ＷＳ−消込年月日                 PIC  X(008).
000740   03  ＷＳ−消込通番
000750     05 ＷＳ−消込日                 PIC  X(002). 
000760     05 ＷＳ−消込連番1              PIC  X(04).
000770     05 ＷＳ−連番1                   PIC  X(005).      
000780   03  ＷＳ−回収金額                   PIC S9(013).
000790   03  ＷＳ−回収消費税                 PIC S9(013).
000800   03  ＷＳ−未回収金額                 PIC S9(013).
000810   03  ＯＬＤ−取引先コード
000820                         PIC  X(009).
000830   03  ＯＬＤ−請求先コード
000840                         PIC  X(005).
000850   03  ＷＳ−受取口座ＣＤ  PIC S9(007).
000860                                            
000870*--< エラー判定用 >                                               
000880     03  Ｗ−エラーコード             PIC S9(04).                 
000890*                                                                 
000900*--< フラグアリア >                                               
000910     03  フラグアリア.                                            
000920         05  Ｗ−終了−フラグ         PIC  X(01).                 
000930         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
000940*                                                                 
000950*--< 件数エリア >                                                 
000960     03  件数エリア.                                              
000970         05  Ｗ−入力−件数           PIC  9(09).                 
000980         05  Ｗ−出力−件数           PIC  9(09).                 
000990*                                                                 
001000*--< キーエリア >                                                 
001010     03  ＫＥＹ−エリア.
001020        05  ＮＥＷキー.                                          
001030          07  ＮＥＷキー1.                                           
001040             09 Ｎ−契約番号           PIC X(009).                 
001050             09 Ｎ−再リースコード     PIC S9(001).
001060             09 Ｎ−勘定処理コード PIC S9(002).
001070          07  ＮＥＷキー2.
001080             09 Ｎ−契約番号           PIC X(009).
001090             09 Ｎ−再リース回数       PIC S9(002).
001100          07  ＮＥＷキー3.
001110             09 Ｎ−銀行ＣＤ PIC S9(007).
001120        05 ＯＬＤキー.       
001130          07  ＯＬＤキー1.                                           
001140             09 Ｏ−契約番号           PIC  X(009).                 
001150             09 Ｏ−再リースコード     PIC S9(001).
001160             09 Ｏ−勘定処理コード PIC S9(002). 
001170          07  ＯＬＤキー2.
001180             09 Ｏ−契約番号           PIC X(009).
001190             09 Ｏ−再リース回数       PIC S9(002). 
001200          07  ＯＬＤキー3.
001210             09 Ｏ−銀行ＣＤ PIC S9(007).              
001220*                                                                 
001230*--< 共通情報 >                                                   
001240 01  Ｗ−共通情報.                                                
001250     03  Ｗ−システム日付.                                        
001260         05  Ｗ−世紀                 PIC  X(02) VALUE  "20".     
001270         05  Ｗ−年月日               PIC  X(06).                 
001280     03  Ｗ−システム時刻             PIC  X(08).                 
001290     03  Ｗ−担当者                   PIC  X(08) VALUE "IKOPG   ".
001300*                                                                 
001310*----------------------------------------------------------------*
001320*    サブルーチン名                                              *
001330*----------------------------------------------------------------*
001340 01  CALL-AREA.                                                   
001350*--< 共通ログサブルーチン >                                       
001360     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
001370     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
001380*                                                                 
001390*----------------------------------------------------------------*
001400*    ＣＯＰＹ領域                                                *
001410*----------------------------------------------------------------*
001420*--< 共通ログ用パラメータ >                                       
001430 01  IF-CHOCO001.                                                 
001440     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
001450*                                                                 
001460*----------------------------------------------------------------*
001470*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001480*----------------------------------------------------------------*
001490 01  PARA-AREA.                                                   
001500     COPY CPBCO001.                                               
001510******************************************************************
001520*    定数用データ定義エリア                                      *
001530******************************************************************
001540 CONSTANT                             SECTION.                    
001550 01  定数領域.                                                    
001560     03  定数−プログラムＩＤ         PIC  X(08) VALUE "COBIS430".
001570     03  定数−プログラム名           PIC  X(80)                  
001580                                      VALUE  "汎用請求テーブル".        
001590     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001600     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001610     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001620     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001630******************************************************************
001640*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001650******************************************************************
001660 PROCEDURE                            DIVISION.                   
001670*                                                                 
001680     PERFORM  初期処理.                                           
001690*                                                                 
001700     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001710*                                                                 
001720     PERFORM  終了処理.                                           
001730*                                                                 
001740     STOP     RUN.                                                
001750*                                                                 
001760******************************************************************
001770*    初期処理                                                    *
001780******************************************************************
001790 初期処理                             SECTION.                    
001800 初期処理−ＳＴＡＲＴ.                                            
001810*                                                                 
001820*----------------------------------------------------------------*
001830*    開始メッセージ出力処理                                      *
001840*----------------------------------------------------------------*
001850     INITIALIZE                       IF-CHOCO001.                
001860     MOVE  "3"                        TO  共１−イベント種別.     
001870     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001880     MOVE  "0"                        TO  共１−復帰コード.       
001890     MOVE  "START"                    TO  共１−処理識別.         
001900     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001910     CALL  CLOCO001                USING  IF-CHOCO001.            
001920*                                                                 
001930*----------------------------------------------------------------*
001940*    作業領域の初期値処理                                        *
001950*----------------------------------------------------------------*
001960     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001970     INITIALIZE                           ＷＯＲＫ−エリア.       
001980*                                                                 
001990     MOVE  LOW-VALUE                  TO  ＯＬＤキー.             
002000*                                                                 
002010*--< ＣＰＵ日付を取得 >                                           
002020     ACCEPT  Ｗ−年月日               FROM  DATE.                 
002030*                                                                 
002040*--< ＣＰＵ時刻を取得 >                                           
002050     ACCEPT  Ｗ−システム時刻         FROM  TIME.                 
002060*                                                                 
002070*--< ＯＲＡＣＬＥ接続 >                                           
002080     PERFORM   ＯＲＡＣＬＥ接続.                                  
002090*                                                                 
002100*--< 結合テーブルカーソル定義 >                                   
002110     PERFORM  結合テーブルカーソル定義.                           
002120*                                                                 
002130*--< 結合テーブルカーソル読込(１件目) >                           
002140     PERFORM  結合テーブルカーソル読込.                           
002150*                                                                 
002160 初期処理−ＥＸＩＴ.                                              
002170     EXIT.                                                        
002180******************************************************************
002190*    ＯＲＡＣＬＥ接続                                            *
002200******************************************************************
002210 ＯＲＡＣＬＥ接続                     SECTION.                    
002220 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
002230*                                                                 
002240*--< ＩＮＩファイル読込サブルーチン呼び出し >                     
002250     CALL  COBCO001                USING  PARA-AREA.              
002260*                                                                 
002270     MOVE  PARA-DBSTRING              TO  DB-STRING.              
002280     MOVE  PARA-USERNAME              TO  USERNAME.               
002290     MOVE  PARA-PASSWORD              TO  PASSWD.                 
002300*                                                                 
002310*----------------------------------------------------------------*
002320*    開始接続                                                    *
002330*----------------------------------------------------------------*
002340     IF  DB-STRING  =  SPACE                                      
002350        EXEC  SQL                                                 
002360           CONNECT  :USERNAME  IDENTIFIED  BY  :PASSWD            
002370        END-EXEC                                                  
002380     ELSE                                                         
002390        EXEC  SQL                                                 
002400           CONNECT  :USERNAME  IDENTIFIED  BY  :PASSWD            
002410             USING  :DB-STRING                                    
002420        END-EXEC                                                  
002430     END-IF.                                                      
002440*                                                                 
002450*----------------------------------------------------------------*
002460*    接続状態判定                                                *
002470*----------------------------------------------------------------*
002480     EVALUATE  SQLCODE                                            
002490        WHEN  定数−ＳＱＬＯＫ                                    
002500*--<       接続正常 >                                             
002510           CONTINUE                                               
002520        WHEN  OTHER                                               
002530*--<       接続エラー >                                           
002540           MOVE     -1                TO  Ｗ−エラーコード        
002550           PERFORM  エラー処理                                    
002560     END-EVALUATE.                                                
002570*                                                                 
002580 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002590     EXIT.                                                        
002600******************************************************************
002610*        結合テーブルカーソル定義                                *
002620******************************************************************
002630 結合テーブルカーソル定義             SECTION.                    
002640 結合テーブルカーソル定義−ＳＴＡＲＴ. 
002650*
002660     EXEC SQL                                                     
002670        DECLARE CUR1  CURSOR FOR                                  
002680           SELECT  LTRSKM.ＫＥＹ項目請求先コード                             
002690                  ,LTRSKM.契約番号                         
002700                  ,LTRSKM.再リースコード  
002710                  ,LTRSKM.勘定処理コード                         
002720                  ,LTRSKM.充当回数
002730                  ,LTRSKM.契約番号                      
002740                  ,NVL(D31KYK_TBL.契約番号, RPAD(' ',10,' '))
002750                  ,NVL(D31KYK_TBL.再リース回数, RPAD(' ',2,' '))
002760                  ,NVL(D31KYK_TBL.再リース請求間隔, 
002770                                             RPAD(' ',2,' '))       
002780                  ,LTRSKM.回収方式    
002790                  ,LTRSKM.請求発行日＿年月日     
002800                  ,LTRSKM.請求金額     
002810                  ,LTRSKM.消費税＿金額
002820                  ,LTRSKM.消込日＿世紀 
002830                  ,LTRSKM.消込日＿年月日
002840                  ,LTRSKM.再リース回数    
002850                  ,LTRSKM.消込通番     
002860                  ,LTRSKM.入金予定日    
002870                  ,LTRSKM.消込金額   
002880                  ,LTRSKM.請求金額     
002890                  ,LTRSKM.請求内訳コード    
002900                  ,LTRSKM.事業所コード    
002910                  ,LTRSKM.長短区分    
002920                  ,LTRSKM.銀行ＣＤ
002930                  ,NVL(D05GKO_TBL.銀行コード, RPAD(' ',4,' '))
002940                  ,NVL(D05GKO_TBL.支店コード, RPAD(' ',3,' '))
002950                  ,LTRSKM.消費税＿消費税コード    
002960                  ,LTRSKM.消費税＿徴収区分   
002970                  ,LTRSKM.総支払回数
002980                  ,LTRSKM.共通情報
002990             FROM  LTRSKM
003000                  ,D31KYK_TBL                    
003010                  ,D05GKO
003020            WHERE  LTRSKM.内部入金区分       =  2                 
003030              AND  LTRSKM.消込通番 = ZERO                          
003040         ORDER BY                           
003050     END-EXEC.
003060*                                                                 
003070*----------------------------------------------------------------*
003080*    カーソルＯＰＥＮ処理                                        *
003090*----------------------------------------------------------------*
003100     EXEC  SQL                                                    
003110        OPEN  CUR1                                                
003120     END-EXEC.                                                    
003130*                                                                 
003140*----------------------------------------------------------------*
003150*    カーソルＯＰＥＮ確認                                        *
003160*----------------------------------------------------------------*
003170     EVALUATE  SQLCODE                                            
003180        WHEN  定数−ＳＱＬＯＫ                                    
003190*--<       正常 >                                                 
003200           CONTINUE                                               
003210        WHEN  OTHER                                               
003220*--<       カーソルＯＰＥＮエラー >                               
003230           MOVE -20                   TO  Ｗ−エラーコード        
003240           PERFORM  エラー判定処理                                
003250     END-EVALUATE.                                                
003260*                                                                 
003270 結合テーブルカーソル定義−ＥＸＩＴ.                              
003280     EXIT.                                                        
003290******************************************************************
003300*    結合テーブルカーソル読込                                    *
003310******************************************************************
003320 結合テーブルカーソル読込             SECTION.                    
003330 結合テーブルカーソル読込−ＳＴＡＲＴ.                            
003340*                                                                 
003350*--< 結合テーブルカーソル読込 >                                   
003360     EXEC SQL                                                     
003370         FETCH  CUR1                                              
003380          INTO    ＬＴＲＳＫＭ−ＫＥＹ項目請求先コード              
003390                  ,:ＬＴＲＳＫＭ−契約番号                         
003400                  ,:ＬＴＲＳＫＭ−再リースコード  
003410                  ,:ＬＴＲＳＫＭ−勘定処理コード                         
003420                  ,:ＬＴＲＳＫＭ−充当回数
003430                  ,:ＬＴＲＳＫＭ−契約番号                      
003450                  ,:Ｄ３１−契約番号
003460                  ,:Ｄ３１−再リース回数
003470                  ,:Ｄ３１− 再リース請求間隔
003490                  ,:ＬＴＲＳＫＭ−回収方式    
003500                  ,:ＬＴＲＳＫＭ−請求発行日＿年月日     
003510                  ,:ＬＴＲＳＫＭ−請求金額     
003520                  ,:ＬＴＲＳＫＭ−消費税＿金額
003530                  ,:ＬＴＲＳＫＭ−消込日＿世紀 
003540                  ,:ＬＴＲＳＫＭ−消込日＿年月日
003550                  ,:ＬＴＲＳＫＭ−再リース回数    
003560                  ,:ＬＴＲＳＫＭ−消込通番     
003570                  ,:ＬＴＲＳＫＭ−入金予定日    
003580                  ,:ＬＴＲＳＫＭ−消込金額   
003590                  ,:ＬＴＲＳＫＭ−請求金額     
003600                  ,:ＬＴＲＳＫＭ−請求内訳コード    
003610                  ,:ＬＴＲＳＫＭ−事業所コード    
003620                  ,:ＬＴＲＳＫＭ−長短区分    
003630                  ,:ＬＴＲＳＫＭ−銀行ＣＤ
003640                  ,:Ｄ０５−銀行コード
003650                  ,:Ｄ０５−支店コード
003660                  ,:ＬＴＲＳＫＭ−消費税＿消費税コード    
003670                  ,:ＬＴＲＳＫＭ−消費税＿徴収区分   
003680                  ,:ＬＴＲＳＫＭ−総支払回数
003690                  ,:ＬＴＲＳＫＭ−共通情報
003700           END-EXEC.                                                    
003710*                                                                 
003720*----------------------------------------------------------------*
003730*    結合テーブルカーソル読込を確認                              *
003740*----------------------------------------------------------------*
003750*
003760     EVALUATE   SQLCODE                                           
003770        WHEN   定数−ＳＱＬＯＫ                                   
003780*--<       正常 > 
003790           MOVE  ＬＴＲＳＫＭ−契約番号   
003800                                      TO  Ｎ−契約番号            
003810           MOVE  ＬＴＲＳＫＭ−再リースコード                           
003820                                      TO  Ｎ−再リースコード        
003830           MOVE  ＬＴＲＳＫＭ−勘定処理コード   
003840                                      TO  Ｎ−勘定処理コード           
003850           MOVE  ＬＴＲＳＫＭ−銀行ＣＤ            
003860                                      TO   Ｎ−銀行ＣＤ                               
003870*                                                                  
003880           COMPUTE  Ｗ−入力−件数  =  Ｗ−入力−件数  +  1       
003890        WHEN   定数−ＳＱＬＥＮＤ                                 
003900*--<       読込終了 >                                             
003910           MOVE  "Y"                  TO  Ｗ−終了−フラグ        
003920        WHEN   OTHER                                              
003930*--<       読込エラー >                                           
003940           MOVE     -30               TO  Ｗ−エラーコード        
003950           PERFORM  エラー判定処理                                
003960     END-EVALUATE.                                                
003970*                                                                 
003980 結合テーブルカーソル読込−ＥＸＩＴ.                              
003990     EXIT.                                                        
004000******************************************************************
004010*    主処理                                                      *
004020******************************************************************
004030 主処理                               SECTION.                    
004040 主処理−ＳＴＡＲＴ.                                              
004050*                                                                 
004060     PERFORM  編集出力処理.                                       
004070*                                                                 
004080*--< 結合テーブルカーソル読込（２件目以降） >                     
004090     PERFORM  結合テーブルカーソル読込.                           
004100*                                                                 
004110     IF  Ｗ−終了−フラグ  =  "Y"                                 
004120*--<    入力データ終わる時最後出力処理 >                          
004130        PERFORM  出力処理                                         
004140     END-IF.                                                      
004150*                                                                 
004160 主処理−ＥＸＩＴ.                                                
004170     EXIT.                                                        
004180******************************************************************
004190*     編集出力処理                                               *
004200******************************************************************
004210 編集出力処理                         SECTION.                    
004220 編集出力処理−ＳＴＡＲＴ.
004230*                                                                 
004240     IF  ＮＥＷキー  =  ＯＬＤキー                                
004250*--<    No.05 >                                                   
004260        MOVE  ＩＫＯ００２−再リース回数      
004270                                      TO  Ｄ４０−再リース回数        
004280*                                                                
004290*--<    No.06 >                                                   
004300        MOVE  ＩＫＯ００２−契約種類          
004310                                      TO  Ｄ４０−契約種類        
004320*                                                          
004330*--<    No.08 >                                                   
004340        MOVE  Ｄ３１−再リース請求間隔          
004350                                      TO  Ｄ４０−請求間隔            
004360*                                                          
004370*--<    No.24 >                                                   
004380        MOVE  Ｄ０５−銀行短縮コード  TO  Ｄ４０−銀行短縮コード  
004390*
004400*--<    No.27 >                                                   
004410        MOVE  ＬＴＲＳＫＭ−勘定処理コード              
004420                                      TO  Ｄ４０−勘定処理コード   
004430*       
004440     ELSE                                                         
004450        IF  Ｗ−入力−件数  >  1                                  
004460*--<       ２件目以降、且つキー変わる時、出力する >               
004470           PERFORM  出力処理                                      
004480        END-IF                                                    
004490*                                                                     
004500*----------------------------------------------------------------*
004510*       項目編集処理                                             *
004520*----------------------------------------------------------------*
004530*--<    No.01 >
004540        PERFORM 変換処理１                                       
004550        MOVE  ＬＴＲＳＫＭ−ＫＥＹ項目請求先コード 
004560                                      TO  Ｄ４０−取引先コード        
004570*                                                                 
004580*--<    No.02 >
004590        PERFORM 変換処理2                                           
004600        MOVE  ＬＴＲＳＫＭ−ＫＥＹ項目請求先コード  
004610                                      TO  Ｄ４０−請求先コード    
004620                                                                  
004630*--<    No.03 >
004640        PERFORM 連番処理                                                   
004650        MOVE ＷＳ−連番               TO  Ｄ４０−連番  
004660*                                                                
004670*--<    No.04 >                                                   
004680        MOVE  ＬＴＲＳＫＭ−契約番号  TO  Ｄ４０−契約番号          
004690*                                                                 
004700*--<    No.05 >
004710        PERFORM             再リース回数契約種類処理                                                   
004720        MOVE  ＩＫＯ００２−再リース回数    
004730                                      TO  Ｄ４０−再リース回数                                                 
004740*                                                                 
004750*--<    No.06 >
004760        PERFORM             再リース回数契約種類処理                                                   
004770        MOVE  ＩＫＯ００２−契約種類          
004780                                      TO  Ｄ４０−契約種類        
004790*                                                                 
004800*--<    No.07 >                                                   
004810        MOVE  ＬＴＲＳＫＭ−充当回数  TO  Ｄ４０−請求回数        
004820*                                                                 
004830*--<    No.08 > 
004840        PERFORM  請求間隔処理                                                  
004850        MOVE  Ｄ３１−再リース請求間隔          
004860                                      TO  Ｄ４０−請求間隔            
004870*                                                                 
004880*--<    No.09 >
004890        PERFORM  回収方法処理                                                  
004900        MOVE  ＬＴＲＳＫＭ−回収方式  TO  Ｄ４０−回収方法           
004910*                                                                 
004920*--<    No.10 >
004930        PERFORM  請求年月日処理                                                  
004940        MOVE  ＷＳ−請求年月日        TO  Ｄ４０−請求年月日      
004950*                                                                 
004960*--<    No.11 >
004970        PERFORM  請求金額処理                                                   
004980        MOVE  ＷＳ−請求金額          TO  Ｄ４０−請求金額       
004990*                                                                 
005000*--<    No.12 >
005010        PERFORM 請求消費税処理                                                   
005020        MOVE  ＬＴＲＳＫＭ−消費税−金額           
005030                                      TO  Ｄ４０−請求消費税           
005040*                                                                 
005050*--<    No.13 >                                                   
005060        MOVE   ＷＳ−消込年月日       TO  Ｄ４０−消込年月日
005070*                                                                 
005080*--<    No.14 >
005090        PERFORM  消込通番処理                                                  
005100        MOVE  ＷＳ−消込通番          TO  Ｄ４０−消込通番       
005110*                                                                 
005120*--<    No.15 >                                                   
005130        MOVE  ＬＴＲＳＫＭ−入金予定日
005140                                      TO  Ｄ４０−回収予定日         
005150*                                                                 
005160*--<    No.16 >                                                   
005170        MOVE  ＷＳ−消込年月日        TO  Ｄ４０−回収年月日      
005180*
005190*--<    No.17 >
005200        PERFORM 回収金額処理                                                  
005210        MOVE  ＷＳ−回収金額          TO  Ｄ４０−回収金額    
005220*
005230*--<    No.18 >
005240        PERFORM 回収消費税処理                                                   
005250        MOVE  ＷＳ−回収消費税        TO  Ｄ４０−回収消費税     
005260                                           
005270*
005280*--<    No.19 >
005290        PERFORM 未回収金額処理                                                    
005300        MOVE  ＷＳ−未回収金額        TO  Ｄ４０−未回収金額      
005310*
005320*--<    No.20 >                                                   
005330        MOVE  ＷＳ−消込日            TO  Ｄ４０−初回入金日      
005340*
005350*--<    No.21 >
005360        PERFORM 請求内訳コード処理                                                   
005370        MOVE  ＬＴＲＳＫＭ−請求内訳コード              
005380                                      TO  Ｄ４０−請求内訳コード  
005390*
005400*--<    No.22 >                                                   
005410        MOVE  ＬＴＲＳＫＭ−事業所コード              
005420                                      TO Ｄ４０−部課コード  
005430*
005440*--<    No.23 >                                                   
005450        MOVE  ＬＴＲＳＫＭ−長短区分  TO Ｄ４０−長短区分     
005460*
005470*--<    No.24 >
005480        PERFORM 銀行短縮コード処理                                                    
005490        MOVE  Ｄ０５−銀行短縮コード    TO  Ｄ４０−銀行短縮コード  
005500*
005510*--<    No.25 >                                                   
005520        MOVE  ＬＴＲＳＫＭ−消費税−消費税コード             
005530                                      TO  Ｄ４０−消費税コード
005540*
005550*--<    No.26 >                                                   
005560        MOVE  ＬＴＲＳＫＭ−消費税−徴収区分             
005570                                      TO  Ｄ４０−消費税徴収区分      
005580*
005590*--<    No.27 >
005600        PERFORM   再リース回数契約種類処理                                                   
005610        MOVE  ＬＴＲＳＫＭ−勘定処理コード              
005620                                      TO  Ｄ４０−勘定処理コード   
005630*
005640*--<    No.28 >                                                   
005650        MOVE  ＬＴＲＳＫＭ−総支払回数             
005660                                      TO  Ｄ４０−総請求回数   
005670*
005680*--<    No.29 >                                                   
005690        MOVE  Ｗ−システム日付        TO  Ｄ４０−登録年月日      
005700*
005710*--<    No.30 >                                                   
005720        MOVE  Ｗ−システム時刻        TO  Ｄ４０−登録時間      
005730*
005740*--<    No.31 >                                                   
005750        MOVE  Ｗ−担当者              TO  Ｄ４０−登録担当者     
005760*
005770*--<    No.32 >                                                   
005780        MOVE  Ｗ−システム日付        TO  Ｄ４０−更新年月日      
005790*
005800*--<    No.33 >                                                   
005810        MOVE  Ｗ−システム時刻        TO  Ｄ４０−更新時間     
005820*
005830*--<    No.34 >                                                   
005840        MOVE  Ｗ−担当者              TO  Ｄ４０−更新者     
005850*
005860*--<    No.35 >                                                   
005870        MOVE  Ｗ−担当者              TO  Ｄ４０−入力担当者コード      
005880*                                                                 
005890     END-IF.                                                     
005900*                                                                 
005910     MOVE ＮＥＷキー                  TO  ＯＬＤキー.             
005920*                                                                                                                  
005930**                                                                 
005940  編集出力処理−ＥＸＩＴ.                                          
005950     EXIT.
005960******************************************************************
005970*                 変換処理1                                           *
005980******************************************************************
005990 変換処理１                           SECTION.                    
006000 変換処理１−ＳＴＡＲＴ.                                          
006010*                                                                 
006020     EXEC  SQL                                                    
006030           SELECT  新取引先コード                                 
006040             INTO :ＩＫＯ００１−新取引先コード                   
006050             FROM  IKOTBL001
006060                   LTRSKM                                     
006070            WHERE  IKOTBL001.新取引先コード                          
006080                            =                           
006090                            :LTRSKM.ＫＥＹ項目請求先コード 
006100              AND  IKOTBL001.目的ＣＤ = '3'                       
006110     END-EXEC.                                                    
006120*                                                                 
006130*----------------------------------------------------------------*
006140*    変換処理１確認                                              *
006150*----------------------------------------------------------------*
006160     EVALUATE  SQLCODE                                            
006170        WHEN  定数−ＳＱＬＯＫ                                    
006180*--<       正常 >                                                 
006190           CONTINUE                                               
006200        WHEN  OTHER                                               
006210*--<       変換処理１エラー >                                     
006220           MOVE     SPACE             TO                          
006230                                     ＩＫＯ００１−新取引先コード
006240     END-EVALUATE.                                                
006250*                                                                 
006260  変換処理１−ＥＸＩＴ.                                           
006270     EXIT.
006280******************************************************************
006290*                 変換処理2                                           *
006300******************************************************************
006310 変換処理１                           SECTION.                    
006320 変換処理１−ＳＴＡＲＴ.                                          
006330*                                                                 
006340     EXEC  SQL                                                    
006350           SELECT  枝番                                 
006360             INTO :ＩＫＯ００１−枝番                   
006370             FROM  IKOTBL001                                      
006380            WHERE  IKOTBL001.枝番                          
006390                            =                           
006400                            :LTRSKM_TBL.ＫＥＹ項目請求先コード 
006410              AND  IKOTBL001.目的ＣＤ = '3'                       
006420     END-EXEC.                                                    
006430*                                                                 
006440*----------------------------------------------------------------*
006450*    変換処理１確認                                              *
006460*----------------------------------------------------------------*
006470     EVALUATE  SQLCODE                                            
006480        WHEN  定数−ＳＱＬＯＫ                                    
006490*--<       正常 >                                                 
006500           CONTINUE                                               
006510        WHEN  OTHER                                               
006520*--<       変換処理１エラー >                                     
006530           MOVE     SPACE             TO                          
006540                                      ＩＫＯ００１−新取引先コード
006550     END-EVALUATE.                                                
006560*                                                                 
006570  変換処理2−ＥＸＩＴ.                                           
006580     EXIT.
006590******************************************************************
006600*                  連番処理                                      *
006610******************************************************************
006620 連番処理                           SECTION.                    
006630 連番処理−ＳＴＡＲＴ.
006640         MOVE  SPACE                   TO  ＯＬＤ−取引先コード                
006650         INITIALIZE                        ＯＬＤ−取引先コード
006660         MOVE  SPACE                   TO  ＯＬＤ−請求先コード 
006670         INITIALIZE                        ＯＬＤ−請求先コード         
006680         IF Ｄ４０−取引先コード   NOT  =  ＯＬＤ−取引先コード
006690            OR  Ｄ４０−請求先コード  
006700                                   NOT  =   ＯＬＤ−請求先コード
006710            MOVE  '1'                  TO   Ｄ４０−連番
006720          ELSE 
006730             Ｄ４０−連番 = Ｄ４０−連番 + 1 
006740             MOVE Ｄ４０−取引先コード TO  ＯＬＤ−取引先コード
006750             MOVE Ｄ４０−請求先コード TO  ＯＬＤ−請求先コード
006760         END-IF.
006770連番処理−ＥＸＩＴ.                                           
006780       EXIT.
006790
006800******************************************************************
006810*                  再リース回数契約種類処理                      *
006820******************************************************************
006830 再リース回数契約種類処理                        SECTION.                    
006840 再リース回数契約種類処理−ＳＴＡＲＴ.
006850        IF  IKOTBL002.契約ＮＯ = LTRSKM.契約番号
006860        ADD IKOTBL002.再リースコード = LTRSKM.再リースコード
006870        ADD IKOTBL002.旧債権勘定処理コード
006880                                   = LTRSKM.勘定処理コード
006890        ADD IKOTBL002.旧債務勘定処理コード
006900                                   = LTRSKM.勘定処理コード                                                                  
006910        MOVE  ＷＳ−再リース回数      TO  Ｎ−再リース回数
006920        END-IF.
006930        MOVE ＮＥＷキー1                  TO  ＯＬＤキー1.             
006940*                                                                 
006950 再リース回数契約種類処理−ＥＸＩＴ.                                          
006960        EXIT.                                                  
006970******************************************************************
006980*                 請求間隔処処理                                 *
006990******************************************************************
007000 請求間隔処理                          SECTION.                    
007010 請求間隔処理−ＳＴＡＲＴ.
007020        EXEC SQL
007030           SELECT 契約番号
007040                 ,再リース回数
007050           INTO :Ｄ３１−契約番号
007060               ,:Ｄ３１−再リース回数
007070            FROM D31KYK
007080       WHERE Ｄ３１−契約番号              = :Ｄ４０−契約番号
007090         AND Ｄ３１−再リース回数          = :Ｄ４０−再リース回数
007100       END-EXEC.
007110*
007120*----------------------------------------------------------------*
007130* 検索処理を確認 *
007140*----------------------------------------------------------------*
007150          EVALUATE SQLCODE
007160          WHEN 定数−ＳＱＬＯＫ
007170*--< 正常の時 >
007180          CONTINUE
007190          WHEN OTHER
007200*--< 取得しない、初期値をセット >
007210          MOVE ZERO TO  ＷＳ−請求間隔
007220          END-EVALUATE.
007230          MOVE ＮＥＷキー2                  TO  ＯＬＤキー2.             
007240*                                                                 
007250 請求間隔処処理−ＥＸＩＴ.                                          
007260          EXIT.                                                  
007270******************************************************************
007280*                  回収方法                                      *
007290******************************************************************
007300 回収方法処理                          SECTION.                    
007310 回収方法処理−ＳＴＡＲＴ.
007320        IF ＬＴＲＳＫＭ−回収方式 = '1'
007330           MOVE ZERO TO  Ｄ４０−回収方法
007340        IF ＬＴＲＳＫＭ−回収方式 = '2'
007350           MOVE '5' TO  Ｄ４０−回収方法 
007360        IF  ＬＴＲＳＫＭ−回収方式 = '3'
007370           MOVE '3' TO Ｄ４０−回収方法
007380        IF ＬＴＲＳＫＭ−回収方式 = '4'
007390           MOVE '4' TO  Ｄ４０−回収方法
007400        END-IF.                     
007410*
007420 回収方法処理−ＥＸＩＴ.                                           
007430     EXIT.
007440
007450******************************************************************
007460*                  請求年月日処理                                *
007470******************************************************************
007480 請求年月日処理                         SECTION.                    
007490 請求年月日処理−ＳＴＡＲＴ.
007500        IF  ＬＴＲＳＫＭ−請求発行日−年月日  = ZERO     
007510           MOVE  ZERO                 TO  Ｗ−請求年月日                       
007520        ELSE                                                         
007530           IF ＬＴＲＳＫＭ−請求発行日−世紀 = 0   
007540              MOVE  "19"                 TO  Ｗ−請求発行日−世紀        
007550           ELSE                                                      
007560              MOVE  "20"                 TO  Ｗ−請求発行日−世紀        
007570              MOVE  ＬＴＲＳＫＭ−請求発行日−年月日  
007580                                         TO  Ｗ−請求発行日−年月日
007590        END-IF.
007600*
007610 請求年月日処理−ＥＸＩＴ.                                           
007620     EXIT.
007630
007640******************************************************************
007650*                  請求金額処理                                  *
007660******************************************************************
007670 請求金額処理                         SECTION.                    
007680 請求金額処理−ＳＴＡＲＴ.
007690   
007700     COMPUTE   ＷＳ−請求金額
007710               ＬＴＲＳＫＭ−請求金額 -
007720                                 ＬＴＲＳＫＭ−消費税−金額.
007730*
007740 請求金額処理−ＥＸＩＴ.                                           
007750     EXIT.
007760
007770******************************************************************
007780*                  消込通番処理                                  *
007790******************************************************************
007800 消込通番処理                         SECTION.                    
007810 消込通番処理−ＳＴＡＲＴ.
007820      ＷＳ−消込日  = SUBSTR(ＬＴＲＳＫＭ−消込日−年月日,1,5)
007830                                               
007840      ＷＳ−消込連番1 = SUBSTR(ＬＴＲＳＫＭ−消込通番,1,4)
007850       ＷＳ−連番1    = SUBSTR(ＷＳ−連番,1[,5]).
007860*
007870 消込通番処理−ＥＸＩＴ.                                           
007880     EXIT.      
007890******************************************************************
007900*                 回収金額処理                                   *
007910******************************************************************
007920 回収金額処理                         SECTION.                    
007930 回収金額処理−ＳＴＡＲＴ.
007940        IF ＬＴＲＳＫＭ−消込金額 >  ZERO
007950           COMPUTE ＷＳ−消込金額     =   ＬＴＲＳＫＭ−消込金額
007960                                      -   
007970                                      ＬＴＲＳＫＭ−消費税−金額
007980        ELSE MOVE ZERO                TO  ＷＳ−消込金額
007990        END-IF.
008000*
008010 回収金額処理−ＥＸＩＴ.                                           
008020     EXIT.      
008030
008040******************************************************************
008050*           回収消費税処理                                       *
008060******************************************************************
008070 回収消費税処理                             SECTION.                    
008080 回収消費税処理−ＳＴＡＲＴ.
008090*
008100         IF ＬＴＲＳＫＭ−消込金額 >  ZERO
008110            MOVE  ＬＴＲＳＫＭ−消費税−金額           
008120                                      TO  ＷＳ−回収消費税
008130         ELSE 
008140            MOVE ZERO                 TO ＷＳ−回収消費税
008150         END-IF.
008160*
008170 回収消費税処理−ＥＸＩＴ.                                           
008180     EXIT.      
008190
008200******************************************************************
008210*   未回収金額処理                                               *
008220******************************************************************
008230 未回収金額処理                             SECTION.                    
008240 未回収金額処理−ＳＴＡＲＴ.                                            
008250*
008260         COMPUTE  ＷＳ−未回収金額    =  ＷＳ−請求金額
008270                                      +  ＷＳ−請求金額
008280                                      -  ＷＳ−回収金額
008290                                      -  ＷＳ−回収消費税.
008300*
008310 未回収金額処理−ＥＸＩＴ.                                           
008320     EXIT.      
008330   
008340******************************************************************
008350*    請求内訳コード処理                                          *
008360******************************************************************
008370 請求内訳コード処理                             SECTION.                    
008380 請求内訳コード処理−ＳＴＡＲＴ.                      
008390*                                                                 
008400     EXEC  SQL                                                    
008410           SELECT  現請求内訳コード
008420                   アクセス区分                                   
008430             INTO :ＩＫＯ００５−現請求内訳コード
008440                 ,:ＩＫＯ００５−アクセス区分                   
008450             FROM  IKOTBL005
008460                   LTRSKM                                     
008470            WHERE  IKOTBL005.アクセス区分                          
008480                                      = A                                            
008490              AND  ＩＫＯ００５−現請求内訳コード
008500                                      =
008510                                     ＬＴＲＳＫＭ−請求内訳コード                       
008520     END-EXEC.
008530*
008540 請求内訳コード処理−ＥＸＩＴ.                                           
008550     EXIT.      
008560
008570******************************************************************
008580*                 銀行短縮コード処理                             *
008590******************************************************************
008600 銀行短縮コード処理                          SECTION.                    
008610 銀行短縮コード処理−ＳＴＡＲＴ.
008620        EXEC SQL
008630           SELECT 銀行コード
008640                 ,支店コード
008650                 ,銀行短縮コード
008660           INTO :Ｄ０５−銀行コード
008670               ,:Ｄ０５−支店コード
008680               ,:Ｄ０５−銀行短縮コード
008690            FROM D05GKO_TBL
008700           WHERE  ＬＴＲＳＫＭ−銀行ＣＤ
008710                                   =  銀行コード 
008720                                   +  支店コード
008730     END-EXEC.
008740*
008750*----------------------------------------------------------------*
008760* 検索処理を確認 *
008770*----------------------------------------------------------------*
008780          EVALUATE SQLCODE
008790          WHEN 定数−ＳＱＬＯＫ
008800*--< 正常の時 >
008810          CONTINUE
008820          WHEN OTHER
008830*--< 取得しない、初期値をセット >
008840          MOVE ZERO TO  Ｄ０５−銀行短縮コード
008850          END-EVALUATE.
008860          MOVE ＮＥＷキー3                  TO  ＯＬＤキー3.             
008870*                                                                 
008880 銀行短縮コード処理−ＥＸＩＴ.                                          
008890          EXIT.                                                                                                                                                                      
008900******************************************************************
008910*    出力処理                                                    *
008920******************************************************************
008930 出力処理                             SECTION.                    
008940 出力処理−ＳＴＡＲＴ.                                            
008950*                                                                 
008960       EXEC  SQL                                                  
008970        INSERT  INTO  D40HSQ_TBL                                  
008980           ( 取引先コード                                             
008990            ,請求先コード                                         
009000            ,連番                                             
009010            ,契約番号                                               
009020            ,再リース回数                                             
009030            ,契約種類                                              
009040            ,請求回数                                             
009050            ,請求間隔                                                 
009060            ,回収方法                                               
009070            ,請求年月日                                          
009080            ,請求金額                                              
009090            ,請求消費税                                   
009100            ,消込年月日                                          
009110            ,消込通番                                             
009120            ,回収予定日
009130            ,回収年月日
009140            ,回収金額
009150            ,回収消費税
009160            ,未回収金額
009170            ,初回入金日
009180            ,請求内訳コード
009190            ,部課コード
009200            ,長短区分
009210            ,銀行短縮コード
009220            ,消費税コード
009230            ,消費税徴収区分
009240            ,勘定処理コード
009250            ,総請求回数
009260            ,登録年月日
009270            ,登録時間
009280            ,登録担当者
009290            ,更新年月日
009300            ,更新時間
009310            ,更新者
009320            ,入力担当者コード)                                       
009330       VALUES                                                     
009340             ( :取引先コード                                             
009350            ,:Ｄ４０−請求先コード                                         
009360            ,:Ｄ４０−連番                                             
009370            ,:Ｄ４０−契約番号                                               
009380            ,:Ｄ４０−再リース回数                                             
009390            ,:Ｄ４０−契約種類                                              
009400            ,:Ｄ４０−請求回数                                             
009410            ,:Ｄ４０−請求間隔                                                 
009420            ,:Ｄ４０−回収方法                                               
009430            ,:Ｄ４０−請求年月日                                          
009440            ,:Ｄ４０−請求金額                                              
009450            ,:Ｄ４０−請求消費税                                   
009460            ,:Ｄ４０−消込年月日                                          
009470            ,:Ｄ４０−消込通番                                             
009480            ,:Ｄ４０−回収予定日
009490            ,:Ｄ４０−回収年月日
009500            ,:Ｄ４０−回収金額
009510            ,:Ｄ４０−回収消費税
009520            ,:Ｄ４０−未回収金額
009530            ,:Ｄ４０−初回入金日
009540            ,:Ｄ４０−請求内訳コード
009550            ,:Ｄ４０−部課コード
009560            ,:Ｄ４０−長短区分
009570            ,:Ｄ４０−銀行短縮コード
009580            ,:Ｄ４０−消費税コード
009590            ,:Ｄ４０−消費税徴収区分
009600            ,:Ｄ４０−勘定処理コード
009610            ,:Ｄ４０−総請求回数
009620            ,:Ｄ４０−登録年月日
009630            ,:Ｄ４０−登録時間
009640            ,:Ｄ４０−登録担当者
009650            ,:Ｄ４０−更新年月日
009660            ,:Ｄ４０−更新時間
009670            ,:Ｄ４０−更新者
009680            ,:Ｄ４０−入力担当者コード)                           
009690     END-EXEC.                                                    
009700*                                                                 
009710*----------------------------------------------------------------*
009720*    追加処理を確認                                              *
009730*----------------------------------------------------------------*
009740     EVALUATE  SQLCODE                                            
009750        WHEN   定数−ＳＱＬＯＫ                                   
009760*--<       追加成功 >                                             
009770           COMPUTE  Ｗ−出力−件数  =  Ｗ−出力−件数  +  1       
009780        WHEN   OTHER                                              
009790*--<       追加処理エラー >                                       
009800           MOVE     -40               TO  Ｗ−エラーコード        
009810           PERFORM  エラー判定処理                                
009820     END-EVALUATE.                                                
009830*                                                                 
009840 出力処理−ＥＸＩＴ.                                              
009850     EXIT.                                                        
009860******************************************************************
009870*    終了処理                                                    *
009880******************************************************************
009890 終了処理                             SECTION.                    
009900 終了処理−ＳＴＡＲＴ.                                            
009910*                                                                 
009920     PERFORM  ＤＢクローズ処理.                                   
009930*                                                                 
009940     PERFORM  ＤＢコミット処理.                                   
009950*                                                                 
009960     PERFORM  終了メッセージ出力.                                 
009970*                                                                 
009980*--< プログラム正常終了 >                                         
009990     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
010000*                                                                 
010010 終了処理−ＥＸＩＴ.                                              
010020     EXIT.                                                        
010030******************************************************************
010040*    終了メッセージ出力                                          *
010050******************************************************************
010060 終了メッセージ出力                   SECTION.                    
010070 終了メッセージ出力−ＳＴＡＲＴ.                                  
010080*                                                                 
010090*----------------------------------------------------------------*
010100*    件数メッセージ出力処理                                      *
010110*----------------------------------------------------------------*
010120     INITIALIZE                       IF-CHOCO001.                
010130     MOVE  "3"                        TO  共１−イベント種別.     
010140     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
010150     MOVE  "0"                        TO  共１−復帰コード.       
010160     MOVE  "LTRSKM"                  TO  共１−処理テーブルＩＤ. 
010170     MOVE  "COUNT"                    TO  共１−処理識別.         
010180     MOVE  Ｗ−入力−件数             TO  共１−データ内容.       
010190     MOVE  "SUMMIT請求明細入力件数"                         
010200                                      TO  共１−その他メッセージ. 
010210     CALL  CLOCO001                USING  IF-CHOCO001.            
010220*                                                                 
010230     INITIALIZE                       IF-CHOCO001.                
010240     MOVE  "3"                        TO  共１−イベント種別.     
010250     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
010260     MOVE  "0"                        TO  共１−復帰コード.       
010270     MOVE  "D40HSQ"                   TO  共１−処理テーブルＩＤ. 
010280     MOVE  "COUNT"                    TO  共１−処理識別.         
010290     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
010300     MOVE  "汎用請求DB出力件数"       TO  共１−その他メッセージ. 
010310     CALL  CLOCO001                USING  IF-CHOCO001.            
010320*                                                                 
010330*----------------------------------------------------------------*
010340*    終了メッセージ出力                                          *
010350*----------------------------------------------------------------*
010360     INITIALIZE                       IF-CHOCO001.                
010370     MOVE  "3"                        TO  共１−イベント種別.     
010380     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
010390     MOVE  "0"                        TO  共１−復帰コード.       
010400     MOVE  "END"                      TO  共１−処理識別.         
010410     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
010420     CALL  CLOCO001                USING  IF-CHOCO001.            
010430*                                                                 
010440 終了メッセージ出力−ＥＸＩＴ.                                    
010450     EXIT.                                                        
010460******************************************************************
010470*    ＤＢクローズ                                                *
010480******************************************************************
010490 ＤＢクローズ処理                     SECTION.                    
010500 ＤＢクローズ処理−ＳＴＡＲＴ.                                    
010510*                                                                 
010520*--< カーソル クローズ >                                          
010530     EXEC SQL                                                     
010540        CLOSE  CUR1                                               
010550     END-EXEC.                                                    
010560*                                                                 
010570 ＤＢクローズ処理−ＥＸＩＴ.                                      
010580     EXIT.                                                        
010590******************************************************************
010600*    ＤＢコミット処理                                            *
010610******************************************************************
010620 ＤＢコミット処理                     SECTION.                    
010630 ＤＢコミット処理−ＳＴＡＲＴ.                                    
010640*                                                                 
010650     EXEC  SQL                                                    
010660        COMMIT  WORK  RELEASE                                     
010670     END-EXEC.                                                    
010680*                                                                 
010690     INITIALIZE                       IF-CHOCO001.                
010700     MOVE  "3"                        TO  共１−イベント種別.     
010710     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
010720     MOVE  "0"                        TO  共１−復帰コード.       
010730     MOVE  "COMMIT"                   TO  共１−処理識別.         
010740     MOVE  "コミット実施"             TO  共１−その他メッセージ. 
010750     CALL  CLOCO001                USING  IF-CHOCO001.            
010760*                                                                 
010770 ＤＢコミット処理−ＥＸＩＴ.                                      
010780     EXIT.                                                        
010790******************************************************************
010800*    ＤＢロールバック処理                                        *
010810******************************************************************
010820 ＤＢロールバック処理                 SECTION.                    
010830 ＤＢロールバック処理−ＳＴＡＲＴ.                                
010840*                                                                 
010850     EXEC  SQL                                                    
010860        ROLLBACK WORK  RELEASE                                    
010870     END-EXEC.                                                    
010880*                                                                 
010890     INITIALIZE                       IF-CHOCO001.                
010900     MOVE  "1"                        TO  共１−イベント種別.     
010910     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
010920     MOVE  "9"                        TO  共１−復帰コード.       
010930     MOVE  "ROLLBACK"                 TO  共１−処理識別.         
010940     MOVE  "ロールバック実施"         TO  共１−その他メッセージ. 
010950     CALL  CLOCO001                USING  IF-CHOCO001.            
010960*                                                                 
010970 ＤＢロールバック処理−ＥＸＩＴ.                                  
010980     EXIT.                                                        
010990******************************************************************
011000*    エラー処理                                                  *
011010******************************************************************
011020 エラー判定処理                       SECTION.                    
011030 エラー判定処理−ＳＴＡＲＴ.                                      
011040*                                                                 
011050     MOVE  "Y"                        TO Ｗ−異常終了−フラグ.    
011060     INITIALIZE                           IF-CHOCO001.            
011070*                                                                 
011080     EVALUATE  Ｗ−エラーコード                                   
011090        WHEN  -10                                                 
011100*--<       ＯＲＡＣＬＥ接続失敗 >                                 
011110           MOVE  "1"                  TO  共１−イベント種別      
011120           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
011130           MOVE  "9"                  TO  共１−復帰コード        
011140           MOVE  "CONNECT"            TO  共１−処理識別          
011150           MOVE  SQLCODE              TO  共１−データ内容        
011160           MOVE  SQLERRMC             TO  共１−その他メッセージ  
011170           CALL  CLOCO001          USING  IF-CHOCO001             
011180*                                                                 
011190        WHEN  -20                                                 
011200*--<       結合テーブルカーソルオープン失敗 >                     
011210           MOVE  "1"                  TO  共１−イベント種別      
011220           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
011230           MOVE  "9"                  TO  共１−復帰コード        
011240           MOVE  "LTRSKY"             TO  共１−処理テーブルＩＤ  
011250           MOVE  "OPEN"               TO  共１−処理識別          
011260           MOVE  SQLCODE              TO  共１−データ内容        
011270           MOVE  SQLERRMC             TO  共１−その他メッセージ  
011280           CALL  CLOCO001          USING  IF-CHOCO001             
011290*                                                                 
011300        WHEN  -30                                                 
011310*--<       結合テーブル読込失敗 >                                 
011320           MOVE  "1"                  TO  共１−イベント種別      
011330           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
011340           MOVE  "9"                  TO  共１−復帰コード        
011350           MOVE  "LTRSKM"             TO  共１−処理テーブルＩＤ  
011360           MOVE  "FETCH"              TO  共１−処理識別          
011370           MOVE  SQLCODE              TO  共１−データ内容        
011380           MOVE  SQLERRMC             TO  共１−その他メッセージ  
011390           CALL  CLOCO001          USING  IF-CHOCO001             
011400*                                                                 
011410        WHEN  -40                                                 
011420*--<       変則払ＤＢ追加失敗 >                                   
011430           MOVE  "1"                  TO  共１−イベント種別      
011440           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
011450           MOVE  "9"                  TO  共１−復帰コード        
011460           MOVE  "D40HNS"             TO  共１−処理テーブルＩＤ  
011470           MOVE  "INSERT"             TO  共１−処理識別          
011480           MOVE  SQLCODE              TO  共１−データ内容        
011490           MOVE  SQLERRMC             TO  共１−その他メッセージ  
011500           CALL  CLOCO001          USING  IF-CHOCO001             
011510*                                                                 
011520        WHEN  OTHER                                               
011530           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
011540     END-EVALUATE.                                                
011550*                                                                 
011560     IF Ｗ−異常終了−フラグ  =  "Y"                              
011570        PERFORM  ＤＢロールバック処理                             
011580*                                                                 
011590        PERFORM  終了メッセージ出力                               
011600*                                                                 
011610*--<    プログラム異常終了のリターンコード >                      
011620        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
011630*                                                                 
011640        EXIT  PROGRAM                                             
011650     END-IF.                                                      
011660*                                                                 
011670 エラー処理−ＥＸＩＴ.                                            
011680     EXIT.                                                        
011690******************************************************************
011700*                  END OF PROGRAM                                *
011710******************************************************************
