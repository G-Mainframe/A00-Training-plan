000010******************************************************************
000020*         ＜海輝軟件(大連)＞                                     *
000030*      1. プログラム名  : 経理締処理（帳票作成）                 *
000040*                         リース前受関連帳票抽出                 *
000050*      2. プログラムID  : AAASED25                               *
000060*      3. 処理概要      : 前受情報ＤＢをメインに、マスタと表     *
000070*                          結合して読込 前受金受払残高中間       *
000080*                         ファイルを 作成する*                   *
000090*      4. 作成者        : 王宏傑                                 *
000100*      5. 作成日        : 2005.03.25                             *
000110******************************************************************
000120*                                                                 
000130******************************************************************
000140*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000150******************************************************************
000160 IDENTIFICATION                       DIVISION.                   
000170*                                                                 
000180 PROGRAM-ID.                          AAASED25.                   
000190******************************************************************
000200*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000210******************************************************************
000220 ENVIRONMENT                          DIVISION.                   
000230******************************************************************
000240*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000250******************************************************************
000260 INPUT-OUTPUT                         SECTION.                    
000270*                                                                 
000280 FILE-CONTROL.                                                    
000290     SELECT    出力ファイル            ASSIGN    TO     U11       
000300     FILE      STATUS     IS          Ｗ−状態                    
000310     ORGANIZATION         IS          LINE      SEQUENTIAL.       
000320******************************************************************
000330*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000340******************************************************************
000350 DATA                                 DIVISION.                   
000360******************************************************************
000370*    ＦＩＬＥ                      ＳＥＣＴＩＯＮ                *
000380******************************************************************
000390 FILE                                 SECTION.                    
000400*----------------------------------------------------------------*
000410*    出力ファイル  前受金受払残高中間ファイル                     
000420*----------------------------------------------------------------*
000430 FD  出力ファイル                                                 
000440     LABEL     RECORD     IS          STANDARD                    
000450     BLOCK     CONTAINS   0           RECORDS.                    
000460*                                                                 
000470 01  出力−レコード.                                              
000480     COPY  CPSCE50  REPLACING  ==()==  BY  ==出力−==.            
000490*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000500******************************************************************
000510  WORKING-STORAGE                     SECTION.                    
000520*----------------------------------------------------------------*
000530*    ホスト変数定義エリア                                        *
000540*----------------------------------------------------------------*
000550     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000560*--< 項目名称マスタの名称 >                                       
000570 01 項目名称マスタの名称.                                         
000580    03 ＷＳ−名称１                   PIC  X(60).                 
000590    03 ＷＳ−名称２                   PIC  X(60).                 
000591 01 ＷＳ−コードＮＯ１                PIC  X(03) VALUE '038' .    
000592 01 ＷＳ−コードＮＯ２                PIC  X(03) VALUE '005' .    
000593*--<業務管理テーブル管理ID>                                       
000594 01 ＷＳ−業務管理ＩＤ                PIC  X(08) VALUE 'GYMKNRRC'.
000600*--< ＯＲＡＣＬＥ共通変数 >                                       
000610     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000620*                        M40MAB.CBL                               
000630*--< ＯＲＡＣＬＥ  ＳＱＬ実行情報 >                               
000640     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000650*                                                                 
000660*--< 前受情報ＤＢ >                                               
000670     EXEC  SQL  INCLUDE  M40MAB.CBL            END-EXEC.          
000680*                                                                 
000690*--< 業務管理テーブル >                                           
000700     EXEC  SQL  INCLUDE  D70GYM.CBL            END-EXEC.          
000710*                                                                 
000720*--< 取引先マスタ>                                                
000730     EXEC  SQL  INCLUDE  D01TRS.CBL            END-EXEC.          
000740*                                                                 
000750*--< 請求先マスタ >                                               
000760     EXEC  SQL  INCLUDE  D02SQS.CBL            END-EXEC.          
000770*--< 項目名称マスタ >                                             
000780     EXEC  SQL  INCLUDE  D19MSY.CBL            END-EXEC.          
000790*--< 債権情報（一般）ＤＢ >                                       
000800     EXEC  SQL  INCLUDE  M01SAJ.CBL            END-EXEC.          
000810*                                                                 
000820     EXEC  SQL  END  DECLARE          SECTION  END-EXEC.          
000830*                                                                 
000840*----------------------------------------------------------------*
000850*    ＷＯＲＫエリア                                              *
000860*----------------------------------------------------------------*
000870 01  ＷＯＲＫ−エリア.                                            
000880*--< エラー判定用 >                                               
000890     03  Ｗ−エラーコード             PIC S9(04).                 
000900*                                                                 
000910*--< フラグアリア >                                               
000920     03  フラグアリア.                                            
000930         05  Ｗ−終了−フラグ         PIC  X(01).                 
000940         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
000950*--< ファイル状態 >                                               
000960     03  Ｗ−状態エリア.                                          
000970         05  Ｗ−状態                 PIC  X(02).
000980*                                                                 
000990*--< 件数エリア >                                                 
001000     03  件数エリア.                                              
001010         05  Ｗ−入力−件数           PIC  9(09).                 
001020         05  Ｗ−出力−件数           PIC  9(09).                 
001030*----------------------------------------------------------------*
001040*    サブルーチン名                                              *
001050*----------------------------------------------------------------*
001060 01  CALL-AREA.                                                   
001070*--< 共通ログサブルーチン >                                       
001080     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
001090     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
001100*                                                                 
001110*----------------------------------------------------------------*
001120*    ＣＯＰＹ領域                                                *
001130*----------------------------------------------------------------*
001140*--< 共通ログ用パラメータ >                                       
001150 01  IF-CHOCO001.                                                 
001160     COPY  CHOCO001  REPLACING ==()== BY  ==共１−==.             
001170*                                                                 
001180*----------------------------------------------------------------*
001190*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001200*----------------------------------------------------------------*
001210 01  PARA-AREA.                                                   
001220     COPY CPBCO001.                                               
001230******************************************************************
001240*    定数用データ定義エリア                                      *
001250******************************************************************
001260 CONSTANT                             SECTION.                    
001270 01  定数領域.                                                    
001280     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
001290     03  定数−プログラム名           PIC  X(80)                  
001300                               VALUE "前受金受払残高ファイル作成".
001310     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001320     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001330     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001340     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001350******************************************************************
001360*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001370******************************************************************
001380 PROCEDURE                            DIVISION.                   
001390*                                                                 
001400     PERFORM  初期処理.                                           
001410*                                                                 
001420     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001430*                                                                 
001440     PERFORM  終了処理.                                           
001450*                                                                 
001460     STOP     RUN.                                                
001470*                                                                 
001480******************************************************************
001490*    初期処理                                                    *
001500******************************************************************
001510 初期処理                             SECTION.                    
001520 初期処理−ＳＴＡＲＴ.                                            
001530*                                                                 
001540*----------------------------------------------------------------*
001550*    開始メッセージ出力処理                                      *
001560*----------------------------------------------------------------*
001570     INITIALIZE                       IF-CHOCO001.                
001580     MOVE  "3"                        TO  共１−イベント種別.     
001590     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001600     MOVE  "0"                        TO  共１−復帰コード.       
001610     MOVE  "START"                    TO  共１−処理識別.         
001620     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001630     CALL  CLOCO001                USING  IF-CHOCO001.            
001640*                                                                 
001650*----------------------------------------------------------------*
001660*    作業領域の初期値処理                                        *
001670*----------------------------------------------------------------*
001680     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001690     INITIALIZE                           ＷＯＲＫ−エリア.       
001700*--< ＯＲＡＣＬＥ接続 >                                           
001710     PERFORM   ＯＲＡＣＬＥ接続.                                  
001720*                                                                 
001730*--< 業務管理テーブル読込  >                                      
001740     PERFORM  業務管理テーブル読込.                               
001750*--< 結合テーブルカーソル宣言 >                                   
001760     PERFORM  結合テーブルカーソル定義.                           
001770*                                                                 
001780*--< ファイルオープン >                                           
001790     PERFORM  ファイルオープン.                                   
001800*                                                                 
001810*--< 結合テーブルカーソル読込(１件目) >                           
001820     PERFORM  結合テーブルカーソル読込.                           
001830*                                                                 
001840 初期処理−ＥＸＩＴ.                                              
001850     EXIT.                                                        
001860******************************************************************
001870*    ＯＲＡＣＬＥ接続                                            *
001880******************************************************************
001890 ＯＲＡＣＬＥ接続                     SECTION.                    
001900 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
001910*                                                                 
001920*--< ＤＢ接続用情報を取得処理 >                                   
001930     CALL  COBCO001                USING  PARA-AREA.              
001940*                                                                 
001950     MOVE  PARA-DBSTRING              TO  DB-STRING.              
001960     MOVE  PARA-USERNAME              TO  USERNAME.               
001970     MOVE  PARA-PASSWORD              TO  PASSWD.                 
001980*                                                                 
001990*----------------------------------------------------------------*
002000*    開始接続                                                    *
002010*----------------------------------------------------------------*
002020     IF    DB-STRING  =  SPACE                                    
002030        EXEC SQL                                                  
002040           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002050        END-EXEC                                                  
002060     ELSE                                                         
002070        EXEC SQL                                                  
002080           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002090             USING  :DB-STRING                                    
002100        END-EXEC                                                  
002110     END-IF.                                                      
002120*                                                                 
002130*----------------------------------------------------------------*
002140*    接続確認                                                    *
002150*----------------------------------------------------------------*
002160     EVALUATE  SQLCODE                                            
002170        WHEN   定数−ＳＱＬＯＫ                                   
002180           CONTINUE                                               
002190        WHEN   OTHER                                              
002200*--<       接続エラー >                                           
002210           MOVE     -10               TO  Ｗ−エラーコード        
002220           PERFORM  エラー判定処理                                
002230     END-EVALUATE.                                                
002240*                                                                 
002250 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002260     EXIT.                                                        
002270******************************************************************
002280*        業務管理テーブル読込                                    *
002290******************************************************************
002300 業務管理テーブル読込                 SECTION.                    
002310 業務管理テーブル読込−ＳＴＡＲＴ.                                
002320*                                                                 
002330*----------------------------------------------------------------*
002340*    業務管理テーブル読込処理                                    *
002350*----------------------------------------------------------------*
002360     EXEC SQL                                                     
002370           SELECT  バッチ用業務年月                               
002380             INTO  Ｄ７０−バッチ用業務年月                       
002390             FROM  D70GYM_TBL                                     
002400            WHERE  業務管理ＩＤ = :ＷＳ−業務管理ＩＤ             
002410     END-EXEC.                                                    
002420                                                                  
002430*----------------------------------------------------------------*
002440*    業務管理テーブル読込処理ＯＰＥＮ確認                        *
002450*----------------------------------------------------------------*
002460     EVALUATE  SQLCODE                                            
002470        WHEN  定数−ＳＱＬＯＫ                                    
002480*--<       正常 >                                                 
002490           CONTINUE                                               
002500        WHEN  OTHER                                               
002510*--<       カーソルＯＰＥＮエラー >                               
002520           MOVE -20                   TO  Ｗ−エラーコード        
002530           PERFORM  エラー判定処理                                
002540     END-EVALUATE.                                                
002550*                                                                 
002560 業務管理テーブル読込−ＥＸＩＴ.                                  
002570     EXIT.                                                        
002580******************************************************************
002590*        結合テーブルカーソル定義                                *
002600******************************************************************
002610 結合テーブルカーソル定義             SECTION.                    
002620 結合テーブルカーソル定義−ＳＴＡＲＴ.                            
002630*                                                                 
002640*----------------------------------------------------------------*
002650*    カーソルＯＰＥＮ処理                                        *
002660*----------------------------------------------------------------*
002670     EXEC SQL                                                     
002680        DECLARE CUR1  CURSOR FOR                                  
002690           SELECT  M40MAB_TBL.レコード区分                        
002700                  ,M40MAB_TBL.経理用主契約区分                    
002710			,M40MAB_TBL.顧客区分                            
002720			,NVL(D01TRS_TBL.名寄せコード,RPAD(' ',40,' '))  
002730			,M40MAB_TBL.請求先取引先コード                  
002740			,M40MAB_TBL.請求先コード                        
002750			,M40MAB_TBL.契約番号                            
002760			,M40MAB_TBL.契約種類                            
002770			,M40MAB_TBL.担当部課コード                      
002780			,M40MAB_TBL.再リース回数                        
002790			,M40MAB_TBL.充当開始年月                        
002800			,M40MAB_TBL.充当月数                            
002810			,M40MAB_TBL.前払回収方法                        
002820			,M40MAB_TBL.入金日                              
002830			,M40MAB_TBL.入金区分                            
002840			,NVL(D01TRS_TBL.取引先名称,RPAD(' ',80,' '))    
002850			,NVL(D02SQS_TBL.請求先名称,RPAD(' ',80,' '))    
002860			,M40MAB_TBL.前月末残高                          
002870			,M40MAB_TBL.当月回収額                          
002880			,M40MAB_TBL.当月消化額                          
002890			,M40MAB_TBL.当月末残高                          
002900                  ,M40MAB_TBL.当月消化額他社                      
002910                  ,M40MAB_TBL.当月他社解約分料金                  
002920                  ,M40MAB_TBL.当月他社解約分消費税                
002930                  ,M40MAB_TBL.当月末残高他社                      
002940                  ,M40MAB_TBL.協調区分                            
002950             FROM  M40MAB_TBL                                     
002960                  ,D01TRS_TBL                                     
002970                  ,D02SQS_TBL                                     
002980            WHERE  M40MAB_TBL.前受金受払残高表対象フラグ  =  '1'  
002990              AND  M40MAB_TBL.請求先取引先コード  =               
003000                              D01TRS_TBL.取引先コード (+)         
003010              AND  M40MAB_TBL.請求先取引先コード  =               
003020                              D02SQS_TBL.取引先コード (+)         
003030              AND  M40MAB_TBL.請求先コード        =               
003040                              D02SQS_TBL.請求先コード (+)         
003050         ORDER BY  M40MAB_TBL.レコード区分                        
003060                  ,M40MAB_TBL.契約番号                            
003070                                                                  
003080     END-EXEC.                                                    
003090*----------------------------------------------------------------*
003100*    カーソルＯＰＥＮ処理                                        *
003110*----------------------------------------------------------------*
003120     EXEC  SQL                                                    
003130        OPEN  CUR1                                                
003140     END-EXEC.                                                    
003150*                                                                 
003160*----------------------------------------------------------------*
003170*    カーソルＯＰＥＮ確認                                        *
003180*----------------------------------------------------------------*
003190     EVALUATE  SQLCODE                                            
003200        WHEN  定数−ＳＱＬＯＫ                                    
003210*--<       正常 >                                                 
003220           CONTINUE                                               
003230        WHEN  OTHER                                               
003240*--<       カーソルＯＰＥＮエラー >                               
003250           MOVE -30                   TO  Ｗ−エラーコード        
003260           PERFORM  エラー判定処理                                
003270     END-EVALUATE.                                                
003280*                                                                 
003290 結合テーブルカーソル定義−ＥＸＩＴ.                              
003300     EXIT.                                                        
003310*                                                                 
003320******************************************************************
003330*    ファイルオープン                                            *
003340******************************************************************
003350 ファイルオープン                     SECTION.                    
003360 ファイルオープン−ＳＴＡＲＴ.                                    
003370*----------------------------------------------------------------*
003380*    ープン                                                      *
003390*----------------------------------------------------------------*
003400     OPEN  OUTPUT   出力ファイル.                                 
003401*                                                                 
003410*                                                                 
003420*--< ファイルオープンの状態判定 >                                 
003430     EVALUATE  Ｗ−状態                                           
003440        WHEN  ZERO                                                
003450           CONTINUE                                               
003460        WHEN  OTHER                                               
003470*--<       ファイルオープンエラー >                               
003480           MOVE     -40               TO  Ｗ−エラーコード        
003490           PERFORM  エラー判定処理                                
003500     END-EVALUATE.                                                
003510*                                                                 
003520 ファイルオープン−ＥＸＩＴ.                                      
003530     EXIT.                                                        
003540                                                                  
003550******************************************************************
003560*    結合テーブルカーソル読込                                    *
003570******************************************************************
003580 結合テーブルカーソル読込             SECTION.                    
003590 結合テーブルカーソル読込−ＳＴＡＲＴ.                            
003600*                                                                 
003610*--< 結合テーブルカーソル読込 >                                   
003620     EXEC SQL                                                     
003630         FETCH  CUR1                                              
003640          INTO  :Ｍ４０−レコード区分                             
003650		     ,:Ｍ４０−経理用主契約区分                         
003660               ,:Ｍ４０−顧客区分                                 
003670               ,:Ｄ０１−名寄せコード                             
003680               ,:Ｍ４０−請求先取引先コード                       
003690		     ,:Ｍ４０−請求先コード                             
003700		     ,:Ｍ４０−契約番号                                 
003710		     ,:Ｍ４０−契約種類                                 
003720		     ,:Ｍ４０−担当部課コード                           
003730		     ,:Ｍ４０−再リース回数                             
003740		     ,:Ｍ４０−充当開始年月                             
003750		     ,:Ｍ４０−充当月数                                 
003760		     ,:Ｍ４０−前払回収方法                             
003770		     ,:Ｍ４０−入金日                                   
003780		     ,:Ｍ４０−入金区分                                 
003790		     ,:Ｄ０１−取引先名称                               
003800		     ,:Ｄ０２−請求先名称                               
003810		     ,:Ｍ４０−前月末残高                               
003820		     ,:Ｍ４０−当月回収額                               
003830		     ,:Ｍ４０−当月消化額                               
003840		     ,:Ｍ４０−当月末残高                               
003850               ,:Ｍ４０−当月消化額他社                           
003860               ,:Ｍ４０−当月他社解約分料金                       
003870               ,:Ｍ４０−当月他社解約分消費税                     
003880               ,:Ｍ４０−当月末残高他社                           
003890               ,:Ｍ４０−協調区分                                 
003900                                                                  
003910     END-EXEC.                                                    
003920*                                                                 
003930*------------------------------------------------------------- --*
003940*    結合テーブルカーソル読込を確認                              *
003950*----------------------------------------------------------------*
003960     EVALUATE   SQLCODE                                           
003970        WHEN   定数−ＳＱＬＯＫ                                   
003980*--<       正常 >                                                 
003990*                                                                 
004000           COMPUTE  Ｗ−入力−件数  =  Ｗ−入力−件数  +  1       
004010        WHEN   定数−ＳＱＬＥＮＤ                                 
004020*--<       読込終了 >                                             
004030           MOVE  "Y"                  TO  Ｗ−終了−フラグ        
004040        WHEN   OTHER                                              
004050*--<       読込エラー >                                           
004060           MOVE     -50               TO  Ｗ−エラーコード        
004070           PERFORM  エラー判定処理                                
004080     END-EVALUATE.                                                
004090*                                                                 
004100 結合テーブルカーソル読込−ＥＸＩＴ.                              
004110     EXIT.                                                        
004120******************************************************************
004130*    主処理                                                      *
004140******************************************************************
004150 主処理                               SECTION.                    
004160 主処理−ＳＴＡＲＴ.                                              
004170*                                                                 
004180     PERFORM  項目名称抽出処理.                                   
004190*                                                                 
004200     PERFORM  債権情報抽出処理.                                   
004210                                                                  
004220	   PERFORM  出力判定処理処理.                                   
004230*--< 結合テーブルカーソル読込（２件目以降） >                     
004240     PERFORM  結合テーブルカーソル読込.                           
004250*                                                                 
004260*                                                                 
004270 主処理−ＥＸＩＴ.                                                
004280     EXIT.                                                        
004290******************************************************************
004300*     項目名称マスタより項目の抽出処理                           *
004310******************************************************************
004320 項目名称抽出処理                     SECTION.                    
004330 項目名称抽出処理−ＳＴＡＲＴ.                                    
004340*                                                                 
004350*----------------------------------------------------------------*
004360*    項目名称マスタより主契約区分名称の抽出処理                  *
004370*----------------------------------------------------------------*
004380     INITIALIZE                       ＷＳ−名称１.               
004390     EXEC SQL                                                     
004400           SELECT  D19MSY_TBL.名称                                
004410             INTO  :ＷＳ−名称１                                  
004420             FROM  D19MSY_TBL                                     
004430                   ,M40MAB_TBL                                    
004440             WHERE D19MSY_TBL.コードＮＯ  =  :ＷＳ−コードＮＯ１  
004450             AND  SUBSTR (D19MSY_TBL.コード,1,1)  =               
004460		        M40MAB_TBL.経理用主契約区分                     
004470     END-EXEC.                                                    
004480                                                                  
004490*----------------------------------------------------------------*
004500*     項目名称マスタより主契約区分名称の抽出確認                 *
004510*----------------------------------------------------------------*
004520     EVALUATE  SQLCODE                                            
004530        WHEN  定数−ＳＱＬＯＫ                                    
004540*--<       正常 >                                                 
004550           CONTINUE                                               
004560        WHEN  OTHER                                               
004570*--<       カーソルＯＰＥＮエラー >                               
004580           MOVE -60                   TO  Ｗ−エラーコード        
004590           PERFORM  エラー判定処理                                
004600     END-EVALUATE.                                                
004610*----------------------------------------------------------------*
004620*    項目名称マスタより顧客区分名称の抽出処理                    *
004630*----------------------------------------------------------------*
004640     INITIALIZE                       ＷＳ−名称２.               
004650     EXEC SQL                                                     
004660           SELECT  D19MSY_TBL.名称                                
004670             INTO  :ＷＳ−名称２                                  
004680             FROM  D19MSY_TBL                                     
004690                  ,M40MAB_TBL                                     
004700             WHERE D19MSY_TBL.コードＮＯ  = :ＷＳ−コードＮＯ２   
004710               AND  SUBSTR (D19MSY_TBL.コード,1,2) =              
004720		          M40MAB_TBL.顧客区分                           
004730     END-EXEC.                                                    
004740                                                                  
004750*----------------------------------------------------------------*
004760*     項目名称マスタより顧客区分名称の抽出確認                   *
004770*----------------------------------------------------------------*
004780     EVALUATE  SQLCODE                                            
004790        WHEN  定数−ＳＱＬＯＫ                                    
004800*--<       正常 >                                                 
004810           CONTINUE                                               
004820        WHEN  OTHER                                               
004830*--<       カーソルＯＰＥＮエラー >                               
004840           MOVE -70                   TO  Ｗ−エラーコード        
004850           PERFORM  エラー判定処理                                
004860     END-EVALUATE.                                                
004870*                                                                 
004880 項目名称抽出処理−ＥＸＩＴ.                                      
004890     EXIT.                                                        
004900******************************************************************
004910*     債権情報（一般）ＤＢより項目の抽出処理                     *
004920******************************************************************
004930 債権情報抽出処理                     SECTION.                    
004940 債権情報抽出処理−ＳＴＡＲＴ.                                    
004950*                                                                 
004960*----------------------------------------------------------------*
004970*    債権情報抽出処理の抽出処理                                  *
004980*----------------------------------------------------------------*
004990     INITIALIZE                       項目名称マスタの名称.       
005000     EXEC SQL                                                     
005010           SELECT  M01SAJ_TBL.状態フラグ                          
005020                  ,M01SAJ_TBL.債権契約件名                        
005030			,M01SAJ_TBL.担保区分                            
005040             INTO  :Ｍ０１−状態フラグ                            
005050		        ,:Ｍ０１−債権契約件名                          
005060			,:Ｍ０１−担保区分                              
005070             FROM  M01SAJ_TBL                                     
005080                  ,M40MAB_TBL                                     
005090            WHERE  M01SAJ_TBL.レコード区分  =  '1'                
005100              AND  M01SAJ_TBL.契約番号  =  M40MAB_TBL.契約番号    
005110	            AND  M01SAJ_TBL.再リース回数  =                     
005120			    M40MAB_TBL.再リース回数                     
005130	            AND  M01SAJ_TBL.契約種類  =  M40MAB_TBL.契約種類    
005140     END-EXEC.                                                    
005150                                                                  
005160*----------------------------------------------------------------*
005170*     債権情報抽出処理の抽出確認                                 *
005180*----------------------------------------------------------------*
005190     EVALUATE  SQLCODE                                            
005200        WHEN  定数−ＳＱＬＯＫ                                    
005210*--<       正常 >                                                 
005220           CONTINUE                                               
005230        WHEN  OTHER                                               
005240*--<       カーソルＯＰＥＮエラー >                               
005250           MOVE -80                   TO  Ｗ−エラーコード        
005260           PERFORM  エラー判定処理                                
005270     END-EVALUATE.                                                
005280 債権情報抽出処理−ＥＸＩＴ.                                      
005290     EXIT.                                                        
005300******************************************************************
005310*    前受金受払残高中間ファイル出力判定処理                      *
005320******************************************************************
005330 出力判定処理処理                     SECTION.                    
005340 出力判定処理処理−ＳＴＡＲＴ.                                    
005350     IF Ｍ０１−担保区分  = 1                                     
005360        CONTINUE                                                  
005370     ELSE                                                         
005380        PERFORM  自社分出力処理                                   
005390        IF  Ｍ４０−協調区分 =  "2"                               
005400           PERFORM  他社分出力処理                                
005410        END-IF                                                    
005420     END-IF.                                                      
005430 出力判定処理処理−ＥＸＩＴ.                                      
005440     EXIT.                                                        
005450******************************************************************
005460*    自社分出力処理                                              *
005470******************************************************************
005480 自社分出力処理                       SECTION.                    
005490 自社分出力処理−ＳＴＡＲＴ.                                      
005491*----------------------------------------------------------------*
005492*    ファイルオの初期値処理                                      *
005493*----------------------------------------------------------------*
005494     MOVE  SPACE                      TO  出力−レコード.         
005495     INITIALIZE                           出力−レコード.         
005500*--<自社分出力処理>                                               
005510      IF   Ｍ０１−状態フラグ  <  3                               
005520	       MOVE  "3"                    TO   出力−自他社区分       
005530      ELSE                                                        
005540         MOVE  "1"                    TO   出力−自他社区分.      
005550*--< 共通出力処理 >                                               
005560      PERFORM   共通出力処理.                                     
005570*                                                                 
005580      MOVE     Ｍ４０−前月末残高     TO   出力−前月末残高.      
005590      MOVE     Ｍ４０−当月回収額     TO   出力−当月入金額.      
005600      MOVE     Ｍ４０−当月消化額     TO   出力−当月消化額.      
005610      MOVE     Ｍ４０−当月末残高     TO   出力−当月末残高.      
005620*----------------------------------------------------------------*
005630*     共通前受金受払残高中間ファイル出力処理                     *
005640*----------------------------------------------------------------*
005650      PERFORM   共通受払残高出力処理.                             
005660 自社分出力処理−ＥＸＩＴ.                                        
005670     EXIT.                                                        
005680******************************************************************
005690*    他社分出力処理                                              *
005700******************************************************************
005710 他社分出力処理                       SECTION.                    
005720 他社分出力処理−ＳＴＡＲＴ.                                      
005721*----------------------------------------------------------------*
005722*    ファイルオの初期値処理                                      *
005723*----------------------------------------------------------------*
005724     MOVE  SPACE                      TO  出力−レコード.         
005725     INITIALIZE                           出力−レコード.         
005730*--<他社分出力処理>                                               
005740     IF   Ｍ０１−状態フラグ  <  3                                
005750        MOVE  "4"  TO   出力−自他社区分                          
005760     ELSE                                                         
005770        MOVE  "2"  TO   出力−自他社区分.                         
005780                                                                  
005790*--< 共通出力処理 >                                               
005800     PERFORM   共通出力処理.                                      
005810*                                                                 
005820     MOVE     Ｍ４０−前月末残高      TO   出力−前月末残高.      
005830     MOVE     Ｍ４０−当月回収額      TO   出力−当月入金額.      
005840     COMPUTE  出力−当月消化額    =  Ｍ４０−当月消化額他社       
005850                                  +  Ｍ４０−当月他社解約分料金   
005860                                  +  Ｍ４０−当月他社解約分消費税.
005870*                                                                 
005880     COMPUTE  出力−当月末残高    =  Ｍ４０−当月末残高他社       
005890                                  -  Ｍ４０−当月他社解約分料金   
005900                                  -  Ｍ４０−当月他社解約分消費税.
005910*----------------------------------------------------------------*
005920*     共通前受金受払残高中間ファイル出力処理                     *
005930*----------------------------------------------------------------*
005940     PERFORM   共通受払残高出力処理.                              
005950                                                                  
005960 他社分出力処理−ＥＸＩＴ.                                        
005970     EXIT.                                                        
005980******************************************************************
005990*    共通出力処理                                                *
006000******************************************************************
006010 共通出力処理                         SECTION.                    
006020 共通出力処理−ＳＴＡＲＴ.                                        
006030*                                                                 
006040     MOVE  Ｍ４０−レコード区分       TO   出力−前受区分.        
006050	   MOVE  Ｍ４０−経理用主契約区分   TO   出力−主契約区分.      
006060	   MOVE  Ｍ４０−顧客区分           TO   出力−連結区分.        
006070	   MOVE  Ｄ０１−名寄せコード       TO   出力−名寄せコード.    
006080	   MOVE  Ｍ４０−請求先取引先コード TO   出力−取引先コード.    
006090	   MOVE  Ｍ４０−請求先コード       TO   出力−請求先コード.    
006100	   MOVE  Ｍ４０−契約番号           TO   出力−契約番号.        
006110     MOVE  Ｍ４０−契約種類           TO   出力−契約種類.        
006120     MOVE  Ｄ７０−バッチ用業務年月   TO   出力−業務年月.        
006130     MOVE  Ｍ４０−担当部課コード     TO   出力−担当部課コード.  
006140     MOVE  Ｍ０１−債権契約件名       TO   出力−契約件名.        
006150     MOVE  Ｍ４０−再リース回数       TO   出力−再リース回数.    
006160     MOVE  Ｍ４０−充当開始年月       TO   出力−充当開始年月.    
006170     MOVE  Ｍ４０−充当月数           TO   出力−充当月数.        
006180     MOVE  Ｍ４０−前払回収方法       TO   出力−前払回収方法.    
006190     MOVE  Ｍ４０−入金日             TO   出力−入金日.          
006200     MOVE  Ｍ４０−入金区分           TO   出力−入金区分.        
006210     MOVE  Ｄ０１−取引先名称         TO   出力−取引先名称.      
006220     MOVE  Ｄ０２−請求先名称         TO   出力−請求先名称.      
006230     MOVE  ＷＳ−名称１               TO   出力−主契約区分名称.  
006240     MOVE  ＷＳ−名称２               TO   出力−連結区分名称.    
006250*                                                                 
006260 共出力処理−ＥＸＩＴ.                                            
006270     EXIT.                                                        
006280******************************************************************
006290*   共通前受金受払残高中間ファイル出力処理                       *
006300******************************************************************
006310 共通受払残高出力処理                 SECTION.                    
006320 共通受払残高出力処理−ＳＴＡＲＴ.                                
006330*                                                                 
006340     IF  出力−前月末残高      NOT =  0                           
006350         	OR  出力−当月入金額 NOT =  0                           
006360          OR  出力−当月消化額 NOT =  0                           
006370          OR  出力−当月末残高 NOT =  0                           
006380         WRITE  出力−レコード.                                   
006390*                                                                 
006400*--< 共通出力の状態判定 >                                         
006410     EVALUATE  Ｗ−状態                                           
006420        WHEN  ZERO                                                
006430*--<      共通出力件数の加算 >                                    
006440           COMPUTE  Ｗ−出力−件数 =  Ｗ−出力−件数 + 1          
006450        WHEN  OTHER                                               
006460*--<       ファイル出力エラー >                                   
006470           MOVE     -90               TO  Ｗ−エラーコード        
006480           PERFORM  エラー判定処理                                
006490     END-EVALUATE.                                                
006500*                                                                 
006510 共通受払残高出力処理−ＥＸＩＴ.                                  
006520     EXIT.                                                        
006530******************************************************************
006540*    終了処理                                                    *
006550******************************************************************
006560 終了処理                             SECTION.                    
006570 終了処理−ＳＴＡＲＴ.                                            
006580*                                                                 
006590     PERFORM  ＤＢクローズ処理.                                   
006600*                                                                 
006610     PERFORM  ファイルクローズ処理.                               
006620*                                                                 
006630     PERFORM  件数メッセージ出力.                                 
006640*                                                                 
006650     PERFORM  終了メッセージ出力.                                 
006660*                                                                 
006670*--< プログラム正常終了 >                                         
006680     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
006690*                                                                 
006700 終了処理−ＥＸＩＴ.                                              
006710     EXIT.                                                        
006720******************************************************************
006730*    ＤＢクローズ                                                *
006740******************************************************************
006750 ＤＢクローズ処理                     SECTION.                    
006760 ＤＢクローズ処理−ＳＴＡＲＴ.                                    
006770*                                                                 
006780*--< カーソル クローズ >                                          
006790     EXEC SQL                                                     
006800        CLOSE  CUR1                                               
006810     END-EXEC.                                                    
006820*                                                                 
006830 ＤＢクローズ処理−ＥＸＩＴ.                                      
006840     EXIT.                                                        
006850******************************************************************
006860*    ファイルクローズ                                            *
006870******************************************************************
006880 ファイルクローズ処理                 SECTION.                    
006890 ファイルクローズ処理−ＳＴＡＲＴ.                                
006900*                                                                 
006910     CLOSE  出力ファイル.                                         
006920*                                                                 
006930 ファイルクローズ処理−ＥＸＩＴ.                                  
006940     EXIT.                                                        
006950*                                                                 
006960******************************************************************
006970*     件数メッセージ出力処理                                     *
006980******************************************************************
006990 件数メッセージ出力                   SECTION.                    
007000 件数メッセージ出力−ＳＴＡＲＴ.                                  
007010*----------------------------------------------------------------*
007020*    件数メッセージ出力処理                                      *
007030*----------------------------------------------------------------*
007040     INITIALIZE                       IF-CHOCO001.                
007050     MOVE  "3"                        TO  共１−イベント種別.     
007060     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007070     MOVE  "0"                        TO  共１−復帰コード.       
007080     MOVE  "M40MAB_TBL"               TO  共１−処理テーブルＩＤ. 
007090     MOVE  "COUNT"                    TO  共１−処理識別.         
007100     MOVE  Ｗ−入力−件数             TO  共１−データ内容.       
007110     MOVE  " 前受情報テーブル（入力）"                            
007120                                      TO  共１−その他メッセージ. 
007130     CALL  CLOCO001                   USING  IF-CHOCO001.         
007140*                                                                 
007150     INITIALIZE                       IF-CHOCO001.                
007160     MOVE  "3"                        TO  共１−イベント種別.     
007170     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007180     MOVE  "0"                        TO  共１−復帰コード.       
007190     MOVE  "SFHSED25.U11"             TO  共１−処理テーブルＩＤ. 
007200     MOVE  "COUNT"                    TO  共１−処理識別.         
007210     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
007220     MOVE  "前受金受払残高ファイル"   TO  共１−その他メッセージ. 
007230     CALL  CLOCO001                   USING  IF-CHOCO001.         
007240 件数メッセージ出力−ＥＸＩＴ.                                    
007250     EXIT.                                                        
007260*                                                                 
007270******************************************************************
007280*    終了メッセージ出力                                          *
007290******************************************************************
007300 終了メッセージ出力                   SECTION.                    
007310 終了メッセージ出力−ＳＴＡＲＴ.                                  
007320*                                                                 
007330*                                                                 
007340*----------------------------------------------------------------*
007350*    終了メッセージ出力                                          *
007360*----------------------------------------------------------------*
007370     INITIALIZE                       IF-CHOCO001.                
007380     MOVE  "3"                        TO  共１−イベント種別.     
007390     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007400     MOVE  "0"                        TO  共１−復帰コード.       
007410     MOVE  "END"                      TO  共１−処理識別.         
007420     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
007430     CALL  CLOCO001                   USING  IF-CHOCO001.         
007440*                                                                 
007450 終了メッセージ出力−ＥＸＩＴ.                                    
007460     EXIT.                                                        
007470******************************************************************
007480*    エラー処理                                                  *
007490******************************************************************
007500 エラー判定処理                       SECTION.                    
007510 エラー判定処理−ＳＴＡＲＴ.                                      
007520*                                                                 
007530     MOVE  "N"                        TO Ｗ−異常終了−フラグ.    
007540     INITIALIZE                           IF-CHOCO001.            
007550*                                                                 
007560     EVALUATE  Ｗ−エラーコード                                   
007570        WHEN  -10                                                 
007580*--<       ＯＲＡＣＬＥ接続失敗 >                                 
007590           MOVE  "1"                  TO  共１−イベント種別      
007600           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
007610           MOVE  "9"                  TO  共１−復帰コード        
007620           MOVE  "CONNECT"            TO  共１−処理識別          
007630           MOVE  SQLCODE              TO  共１−データ内容        
007640           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007650           CALL  CLOCO001             USING  IF-CHOCO001          
007660*                                                                 
007670        WHEN  -20                                                 
007680*--<       業務管理テーブル読込処理失敗 >                         
007690           MOVE  "1"                  TO  共１−イベント種別      
007700           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
007710           MOVE  "9"                  TO  共１−復帰コード        
007720           MOVE  "D70GYM_TBL"         TO  共１−処理テーブルＩＤ  
007730           MOVE  "SELECT"             TO  共１−処理識別          
007740           MOVE  SQLCODE              TO  共１−データ内容        
007750           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007760           CALL  CLOCO001             USING  IF-CHOCO001          
007770           MOVE  "Y"                  TO  Ｗ−異常終了−フラグ    
007780*                                                                 
007790        WHEN  -30                                                 
007800*--<      結合テーブルカーソル定義処理失敗 >                      
007810           MOVE  "1"                  TO  共１−イベント種別      
007820           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
007830           MOVE  "9"                  TO  共１−復帰コード        
007840           MOVE  "M40MAB_TBL"         TO  共１−処理テーブルＩＤ  
007850           MOVE  "SELECT"             TO  共１−処理識別          
007860           MOVE  SQLCODE              TO  共１−データ内容        
007870           MOVE  SQLERRMC             TO  共１−その他メッセージ  
007880           CALL  CLOCO001             USING  IF-CHOCO001          
007890*                                                                 
007900        WHEN  -40                                                 
007910*--<       ファイルオープン失敗 >                                 
007920           MOVE  "1"                  TO  共１−イベント種別      
007930           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
007940           MOVE  "9"                  TO  共１−復帰コード        
007950           MOVE  "SFHSED25.U11"       TO  共１−処理テーブルＩＤ  
007960           MOVE  "OPEN"               TO  共１−処理識別          
007970           MOVE  Ｗ−状態             TO  共１−データ内容        
007980           CALL  CLOCO001             USING  IF-CHOCO001          
007990*                                                                 
008000           WHEN  -50                                              
008010*--<       結合テーブルカーソル読込失敗 >                         
008020           MOVE  "1"                  TO  共１−イベント種別      
008030           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008040           MOVE  "9"                  TO  共１−復帰コード        
008050           MOVE  "M40MAB_TBL"         TO  共１−処理テーブルＩＤ  
008060           MOVE  "FETCH"              TO  共１−処理識別          
008070           MOVE  SQLCODE              TO  共１−データ内容        
008080           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008090           CALL  CLOCO001             USING  IF-CHOCO001          
008100*                                                                 
008110           WHEN  -60                                              
008120*--< 項目名称マスタより主契約区分名称の抽出確認失敗>              
008130           MOVE  "1"                  TO  共１−イベント種別      
008140           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008150           MOVE  "9"                  TO  共１−復帰コード        
008160           MOVE  "D19MSY_TBL"         TO  共１−処理テーブルＩＤ  
008170           MOVE  "SELECT"             TO  共１−処理識別          
008180           MOVE  SQLCODE              TO  共１−データ内容        
008190           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008200           CALL  CLOCO001             USING  IF-CHOCO001          
008210           MOVE  SPACE                TO  ＷＳ−名称１            
008220*                                                                 
008230           WHEN  -70                                              
008240*--<      項目名称マスタより顧客区分名称の抽出失敗 >              
008250           MOVE  "1"                  TO  共１−イベント種別      
008260           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008270           MOVE  "9"                  TO  共１−復帰コード        
008280           MOVE  "D19MSY_TBL-2"       TO  共１−処理テーブルＩＤ  
008290           MOVE  "SELECT"             TO  共１−処理識別          
008300           MOVE  SQLCODE              TO  共１−データ内容        
008310           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008320           CALL  CLOCO001             USING  IF-CHOCO001          
008330           MOVE  SPACE                TO  ＷＳ−名称２            
008340*                                                                 
008350           WHEN  -80                                              
008360*--<         債権情報抽出処理の抽出確認 失敗 >                    
008370           MOVE  "1"                  TO  共１−イベント種別      
008380           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008390           MOVE  "9"                  TO  共１−復帰コード        
008400           MOVE  "M01SAJ_TBL"         TO  共１−処理テーブルＩＤ  
008410           MOVE  "SELECT"             TO  共１−処理識別          
008420           MOVE  SQLCODE              TO  共１−データ内容        
008430           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008440           CALL  CLOCO001             USING  IF-CHOCO001          
008450           MOVE  SPACE                TO Ｍ０１−状態フラグ       
008460		                               Ｍ０１−債権契約件名     
008470		 MOVE  "0"                  TO Ｍ０１−担保区分         
008500*                                                                 
008510           WHEN  -90                                              
008520*--<         共通前受金受払残高中間ファイル出力処理失敗 >         
008530           MOVE  "1"                  TO  共１−イベント種別      
008540           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008550           MOVE  "9"                  TO  共１−復帰コード        
008560           MOVE  "SFHSED25.U11"       TO  共１−処理テーブルＩＤ  
008570           MOVE  "WRITE"              TO  共１−処理識別          
008580           MOVE  SQLCODE              TO  共１−データ内容        
008590           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008600           CALL  CLOCO001             USING  IF-CHOCO001          
008610        WHEN  OTHER                                               
008620           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
008630     END-EVALUATE.                                                
008640*                                                                 
008650     IF Ｗ−異常終了−フラグ  =  "Y"                              
008660*                                                                 
008670        PERFORM  終了処理                                         
008680*                                                                 
008690*--<    プログラム異常終了のリターンコード >                      
008700        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
008710*                                                                 
008720        EXIT  PROGRAM                                             
008730     END-IF.                                                      
008740*                                                                 
008750 エラー処理−ＥＸＩＴ.                                            
008760     EXIT.                                                        
008770******************************************************************
008780*                  END OF PROGRAM                                *
008790******************************************************************
