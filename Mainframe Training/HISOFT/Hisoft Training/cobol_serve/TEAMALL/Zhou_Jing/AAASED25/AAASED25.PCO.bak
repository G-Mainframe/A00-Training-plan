000001******************************************************************
000002*         ＜海輝軟件(大連)＞                                     *
000003*      1. プログラム名    ：前受金受払残高ファイル作成           *
000004*      2. プログラムID    ：AAASED25                             *
000005*      3. 処理概要        ：前受情報ＤＢをメインに、マスタと表   *
000006*                           結合して読込み、前受金受払残高中間   *
000007*                           ファイルを作成する。                 *
000008*      4. 作成者          ：李大偉                               *
000009*      5. 作成日          ：2005.03.25                           *
000010******************************************************************
000011*                                                                 
000012******************************************************************
000013*    ＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ                *
000014******************************************************************
000015 IDENTIFICATION                       DIVISION.                   
000016*                                                                 
000017 PROGRAM-ID.                          AAASED25.                   
000018******************************************************************
000019*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000020******************************************************************
000021 ENVIRONMENT                          DIVISION.                   
000022******************************************************************
000023*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000024******************************************************************
000025 INPUT-OUTPUT                         SECTION.                    
000026 FILE-CONTROL.                                                    
000027*                                                                 
000028     SELECT         出力ファイル      ASSIGN    TO   U11          
000029     FILE STATUS    IS                Ｗ−状態                    
000030     ORGANIZATION   IS     LINE       SEQUENTIAL.                 
000031*                                                                 
000032******************************************************************
000033*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000034******************************************************************
000035 DATA                                 DIVISION.                   
000036******************************************************************
000037*    ＦＩＬＥ                      ＳＥＣＴＩＯＮ                *
000038******************************************************************
000039 FILE                                 SECTION.                    
000040*----------------------------------------------------------------*
000041*    出力ファイル                                                *
000042*----------------------------------------------------------------*
000043 FD  出力ファイル                                                 
000044     LABEL  RECORD    IS              STANDARD                    
000045     BLOCK  CONTAINS  0               RECORDS.                    
000046*                                                                 
000047 01  出力−レコード.                                              
000048     COPY   CPSCE50   REPLACING      ==()==  BY  ==出力−==.      
000049*                                                                 
000050******************************************************************
000051*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000052******************************************************************
000053 WORKING-STORAGE                      SECTION.                    
000054*----------------------------------------------------------------*
000055*    ホスト変数定義エリア                                        *
000056*----------------------------------------------------------------*
000057     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000058 01  ＷＳ−名称１                     PIC  X(060).                
000059 01  ＷＳ−名称２                     PIC  X(060).                
000060*                                                                 
000061 01  ＷＳ−業務管理ＩＤ               PIC  X(8) VALUE 'GYMKNRRC'. 
000062*                                                                 
000063 01  ＷＳ−コードＮＯ１               PIC  X(3) VALUE '038'.      
000064*                                                                 
000065 01  ＷＳ−コードＮＯ２               PIC  X(3) VALUE '005'.      
000066*                                                                 
000067 01  ＷＳ−前受金受払残高表対象フラグ PIC  X(1) VALUE '1'.        
000068*                                                                 
000069 01  ＷＳ−レコード区分               PIC  X(1) VALUE '1'.        
000070*                                                                 
000071 01  ＷＳ−Ｍ０１−担保区分           PIC  X(1) VALUE '1'.        
000072*                                                                 
000073 01  ＷＳ−Ｍ４０−協調区分           PIC  X(1) VALUE '2'.        
000074*                                                                 
000075*--< ＯＲＡＣＬＥ共通変数 >                                       
000076     EXEC  SQL  INCLUDE  SQLCOM.CBL             END-EXEC.          
000077*                                                                 
000078*--< 前受情報ＤＢ >                                               
000079     EXEC  SQL  INCLUDE  M40MAB.CBL             END-EXEC.          
000080*                                                                 
000081*--< 業務管理テーブル >                                           
000082     EXEC  SQL  INCLUDE  D70GYM.CBL             END-EXEC.          
000083*                                                                 
000084*--< 取引先マスタ >                                               
000085     EXEC  SQL  INCLUDE  D01TRS.CBL             END-EXEC.          
000086*                                                                 
000087*--< 請求先マスタ >                                               
000088     EXEC  SQL  INCLUDE  D02SQS.CBL             END-EXEC.          
000089*                                                                 
000090*--< 項目名称マスタ >                                             
000091     EXEC  SQL  INCLUDE  D19MSY.CBL             END-EXEC.          
000092*                                                                 
000093*--< 債権情報（一般）ＤＢ >                                       
000094     EXEC  SQL  INCLUDE  M01SAJ.CBL             END-EXEC.          
000095*                                                                 
000096*--< ＯＲＡＣＬＥ ＳＱＬ実行情報 (SQLCA) >                        
000097     EXEC  SQL  INCLUDE  SQLCA.COB              END-EXEC.          
000098*                                                                 
000099     EXEC  SQL  END      DECLARE      SECTION   END-EXEC.          
000100*----------------------------------------------------------------*
000101*    作業領域定義                                                *
000102*----------------------------------------------------------------*
000103 01  ＷＯＲＫ−エリア.                                            
000104*                                                                 
000105*--< ファイル状態 >                                               
000106     03  Ｗ−状態エリア.                                          
000107         05  Ｗ−状態                 PIC  X(02).                 
000108*                                                                 
000109*--< エラーコード >                                               
000110     03  Ｗ−エラーコード             PIC S9(02).                
000111*                                                                 
000112*--< ファイル状態 >                                               
000113     03  ファイル状態                 PIC  X(02).                 
000114*                                                                 
000115*--< 件数エリア >                                                 
000116     03  件数エリア.                                              
000117        05  Ｗ−入力−件数            PIC  9(09).                 
000118        05  Ｗ−出力−件数            PIC  9(09).                 
000119*                                                                 
000120*--< フラグアリア >                                               
000121     03  フラグ−エリア.                                          
000122        05  Ｗ−終了−フラグ          PIC  X(01).                 
000123        05  Ｗ−異常終了−フラグ      PIC  X(01).                 
000124*                                                                 
      *----------------------------------------------------------------*
000136*    サブルーチン名                                              *
000137*----------------------------------------------------------------*
000138 01  CALL-AREA.                                                   
000139*--< 共通ログサブルーチン >                                       
000140     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
000141     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
000142*----------------------------------------------------------------*
000143*    ＣＯＰＹ領域                                                *
000144*----------------------------------------------------------------*
000145*--< 共通ログ用パラメータ >                                       
000146 01  IF-CHOCO001.                                                 
000147     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
000148*                                                                 
000149*----------------------------------------------------------------*
000150*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
000151*----------------------------------------------------------------*
000152 01  PARA-AREA.                                                   
000153     COPY CPBCO001.                                               
000154******************************************************************
000155*    定数用データ定義エリア                                      *
000156******************************************************************
000157 CONSTANT                             SECTION.                    
000158 01  定数領域.                                                    
000159     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
000160     03  定数−プログラム名           PIC  X(80) VALUE                 
000161                                       "前受金受払残ファイル作成".
000162     03  定数−ＳＱＬＯＫ             PIC  9(04) VALUE  0000.    
000163     03  定数−ＳＱＬＥＮＤ           PIC  9(04) VALUE  0100.    
000164     03  定数−正常状態               PIC  9(04) VALUE  ZERO.    
000165     03  定数−異常状態               PIC  9(04) VALUE  0009.    
000166******************************************************************
000167*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
000168******************************************************************
000169 PROCEDURE                            DIVISION.                   
000170*                                                                 
000171     PERFORM  初期処理.                                          
000172*                                                                 
000173     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".           
000174*                                                                 
000175     PERFORM  終了処理.                                          
000176*                                                                 
000177     STOP RUN.                                                    
000178*                                                                 
000179******************************************************************
000180*    初期処理                                            <1.0>   *
000181******************************************************************
000182 初期処理                             SECTION.                    
000183 初期処理−ＳＴＡＲＴ.                                            
000184*                                                                 
000185*----------------------------------------------------------------*
000186*     開始メッセージ出力                                 <1.1>   *
000187*----------------------------------------------------------------*
000188     INITIALIZE                       IF-CHOCO001.                
000189     MOVE  "3"                        TO  共１−イベント種別.     
000190     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
000191     MOVE  "0"                        TO  共１−復帰コード.       
000192     MOVE  "START"                    TO  共１−処理識別.         
000193     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
000194     CALL  CLOCO001                USING  IF-CHOCO001.            
000195*                                                                 
000196*----------------------------------------------------------------*
000197*    作業領域の初期値設定                                <1.2>   *
000198*----------------------------------------------------------------*
000199     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
000200     INITIALIZE                           ＷＯＲＫ−エリア.       
000201*                                                                 
000207*----------------------------------------------------------------*
000208*    ＯＲＡＣＬＥ接続                                    <1.3>   *
000209*----------------------------------------------------------------*
000210     PERFORM  ＯＲＡＣＬＥ接続.                                   
000211*----------------------------------------------------------------*
000212*    業務管理テーブル読込                                <1.4>   *
000213*----------------------------------------------------------------*
000214     PERFORM   業務管理テーブル読込                               
000215*----------------------------------------------------------------*
000216*    結合テーブルカーソル宣言                            <1.5>   *
000217*----------------------------------------------------------------*
000218     PERFORM  結合テーブルカーソル宣言.                           
000219*----------------------------------------------------------------*
000220*    ファイルオープン                                    <1.6>   *
000221*----------------------------------------------------------------*
000222     PERFORM  ファイルオープン.                                   
000223*----------------------------------------------------------------*
000224*    結合テーブル読込(１件目)                            <1.7>   *
000225*----------------------------------------------------------------*
000226     PERFORM   結合テーブル読込.                                  
000227*                                                                 
000228 初期処理−ＥＸＩＴ.                                              
000229     EXIT.                                                        
000230******************************************************************
000231*    ＯＲＡＣＬＥ接続                                    <1.3>   *
000232******************************************************************
000233 ＯＲＡＣＬＥ接続                     SECTION.                    
000234 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
000235*                                                                 
000236*--< ＩＮＩファイル読込サブルーチン呼び出し >                     
000237     CALL  COBCO001                USING  PARA-AREA.              
000238*                                                                 
000239     MOVE  PARA-DBSTRING              TO  DB-STRING.              
000240     MOVE  PARA-USERNAME              TO  USERNAME.               
000241     MOVE  PARA-PASSWORD              TO  PASSWD.                 
000242*                                                                 
000243*----------------------------------------------------------------*
000244*    開始接続                                                    *
000245*----------------------------------------------------------------*
000246     IF  DB-STRING  =  SPACE                                      
000247        EXEC  SQL                                                 
000248           CONNECT  :USERNAME  IDENTIFIED  BY  :PASSWD            
000249        END-EXEC                                                  
000250     ELSE                                                         
000251        EXEC  SQL                                                 
000252           CONNECT  :USERNAME  IDENTIFIED  BY  :PASSWD            
000253             USING  :DB-STRING                                    
000254        END-EXEC                                                  
000255     END-IF.                                                      
000256*                                                                 
000257*----------------------------------------------------------------*
000258*    接続状態判定                                                *
000259*----------------------------------------------------------------*
000260     EVALUATE  SQLCODE                                            
000261        WHEN  定数−ＳＱＬＯＫ                                    
000262*--<       接続正常 >                                             
000263           CONTINUE                                               
000264        WHEN  OTHER                                               
000265*--<       接続エラー >                                           
000266           MOVE     -1                TO  Ｗ−エラーコード         
000267           PERFORM  エラー処理                                    
000268     END-EVALUATE.                                                
000269*                                                                 
000270 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
000271     EXIT.                                                        
000272******************************************************************
000273* 4  業務管理テーブル読込                                <1.4>   *
000274******************************************************************
000275 業務管理テーブル読込                 SECTION.                     
000276 業務管理テーブル読込−ＳＴＡＲＴ.                                
000277*--< 取得条件  >                                                 
000278*                                                                 
000279     EXEC  SQL                                                    
000280           SELECT  バッチ用業務年月                               
000281             INTO :Ｄ７０−バッチ用業務年月                       
000282             FROM  D70GYM_TBL                                     
000283            WHERE  業務管理ＩＤ = :ＷＳ−業務管理ＩＤ             
000284*                                                                 
000285     END-EXEC.                                                    
000286*                                                                 
000287*----------------------------------------------------------------*
000288*    業務管理テーブル読込を確認                                  *
000289*----------------------------------------------------------------*
000290     EVALUATE  SQLCODE                                            
000291        WHEN  定数−ＳＱＬＯＫ                                    
000292*--<       正常 >                                                 
000293           CONTINUE                                               
000294        WHEN  OTHER                                               
000295*--<       カーソルＯＰＥＮエラー >                               
000296           MOVE -2                    TO  Ｗ−エラーコード         
000297           PERFORM  エラー処理                                    
000298     END-EVALUATE.                                                
000299*                                                                 
000300 業務管理テーブル読込−ＥＸＩＴ.                                  
000301     EXIT.                                                        
000302*                                                                 
000303******************************************************************
000304*    結合テーブルカーソル宣言                            <1.5>   *
000305******************************************************************
000306*                                                                 
000307 結合テーブルカーソル宣言             SECTION.                   
000308 結合テーブルカーソル宣言−ＳＴＡＲＴ.                            
000309*--< 結合テーブルカーソル定義  >                                 
000310     EXEC SQL                                                  
000311        DECLARE CUR1 CURSOR FOR                                
000312         SELECT  M40MAB_TBL.レコード区分                        
000313                ,M40MAB_TBL.経理用主契約区分                    
000314                ,M40MAB_TBL.顧客区分                            
000315                ,NVL(D01TRS_TBL.名寄せコード,RPAD(' ',40,' '))  
000316                ,M40MAB_TBL.請求先取引先コード                  
000317                ,M40MAB_TBL.請求先コード                        
000318                ,M40MAB_TBL.契約番号                            
000319                ,M40MAB_TBL.契約種類                            
000320                ,M40MAB_TBL.担当部課コード                      
000321                ,M40MAB_TBL.再リース回数                        
000322                ,M40MAB_TBL.充当開始年月                        
000323                ,M40MAB_TBL.充当月数                            
000324                ,M40MAB_TBL.前払回収方法                        
000325                ,M40MAB_TBL.入金日                              
000326                ,M40MAB_TBL.入金区分                            
000327                ,NVL(D01TRS_TBL.取引先名称,RPAD(' ',80,' '))    
000328                ,NVL(D02SQS_TBL.請求先名称,RPAD(' ',80,' '))    
000329                ,M40MAB_TBL.前月末残高                          
000330                ,M40MAB_TBL.当月回収額                          
000331                ,M40MAB_TBL.当月消化額                          
000332                ,M40MAB_TBL.当月末残高                          
000333                ,M40MAB_TBL.協調区分                            
000334                ,M40MAB_TBL.前月末残高他社                      
000335                ,M40MAB_TBL.当月回収額他社                      
000336                ,M40MAB_TBL.当月消化額他社                      
000337                ,M40MAB_TBL.当月他社解約分料金                  
000338                ,M40MAB_TBL.当月他社解約分消費税                
000339                ,M40MAB_TBL.当月末残高他社                      
000340           FROM  M40MAB_TBL                                     
000341                ,D01TRS_TBL                                     
000342                ,D02SQS_TBL                                     
000343          WHERE  M40MAB_TBL.前受金受払残高表対象フラグ =        
000344                               :ＷＳ−前受金受払残高表対象フラグ 
000345            AND  M40MAB_TBL.請求先取引先コード       =        
000346                                   D01TRS_TBL.取引先コード ( + )  
000347            AND  M40MAB_TBL.請求先取引先コード       =        
000348                                   D01TRS_TBL.取引先コード ( + )  
000349            AND  M40MAB_TBL.請求先コード             =        
000350                                   D02SQS_TBL.請求先コード ( + )  
000351       ORDER BY  M40MAB_TBL.レコード区分                        
000352                ,M40MAB_TBL.契約番号                            
000353     END-EXEC.                                                    
000354*                                                                 
000355*----------------------------------------------------------------*
000359*    カーソルＯＰＥＮ処理                                        *
000360*----------------------------------------------------------------*
000363     EXEC  SQL                                                    
000364        OPEN  CUR1                                                
000365     END-EXEC.                                                    
000366*----------------------------------------------------------------*
000367*    カーソルＯＰＥＮ確認                                        *
000368*----------------------------------------------------------------*
000369     EVALUATE  SQLCODE                                            
000370        WHEN  定数−ＳＱＬＯＫ                                    
000371*--<       正常 >                                                 
000372           CONTINUE                                               
000373        WHEN  OTHER                                               
000374*--<       カーソルＯＰＥＮエラー >                               
000375           MOVE -3                    TO  Ｗ−エラーコード         
000376           PERFORM  エラー処理                                    
000377     END-EVALUATE.                                                
000378*                                                                 
000379 結合テーブルカーソル宣言−ＥＸＩＴ.                              
000380     EXIT.                                                        
000381*----------------------------------------------------------------*
000382*    ファイルオープン                                            *
000383*----------------------------------------------------------------*
000384 ファイルオープン                     SECTION.                     
000385 ファイルオープンーＳＴＡＲＴ.                                    
000386*                                                                 
000387     OPEN  OUTPUT 出力ファイル.                                   
000388*                                                                 
000392     EVALUATE   SQLCODE                                           
000393        WHEN   定数−ＳＱＬＯＫ                                   
000394*--< 正常 >                                                 
000395           CONTINUE                                               
000396        WHEN   OTHER                                              
000397*--<  カーソルオープン失敗、プログラムが異常終了 >           
000398           MOVE      -4               TO  Ｗ−エラーコード         
000399           PERFORM   エラー処理                                   
000400     END-EVALUATE.                                                
000401 ファイルオープン−ＥＸＩＴ.                                      
000402     EXIT.                                                        
000403*                                                                 
000404******************************************************************
000405*    結合テーブル読込                                    <C.1>   *
000406******************************************************************
000407 結合テーブル読込                     SECTION.                      
000408 結合テーブル読込−ＳＴＡＲＴ.                                    
000409*                                                                 
000410     EXEC  SQL                                                    
000411        FETCH  CUR1                                               
000412           INTO  :Ｍ４０−レコード区分                            
000413                ,:Ｍ４０−経理用主契約区分                        
000414                ,:Ｍ４０−顧客区分                                
000415                ,:Ｄ０１−名寄せコード                            
000416                ,:Ｍ４０−請求先取引先コード                      
000417                ,:Ｍ４０−請求先コード                            
000418                ,:Ｍ４０−契約番号                                
000419                ,:Ｍ４０−契約種類                                
000420                ,:Ｍ４０−担当部課コード                          
000421                ,:Ｍ４０−再リース回数                            
000422                ,:Ｍ４０−充当開始年月                            
000423                ,:Ｍ４０−充当月数                                
000424                ,:Ｍ４０−前払回収方法                            
000425                ,:Ｍ４０−入金日                                  
000426                ,:Ｍ４０−入金区分                                
000427                ,:Ｄ０１−取引先名称                              
000428                ,:Ｄ０２−請求先名称                              
000429                ,:Ｍ４０−前月末残高                              
000430                ,:Ｍ４０−当月回収額                              
000431                ,:Ｍ４０−当月消化額                              
000432                ,:Ｍ４０−当月末残高                              
000433                ,:Ｍ４０−協調区分                                
000434                ,:Ｍ４０−前月末残高他社                          
000435                ,:Ｍ４０−当月回収額他社                          
000436                ,:Ｍ４０−当月消化額他社                          
000437                ,:Ｍ４０−当月他社解約分料金                      
000438                ,:Ｍ４０−当月他社解約分消費税                    
000439                ,:Ｍ４０−当月末残高他社                          
000440     END-EXEC.                                                    
000441*                                                                 
000442*----------------------------------------------------------------*
000443*    結合テーブルカーソル読込を確認                              *
000444*----------------------------------------------------------------*
000445     EVALUATE   SQLCODE                                           
000446        WHEN   定数−ＳＱＬＯＫ                                   
000447*--< 正常 >                                                 
000448           COMPUTE  Ｗ−入力−件数    =  Ｗ−入力−件数  +  1       
000449        WHEN   定数−ＳＱＬＥＮＤ                                 
000450*--< 読込終了 >                                             
000451           MOVE  "Y"                  TO  Ｗ−終了−フラグ        
000452        WHEN   OTHER                                              
000453*--< 読込エラー >                                           
000454           MOVE     -5                TO  Ｗ−エラーコード        
000455           PERFORM  エラー処理                                    
000456     END-EVALUATE.                                                
000457*                                                                 
000459 結合テーブル読込−ＥＸＩＴ.                                      
000460     EXIT.                                                        
000461*                                                                 
000462******************************************************************
000463*    主処理                                              <2.0>   *
000464******************************************************************
000465 主処理                               SECTION.                    
000466 主処理−ＳＴＡＲＴ.                                              
000467*                                                                 
000468*----------------------------------------------------------------*
000469*    項目名称マスタより項目の抽出処理                    <2.1>   *
000470*----------------------------------------------------------------*
000471     PERFORM  項目名称マスタより項目の抽出処理.                   
000472*----------------------------------------------------------------*
000473*    債権情報（一般）ＤＢより項目の抽出処理              <2.2>   *
000474*----------------------------------------------------------------*
000475     PERFORM  債権情報ＤＢより項目の抽出処理.                     
000476*----------------------------------------------------------------*
000477*    前受金受払残高中間ファイル項目編集、出力処理      <2.4>     *
000478*----------------------------------------------------------------*
000479     IF  Ｍ０１−担保区分  NOT = ＷＳ−Ｍ０１−担保区分           
000481        PERFORM   中間ファイル項目編集と出力処理                  
000482     END-IF.                                                      
000483*----------------------------------------------------------------*
000484*    結合テーブル読込（２件目以降）                    <2.5>     *
000485*----------------------------------------------------------------*
000486     PERFORM   結合テーブル読込.                                  
000487*                                                                 
000488 主処理−ＥＸＩＴ.                                                
000489     EXIT.                                                        
000490******************************************************************
000491*    項目名称マスタより項目の抽出処理                    <2.1>   *
000492******************************************************************
000493 項目名称マスタより項目の抽出処理     SECTION.                    
000494 項目名称マスタより項目の抽出処理−ＳＴＡＲＴ.                    
000495*                                                                 
000496*----------------------------------------------------------------*
000497*    項目名称マスタより主契約区分名称の抽出処理          <2.1.1> *
000498*----------------------------------------------------------------*
000499     EXEC  SQL                                                   
000500        SELECT  名称                                           
000501           INTO  ＷＳ−名称１                                   
000502           FROM  D19MSY_TBL                                     
000503          WHERE  コードＮＯ =:ＷＳ−コードＮＯ１                
000504            AND  SUBSTR(コード,1,1) = :Ｍ４０−経理用主契約区分 
000505     END-EXEC.                                                   
000506*                                                                 
000507*----------------------------------------------------------------*
000508*    項目名称マスタより主契約区分名称の抽出処理確認              *
000509*----------------------------------------------------------------*
000510     EVALUATE  SQLCODE                                            
000511        WHEN  定数−ＳＱＬＯＫ                                    
000512*--< 正常 >                                                 
000513           CONTINUE                                               
000514        WHEN  OTHER                                               
000515*--< カーソルＯＰＥＮエラー >                               
000516           MOVE -6                    TO  Ｗ−エラーコード         
000517           PERFORM  エラー処理                                    
000518     END-EVALUATE.                                                
000519*                                                                 
000520*----------------------------------------------------------------*
000521*    項目名称マスタより顧客区分名称の抽出処理            <2.1.2> *
000522*----------------------------------------------------------------*
000523     EXEC  SQL                                                   
000524        SELECT  名称                                           
000525          INTO  ＷＳ−名称２                                   
000526          FROM  D19MSY_TBL                                     
000527         WHERE  コードＮＯ = :ＷＳ−コードＮＯ２               
000528           AND  SUBSTR(コード,1,2) = :Ｍ４０−顧客区分         
000529     END-EXEC.                                                   
000530*                                                                 
000531*----------------------------------------------------------------*
000532*    項目名称マスタより主契約区分名称の抽出処理確認              *
000533*----------------------------------------------------------------*
000534     EVALUATE  SQLCODE                                            
000535        WHEN  定数−ＳＱＬＯＫ                                    
000536*--< 正常 >                                                 
000537           CONTINUE                                               
000538        WHEN  OTHER                                               
000539*--<       カーソルＯＰＥＮエラー >                               
000540           MOVE -6                    TO  Ｗ−エラーコード         
000541           PERFORM  エラー処理                                    
000542     END-EVALUATE.                                                
000543*                                                                 
000544******************************************************************
000545*    債権情報ＤＢより項目の抽出処理                      <2.2>   *
000546******************************************************************
000547 債権情報ＤＢより項目の抽出処理     SECTION.                      
000548 債権情報ＤＢより項目の抽出処理−ＳＴＡＲＴ.                      
000549*                                                                 
000550     EXEC  SQL                                                    
000551        SELECT  状態フラグ                                     
000552               ,債権契約件名                                   
000553               ,担保区分                                       
000554         INTO  :Ｍ０１−状態フラグ                            
000555              ,:Ｍ０１−債権契約件名                          
000556              ,:Ｍ０１−担保区分                              
000557         FROM   M01SAJ_TBL                                     
000558        WHERE   レコード区分 = :ＷＳ−レコード区分             
000559          AND   契約番号 = :Ｍ４０−契約番号                   
000560          AND   再リース回数 = :Ｍ４０−再リース回数           
000561          AND   契約種類 = :Ｍ４０−契約種類                   
000562     END-EXEC.                                                    
000563*                                                                 
000564*----------------------------------------------------------------*
000565*    債権情報ＤＢより項目の抽出処理確認                          *
000566*----------------------------------------------------------------*
000567     EVALUATE  SQLCODE                                            
000568        WHEN  定数−ＳＱＬＯＫ                                    
000569*--< 正常 >                                                 
000570           CONTINUE                                               
000571        WHEN  OTHER                                               
000572*--< カーソルＯＰＥＮエラー >                               
000573           MOVE     SPACE             TO  Ｍ０１−状態フラグ      
000574           MOVE     SPACE             TO  Ｍ０１−債権契約件名    
000575           MOVE     SPACE             TO  Ｍ０１−担保区分        
000576           MOVE -7                    TO  Ｗ−エラーコード         
000577           PERFORM  エラー処理                                    
000578     END-EVALUATE.                                                
000579*                                                                 
000580 債権情報ＤＢより項目の抽出処理−ＥＸＩＴ.                        
000581     EXIT.                                                        
000582*                                                                 
000583******************************************************************
000584*    前受金受払残高中間ファイル項目編集と出力処理        <2.4>   *
000585******************************************************************
000586 中間ファイル項目編集と出力処理       SECTION.                   
000587 中間ファイル項目編集と出力処理ーＳＴＡＲＴ.                      
000588*                                                                 
000589*--< 出力レコードの初期化処理 >                                   
000590     MOVE  SPACE                      TO  出力−レコード.               
000591     INITIALIZE                           出力−レコード.               
000592*                                                                 
000593*--< 自社分個別の編集 >                                           
000594     PERFORM  自社分編集.                                         
000595*                                                                 
000596*--< 自社分出力判定 >                                             
000597     IF      出力−前月末残高    =  0                             
000598        AND  出力−当月入金額    =  0                             
000599        AND  出力−当月消化額    =  0                             
000600        AND  出力−当月末残高    =  0                             
000601        CONTINUE                                                  
000602      ELSE                                                        
000603         PERFORM  中間ファイル出力処理                            
000604      END-IF.                                                     
000605*--< 他社分個別の編集 >                                           
000606     IF  Ｍ４０−協調区分 = ＷＳ−Ｍ４０−協調区分                
000607        PERFORM  他社分編集出力                                   
000608     END-IF.                                                      
000609*                                                                 
000610 前受金受払残高中間ファイル出力判定処理−ＥＸＩＴ.                
000611     EXIT.                                                        
000612*                                                                 
000613******************************************************************
000614*    自社分編集                                                  *
000615******************************************************************
000616*                                                                 
000617 自社分編集                           SECTION.                                          
000618 自社分編集−ＳＴＡＲＴ.                                          
000619*                                                                 
000620*--< No.1 >                                                       
000622     IF   Ｍ０１−状態フラグ < 3                                  
000623       MOVE  3                        TO  出力−自他社区分      
000624     ELSE                                                         
000625       MOVE 1                         TO  出力−自他社区分      
000626     END-IF.                                                      
000627*--< No.2 >                                                     
000628     MOVE  Ｍ４０−レコード区分       TO  出力−前受区分.       
000629*--< No.3 >                                                     
000630     MOVE  Ｍ４０−経理用主契約区分   TO  出力−主契約区分.     
000631*--< No.4 >                                                     
000632     MOVE  Ｍ４０−顧客区分           TO  出力−連結区分.       
000633*--< No.5 >                                                     
000634     MOVE  Ｄ０１−名寄せコード       TO  出力−名寄せコード.   
000635*--< No.6 >                                                     
000636     MOVE  Ｍ４０−請求先取引先コード TO  出力−取引先コード.   
000637*--< No.7 >                                                     
000638     MOVE  Ｍ４０−請求先コード       TO  出力−請求先コード.   
000639*--< No.8 >                                                     
000640     MOVE  Ｍ４０−契約番号           TO  出力−契約番号.       
000641*--< No.9 >                                                     
000642     MOVE  Ｍ４０−契約種類           TO  出力−契約種類.       
000643*--< No.10 >                                                    
000644     MOVE  Ｄ７０−バッチ用業務年月   TO  出力−業務年月.       
000645*--< No.11 >                                                    
000646     MOVE  Ｍ４０−担当部課コード     TO  出力−担当部課コード. 
000647*--< No.12 >                                                    
000648     MOVE  Ｍ０１−債権契約件名       TO  出力−契約件名.       
000649*--< No.13 >                                                    
000650     MOVE  Ｍ４０−再リース回数       TO  出力−再リース回数.   
000651*--< No.14 >                                                    
000652     MOVE  Ｍ４０−充当開始年月       TO  出力−充当開始年月.   
000653*--< No.15 >                                                    
000654     MOVE  Ｍ４０−充当月数           TO  出力−充当月数.       
000655*--< No.16 >                                                    
000656     MOVE  Ｍ４０−前払回収方法       TO  出力−前払回収方法.   
000657*--< No.17 >                                                    
000658     MOVE  Ｍ４０−入金日             TO  出力−入金日.         
000659*--< No.18 >                                                    
000660     MOVE  Ｍ４０−入金区分           TO  出力−入金区分.       
000661*--< No.19 >                                                    
000662     MOVE  Ｄ０１−取引先名称         TO  出力−取引先名称.     
000663*--< No.20 >                                                    
000664     MOVE  Ｄ０２−請求先名称         TO  出力−請求先名称.     
000665*--< No.21 >                                                    
000666     MOVE  ＷＳ−名称１               TO  出力−主契約区分名称. 
000667*--< No.22 >                                                    
000668     MOVE  ＷＳ−名称２               TO  出力−連結区分名称.   
000669*--< No.23 >                                                    
000670     MOVE  Ｍ４０−前月末残高         TO  出力−前月末残高.     
000671*--< No.24 >                                                    
000672     MOVE  Ｍ４０−当月回収額         TO  出力−当月入金額.     
000673*--< No.25 >                                                    
000674     MOVE  Ｍ４０−当月消化額         TO  出力−当月消化額.     
000675*--< No.26 >                                                    
000676     MOVE  Ｍ４０−当月末残高         TO  出力−当月末残高.     
000677*                                                               
000678 自社分編集−ＥＸＩＴ.                                            
000679       EXIT.                                                      
000680*                                                                 
000681*----------------------------------------------------------------*
000682*    他社分編集        <2.4.2>                                   *
000683*----------------------------------------------------------------*
000684 他社分編集出力     SECTION.                                      
000685 他社分編集出力−ＳＴＡＲＴ.                                      
000686*                                                                 
000687*--< No.1 >                                                     
000688     IF   Ｍ０１−状態フラグ < 3                                  
000689        MOVE  4                       TO  出力−自他社区分       
000690     ELSE                                                         
000691        MOVE 2                        TO  出力−自他社区分       
000692     END-IF.                                                      
000693*--< No.23 >                                                    
000694     MOVE  Ｍ４０−前月末残高         TO  出力−前月末残高.     
000695*--< No.24 >                                                    
000696     MOVE  Ｍ４０−当月回収額         TO  出力−当月入金額.     
000697*--< No.25 >                                                    
000698     COMPUTE  出力−当月消化額  =  Ｍ４０−当月消化額           
000699                                +  Ｍ４０−当月他社解約分料金   
000700                                +  Ｍ４０−当月他社解約分消費税.
000701*--< No.26 >                                                    
000702     COMPUTE  出力−当月末残高  =  Ｍ４０−当月末残高           
000703                                -  Ｍ４０−当月他社解約分料金   
000704                                -  Ｍ４０−当月他社解約分消費税.
000705*                                                               
000707*--< 他社分出力判定 >                                             
000708     IF      出力−前月末残高  =  0                              
000709        AND  出力−当月入金額  =  0                              
000710        AND  出力−当月消化額  =  0                              
000711        AND  出力−当月末残高  =  0                              
000712        CONTINUE                                                 
000713     ELSE                                                         
000714        PERFORM   中間ファイル出力処理                           
000715     END-IF.                                                      
000716*                                                                 
000717 他社分編集出力−ＥＸＩＴ.                                        
000718     EXIT.                                                        
000719*                                                                 
000723******************************************************************
000724*    前受金受払残高中間ファイル出力処理                  <2.4.2> *
000725******************************************************************
000726 中間ファイル出力処理  SECTION.                                   
000727 中間ファイル出力処理−ＳＴＡＲＴ.                                
000728*                                                                 
000729     WRITE  出力−レコード.                                       
000730*                                                                 
000731*--< 前受金受払残高中間ファイル出力の状態判定 >                   
000732     EVALUATE  SQLCODE                                            
000733        WHEN  ZERO                                                
000734*--< 前受金受払残高中間ファイル出力件数の加算 >             
000735           COMPUTE  Ｗ−出力−件数 =  Ｗ−出力−件数 + 1          
000736        WHEN  OTHER                                               
000737*--< ファイル出力エラー >                                   
000738           MOVE     -8                TO  Ｗ−エラーコード        
000739           PERFORM  エラー処理                                    
000740     END-EVALUATE.                                                
000741*                                                                 
000742 中間ファイル出力処理−ＥＸＩＴ.                                  
000743     EXIT.                                                        
000744*                                                                 
000745******************************************************************
000746*    終了処理                                            <3.0>   *
000747******************************************************************
000748 終了処理                             SECTION.                    
000749 終了処理−ＳＴＡＲＴ.                                            
000750*                                                                 
000751*----------------------------------------------------------------*
000752*    ＤＢクローズ処理                                    <3.1>   *
000753*----------------------------------------------------------------*
000754*                                                                 
000755     EXEC  SQL                                                    
000756        CLOSE  CUR1                                               
000757     END-EXEC.                                                    
000758*                                                                 
000759*----------------------------------------------------------------*
000760*   ファイルクローズ処理                                         *
000761*----------------------------------------------------------------*
000762*--< ファイルクローズ >                                           
000763     CLOSE  出力ファイル.                                         
000764*                                                                 
000765*----------------------------------------------------------------*
000766*    件数メッセージ出力処理                                      *
000767*----------------------------------------------------------------*
000768     PERFORM  件数メッセージ出力.                                 
000769*                                                                 
000770*----------------------------------------------------------------*
000771*    終了メッセージ出力処理                              <C.3>   *
000772*----------------------------------------------------------------*
000773     PERFORM  終了メッセージ出力.                                 
000774*                                                                 
000775*--< プログラム正常終了 >                                         
000776     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
000777*                                                                 
000778 終了処理−ＥＸＩＴ.                                              
000779     EXIT.                                                        
000781******************************************************************
000782*    件数メッセージ出力処理                                      *
000783******************************************************************
000784 件数メッセージ出力                   SECTION.                    
000785 件数メッセージ出力−ＳＴＡＲＴ.                                  
000786*                                                                 
000787     INITIALIZE                       IF-CHOCO001.                
000788     MOVE  "3"                        TO  共１−イベント種別.     
000789     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
000790     MOVE  "0"                        TO  共１−復帰コード.       
000791     MOVE  "M40MAB"                   TO  共１−処理テーブルＩＤ. 
000792     MOVE  "COUNT"                    TO  共１−処理識別.         
000793     MOVE  Ｗ−入力−件数             TO  共１−データ内容.       
000794     MOVE  "前受情報ＤＢ入力件数"     TO  共１−その他メッセージ. 
000795     CALL  CLOCO001                USING  IF-CHOCO001.            
000796*                                                                 
000797     INITIALIZE                       IF-CHOCO001.                
000798     MOVE  "3"                        TO  共１−イベント種別.     
000799     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
000800     MOVE  "0"                        TO  共１−復帰コード.       
000801     MOVE  "SFHSED25"                 TO  共１−処理テーブルＩＤ. 
000802     MOVE  "COUNT"                    TO  共１−処理識別.         
000803     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
000804     MOVE  "前受金受払残高中間ファイル"                           
000805                                      TO  共１−その他メッセージ. 
000806     CALL  CLOCO001                USING  IF-CHOCO001.            
000807*                                                                 
000808 件数メッセージ出力−ＥＸＩＴ.                                    
000809     EXIT.                                                        
000810*                                                                 
000811******************************************************************
000812*    終了メッセージ出力処理                                      *
000813******************************************************************
000814 終了メッセージ出力                   SECTION.                    
000815 終了メッセージ出力−ＳＴＡＲＴ.                                  
000816*                                                                 
000817     INITIALIZE                       IF-CHOCO001.                
000818     MOVE  "3"                        TO  共１−イベント種別.     
000819     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
000820     MOVE  "0"                        TO  共１−復帰コード.       
000821     MOVE  "END"                      TO  共１−処理識別.         
000822     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
000823     CALL  CLOCO001                USING  IF-CHOCO001.            
000824*                                                                 
000825 終了メッセージ出力−ＥＸＩＴ.                                    
000826     EXIT.                                                        
000827*                                                                 
000828******************************************************************
000829*    エラー処理                                          <4.0>   *
000830******************************************************************
000831 エラー処理                           SECTION.                    
000832 エラー処理−ＳＴＡＲＴ.                                          
000833*                                                                 
000834     MOVE  "Y"                        TO  Ｗ−異常終了−フラグ.   
000835     INITIALIZE                       IF-CHOCO001.                
000836*                                                                 
000837     EVALUATE  Ｗ−エラーコード                                   
000838        WHEN  -1                                                  
000839*--< ＯＲＡＣＬＥ接続失敗 >                                 
000840           MOVE  "1"                  TO  共１−イベント種別      
000841           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
000842           MOVE  "9"                  TO  共１−復帰コード        
000843           MOVE  "CONNECT"            TO  共１−処理識別          
000844           MOVE  SQLCODE              TO  共１−データ内容        
000845           MOVE  SQLERRMC             TO  共１−その他メッセージ  
000846           CALL  CLOCO001          USING  IF-CHOCO001             
000847           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
000848*                                                                 
000849        WHEN  -2                                                  
000850*--< 業務管理テーブオープンエラー >                         
000851           MOVE  "1"                  TO  共１−イベント種別      
000852           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
000853           MOVE  "9"                  TO  共１−復帰コード        
000854           MOVE  SQLCODE              TO  共１−処理テーブルＩＤ  
000855           MOVE  "READ"               TO  共１−処理識別          
000856           MOVE  SQLCODE              TO  共１−データ内容        
000857           MOVE  SQLERRMC             TO  共１−その他メッセージ  
000858           CALL  CLOCO001          USING  IF-CHOCO001             
000859           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
000860*                                                                 
000861        WHEN  -3                                                  
000862*--< カーソルオープン処理エラー  >                          
000863           MOVE  "1"                  TO  共１−イベント種別      
000864           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
000865           MOVE  "9"                  TO  共１−復帰コード        
000866           MOVE  "CUR1"               TO  共１−処理テーブルＩＤ  
000868           MOVE  "OPEN"               TO  共１−処理識別          
000869           MOVE  SQLCODE              TO  共１−データ内容        
000870           MOVE  SQLERRMC             TO  共１−その他メッセージ  
000871           CALL  CLOCO001          USING  IF-CHOCO001             
000872           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
000873*                                                                 
000874        WHEN  -4                                                  
000875*--< 出力ファイルオープンエラー  >                          
000876           MOVE  "1"                  TO  共１−イベント種別      
000877           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
000878           MOVE  "9"                  TO  共１−復帰コード        
000879           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
000880           MOVE  "OPEN"               TO  共１−処理識別          
000882           MOVE  SQLCODE              TO  共１−データ内容        
000883           MOVE  SQLERRMC             TO  共１−その他メッセージ  
000884           CALL  CLOCO001          USING  IF-CHOCO001             
000885           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
000886*                                                                 
000887        WHEN  -5                                                  
000888*--< カーソルオープン失敗 >                                 
000889           MOVE  "1"                  TO  共１−イベント種別      
000890           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
000891           MOVE  "9"                  TO  共１−復帰コード        
000892           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
000894           MOVE  "FETCH"              TO  共１−処理識別          
000896           MOVE  SQLCODE              TO  共１−データ内容        
000897           MOVE  SQLERRMC             TO  共１−その他メッセージ  
000898           CALL  CLOCO001          USING  IF-CHOCO001             
000899           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
000900*                                                                 
000901        WHEN  -6                                                  
000902*--< 項目名称マスタより項目の抽出処理エラー   >             
000903           MOVE  "1"                  TO  共１−イベント種別      
000904           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
000905           MOVE  "9"                  TO  共１−復帰コード        
000906           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
000908           MOVE  "OPEN"               TO  共１−処理識別          
000910           MOVE  SQLCODE              TO  共１−データ内容        
000911           MOVE  SQLERRMC             TO  共１−その他メッセージ  
000912           CALL  CLOCO001          USING  IF-CHOCO001             
000913           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
000914*                                                                 
000915           WHEN  -7                                               
000916*--< 項目名称マスタより主契約区分名称の抽出処理エラー    >  
000917           MOVE  "1"                  TO  共１−イベント種別      
000918           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
000919           MOVE  "9"                  TO  共１−復帰コード        
000920           MOVE  "D01SAJ"             TO  共１−処理テーブルＩＤ  
000922           MOVE  "SELECT"             TO  共１−処理識別          
000924           MOVE  SQLCODE              TO  共１−データ内容        
000925           MOVE  SQLERRMC             TO  共１−その他メッセージ  
000926           CALL  CLOCO001          USING  IF-CHOCO001             
000927           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
000928*                                                                 
000929           WHEN  -8                                               
000930*--< 債権情報ＤＢより項目の抽出処理エラー    >              
000931           MOVE  "1"                  TO  共１−イベント種別      
000932           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
000933           MOVE  "9"                  TO  共１−復帰コード        
000934           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
000936           MOVE  "WRITE"              TO  共１−処理識別          
000938           MOVE  SQLCODE              TO  共１−データ内容        
000939           MOVE  SQLERRMC             TO  共１−その他メッセージ  
000940           CALL  CLOCO001          USING  IF-CHOCO001             
000941           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
000942        WHEN  OTHER                                               
000943           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
000944     END-EVALUATE.                                                
000945*                                                                 
000946     IF  Ｗ−異常終了−フラグ =  "Y"                              
000947*----------------------------------------------------------------*
000948*    終了メッセージ出力処理                                      *
000949*----------------------------------------------------------------*
000950        PERFORM  終了メッセージ出力                               
000951*                                                                 
000952*--< プログラムリターンコード >                                
000953        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
000954        EXIT  PROGRAM                                             
000955     END-IF.                                                      
000956*                                                                 
000957 エラー処理−ＥＸＩＴ.                                            
000958     EXIT.                                                       
000959******************************************************************
000960*                  END OF PROGRAM                                *
000961******************************************************************
