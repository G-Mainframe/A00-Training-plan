000010******************************************************************
000020*         ＜海輝軟件(大連)＞                                     *
000030*      1. プログラム名  : 前受金受払残高ファイル作成             *
000040*      2. プログラムID  : AAASED25                               *
000050*      3. 処理概要      : 前受情報ＤＢをメインに、マスタと表結合 *
000060*                         して読込み前受金受払残高中間ファイルを *
000070*                         作成する。			       *
000080*      4. 作成者        : 白陽                                   *
000090*      5. 作成日        : 2005.03.28                             *
000100******************************************************************
000110*                                                                 
000120******************************************************************
000130*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000140******************************************************************
000150 IDENTIFICATION                       DIVISION.                   
000160*                                                                 
000170 PROGRAM-ID.                          AAASED25.                   
000180******************************************************************
000190*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000200******************************************************************
000210 ENVIRONMENT                          DIVISION.                   
000220*                                                                 
000230******************************************************************
000240*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000250******************************************************************
000260 INPUT-OUTPUT                         SECTION.                    
000270*                                                                 
000280 FILE-CONTROL.                                                    
000290     SELECT    出力ファイル           ASSIGN    TO     U11        
000300     FILE      STATUS     IS          Ｗ−状態                    
000310     ORGANIZATION         IS          LINE      SEQUENTIAL.       
000320*                                                                 
000330******************************************************************
000340*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000350******************************************************************
000360 DATA                                 DIVISION.                   
000370******************************************************************
000380*    ＦＩＬＥ                      ＳＥＣＴＩＯＮ                *
000390******************************************************************
000400 FILE                                 SECTION.                    
000410*----------------------------------------------------------------*
000420*    出力ファイル                                                *
000430*----------------------------------------------------------------*
000440 FD  出力ファイル                                                 
000450     LABEL     RECORD     IS          STANDARD                    
000460     BLOCK     CONTAINS   0           RECORDS.                    
000470*                                                                 
000480 01  出力−レコード.                                              
000490     COPY  CPSCE50     REPLACING      ==()==  BY  ==出力−==.     
000500******************************************************************
000510*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000520******************************************************************
000530  WORKING-STORAGE                     SECTION.                    
000540*----------------------------------------------------------------*
000550*    ホスト変数定義エリア                                        *
000560*----------------------------------------------------------------*
000570     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000580 01  ＷＳ−名称１                     PIC  X(60).                 
000590 01  ＷＳ−名称２                     PIC  X(60).                 
000600 01  ＷＳ−業務管理ＩＤ               PIC  X(08) VALUE 'GYMKNRRC'.
000610 01  ＷＳ−前受金受払残高表対象フラグ PIC  X(01) VALUE '1'.       
000620 01  ＷＳ−コードＮＯ１               PIC  X(12) VALUE '038'.     
000630 01  ＷＳ−コードＮＯ２               PIC  X(12) VALUE '005'.     
000640 01  ＷＳ−レコード区分               PIC  X(01) VALUE '1'.       
000650*                                                                 
000660*--< ＯＲＡＣＬＥ共通変数 >                                       
000670     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000680*                                                                 
000690*--< ＯＲＡＣＬＥ  ＳＱＬ実行情報 >                               
000700     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000710*                                                                 
000720*--< 前受情報ＤＢ >                                               
000730     EXEC  SQL  INCLUDE  M40MAB.CBL            END-EXEC.          
000740*                        		                                
000750*--< 業務管理テーブル >                                           
000760     EXEC  SQL  INCLUDE  D70GYM.CBL            END-EXEC.          
000770*                        		                                
000780*--< 取引先マスタ >                                               
000790     EXEC  SQL  INCLUDE  D01TRS.CBL            END-EXEC.          
000800*                                                                 
000810*--< 請求先マスタ >                                               
000820     EXEC  SQL  INCLUDE  D02SQS.CBL	     END-EXEC.          
000830*                                                                 
000840*--< 項目名称マスタ >                           	                
000850	   EXEC  SQL  INCLUDE  D19MSY.CBL	     END-EXEC.          
000860*                                                                 
000870*--< 債権情報（一般）ＤＢ >             	                        
000880	   EXEC  SQL  INCLUDE  M01SAJ.CBL	     END-EXEC.          
000890                                                                  
000900     EXEC  SQL  END  DECLARE          SECTION  END-EXEC.          
000910*                                                                 
000920*----------------------------------------------------------------*
000930*    ＷＯＲＫエリア                                              *
000940*----------------------------------------------------------------*
000950 01  ＷＯＲＫ−エリア.                                            
000960*--< エラー判定用 >                                               
000970     03  Ｗ−エラーコード             PIC  S9(04).                
000980     03  Ｗ−状態                     PIC  X(02).                 
000990*                                                                 
001000*--< フラグアリア >                                               
001010     03  フラグアリア.                                            
001020         05  Ｗ−終了−フラグ         PIC  X(01).                 
001030         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
001040*                                                                 
001050*--< 件数エリア >                                                 
001060     03  件数エリア.                                              
001070         05  Ｗ−入力−件数           PIC  9(09).                 
001080         05  Ｗ−出力−件数           PIC  9(09).                 
001090*                                                                 
001180*----------------------------------------------------------------*
001190*    サブルーチン名                                              *
001200*----------------------------------------------------------------*
001210 01  CALL-AREA.                                                   
001220*--< 共通ログサブルーチン >                                       
001230     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
001240     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
001250*                                                                 
001260*----------------------------------------------------------------*
001270*    ＣＯＰＹ領域                                                *
001280*----------------------------------------------------------------*
001290*--< 共通ログ用パラメータ >                                       
001300 01  IF-CHOCO001.                                                 
001310     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
001320*                                                                 
001330*----------------------------------------------------------------*
001340*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001350*----------------------------------------------------------------*
001360 01  PARA-AREA.                                                   
001370     COPY CPBCO001.                                               
001380******************************************************************
001390*    定数用データ定義エリア                                      *
001400******************************************************************
001410 CONSTANT                             SECTION.                    
001420 01  定数領域.                                                    
001430     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
001440     03  定数−プログラム名           PIC  X(80)                  
001450                               VALUE "前受金受払残高ファイル作成".
001460     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001470     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001480     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001490     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001500******************************************************************
001510*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001520******************************************************************
001530 PROCEDURE                            DIVISION.                   
001540*                                                                 
001550     PERFORM  初期処理.                                           
001560*                                                                 
001570     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001580*                                                                 
001590     PERFORM  終了処理.                                           
001600*                                                                 
001610     STOP     RUN.                                                
001620*                                                                 
001630******************************************************************
001640*    初期処理                                                    *
001650******************************************************************
001660 初期処理                             SECTION.                    
001670 初期処理−ＳＴＡＲＴ.                                            
001680*                                                                 
001690*----------------------------------------------------------------*
001700*    開始メッセージ出力処理                                      *
001710*----------------------------------------------------------------*
001720     INITIALIZE                       IF-CHOCO001.                
001730     MOVE  "3"                        TO  共１−イベント種別.     
001740     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001750     MOVE  "0"                        TO  共１−復帰コード.       
001760     MOVE  "START"                    TO  共１−処理識別.         
001770     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001780     CALL  CLOCO001                USING  IF-CHOCO001.            
001790*                                                                 
001800*----------------------------------------------------------------*
001810*    作業領域の初期値処理                                        *
001820*----------------------------------------------------------------*
001830     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001840     INITIALIZE                           ＷＯＲＫ−エリア.       
001850*                                                                 
001860*--< ＯＲＡＣＬＥ接続 >                                           
001870     PERFORM  ＯＲＡＣＬＥ接続.                                   
001880*--< ファイルオープン >                                           
001890     PERFORM  ファイルオープン.                                   
001900*                                                                 
001910*--< 結合テーブルカーソル定義 >                                   
001920     PERFORM  結合テーブルカーソル定義.                           
001930*                                                                 
001940*--< 結合テーブルカーソル読込(１件目) >                           
001950     PERFORM  結合テーブルカーソル読込.                           
001960*                                                                 
001970 初期処理−ＥＸＩＴ.                                              
001980     EXIT.                                                        
001990******************************************************************
002000*    ＯＲＡＣＬＥ接続                                            *
002010******************************************************************
002020 ＯＲＡＣＬＥ接続                     SECTION.                    
002030 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
002040*                                                                 
002050*--< ＤＢ接続用情報を取得処理 >                                   
002060     CALL  COBCO001                USING  PARA-AREA.              
002070*                                                                 
002080     MOVE  PARA-DBSTRING              TO  DB-STRING.              
002090     MOVE  PARA-USERNAME              TO  USERNAME.               
002100     MOVE  PARA-PASSWORD              TO  PASSWD.                 
002110*                                                                 
002120*----------------------------------------------------------------*
002130*    開始接続                                                    *
002140*----------------------------------------------------------------*
002150     IF    DB-STRING  =  SPACE                                    
002160        EXEC SQL                                                  
002170           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002180        END-EXEC                                                  
002190     ELSE                                                         
002200        EXEC SQL                                                  
002210           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002220             USING  :DB-STRING                                    
002230        END-EXEC                                                  
002240     END-IF.                                                      
002250*                                                                 
002260*----------------------------------------------------------------*
002270*    接続確認                                                    *
002280*----------------------------------------------------------------*
002290     EVALUATE  SQLCODE                                            
002300        WHEN   定数−ＳＱＬＯＫ                                   
002310           CONTINUE                                               
002320        WHEN   OTHER                                              
002330*--< 接続エラー >                                                 
002340           MOVE     -10               TO  Ｗ−エラーコード        
002350           PERFORM  エラー判定処理                                
002360     END-EVALUATE.                                                
002370*                                                                 
002380 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002390     EXIT.                                                        
002400******************************************************************
002410*      業務管理テーブル読込				       *
002420******************************************************************
002430 業務管理テーブル読込		    SECTION.                    
002440 業務管理テーブル読込−ＳＴＡＲＴ.                                
002450*                                                                 
002460*----------------------------------------------------------------*
002470*     業務管理テーブル読込                                       *
002480*----------------------------------------------------------------*
002490     EXEC SQL                                                     
002500        SELECT  バッチ用業務年月                                  
002510          INTO  :Ｄ７０−バッチ用業務年月                         
002520          FROM  D70GYM_TBL                                        
002530         WHERE  業務管理ＩＤ = :ＷＳ−業務管理ＩＤ                
002540	   END-EXEC.                                                    
002550*----------------------------------------------------------------*
002560*     業務管理テーブル検索を確認                                 *
002570*----------------------------------------------------------------*
002580 	   EVALUATE  SQLCODE                                            
002590         WHEN  定数−ＳＱＬＯＫ                                   
002600*--< 正常の時 >                                                   
002610         DISPLAY "業務年月  =  " Ｄ７０−バッチ用業務年月       
003020        WHEN  OTHER                                                                           
002630*--< 存在しない >                                                 
002640     MOVE -30       TO   Ｗ−エラーコード                         
002650     MOVE "Y"       TO   Ｗ−異常終了−フラグ                     
002660        PERFORM  エラー判定処理                                   
002670	   END-EVALUATE.				                
002680 業務管理テーブル読込−ＥＸＩＴ.                                  
002690      EXIT.                                                       
002700******************************************************************
002710*        結合テーブルカーソル定義                                *
002720******************************************************************
002730 結合テーブルカーソル定義             SECTION.                    
002740 結合テーブルカーソル定義−ＳＴＡＲＴ.                            
002750                                                                  
002760*----------------------------------------------------------------*
002770*    カーソル定義処理                                            *
002780*----------------------------------------------------------------*
002790     EXEC SQL                                                     
003200        DECLARE CUR1  CURSOR FOR                                  
003210           SELECT  M40MAB_TBL.レコード区分                        
003220                  ,M40MAB_TBL.経理用主契約区分                    
003230                  ,M40MAB_TBL.顧客区分                            
003240                  ,NVL(D01TRS_TBL.名寄せコード,RPAD(' ',40,' '))  
003250                  ,M40MAB_TBL.請求先取引先コード                  
003260                  ,M40MAB_TBL.請求先コード                        
003270                  ,M40MAB_TBL.契約番号                            
003280                  ,M40MAB_TBL.契約種類                            
003290                  ,M40MAB_TBL.担当部課コード                      
003300                  ,M40MAB_TBL.再リース回数                        
003310                  ,M40MAB_TBL.充当開始年月                        
003320                  ,M40MAB_TBL.充当月数                            
003330                  ,M40MAB_TBL.前払回収方法                        
003340                  ,M40MAB_TBL.入金日                              
003350                  ,M40MAB_TBL.入金区分                            
003360                  ,NVL(D01TRS_TBL.取引先名称,RPAD(' ',80,' '))    
003370                  ,NVL(D02SQS_TBL.請求先名称,RPAD(' ',80,' '))    
003380                  ,M40MAB_TBL.前月末残高                          
003390                  ,M40MAB_TBL.当月回収額                          
003400                  ,M40MAB_TBL.当月消化額                          
003410                  ,M40MAB_TBL.前月末残高他社                      
003420                  ,M40MAB_TBL.当月消化額他社                      
003430                  ,M40MAB_TBL.当月他社解約分料金                  
003440                  ,M40MAB_TBL.当月他社解約分消費税                
003450                  ,M40MAB_TBL.当月末残高他社                      
003460                  ,M40MAB_TBL.協調区分                            
003470                  ,M40MAB_TBL.当月末残高                          
003480                  ,M40MAB_TBL.当月回収額他社                      
003490                  ,M40MAB_TBL.仮受金入金日                        
003500                  ,M40MAB_TBL.仮受金ＳＥＱ＿ＮＯ                  
003510             FROM  M40MAB_TBL                                     
003520                  ,D01TRS_TBL                                     
003530                  ,D02SQS_TBL                                     
003540            WHERE  M40MAB_TBL.前受金受払残高表対象フラグ =  '1'   
003550              AND  M40MAB_TBL.請求先取引先コード =                
003560                                    D01TRS_TBL.取引先コード (+)   
003570              AND  M40MAB_TBL.請求先取引先コード =                
003580                                    D02SQS_TBL.取引先コード (+)   
003590              AND  M40MAB_TBL.請求先コード       =                
003600                                    D02SQS_TBL.請求先コード (+)   
003610         ORDER BY  M40MAB_TBL.レコード区分                        
003620                  ,M40MAB_TBL.契約番号                            
003630     END-EXEC.                                                                  
003160*                                                                 
003170*----------------------------------------------------------------*
003180*    カーソルＯＰＥＮ処理                                        *
003190*----------------------------------------------------------------*
003200     EXEC  SQL                                                    
003210        OPEN  CUR1                                                
003220     END-EXEC.                                                    
003230*                                                                 
003240*----------------------------------------------------------------*
003250*    カーソルＯＰＥＮ確認                                        *
003260*----------------------------------------------------------------*
003270     EVALUATE  SQLCODE                                            
003280        WHEN  定数−ＳＱＬＯＫ                                    
003290*--< 正常 >                                                       
003300           CONTINUE                                               
003310        WHEN  OTHER                                               
003320*--< カーソルＯＰＥＮエラー >                                     
003330           MOVE -20                   TO  Ｗ−エラーコード        
003340           PERFORM  エラー判定処理                                
003350     END-EVALUATE.                                                
003360*                                                                 
003370 結合テーブルカーソル定義−ＥＸＩＴ.                              
003380     EXIT.                                                        
003390******************************************************************
003400*    ファイルオープン                                            *
003410******************************************************************
003420 ファイルオープン                     SECTION.                    
003430 ファイルオープン−ＳＴＡＲＴ.                                    
003440*                                                                 
003450*----------------------------------------------------------------*
003460*    前受金受払残高中間ファイルのオープン                        *
003470*----------------------------------------------------------------*
003480     OPEN  OUTPUT   出力ファイル.                                 
003490*                                                                 
003500*--< ファイルオープンの状態判定 >                                 
003510     EVALUATE  Ｗ−状態                                           
003520        WHEN  ZERO                                                
003530           CONTINUE                                               
003540        WHEN  OTHER                                               
003550*--< ファイルオープンエラー >                                     
003560           MOVE     -40               TO  Ｗ−エラーコード        
003570           PERFORM  エラー判定処理                                
003580     END-EVALUATE.                                                
003590*                                                                 
003600 ファイルオープン−ＥＸＩＴ.                                      
003610     EXIT.                                                        
003620******************************************************************
003630*    結合テーブルカーソル読込                                    *
003640******************************************************************
003650 結合テーブルカーソル読込             SECTION.                    
003660 結合テーブルカーソル読込−ＳＴＡＲＴ.                            
003670*                                                                 
003680*--< 結合テーブルカーソル読込 >                                   
003690    EXEC SQL                                                     
004170         FETCH  CUR1                                              
004180          INTO   :Ｍ４０−レコード区分                            
004190                ,:Ｍ４０−経理用主契約区分                        
004200                ,:Ｍ４０−顧客区分                                
004210                ,:Ｄ０１−名寄せコード                            
004220                ,:Ｍ４０−請求先取引先コード                      
004230                ,:Ｍ４０−請求先コード                            
004240                ,:Ｍ４０−契約番号                                
004250                ,:Ｍ４０−契約種類                                
004260                ,:Ｍ４０−担当部課コード                          
004270                ,:Ｍ４０−再リース回数                            
004280                ,:Ｍ４０−充当開始年月                            
004290                ,:Ｍ４０−充当月数                                
004300                ,:Ｍ４０−前払回収方法                            
004310                ,:Ｍ４０−入金日                                  
004320                ,:Ｍ４０−入金区分                                
004330                ,:Ｄ０１−取引先名称                              
004340                ,:Ｄ０２−請求先名称                              
004350                ,:Ｍ４０−前月末残高                              
004360                ,:Ｍ４０−当月回収額                              
004370                ,:Ｍ４０−当月消化額                              
004380                ,:Ｍ４０−前月末残高他社                          
004390                ,:Ｍ４０−当月消化額他社                          
004400                ,:Ｍ４０−当月他社解約分料金                      
004410                ,:Ｍ４０−当月他社解約分消費税                    
004420                ,:Ｍ４０−当月末残高他社                          
004430                ,:Ｍ４０−協調区分                                
004440                ,:Ｍ４０−当月末残高                              
004450                ,:Ｍ４０−当月回収額他社                          
004460                ,:Ｍ４０−仮受金入金日                            
004470                ,:Ｍ４０−仮受金ＳＥＱ−ＮＯ                      
004480     END-EXEC.                                                    
004490*                                                        
003940*----------------------------------------------------------------*
003950*    結合テーブルカーソル読込を確認                              *
003960*----------------------------------------------------------------*
003970     EVALUATE   SQLCODE                                           
003980        WHEN   定数−ＳＱＬＯＫ                                   
003990*--< 正常 >                                                       
004000           COMPUTE  Ｗ−入力−件数  =  Ｗ−入力−件数  +  1       
004010        WHEN   定数−ＳＱＬＥＮＤ                                 
004020*--< 読込終了 >                                                   
004030           MOVE  "Y"                  TO  Ｗ−終了−フラグ        
004040        WHEN   OTHER                                              
004050*--< 読込エラー >                                                 
004060           MOVE     -30               TO  Ｗ−エラーコード        
004070           PERFORM  エラー判定処理                                
004080     END-EVALUATE.                                                
004090*                                                                 
004100 結合テーブルカーソル読込−ＥＸＩＴ.                              
004110     EXIT.                                                        
004120******************************************************************
004130*    主処理                                                      *
004140******************************************************************
004150 主処理                               SECTION.                    
004160 主処理−ＳＴＡＲＴ.                                              
004170*                                                                 
004180*------------ ---------------------------------------------------*
004190*     項目名称マスタより項目の抽出処理.                          *
004200*----------------------------------------------------------------*
004210     PERFORM  項目名称抽出処理.                                   
004220*                                                                 
004230*----------------------------------------------------------------*
004240*     債権情報ＤＢ項目の抽出処理                                 *
004250*----------------------------------------------------------------*
004260     PERFORM  債権情報ＤＢ項目の抽出処理.                         
004270*                                                                 
004280*----------------------------------------------------------------*
004290*     前受金受払残高中間ファイル出力判定処理                     *
004300*----------------------------------------------------------------*
004310     IF  Ｍ０１−担保区分  NOT = "1"                              
004320*--< 前受金受払残高中間ファイル項目編集、出力処理 >               
004330       PERFORM  前受金受払残高中間ファイル編集出力                
004340     END-IF.                                                      
004350*                                                                 
004360*--< 結合テーブルカーソル読込（２件目以降）>                      
004370     PERFORM  結合テーブルカーソル読込.                           
004380*                                                                 *                                                                 
004390 主処理−ＥＸＩＴ.                                                
004400     EXIT.                                                        
004410******************************************************************
004420*      項目名称マスタより項目の抽出処理.                         *
004430******************************************************************
004440 項目名称抽出処理                     SECTION.                    
004450 項目名称抽出処理−ＳＴＡＲＴ.                                    
004460*                                                                 
004470*----------------------------------------------------------------*
004480*      項目名称マスタより主契約区分名称の抽出処理	               *
004490*----------------------------------------------------------------*
004500      EXEC SQL                                                    
004510         SELECT  名称                                             
004520           INTO :ＷＳ−名称１                                     
004530           FROM  D19MSY_TBL                                       
004540          WHERE  コードＮＯ  = :ＷＳ−コードＮＯ１                
004550            AND  SUBSTR(コード,1,1) = :Ｍ４０−経理用主契約区分   
004560      END-EXEC.                                                   
004570*----------------------------------------------------------------*
004580*    項目名称抽出処理テーブル読込を確認                          *
004590*----------------------------------------------------------------*
004600      EVALUATE  SQLCODE                                           
004610          WHEN  定数−ＳＱＬＯＫ                                  
004620*--<  正常の時 >                                                  
004630         CONTINUE                                                 
004640       WHEN  OTHER                                                
004650*--<  存在しない >                                                
004660         MOVE      SPACE              TO  ＷＳ−名称１            
004670         MOVE      -30                TO  Ｗ−エラーコード        
004680         PERFORM   エラー判定処理                                 
004690       END-EVALUATE.                                              
004700*----------------------------------------------------------------*
004710*      項目名称マスタより顧客区分名称の抽出処理		       *
004720*----------------------------------------------------------------*
004730      EXEC SQL                                                    
004740         SELECT  名称                                             
004750           INTO :ＷＳ−名称２                                     
004760           FROM  D19MSY_TBL                                       
004770          WHERE  コードＮＯ = :ＷＳ−コードＮＯ２                 
004780            AND  SUBSTR(コード,1,2) = :Ｍ４０−顧客区分           
004790      END-EXEC.                                                   
004800*----------------------------------------------------------------*
004810*    項目名称顧客区分名称抽出処理テーブル読込を確認              *
004820*----------------------------------------------------------------*
004830      EVALUATE  SQLCODE                                           
004840          WHEN  定数−ＳＱＬＯＫ                                  
004850*--< 正常の時 >                                                   
004860         CONTINUE                                                 
004870       WHEN  OTHER                                                
004880*--< 存在しない >                                                 
004890         MOVE  SPACE                  TO    ＷＳ−名称２          
004900         MOVE  -30                    TO    Ｗ−エラーコード      
004910         PERFORM  エラー判定処理                                  
004920       END-EVALUATE.                                              
004930  項目名称抽出処理−ＥＸＩＴ.                                     
004940       EXIT.                                                      
004950******************************************************************
004960*       債権情報ＤＢ項目の抽出処理                               *
004970******************************************************************
004980 債権情報ＤＢ項目の抽出処理           SECTION.                    
004990 債権情報ＤＢ項目の抽出処理−ＳＴＡＲＴ.                          
005000*                                                                 
005010*----------------------------------------------------------------*
005020*     債権情報ＤＢの読込		                               *
005030*----------------------------------------------------------------*
005040      EXEC SQL                                                    
005050         SELECT  状態フラグ                                       
005060                ,債権契約件名                                     
005070                ,担保区分                                         
005080           INTO  Ｍ０１−状態フラグ                               
005090                ,Ｍ０１−債権契約件名                             
005100                ,Ｍ０１−担保区分                                 
005110           FROM  M01SAJ_TBL                                       
005120          WHERE  レコード区分 = :ＷＳ−レコード区分               
005130            AND  契約番号  =  :Ｍ４０−契約番号                   
005140            AND  再リース回数 = :Ｍ４０−再リース回数             
005150            AND  契約種類 = :Ｍ４０−契約種類                     
005160      END-EXEC.                                                   
005170*----------------------------------------------------------------*
005180*    債権情報ＤＢ検索を確認                                      *
005190*----------------------------------------------------------------*
005200      EVALUATE  SQLCODE                                           
005210          WHEN  定数−ＳＱＬＯＫ                                  
005220*--< 正常の時 >                                                   
005230         CONTINUE                                                 
005240       WHEN  OTHER                                                
005250*--< 存在しない >                                                 
005260         MOVE   SPACE                 TO    Ｍ０１−状態フラグ    
005270         MOVE   SPACE                 TO    Ｍ０１−債権契約件名  
005280         MOVE   SPACE                 TO    Ｍ０１−担保区分      
005290         MOVE   -30                   TO    Ｗ−エラーコード      
005300         PERFORM   エラー判定処理                                 
005310       END-EVALUATE.                                              
005320 債権情報ＤＢ項目の抽出処理−ＥＸＩＴ.                            
005330       EXIT.                                                      
005340******************************************************************
005350*      前受金受払残高中間ファイル項目編集、出力処理	       *
005360******************************************************************
005370 前受金受払残高中間ファイル編集出力   SECTION.                    
005380 前受金受払残高中間ファイル編集出力−ＳＴＡＲＴ.                  
005390*                                                                 
005400*--< 出力レコードの初期化処理 >                                   
005410     MOVE  SPACE                      TO  出力−レコード.         
005420     INITIALIZE                           出力−レコード.         
005430*--< 自社分個別の編集 >                                           
005440     PERFORM  自社分編集.                                         
005450*--< 自社分出力判定 >                                             
005460     IF      出力−前月末残高  NOT  =  0                          
005470         OR  出力−当月入金額  NOT  =  0                          
005480         OR  出力−当月消化額  NOT  =  0                          
005490         OR  出力−当月末残高  NOT  =  0                          
005500         PERFORM  前受金受払残高中間ファイル出力処理              
005510     END-IF.                                                      
005520*--< 他社分個別の編集 >                                           
005530     IF  Ｍ４０−協調区分 = "2"                                   
005540        PERFORM  他社分編集出力                                   
005550     END-IF.                                                      
005560*                                                                 
005570 前受金受払残高中間ファイル編集出力−ＥＸＩＴ.                    
005580     EXIT.                                                        
005590*                                                                 
005600******************************************************************
005610*     自社分編集                                  	       *
005620******************************************************************
005630 自社分編集                           SECTION.                    
005640 自社分編集−ＳＴＡＲＴ.                                          
005650*                                                                 
005660*--< No.01 >                                                      
005670     IF  Ｍ０１−状態フラグ < 3                                   
005680        MOVE  3                       TO    出力−自他社区分      
005690     ELSE                                                         
005700        MOVE  1                       TO    出力−自他社区分      
005710     END-IF.                                                      
005720*                                                                 
005730*--< No.02 >                                                      
005740     MOVE  Ｍ４０−レコード区分       TO    出力−前受区分.       
005750*                                                                 
005760*--< No.03 >                                                      
005770     MOVE  Ｍ４０−経理用主契約区分   TO    出力−主契約区分.	
005780*                                                                 
005790*--< No.04 >                                                      
005800     MOVE  Ｍ４０−顧客区分           TO    出力−連結区分.       
005810*                                                                 
005820*--< No.05 >                                                      
005830     MOVE  Ｄ０１−名寄せコード       TO    出力−名寄せコード.   
005840*                                                                 
005850*--< No.06 >                                                      
005860     MOVE  Ｍ４０−請求先取引先コード TO    出力−取引先コード.   
005870*                                                                 
005880*--< No.07 >                                                      
005890     MOVE  Ｍ４０−請求先コード       TO    出力−請求先コード.   
005900*                                                                 
005910*--< No.08 >                                                      
005920     MOVE  Ｍ４０−契約番号           TO    出力−契約番号.       
005930*                                                                 
005940*--< No.09 >                                                      
005950     MOVE  Ｍ４０−契約種類           TO    出力−契約種類.       
005960*                                                                 
005970*--< No.10 >                                                      
005980     MOVE  Ｄ７０−バッチ用業務年月   TO    出力−業務年月.       
005990*                                                                 
006000*--< No.11 >                                                      
006010     MOVE  Ｍ４０−担当部課コード     TO    出力−担当部課コード. 
006020*                                                                 
006030*--< No.12 >                                                      
006040     MOVE  Ｍ０１−債権契約件名       TO    出力−契約件名.       
006050*                                                                 
006060*--< No.13 >                                                      
006070     MOVE  Ｍ４０−再リース回数       TO    出力−再リース回数.   
006080*                                                                 
006090*--< No.14 >                                                      
006100     MOVE  Ｍ４０−充当開始年月       TO    出力−充当開始年月.   
006110*                                                                 
006120*--< No.15 >                                                      
006130     MOVE  Ｍ４０−充当月数           TO    出力−充当月数.       
006140*                                                                 
006150*--< No.16 >                                                      
006160     MOVE  Ｍ４０−前払回収方法       TO    出力−前払回収方法.   
006170*                                                                 
006180*--< No.17 >                                                      
006190     MOVE  Ｍ４０−入金日             TO    出力−入金日.         
006200*                                                                 
006210*--< No.18 >                                                      
006220     MOVE  Ｍ４０−入金区分           TO    出力−入金区分.       
006230*                                                                 
006240*--< No.19 >                                                      
006250     MOVE  Ｄ０１−取引先名称         TO    出力−取引先名称.     
006260*                                                                 
006270*--< No.20 >                                                      
006280     MOVE  Ｄ０２−請求先名称         TO    出力−請求先名称.     
006290*                                                                 
006300*--< No.21 >                                                      
006310     MOVE  ＷＳ−名称１               TO    出力−主契約区分名称. 
006320*                                                                 
006330*--< No.22 >                                                      
006340     MOVE  ＷＳ−名称２               TO    出力−連結区分名称.   
006350*                                                                 
006360*--< No.23 >                                                      
006370     MOVE  Ｍ４０−前月末残高         TO    出力−前月末残高.     
006380*                                                                 
006390*--< No.24 >                                                      
006400     MOVE  Ｍ４０−当月回収額         TO    出力−当月入金額.     
006410*                                                                 
006420*--< No.25 >                                                      
006430     MOVE  Ｍ４０−当月消化額         TO    出力−当月消化額.     
006440*                                                                 
006450*--< No.26 >                                                      
006460     MOVE  Ｍ４０−当月末残高         TO    出力−当月末残高.     
006470*                                                                 
006480*                                                                 
006490 自社分編集−ＥＸＩＴ.                                            
006500     EXIT.                                                        
006510******************************************************************
006520*    他社分個別部分の編集出力                                    *
006530******************************************************************
006540 他社分編集出力                       SECTION.                    
006550 他社分編集出力−ＳＴＡＲＴ.                                      
006560*                                                                 
006561*--<の初期化処理 >                                   
006562     MOVE  SPACE                      TO  出力−レコード.         
006563     INITIALIZE                           出力−レコード.         
006564
006570*--< 他社分編集 >                                                 
006580*--< No.01 >                                                      
006590     IF  Ｍ０１−状態フラグ < 3                                   
006600         MOVE  4                      TO    出力−自他社区分      
006610     ELSE                                                         
006620         MOVE  2                      TO    出力−自他社区分      
006630     END-IF.                                                      
006640*--< No.23 >                                                      
006650     MOVE  Ｍ４０−前月末残高         TO    出力−前月末残高.     
006660*                                                                 
006670*--< No.24 >                                                      
006680     MOVE  Ｍ４０−当月回収額         TO    出力−当月入金額.     
006690*                                                                 
006700*--< No.25 >                                                      
006710     COMPUTE   出力−当月消化額  =  Ｍ４０−当月消化額            
006720                                 +  Ｍ４０−当月他社解約分料金    
006730                                 +  Ｍ４０−当月他社解約分消費税. 
006740*                                                                 
006750*--< No.26 >                                                      
006760     COMPUTE   出力−当月末残高  =  Ｍ４０−当月末残高他社        
006770                                 -  Ｍ４０−当月他社解約分料金    
006780                                 -  Ｍ４０−当月他社解約分消費税. 
006790*--< 他社分出力判定 >                                             
006800     IF      出力−前月末残高  NOT  =  0                          
006810         OR  出力−当月入金額  NOT  =  0                          
006820         OR  出力−当月消化額  NOT  =  0                          
006830         OR  出力−当月末残高  NOT  =  0                          
006840         PERFORM  前受金受払残高中間ファイル出力処理              
006850     END-IF.                                                      
006860                                                                  
006870 他社分編集出力−ＥＸＩＴ.                                        
006880     EXIT.                                                        
006890******************************************************************
006900*    前受金受払残高中間ファイル出力処理                          *
006910******************************************************************
006920 前受金受払残高中間ファイル出力処理   SECTION.                    
006930 前受金受払残高中間ファイル出力処理−ＳＴＡＲＴ.                  
006940                                                                  
006950     WRITE  出力−レコード.                                       
006960*                                                                 
006970*--< 前受金受払残高中間ファイル出力の状態判定 >                   
006980     EVALUATE  Ｗ−状態                                           
006990        WHEN  ZERO                                                
007000*--< 前受金受払残高中間ファイル出力件数の加算 >                   
007010           COMPUTE  Ｗ−出力−件数 = Ｗ−出力−件数 + 1           
007020        WHEN  OTHER                                               
007030*--< ファイル出力エラー >                                         
007040           MOVE     -8                TO  Ｗ−エラーコード        
007050           PERFORM  エラー判定処理                                
007060     END-EVALUATE.                                                
007070*                                                                 
007080 前受金受払残高中間ファイル出力処理−ＥＸＩＴ.                    
007090     EXIT.                                                        
007100******************************************************************
007110*    終了処理                                                    *
007120******************************************************************
007130 終了処理                             SECTION.                    
007140 終了処理−ＳＴＡＲＴ.                                            
007150*                                                                 
007160*----------------------------------------------------------------*
007170*      ＤＢクローズ                                              *
007180*----------------------------------------------------------------*
007190     EXEC  SQL                                                    
007200        CLOSE  CUR1                                               
007210     END-EXEC.                                                    
007220*----------------------------------------------------------------*
007230*      ファイルクローズ                                          *
007240*----------------------------------------------------------------*
007250     CLOSE  出力ファイル                                          
007260*----------------------------------------------------------------*
007270*      件数メッセージ出力				               *
007280*----------------------------------------------------------------*
007290     PERFORM    件数メッセージ出力処理                            
007300*----------------------------------------------------------------*
007310*       終了メッセージ出力				       *
007320*----------------------------------------------------------------*
007330     PERFORM    終了メッセージ出力      				
007340*--< プログラム正常終了 >                                         
007350     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
007360*                                                                 
007370 終了処理−ＥＸＩＴ.                                              
007380     EXIT.                                                        
007390*                                                                 
007400******************************************************************
007410*    終了メッセージ出力                                          *
007420******************************************************************
007430 終了メッセージ出力                   SECTION.                    
007440 終了メッセージ出力−ＳＴＡＲＴ.                                  
007450*                                                                 
007460     INITIALIZE                       IF-CHOCO001.                
007470     MOVE  "3"                        TO  共１−イベント種別.     
007480     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007490     MOVE  "0"                        TO  共１−復帰コード.       
007500     MOVE  "END"                      TO  共１−処理識別.         
007510     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
007520     CALL  CLOCO001                USING  IF-CHOCO001.            
007530*                                                                 
007540 終了メッセージ出力−ＥＸＩＴ.                                    
007550     EXIT.                                                        
007560******************************************************************
007570*    件数メッセージ出力処理                                      *
007580******************************************************************
007590 件数メッセージ出力処理               SECTION.                    
007600 件数メッセージ出力処理−ＳＴＡＲＴ.                              
007610*                                                                 
007620     INITIALIZE                       IF-CHOCO001.                
007630     MOVE  "3"                        TO  共１−イベント種別.     
007640     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007650     MOVE  "0"                        TO  共１−復帰コード.       
007660     MOVE  "M40MAB"                   TO  共１−処理テーブルＩＤ. 
007670     MOVE  "COUNT"                    TO  共１−処理識別.         
007680     MOVE  Ｗ−入力−件数             TO  共１−データ内容.       
007690     MOVE  "前受情報ＤＢ入力件数"     TO  共１−その他メッセージ. 
007700     CALL  CLOCO001                USING  IF-CHOCO001.            
007710*                                                                 
007720     INITIALIZE                       IF-CHOCO001.                
007730     MOVE  "3"                        TO  共１−イベント種別.     
007740     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
007750     MOVE  "0"                        TO  共１−復帰コード.       
007760     MOVE  "SFHSED25"                 TO  共１−処理テーブルＩＤ. 
007770     MOVE  "COUNT"                    TO  共１−処理識別.         
007780     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
007790     MOVE "前受金受払残高中間ファイル"                            
007800                                      TO  共１−その他メッセージ. 
007810     CALL  CLOCO001                USING  IF-CHOCO001.            
007820*                                                                 
007830  件数メッセージ出力処理−ＥＸＩＴ.                               
007840     EXIT.                                                        
007850*                                                                 
007860******************************************************************
007870*    エラー処理                                                  *
007880******************************************************************
007890 エラー判定処理                       SECTION.                    
007900 エラー判定処理−ＳＴＡＲＴ.                                      
007910*                                                                 
007920     MOVE  "Y"                        TO Ｗ−異常終了−フラグ.    
007930     INITIALIZE                           IF-CHOCO001.            
007940*                                                                 
007950     EVALUATE  Ｗ−エラーコード                                   
007960        WHEN  -10                                                 
007970*--< ＯＲＡＣＬＥ接続失敗 >                                       
007980           MOVE  "1"                  TO  共１−イベント種別      
007990           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008000           MOVE  "9"                  TO  共１−復帰コード        
008010           MOVE  "CONNECT"            TO  共１−処理識別          
008020           MOVE  SQLCODE              TO  共１−データ内容        
008030           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008040           CALL  CLOCO001          USING  IF-CHOCO001             
008050*                                                                 
008060        WHEN  -20                                                 
008070*--< 業務管理テーブルオープンエラー >                             
008080           MOVE  "1"                  TO  共１−イベント種別      
008090           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008100           MOVE  "9"                  TO  共１−復帰コード        
008110           MOVE  "D70GYM"             TO  共１−処理テーブルＩＤ  
008120           MOVE  "OPEN"               TO  共１−処理識別          
008130           MOVE  SQLCODE              TO  共１−データ内容        
008140           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008150           CALL  CLOCO001          USING  IF-CHOCO001             
008160*                                                                 
008170        WHEN  -30                                                 
008180*--< 結合テーブルカーソルオープン失敗 >                           
008190           MOVE  "1"                  TO  共１−イベント種別      
008200           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008210           MOVE  "9"                  TO  共１−復帰コード        
008220           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
008230           MOVE  "OPEN"               TO  共１−処理識別          
008240           MOVE  SQLCODE              TO  共１−データ内容        
008250           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008260           CALL  CLOCO001          USING  IF-CHOCO001             
008270*                                                                 
008280        WHEN  -40                                                 
008290*--< 前受金受払残高中間ファイルオープンエラー >                   
008300           MOVE  "1"                  TO  共１−イベント種別      
008310           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008320           MOVE  "9"                  TO  共１−復帰コード        
008330           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
008340           MOVE  "OPEN"               TO  共１−処理識別          
008350           MOVE  SQLCODE              TO  共１−データ内容        
008360           MOVE  "前受金受払残高中間ファイルオープンエラー"       
008370                                      TO  共１−その他メッセージ  
008380           CALL  CLOCO001          USING  IF-CHOCO001             
008390*                                                                 
008400        WHEN  -50                                                 
008410*--< 結合テーブル読込失敗 >                                       
008420           MOVE  "1"                  TO  共１−イベント種別      
008430           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008440           MOVE  "9"                  TO  共１−復帰コード        
008450           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
008460           MOVE  "FETCH"              TO  共１−処理識別          
008470           MOVE  SQLCODE              TO  共１−データ内容        
008480           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008490           CALL  CLOCO001          USING  IF-CHOCO001             
008500*                                                                 
008510        WHEN  -60                                                 
008520*--< 項目名称マスタオープンエラー >                               
008530           MOVE  "1"                  TO  共１−イベント種別      
008540           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008550           MOVE  "9"                  TO  共１−復帰コード        
008560           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
008570           MOVE  "OPEN"               TO  共１−処理識別          
008580           MOVE  SQLCODE              TO  共１−データ内容        
008590           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008600           CALL  CLOCO001          USING  IF-CHOCO001
                 MOVE  "N"                  TO  Ｗ−異常終了−フラグ
008610*                                                                 
008620        WHEN  -70                                                 
008630*--< 債権情報（一般）ＤＢオープンエラー >                         
008640           MOVE  "1"                  TO  共１−イベント種別      
008650           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008660           MOVE  "9"                  TO  共１−復帰コード        
008670           MOVE  "D01SAJ"             TO  共１−処理テーブルＩＤ  
008680           MOVE  "OPEN"               TO  共１−処理識別          
008690           MOVE  SQLCODE              TO  共１−データ内容        
008700           MOVE  SQLERRMC             TO  共１−その他メッセージ  
008710           CALL  CLOCO001          USING  IF-CHOCO001  
            
008720        WHEN  -80                                                 
008730*--< 前受金受払残高中間ファイル出力エラー >                       
008740           MOVE  "1"                  TO  共１−イベント種別      
008750           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
008760           MOVE  "9"                  TO  共１−復帰コード        
008770           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
008780           MOVE  "WRITE"              TO  共１−処理識別          
008790           MOVE  SQLCODE              TO  共１−データ内容        
008800           MOVE  "前受金受払残高中間ファイル出力エラー "          
008810                                      TO  共１−その他メッセージ  
008820           CALL  CLOCO001          USING  IF-CHOCO001             
008830*                                                                 
008840        WHEN  OTHER                                               
008850           MOVE  "N"                  TO  Ｗ−異常終了−フラグ    
008860     END-EVALUATE.                                                
008870*                                                                 
008880     IF  Ｗ−異常終了−フラグ  =  "Y"                             
008890        PERFORM  終了メッセージ出力                               
008900                THRU  件数メッセージ出力処理                      
008910*                                                                 
008920*--< プログラム異常終了のリターンコード >                         
008930        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
008940*                                                                 
008950        EXIT  PROGRAM                                             
008960     END-IF.                                                      
008970*                                                                 
008980 エラー判定処理−ＥＸＩＴ.                                        
008990     EXIT.                                                        
009000******************************************************************
009010*                  END OF PROGRAM                                *
009020******************************************************************
