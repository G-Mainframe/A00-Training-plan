000010******************************************************************
000020*         ＜海輝軟件(大連)＞                                     *
000030*      1. プログラム名    ：前受金受払残高ファイル作成           *
000040*      2. プログラムID    ：AAASED25  (抽出)                     *
000050*      3. 処理概要        ：前受情報ＤＢをメインに、             *
000060*                           マスタと表結合して読込み、           *
000070*                          前受金受払残高中間ファイルを作成する。*
000080*      4. 作成者          ：劉  忻                               *
000090*      5. 作成日          ：2005.03.25                           *
000100******************************************************************
000110*                                                                 
000120******************************************************************
000130*    ＩＤＥＮＴＩＦＩＣＡＴＩＯＮ  ＤＩＶＩＳＩＯＮ              *
000140******************************************************************
000150 IDENTIFICATION                       DIVISION.                   
000160*                                                                 
000170 PROGRAM-ID.                          AAASED25.                   
000180******************************************************************
000190*    ＥＮＶＩＲＯＮＭＥＮＴ        ＤＩＶＩＳＩＯＮ              *
000200******************************************************************
000210 ENVIRONMENT                          DIVISION.                   
000220******************************************************************
000230*    ＩＮＰＵＴ−ＯＵＴＰＵＴ      ＳＥＣＴＩＯＮ                *
000240******************************************************************
000250 INPUT-OUTPUT                         SECTION.                    
000260 FILE-CONTROL.                                                    
000270*                                                                 
000280     SELECT         出力ファイル      ASSIGN    TO   U11          
000290     FILE STATUS    IS     Ｗ−状態                               
000300     ORGANIZATION   IS     LINE       SEQUENTIAL.                 
000310*                                                                 
000320******************************************************************
000330*    ＤＡＴＡ                      ＤＩＶＩＳＩＯＮ              *
000340******************************************************************
000350 DATA                                 DIVISION.                   
000360******************************************************************
000370*    ＦＩＬＥ                      ＳＥＣＴＩＯＮ                *
000380******************************************************************
000390 FILE                                 SECTION.                    
000400*----------------------------------------------------------------*
000410*    出力ファイル                                                *
000420*----------------------------------------------------------------*
000430 FD  出力ファイル                                                 
000440     LABEL  RECORD    IS              STANDARD                    
000450     BLOCK  CONTAINS  0               RECORDS.                    
000460*                                                                 
000470 01  出力−レコード.                                              
000480     COPY   CPSCE50   REPLACING      ==()==  BY  ==出力−==.      
000490*                                                                 
000500******************************************************************
000510*  ＷＯＲＫＩＮＧ−ＳＴＯＲＡＧＥ  ＳＥＣＴＩＯＮ                *
000520******************************************************************
000530 WORKING-STORAGE                      SECTION.                    
000540*----------------------------------------------------------------*
000550*    ホスト変数定義エリア                                        *
000560*----------------------------------------------------------------*
000570     EXEC  SQL  BEGIN  DECLARE        SECTION  END-EXEC.          
000580*                                                                 
000590*--< ＯＲＡＣＬＥ共通変数 >                                       
000600     EXEC  SQL  INCLUDE  SQLCOM.CBL            END-EXEC.          
000610*	                                                            
000620*--< 前受情報ＤＢ >                                               
000630     EXEC  SQL  INCLUDE  M40MAB.CBL            END-EXEC.          
000640*                                                                 
000650*--< 業務管理テーブル >                                           
000660     EXEC  SQL  INCLUDE  D70GYM.CBL            END-EXEC.          
000670*                                                                 
000680*--< 取引先マスタ >                                               
000690     EXEC  SQL  INCLUDE  D01TRS.CBL            END-EXEC.          
000700*                                                                 
000710*--< 請求先マスタ >                                               
000720     EXEC  SQL  INCLUDE  D02SQS.CBL            END-EXEC.          
000730*                                                                 
000740*--< 項目名称マスタ >                                             
000750     EXEC  SQL  INCLUDE  D19MSY.CBL            END-EXEC.          
000760*                                                                 
000770*--< 債権情報（一般）ＤＢ >                                       
000780     EXEC  SQL  INCLUDE  M01SAJ.CBL            END-EXEC.          
000790*                                                                 
000800*--< ＯＲＡＣＬＥ ＳＱＬ実行情報 (SQLCA) >                        
000810     EXEC  SQL  INCLUDE  SQLCA.COB             END-EXEC.          
000820*                                                                 
000830 01  項目名称マスタ名称.                                          
000840*--< 項目名称マスタ名称 >	                                    
000850	   03  WS-NAME1                     PIC  X(60).             
000860	   03  WS-NAME2                     PIC  X(60).             
000870*                                                                 
000880 01  Ｗ−業務管理ＩＤ   PIC   X(08)   VALUE  'GYMKNRRC'.          
000890 01  Ｗ−コードＮＯ１   PIC   X(12)   VALUE  '038'.               
000900 01  Ｗ−コードＮＯ２   PIC   X(12)   VALUE  '005'.               
000910*                                                                 
000920     EXEC  SQL  END      DECLARE      SECTION  END-EXEC.          
000930*                                                                 
000940*----------------------------------------------------------------*
000950*    ＷＯＲＫエリア                                              *
000960*----------------------------------------------------------------*
000970 01  ＷＯＲＫ−エリア.                                            
000980*--< 他社分エリア >                                               
000990     03  他社分エリア.                                            
001000         05  Ｗ−当月消化額１         PIC S9(13).                 
001010         05  Ｗ−当月末残高１         PIC S9(13).                 
001020*                                                                 
001030*--< エラー判定用 >                                               
001040     03  Ｗ−エラーコード             PIC S9(04).                 
001050*                                                                 
001060*--< ファイル状態 >                                               
001070     03  Ｗ−状態エリア.                                          
001080         05  Ｗ−状態                 PIC  X(02).                 
001090*                                                                 
001100*--< フラグアリア >                                               
001110     03  フラグアリア.                                            
001120         05  Ｗ−終了−フラグ         PIC  X(01).                 
001130         05  Ｗ−異常終了−フラグ     PIC  X(01).                 
001140*                                                                 
001150*--< 件数エリア >                                                 
001160     03  件数エリア.                                              
001170         05  Ｗ−入力−件数           PIC  9(09).                 
001180         05  Ｗ−出力−件数           PIC  9(09).                 
001190*                                                                 
001200*----------------------------------------------------------------*
001210*    サブルーチン名                                              *
001220*----------------------------------------------------------------*
001230 01  CALL-AREA.                                                   
001240*--< 共通ログサブルーチン >                                       
001250     03  CLOCO001                     PIC  X(08) VALUE "CLOCO001".
001260     03  COBCO001                     PIC  X(08) VALUE "COBCO001".
001270*                                                                 
001280*----------------------------------------------------------------*
001290*    ＣＯＰＹ領域                                                *
001300*----------------------------------------------------------------*
001310*--< 共通ログ用パラメータ >                                       
001320 01  IF-CHOCO001.                                                 
001330     COPY  CHOCO001  REPLACING  ==()==  BY  ==共１−==.           
001340*                                                                 
001350*----------------------------------------------------------------*
001360*    ＩＮＩファイル読込サブルーチン用パラメタ領域                *
001370*----------------------------------------------------------------*
001380 01  PARA-AREA.                                                   
001390     COPY CPBCO001.                                               
001400******************************************************************
001410*    定数用データ定義エリア                                      *
001420******************************************************************
001430 CONSTANT                             SECTION.                    
001440 01  定数領域.                                                    
001450     03  定数−プログラムＩＤ         PIC  X(08) VALUE "AAASED25".
001460     03  定数−プログラム名           PIC  X(80)                  
001470                              VALUE  "前受金受払残高ファイル作成".
001480     03  定数−ＳＱＬＯＫ             PIC S9(04)  VALUE  ZERO.    
001490     03  定数−ＳＱＬＥＮＤ           PIC S9(04)  VALUE  0100.    
001500     03  定数−正常状態               PIC S9(04)  VALUE  ZERO.    
001510     03  定数−異常状態               PIC S9(04)  VALUE  0009.    
001520******************************************************************
001530*    ＰＲＯＣＥＤＵＲＥ            ＤＩＶＩＳＩＯＮ              *
001540******************************************************************
001550 PROCEDURE                            DIVISION.                   
001560*                                                                 
001570     PERFORM  初期処理.                                           
001580*                                                                 
001590     PERFORM  主処理  UNTIL  Ｗ−終了−フラグ  =  "Y".            
001600*                                                                 
001610     PERFORM  終了処理.                                           
001620*                                                                 
001630     STOP     RUN.                                                
001640*                                                                 
001650******************************************************************
001660*    初期処理                                        <1.0>       *
001670******************************************************************
001680 初期処理                             SECTION.                    
001690 初期処理−ＳＴＡＲＴ.                                            
001700*                                                                 
001710*----------------------------------------------------------------*
001720*    開始メッセージ出力処理                          <1.1>       *
001730*----------------------------------------------------------------*
001740     INITIALIZE                       IF-CHOCO001.                
001750     MOVE  "3"                        TO  共１−イベント種別.     
001760     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
001770     MOVE  "0"                        TO  共１−復帰コード.       
001780     MOVE  "START"                    TO  共１−処理識別.         
001790     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
001800     CALL  CLOCO001                USING  IF-CHOCO001.            
001810*                                                                 
001820*----------------------------------------------------------------*
001830*    作業領域の初期値処理                            <1.2>       *
001840*----------------------------------------------------------------*
001850     MOVE  SPACE                      TO  ＷＯＲＫ−エリア.       
001860     INITIALIZE                           ＷＯＲＫ−エリア.       
001870*                                                                 
001880*--< ＯＲＡＣＬＥ接続 >                                           
001890     PERFORM   ＯＲＡＣＬＥ接続.                                  
001900*                                                                 
001910*--< 業務管理テーブル読込 >                                       
001920     PERFORM   業務管理読込.                              
001930*                                                                 
001940*--< 結合テーブルカーソル宣言>
001950     PERFORM  結合カーソル宣言.                                   
001960*
001970*--< ファイルオープン>
001980     PERFORM  ファイルオープン.                                   
001990*
002000*--< 結合テーブル読込（１件目） >
002010     PERFORM  結合テーブル読込.                                   
002020*                                                                 
002030 初期処理−ＥＸＩＴ.                                              
002040     EXIT.                                                        
002050******************************************************************
002060*    ＯＲＡＣＬＥ接続                                    <1.3>   *
002070******************************************************************
002080 ＯＲＡＣＬＥ接続                     SECTION.                    
002090 ＯＲＡＣＬＥ接続−ＳＴＡＲＴ.                                    
002100*
002110*--< ＤＢ接続用情報を取得処理 >
002120     CALL  COBCO001                USING  PARA-AREA.              
002130*
002140     MOVE  PARA-DBSTRING              TO  DB-STRING.              
002150     MOVE  PARA-USERNAME              TO  USERNAME.               
002160     MOVE  PARA-PASSWORD              TO  PASSWD.                 
002170*
002180*----------------------------------------------------------------*
002190*    開始接続                                                    *
002200*----------------------------------------------------------------*
002210     IF    DB-STRING  =  SPACE                                    
002220        EXEC SQL                                                  
002230           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002240        END-EXEC                                                  
002250     ELSE                                                         
002260        EXEC SQL                                                  
002270           CONNECT  :USERNAME IDENTIFIED BY :PASSWD               
002280             USING  :DB-STRING                                    
002290        END-EXEC                                                  
002300     END-IF.                                                      
002310*
002320*----------------------------------------------------------------*
002330*    接続確認                                                    *
002340*----------------------------------------------------------------*
002350     EVALUATE  SQLCODE                                            
002360        WHEN   定数−ＳＱＬＯＫ                                   
002370           CONTINUE                                               
002380        WHEN   OTHER                                              
002390*--<       接続エラー >                                           
002400           MOVE     -10               TO  Ｗ−エラーコード        
002410               PERFORM  エラー処理                                
002420     END-EVALUATE.                                                
002430*                                                                 
002440 ＯＲＡＣＬＥ接続−ＥＸＩＴ.                                      
002450     EXIT.                                                        
002460******************************************************************
002470*    業務管理テーブル読込                                <1.4>   *
002480******************************************************************
002490*                                                                 
002500 業務管理読込                         SECTION.                    
002510 業務管理読込−ＳＴＡＲＴ.                                
002520*                                                                 
002530*----------------------------------------------------------------*
002540*    業務管理テーブル読込                                        *
002550*----------------------------------------------------------------*
002560     EXEC SQL                                                     
002570        SELECT  バッチ用業務年月, 業務年月                                  
002580          INTO :Ｄ７０−バッチ用業務年月
002590              , Ｄ７０−業務年月                          
002600          FROM  D70GYM_TBL                                        
002610         WHERE  業務管理ＩＤ  =  :Ｗ−業務管理ＩＤ                
002620     END-EXEC.                                                    
002630*----------------------------------------------------------------*
002640*    業務管理テーブル読込確認                                    *
002650*----------------------------------------------------------------*
002660     EVALUATE   SQLCODE                                           
002670        WHEN   定数−ＳＱＬＯＫ                                   
002680*--<       正常 >                                                 
002690           DISPLAY   "業務年月 = " , Ｄ７０−業務年月
002700        WHEN   OTHER                                              
002710*--<       業務管理テーブル読込失敗、プログラムが異常終了 >
002720           MOVE      -20              TO  Ｗ−エラーコード        
002730           PERFORM   エラー処理                                   
002740     END-EVALUATE.                                                
002750*
002760 業務管理読込−ＥＸＩＴ.                                  
002770     EXIT.                                                        
002780******************************************************************
002790*    結合カーソル宣言                                <1.5>       *
002800******************************************************************
002810*
002820 結合カーソル宣言                     SECTION.                
002830 結合カーソル宣言−ＳＴＡＲＴ.                                    
002840*
002850*----------------------------------------------------------------*
002860*    結合カーソル宣言                                            *
002870*----------------------------------------------------------------*
002880     EXEC  SQL                                                    
002890        DECLARE   CUR1       CURSOR  FOR                          
002900           SELECT  M40MAB_TBL.レコード区分                        
002910                  ,M40MAB_TBL.経理用主契約区分                    
002920                  ,M40MAB_TBL.顧客区分                            
002930                  ,NVL(D01TRS_TBL.名寄せコード,RPAD(' ',40,' '))  
002940                  ,M40MAB_TBL.請求先取引先コード                  
002950                  ,M40MAB_TBL.請求先コード                        
002960                  ,M40MAB_TBL.契約番号                            
002970                  ,M40MAB_TBL.契約種類                            
002980                  ,M40MAB_TBL.担当部課コード                      
002990                  ,M40MAB_TBL.再リース回数                        
003000                  ,M40MAB_TBL.充当開始年月                        
003010			,M40MAB_TBL.充当月数                            
003020			,M40MAB_TBL.前払回収方法                        
003030			,M40MAB_TBL.入金日                              
003040			,M40MAB_TBL.入金区分                            
003050			,NVL(D01TRS_TBL.取引先名称,RPAD(' ',80,' '))    
003060			,NVL(D02SQS_TBL.請求先名称,RPAD(' ',80,' '))    
003070			,M40MAB_TBL.前月末残高                          
003080			,M40MAB_TBL.当月回収額                          
003090			,M40MAB_TBL.当月消化額                          
003100			,M40MAB_TBL.当月末残高                          
003110			,M40MAB_TBL.協調区分                            
003120		        ,M40MAB_TBL.前月末残高他社                    
003130		        ,M40MAB_TBL.当月回収額他社                    
003140		        ,M40MAB_TBL.当月消化額他社                    
003150		        ,M40MAB_TBL.当月他社解約分料金                
003160		        ,M40MAB_TBL.当月他社解約分消費税              
003170			,M40MAB_TBL.当月末残高他社                      
003180             FROM  M40MAB_TBL                                     
003190                  ,D01TRS_TBL                                     
003200			,D02SQS_TBL                                     
003210            WHERE  M40MAB_TBL.前受金受払残高表対象フラグ = '1'    
003220              AND  M40MAB_TBL.請求先取引先コード =                
003230					D01TRS_TBL.取引先コード (+)     
003240		    AND  M40MAB_TBL.請求先取引先コード =              
003250					D02SQS_TBL.取引先コード (+)      
003260		    AND  M40MAB_TBL.請求先コード =                    
003270					D02SQS_TBL.請求先コード (+)      
003280	       ORDER BY  M40MAB_TBL.レコード区分                    
003290	                ,M40MAB_TBL.契約番号                        
003300     END-EXEC.                                                    
003310*
003320*----------------------------------------------------------------*
003330*    結合テーブルカーソルオープン                                *
003340*----------------------------------------------------------------*
003350     EXEC  SQL                                                    
003360        OPEN  CUR1                                                
003370     END-EXEC.                                                    
003380*
003390*----------------------------------------------------------------*
003400*    結合テーブルカーソルオープンを確認                          *
003410*----------------------------------------------------------------*
003420     EVALUATE   SQLCODE                                           
003430        WHEN   定数−ＳＱＬＯＫ                                   
003440*--<       正常 >
003450           CONTINUE                                               
003460        WHEN   OTHER                                              
003470*--<       結合テーブルカーソルオープン失敗 >
003480           MOVE      -30              TO  Ｗ−エラーコード        
003490           PERFORM   エラー処理                                   
003500     END-EVALUATE.                                                
003510*
003520 結合カーソル宣言−ＥＸＩＴ.                                      
003530     EXIT.                                                        
003540******************************************************************
003550*    ファイルオープン                                <1.6>       *
003560******************************************************************
003570 ファイルオープン                     SECTION.                    
003580 ファイルオープン−ＳＴＡＲＴ.                                    
003590*----------------------------------------------------------------*
003600*    前受金受払残高中間ファイルのオープン                        *
003610*----------------------------------------------------------------*
003620     OPEN  OUTPUT   出力ファイル.                                 
003630*
003640*--< ファイルオープンの状態判定 >
003650     EVALUATE  Ｗ−状態                                           
003660        WHEN  ZERO                                                
003670           CONTINUE                                               
003680        WHEN  OTHER                                               
003690*--<       ファイルオープンエラー >
003700           MOVE     -90               TO  Ｗ−エラーコード        
003710           PERFORM  エラー処理                                    
003720     END-EVALUATE.                                                
003730*
003740 ファイルオープン−ＥＸＩＴ.                                      
003750     EXIT.                                                        
003760******************************************************************
003770*    結合テーブル読込                                <1.7>       *
003780******************************************************************
003790 結合テーブル読込                     SECTION.                    
003800 結合テーブル読込−ＳＴＡＲＴ.                                    
003810*
003820     EXEC  SQL                                                    
003830        FETCH  CUR1                                               
003840           INTO                                                   
003850             :Ｍ４０−レコード区分                                
003860            ,:Ｍ４０−経理用主契約区分                            
003870            ,:Ｍ４０−顧客区分                                    
003880            ,:Ｄ０１−名寄せコード                                
003890            ,:Ｍ４０−請求先取引先コード                          
003900            ,:Ｍ４０−請求先コード                                
003910            ,:Ｍ４０−契約番号                                    
003920            ,:Ｍ４０−契約種類                                    
003930            ,:Ｍ４０−担当部課コード                              
003940        	  ,:Ｍ４０−再リース回数                              
003950	   	  ,:Ｍ４０−充当開始年月                              
003960		  ,:Ｍ４０−充当月数                                  
003970		  ,:Ｍ４０−前払回収方法                              
003980		  ,:Ｍ４０−入金日                                    
003990		  ,:Ｍ４０−入金区分                                  
004000		  ,:Ｄ０１−取引先名称                                
004010		  ,:Ｄ０２−請求先名称                                
004020		  ,:Ｍ４０−前月末残高                                
004030		  ,:Ｍ４０−当月回収額                                
004040		  ,:Ｍ４０−当月消化額                                
004050		  ,:Ｍ４０−当月末残高                                
004060		  ,:Ｍ４０−協調区分                                  
004070		  ,:Ｍ４０−前月末残高他社                            
004080		  ,:Ｍ４０−当月回収額他社                            
004090		  ,:Ｍ４０−当月消化額他社                            
004100		  ,:Ｍ４０−当月他社解約分料金                        
004110		  ,:Ｍ４０−当月他社解約分消費税                      
004120		  ,:Ｍ４０−当月末残高他社                            
004130     END-EXEC.                                                    
004140*
004150*----------------------------------------------------------------*
004160*    結合テーブル読込確認                                        *
004170*----------------------------------------------------------------*
004180     EVALUATE  SQLCODE                                            
004190        WHEN  定数−ＳＱＬＯＫ                                    
004200*--<       正常 >                                                 
004210           COMPUTE   Ｗ−入力−件数 =  Ｗ−入力−件数 +  1        
004220        WHEN  定数−ＳＱＬＥＮＤ                                  
004230*--<       読込終了 >                                             
004240           MOVE      "Y"              TO  Ｗ−終了−フラグ        
004250        WHEN  OTHER                                               
004260*--<       読込エラー >                                           
004270           MOVE      -40              TO  Ｗ−エラーコード        
004280           PERFORM   エラー処理                                   
004290     END-EVALUATE.                                                
004300*                                                                 
004310 結合テーブル読込−ＥＸＩＴ.                                      
004320     EXIT.                   
004330******************************************************************
004340*    主処理                                          <2.0>       *
004350******************************************************************
004360 主処理                               SECTION.                    
004370 主処理−ＳＴＡＲＴ.                                              
004380* 
004390*--< 項目名称マスタより項目の抽出処理 >			
004400     PERFORM  項目名称抽出処理.                             
004410*
004420*--< 債権情報（一般）ＤＢより項目の抽出処理 >			
004430     PERFORM  債権情報抽出処理.                                   
004440*
004450*--< 前受金受払残高中間ファイル出力判定処理>
004460     PERFORM  出力判定.
004470*
004510*--< 結合テーブル読込（２件目以降）>
004520     PERFORM  結合テーブル読込.                                   
004530*
004540 主処理−ＥＸＩＴ.                                                
004550     EXIT.           
004560*
004570******************************************************************
004580*    項目名称マスタより項目の抽出処理                <2.1>       *
004590******************************************************************
004600*
004610 項目名称抽出処理                     SECTION.              
004620 項目名称抽出処理−ＳＴＡＲＴ.                              
004630*
004640*--< 項目名称マスタより主契約区分名称の抽出処理>
004650     PERFORM   主契約区分抽出処理.                       
004660*
004670*--< 項目名称マスタより顧客区分名称の抽出処理>
004680     PERFORM   顧客区分抽出処理.    
004690*
004700 項目名称抽出処理−ＥＸＩＴ.                                
004710     EXIT.   
004720******************************************************************
004730*    主契約区分名称の抽出処理                        <2.1.1>     *
004740******************************************************************
004750*
004760 主契約区分抽出処理                   SECTION.                  
004770 主契約区分抽出処理−ＳＴＡＲＴ.                            
004780*
004790*----------------------------------------------------------------*
004800*   主契約区分名称の抽出処理                                     *
004810*----------------------------------------------------------------*
004820     EXEC SQL                                                     
004830        SELECT  名称                                              
004840          INTO :WS-NAME1                                          
004850          FROM  D19MSY_TBL                                        
004860        WHERE   D19MSY_TBL.コードＮＯ  =  :Ｗ−コードＮＯ１       
004870          AND   SUBSTR(D19MSY_TBL.コード,1,1) = 
004880                                      :Ｍ４０−経理用主契約区分   
004890     END-EXEC.                                                    
004900*----------------------------------------------------------------*
004910*    主契約区分名称の抽出処理確認                                *
004920*----------------------------------------------------------------*
004930     EVALUATE   SQLCODE                                           
004940        WHEN   定数−ＳＱＬＯＫ                                   
004950*--<       正常 >
004960           CONTINUE                                               
004970        WHEN   OTHER                                              
004980*--<       主契約区分名称の抽出処理失敗>
004990           MOVE      -50              TO  Ｗ−エラーコード        
005000           PERFORM   エラー処理                                   
005010           MOVE      ZERO             TO  WS-NAME1                
005020     END-EVALUATE.                                                
005030*
005040 主契約区分抽出処理−ＥＸＩＴ.                              
005050     EXIT.                           
005060*
005070******************************************************************
005080*    顧客区分名称の抽出処理                          <2.1.2>     *
005090******************************************************************
005100*
005110 顧客区分抽出処理                     SECTION.                    
005120 顧客区分抽出処理−ＳＴＡＲＴ.                              
005130*
005140*----------------------------------------------------------------*
005150*   顧客区分名称の抽出処理                                       *
005160*----------------------------------------------------------------*
005170     EXEC SQL                                                     
005180        SELECT  名称                                              
005190          INTO :WS-NAME2                                          
005200          FROM  D19MSY_TBL                                        
005210         WHERE  D19MSY_TBL.コードＮＯ  =  :Ｗ−コードＮＯ２       
005220          AND   SUBSTR(D19MSY_TBL.コード,1,2)  = :Ｍ４０−顧客区分
005230     END-EXEC.                                                    
005240*----------------------------------------------------------------*
005250*    顧客区分名称の抽出処理確認                                  *
005260*----------------------------------------------------------------*
005270     EVALUATE   SQLCODE                                           
005280        WHEN   定数−ＳＱＬＯＫ                                   
005290*--<       正常 >
005300           CONTINUE                                               
005310        WHEN   OTHER                                              
005320*--<       顧客区分名称の抽出処理失敗>
005330           MOVE      -60              TO  Ｗ−エラーコード        
005340           PERFORM   エラー処理                                   
005350           MOVE      ZERO             TO  WS-NAME2                
005360     END-EVALUATE.                                                
005370*
005380 顧客区分抽出処理−ＥＸＩＴ.                                
005390     EXIT. 
005400******************************************************************
005410*    債権情報抽出処理                                <2.2>       *
005420******************************************************************
005430*
005440 債権情報抽出処理                     SECTION.                    
005450 債権情報抽出処理−ＳＴＡＲＴ.                                    
005460*
005470*----------------------------------------------------------------*
005480*   債権情報抽出処理                                             *
005490*----------------------------------------------------------------*
005500     EXEC SQL                                                     
005510       SELECT  M01SAJ_TBL.状態フラグ                              
005520               M01SAJ_TBL.債権契約件名                           
005530		     M01SAJ_TBL.担保区分                             
005540        INTO  :Ｍ０１−状態フラグ                                
005550             ,:Ｍ０１−債権契約件名                              
005560		   ,:Ｍ０１−担保区分                                
005570         FROM  M01SAJ_TBL                                         
005590       WHERE   レコード区分 =  '1'                     
005600         AND   契約番号 = :Ｍ４０−契約番号          
005610	       AND   再リース回数 = :Ｍ４０−再リース回数
005620	       AND   契約種類 = :Ｍ４０−契約種類        
005630     END-EXEC.                                                    
005640*----------------------------------------------------------------*
005650*    債権情報抽出処理確認                                        *
005660*----------------------------------------------------------------*
005670     EVALUATE   SQLCODE                                           
005680        WHEN   定数−ＳＱＬＯＫ                                   
005690*--<       正常 >
005700           CONTINUE                                               
005710        WHEN   OTHER                                              
005720*--<       債権情報抽出処理失敗>
005730           MOVE      -70              TO  Ｗ−エラーコード        
005740           PERFORM   エラー処理 
005750           MOVE      ZERO             TO  Ｍ０１−状態フラグ      
005760           MOVE      SPACE            TO  Ｍ０１−債権契約件名    
005770           MOVE      ZERO             TO  Ｍ０１−担保区分        
005780     END-EVALUATE.                                                
005790*
005800 債権情報抽出処理−ＥＸＩＴ.                                      
005810     EXIT.                                                        
005820******************************************************************
005830*    前受金受払残高中間ファイル出力判定処理          <2.3>       *
005840******************************************************************
005850 出力判定                             SECTION.                    
005860 出力判定−ＳＴＡＲＴ.                                
005870*
005880     IF Ｍ０１−担保区分 NOT = "1"                                
005890        PERFORM  編集出力処理        
005900     END-IF.                                                      
005910*                                                                 
005920 出力判定−ＥＸＩＴ.                                  
005930     EXIT.                                                        
005940*
005950******************************************************************
005960*    前受金受払残高中間ファイル項目編集、出力処理    <2.4>       *
005970******************************************************************
005980 編集出力処理                         SECTION.                    
005990 編集出力処理−ＳＴＡＲＴ.                                        
006000*
006010*----------------------------------------------------------------*
006020*       初期化処理                                               *
006030*----------------------------------------------------------------*
006040        MOVE  SPACE                   TO  出力−レコード.         
006050        INITIALIZE                        出力−レコード.         
006060*
006070*--< 前受金受払残高中間ファイル項目編集処理（自社分）>	      
006080     PERFORM    自社分編集処理.
006090*
006100*--< 前受金受払残高中間ファイル項目編集処理（他社分）>            
006110     PERFORM    他社分編集処理.
006120*
006130 編集出力処理−ＥＸＩＴ.
006140     EXIT.
006150*
006160******************************************************************
006170*    前受金受払残高中間ファイル項目編集処理（自社分）<2.4.1>     *
006180******************************************************************
006190 自社分編集処理                       SECTION.                                                                 
006200 自社分編集処理−ＳＴＡＲＴ. 
006210*                                                                 
006220     PERFORM  共通項目編集.
006230*
006240*--< No.01 >
006250     IF Ｍ０１−状態フラグ < "3"                                
006260	      MOVE   "3"                    TO  出力−自他社区分    
006270	   ELSE                                                     
006280	      MOVE   "1"                    TO  出力−自他社区分    
006290     END-IF.
006300*
006310*--< No.23 >
006320     MOVE  Ｍ４０−前月末残高         TO  出力−前月末残高.       
006330*
006340*--< No.24 >
006350     MOVE  Ｍ４０−当月回収額         TO  出力−当月入金額.       
006360*
006370*--< No.25 >
006380     MOVE  Ｍ４０−当月消化額         TO  出力−当月消化額.       
006390*
006400*--< No.26 >
006410     MOVE  Ｍ４０−当月末残高         TO  出力−当月末残高.       
006420*
006430     PERFORM  出力処理判定.
006440*
006450 自社分編集処理−ＥＸＩＴ.
006460     EXIT.
006470******************************************************************
006480*    前受金受払残高中間ファイル項目編集処理（他社分) <2.4.3>     *
006490******************************************************************
006500 他社分編集処理                       SECTION.
006510 他社分編集処理−ＳＴＡＲＴ.
006520*
006530     PERFORM  共通項目編集.                                       
006540*
006550*--< No.01 >
006560     IF Ｍ４０−協調区分  = "2" 
006570         IF Ｍ０１−状態フラグ < 3                             
006580			MOVE   "4"          TO 出力−自他社区分         
006590		ELSE                                                  
006600		        MOVE   "2"          TO 出力−自他社区分       
006610		END-IF
006620     END-IF.
006630*                                                                 
006640*--< No.23 >	                                                
006650     MOVE  Ｍ４０−前月末残高他社     TO   出力−前月末残高. 
006660*
006670*--< No.24 >	                                                
006680     MOVE  Ｍ４０−当月回収額他社     TO   出力−当月入金額. 
006690*                                                                 
006700*--< No.25 >	                                                
006710*
006720     COMPUTE  Ｗ−当月消化額１ = Ｍ４０−当月消化額他社   +	
006730                                 Ｍ４０−当月他社解約分消費税 +	
006740                                 Ｍ４０−当月他社解約分消費税.	
006750*
006760*--< No.26 >                                                   
006770     COMPUTE  Ｗ−当月末残高１ = Ｍ４０−当月末残高他社   -       
006780                                  Ｍ４０−当月他社解約分料金  -	
006790                                  Ｍ４０−当月他社解約分消費税.   
006800*
006810     PERFORM  出力処理判定.
006820*
006830 他社分編集処理−ＥＸＩＴ.
006840     EXIT.
006850******************************************************************
006860*    前受金受払残高中間ファイル共通項目編集    	               *
006870******************************************************************
006880 共通項目編集                             SECTION.
006890 共通項目編集−ＳＴＡＲＴ.                                        
006900*
006910*--< No.02 >
006920     MOVE  Ｍ４０−レコード区分       TO  出力−前受区分.         
006930*
006940*--< No.03 >
006950     MOVE  Ｍ４０−経理用主契約区分   TO  出力−主契約区分.       
006960*
006970*--< No.04 >
006980     MOVE  Ｍ４０−顧客区分           TO  出力−連結区分.         
006990*
007000*--< No.05 >
007010     MOVE  Ｄ０１−名寄せコード       TO  出力−名寄せコード.     
007020*
007030*--< No.06 >
007040     MOVE  Ｍ４０−請求先取引先コード TO  出力−取引先コード.  
007050*
007060*--< No.07 >
007070     MOVE  Ｍ４０−請求先コード       TO  出力−請求先コード. 
007080*                                                                 
007090*--< No.08 >
007100     MOVE  Ｍ４０−契約番号           TO  出力−契約番号.         
007110*
007120*--< No.09 >
007130     MOVE  Ｍ４０−契約種類           TO  出力−契約種類.         
007140*
007150*--< No.10 >
007160     MOVE  Ｄ７０−バッチ用業務年月   TO  出力−業務年月.      
007170*
007180*--< No.11 >
007190     MOVE  Ｍ４０−担当部課コード     TO  出力−担当部課コード.   
007200*
007210*--< No.12 >
007220     MOVE  Ｍ０１−債権契約件名       TO  出力−契約件名.       
007230*
007240*--< No.13 >
007250     MOVE  Ｍ４０−再リース回数       TO  出力−再リース回数.    
007260*
007270*--< No.14 >
007280     MOVE  Ｍ４０−充当開始年月       TO  出力−充当開始年月.     
007290*
007300*--< No.15 >
007310     MOVE  Ｍ４０−充当月数           TO  出力−充当月数.         
007320*
007330*--< No.16 >
007340     MOVE  Ｍ４０−前払回収方法       TO  出力−前払回収方法.  
007350*
007360*--< No.17 >
007370     MOVE  Ｍ４０−入金日             TO  出力−入金日.        
007380*
007390*--< No.18 >
007400     MOVE  Ｍ４０−入金区分           TO  出力−入金区分.      
007410*
007420*--< No.19 >
007430     MOVE  Ｄ０１−取引先名称         TO  出力−取引先名称.    
007440*
007450*--< No.20 >
007460     MOVE  Ｄ０２−請求先名称         TO  出力−請求先名称.    
007470*
007480*--< No.21 >
007490     MOVE  WS-NAME1                   TO  出力−主契約区分名称.  
007500*
007510*--< No.22 >
007520     MOVE  WS-NAME2                   TO  出力−連結区分名称.     
007530*                                                                 
007540 共通項目編集−ＥＸＩＴ.
007550     EXIT.
007560*
007570******************************************************************
007580*    自社分他社分出力処理判定                   <2.4.2>/<2.4.4>  *
007590******************************************************************
007600 出力処理判定                         SECTION.
007610 出力処理判定−ＳＴＡＲＴ.
007620* 
007630     IF  出力−前月末残高 = 0 AND 
007640         出力−当月入金額 = 0 AND
007650         出力−当月消化額 = 0 AND 
007660         出力−当月末残高 = 0
007670          CONTINUE
007680     ELSE  
007690        PERFORM  項目出力処理 
007700     END-IF.
007710*                                                                 
007720 出力処理判定−ＥＸＩＴ.
007730     EXIT.
007740*
007750******************************************************************
007760*    前受金受払残高中間ファイル出力処理         <2.4.2>/<2.4.4>  *
007770******************************************************************
007780 項目出力処理                         SECTION.
007790 項目出力処理−ＳＴＡＲＴ.
007800*
007810     WRITE  出力−レコード.                                       
007820*
007830*--< ファイル出力の状態判定 >
007840     EVALUATE  Ｗ−状態                                           
007850        WHEN  ZERO                                                
007860*--<       ファイル出力件数の加算 >
007870           COMPUTE  Ｗ−出力−件数 =  Ｗ−出力−件数 + 1          
007880        WHEN  OTHER                                               
007890*--<       ファイル出力エラー >
007900           MOVE     -80               TO  Ｗ−エラーコード       
007910           PERFORM  エラー処理                                    
007920     END-EVALUATE.                                                
007930*
007940
007950 項目出力処理−ＥＸＩＴ.                                          
007960     EXIT.               
007970*
007980******************************************************************
007990*    終了処理                                          <3.0>     *
008000******************************************************************
008010 終了処理                             SECTION.                    
008020 終了処理−ＳＴＡＲＴ.                                            
008030*
008040     PERFORM  ＤＢクローズ処理.                                   
008050*
008060     PERFORM  ファイルクローズ.                                   
008070*
008080     PERFORM  件数メッセージ出力.					
008090*
008100     PERFORM  終了メッセージ出力.                                 
008110*
008120*--< プログラム正常終了のリターンコード >                         
008130     MOVE  定数−正常状態             TO  PROGRAM-STATUS.         
008140*
008150 終了処理−ＥＸＩＴ.                                              
008160     EXIT.          
008170*
008180*----------------------------------------------------------------*
008190*    ＤＢクローズ                                    <3.1>       *
008200*----------------------------------------------------------------*
008210 ＤＢクローズ処理                     SECTION.                    
008220 ＤＢクローズ処理−ＳＴＡＲＴ.                                    
008230*
008240*--< カーソル クローズ >                                          
008250     EXEC SQL                                                     
008260        CLOSE  CUR1                                               
008270     END-EXEC.                                                    
008280*
008290 ＤＢクローズ処理−ＥＸＩＴ.                                      
008300     EXIT.                                                        
008310*
008320*----------------------------------------------------------------*
008330*    ファイルクローズ				   <3.2>       *
008340*----------------------------------------------------------------*
008350 ファイルクローズ                     SECTION.                    
008360 ファイルクローズ−ＳＴＡＲＴ.                                                
008370*
008380     CLOSE    出力ファイル.                                       
008390*
008400 ファイルクローズ−ＥＸＩＴ.
008410     EXIT.
008420*
008430*----------------------------------------------------------------*
008440*    件数メッセージ出力処理                          <3.3>       *
008450*----------------------------------------------------------------*
008460 件数メッセージ出力                   SECTION.                    
008470 件数メッセージ出力−ＳＴＡＲＴ.
008480*
008490     INITIALIZE                       IF-CHOCO001.                
008500     MOVE  "3"                        TO  共１−イベント種別.     
008510     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
008520     MOVE  "0"                        TO  共１−復帰コード.       
008530     MOVE  "M40MAB"                   TO  共１−処理テーブルＩＤ. 
008540     MOVE  "COUNT"                    TO  共１−処理識別.         
008550     MOVE  Ｗ−入力−件数             TO  共１−データ内容.       
008560     MOVE  "前受情報テーブル（入力）" TO  共１−その他メッセージ. 
008570     CALL  CLOCO001                USING  IF-CHOCO001.            
008580*
008590     INITIALIZE                       IF-CHOCO001.                
008600     MOVE  "3"                        TO  共１−イベント種別.     
008610     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
008620     MOVE  "0"                        TO  共１−復帰コード.       
008630     MOVE  "SFHSED25"                 TO  共１−処理テーブルＩＤ. 
008640     MOVE  "COUNT"                    TO  共１−処理識別.         
008650     MOVE  Ｗ−出力−件数             TO  共１−データ内容.       
008660     MOVE  "前受金受払残高ファイル(出力)"
008670                                      TO  共１−その他メッセージ. 
008680     CALL  CLOCO001                USING  IF-CHOCO001.            
008690*
008700 件数メッセージ出力−ＥＸＩＴ.
008710     EXIT.
008720*
008730*----------------------------------------------------------------*
008740*    終了メッセージ出力                              <3.4>       *
008750*----------------------------------------------------------------*
008760 終了メッセージ出力                   SECTION.                    
008770 終了メッセージ出力−ＳＴＡＲＴ.     
008780*
008790     INITIALIZE                       IF-CHOCO001.                
008800     MOVE  "3"                        TO  共１−イベント種別.     
008810     MOVE  定数−プログラムＩＤ       TO  共１−ソースＩＤ.       
008820     MOVE  "0"                        TO  共１−復帰コード.       
008830     MOVE  "END"                      TO  共１−処理識別.         
008840     MOVE  定数−プログラム名         TO  共１−その他メッセージ. 
008850     CALL  CLOCO001                USING  IF-CHOCO001.            
008860*
008870 終了メッセージ出力−ＥＸＩＴ.                                    
008880     EXIT.                                                        
008890******************************************************************
008900*    エラー処理                                        <4.0>     *
008910******************************************************************
008920 エラー処理                           SECTION.                        
008930 エラー処理−ＳＴＡＲＴ.                                          
008940*
008950     MOVE  "Y"                        TO Ｗ−異常終了−フラグ.    
008960     INITIALIZE                           IF-CHOCO001.            
008970*
008980     EVALUATE  Ｗ−エラーコード                                   
008990        WHEN  -10                                                 
009000*--<       ＯＲＡＣＬＥ接続失敗 >
009010           MOVE  "1"                  TO  共１−イベント種別      
009020           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009030           MOVE  "9"                  TO  共１−復帰コード        
009040           MOVE  "CONNECT"            TO  共１−処理識別          
009050           MOVE  SQLCODE              TO  共１−データ内容        
009060           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009070           CALL  CLOCO001          USING  IF-CHOCO001             
009080*
009090        WHEN  -20                                                 
009100*--<       業務管理テーブル読込失敗 >
009110           MOVE  "1"                  TO  共１−イベント種別      
009120           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009130           MOVE  "9"                  TO  共１−復帰コード        
009140           MOVE  "D70GYM"             TO  共１−処理テーブルＩＤ  
009150           MOVE  "SELECT"             TO  共１−処理識別          
009160           MOVE  SQLCODE              TO  共１−データ内容        
009170           MOVE  SQLERRMC             TO  共１−その他メッセージ            
009180           CALL  CLOCO001          USING  IF-CHOCO001             
009190*
009200        WHEN  -30                                                 
009210*--<       結合テーブルカーソルオープン失敗 >
009220           MOVE  "1"                  TO  共１−イベント種別      
009230           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009240           MOVE  "9"                  TO  共１−復帰コード        
009250           MOVE  "M40MAB"       TO  共１−処理テーブルＩＤ  
009260           MOVE  "OPEN"               TO  共１−処理識別          
009270           MOVE  SQLCODE              TO  共１−データ内容        
009280           MOVE  SQLERRMC             TO  共１−その他メッセージ            
009290           CALL  CLOCO001          USING  IF-CHOCO001             
009300*
009310        WHEN  -40                                                 
009320*--<       結合テーブル読込失敗 >
009330           MOVE  "1"                  TO  共１−イベント種別      
009340           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009350           MOVE  "9"                  TO  共１−復帰コード        
009360           MOVE  "M40MAB"             TO  共１−処理テーブルＩＤ  
009370           MOVE  "FETCH"              TO  共１−処理識別          
009380           MOVE  SQLCODE              TO  共１−データ内容        
009390           MOVE  SQLERRMC
009400				    TO  共１−その他メッセージ            
009410           CALL  CLOCO001          USING  IF-CHOCO001             
009420*
009430        WHEN  -50                                                 
009440*--<       主契約区分名称の抽出処理失敗 >
009450           MOVE  "2"                  TO  共１−イベント種別      
009460           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009470           MOVE  "9"                  TO  共１−復帰コード        
009480           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
009490           MOVE  "SELECT"             TO  共１−処理識別          
009500           MOVE  SQLCODE              TO  共１−データ内容        
009510           MOVE  SQLERRMC  	    TO  共１−その他メッセージ  
009520           CALL  CLOCO001          USING  IF-CHOCO001             
009530           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
009540*
009550        WHEN  -60                                                 
009560*--<       顧客区分名称の抽出処理失敗 >
009570           MOVE  "2"                  TO  共１−イベント種別      
009580           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009590           MOVE  "9"                  TO  共１−復帰コード        
009600           MOVE  "D19MSY"             TO  共１−処理テーブルＩＤ  
009610           MOVE  "SELECT"             TO  共１−処理識別          
009620           MOVE  SQLCODE              TO  共１−データ内容        
009630           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009640           CALL  CLOCO001          USING  IF-CHOCO001             
009650           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
009660*
009670        WHEN  -70                                                 
009680*--<       債権情報ＤＢ抽出処理失敗 >
009690           MOVE  "2"                  TO  共１−イベント種別      
009700           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009710           MOVE  "9"                  TO  共１−復帰コード        
009720           MOVE  "M01SAJ"             TO  共１−処理テーブルＩＤ  
009730           MOVE  "SELECT"             TO  共１−処理識別          
009740           MOVE  SQLCODE              TO  共１−データ内容        
009750           MOVE  SQLERRMC             TO  共１−その他メッセージ  
009760           CALL  CLOCO001          USING  IF-CHOCO001             
009770           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
009780*
009790        WHEN  -80                                                 
009800*--<       前受金受払残高中間ファイル出力失敗 >
009810           MOVE  "1"                  TO  共１−イベント種別      
009820           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009830           MOVE  "9"                  TO  共１−復帰コード        
009840           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
009850           MOVE  "WRITE"              TO  共１−処理識別          
009860           MOVE  Ｗ−状態             TO  共１−データ内容        
009870           MOVE  "前受金受払残高中間ファイル出力失敗"             
009880				    TO  共１−その他メッセージ            
009890           CALL  CLOCO001          USING  IF-CHOCO001             
009900*
009910        WHEN  -90
009920*--<       前受金受払残高中間ファイルオープン失敗 >
009930           MOVE  "1"                  TO  共１−イベント種別      
009940           MOVE  定数−プログラムＩＤ TO  共１−ソースＩＤ        
009950           MOVE  "9"                  TO  共１−復帰コード        
009960           MOVE  "SFHSED25"           TO  共１−処理テーブルＩＤ  
009970           MOVE  "OPEN"               TO  共１−処理識別          
009980           MOVE  Ｗ−状態             TO  共１−データ内容        
009990           MOVE  "前受金受払残高中間ファイルオープン失敗"         
010000                                      TO  共１−その他メッセージ  
010010           CALL  CLOCO001          USING  IF-CHOCO001             
010020*
010030        WHEN  OTHER                                               
010040           MOVE  "N"                  TO Ｗ−異常終了−フラグ     
010050     END-EVALUATE.                                                
010060*
010070     IF Ｗ−異常終了−フラグ  =  "Y"                              
010080*                                         
010090        PERFORM  件数メッセージ出力
010100*                                         
010110        PERFORM  終了メッセージ出力                               
010120*                                                                 
010130*--<    プログラム異常終了のリターンコード >                      
010140        MOVE  定数−異常状態          TO  PROGRAM-STATUS          
010150*                                                                 
010160        EXIT  PROGRAM                                             
010170     END-IF.                                                      
010180*                                                                 
010190 エラー処理−ＥＸＩＴ.                                            
010200     EXIT.                                                        
010210******************************************************************
010220*                  END OF PROGRAM                                *
010230******************************************************************
